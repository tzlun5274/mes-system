{% extends 'base.html' %}
{% load static %}

{% block title %}評分儀表板{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
<style>
    .score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .score-value {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin: 10px 0;
    }
    
    .score-label {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .grade-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .grade-excellent { background-color: #28a745; color: white; }
    .grade-good { background-color: #17a2b8; color: white; }
    .grade-pass { background-color: #ffc107; color: black; }
    .grade-fail { background-color: #dc3545; color: white; }
    
    .improvement-card {
        border-left: 4px solid #dc3545;
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    
    .improvement-urgent { border-left-color: #dc3545; }
    .improvement-important { border-left-color: #fd7e14; }
    .improvement-normal { border-left-color: #ffc107; }
    .improvement-suggestion { border-left-color: #20c997; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">評分儀表板</h1>
                <div>
                    <a href="{% url 'reporting:operator_score_list' %}" class="btn btn-warning">
                        <i class="fas fa-star"></i> 主管評分
                    </a>
                    <a href="{% url 'reporting:generate_scoring_report' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 生成新評分報表
                    </a>
                    <a href="{% url 'reporting:scoring_report_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> 查看所有報表
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if latest_report %}
    <!-- 最新評分概覽 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="score-card">
                <div class="score-label">總分</div>
                <div class="score-value">{{ latest_report.total_score|floatformat:1 }}</div>
                <div class="text-center">
                    <span class="grade-badge grade-{{ latest_report.overall_grade|lower }}">
                        {{ latest_report.overall_grade }}
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="score-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="score-label">生產效率 (80%)</div>
                <div class="score-value">{{ latest_report.capacity_score|floatformat:1 }}</div>
                <div class="text-center">
                    <span class="grade-badge grade-{% if latest_report.capacity_score >= 90 %}excellent{% elif latest_report.capacity_score >= 80 %}good{% elif latest_report.capacity_score >= 70 %}pass{% else %}fail{% endif %}">
                        {% if latest_report.capacity_score >= 90 %}優秀{% elif latest_report.capacity_score >= 80 %}良好{% elif latest_report.capacity_score >= 70 %}及格{% else %}不及格{% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="score-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="score-label">主管評分 (20%)</div>
                <div class="score-value">{{ latest_report.supervisor_score|floatformat:1 }}</div>
                <div class="text-center">
                    <span class="grade-badge grade-{% if latest_report.supervisor_score >= 90 %}excellent{% elif latest_report.supervisor_score >= 80 %}good{% elif latest_report.supervisor_score >= 70 %}pass{% else %}fail{% endif %}">
                        {% if latest_report.supervisor_score >= 90 %}優秀{% elif latest_report.supervisor_score >= 80 %}良好{% elif latest_report.supervisor_score >= 70 %}及格{% else %}不及格{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- 評分趨勢圖 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">評分趨勢分析</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 評分維度分析 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">評分維度分析</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-industry"></i> 生產效率 (80%)</h6>
                                </div>
                                <div class="card-body">
                                    <h4 class="text-primary">{{ latest_report.capacity_score|floatformat:1 }}分</h4>
                                    <p class="mb-2">基於產能比率計算</p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-primary" style="width: {{ latest_report.capacity_score }}%"></div>
                                    </div>
                                    <small class="text-muted">標準產能：{{ latest_report.standard_capacity_per_hour }} | 實際產能：{{ latest_report.actual_capacity_per_hour }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-user-tie"></i> 主管評分 (20%)</h6>
                                </div>
                                <div class="card-body">
                                    <h4 class="text-info">{{ latest_report.supervisor_score|floatformat:1 }}分</h4>
                                    <p class="mb-2">主管主觀評分</p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-info" style="width: {{ latest_report.supervisor_score }}%"></div>
                                    </div>
                                    {% if latest_report.supervisor_comment %}
                                    <small class="text-muted">評語：{{ latest_report.supervisor_comment }}</small>
                                    {% else %}
                                    <small class="text-muted">尚未評分</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">等級統計</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>優秀項目</span>
                        <span class="badge bg-success">{{ latest_report.excellent_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>良好項目</span>
                        <span class="badge bg-info">{{ latest_report.good_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>及格項目</span>
                        <span class="badge bg-warning">{{ latest_report.pass_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>不及格項目</span>
                        <span class="badge bg-danger">{{ latest_report.fail_count }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- 無資料提示 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">尚未有評分報表</h4>
                    <p class="text-muted">點擊下方按鈕生成您的第一份評分報表</p>
                    <a href="{% url 'reporting:generate_scoring_report' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 生成評分報表
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 待評分項目 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock text-warning"></i> 待評分項目
                    </h5>
                    <div class="card-tools">
                        <a href="{% url 'reporting:operator_score_list' %}?has_supervisor_score=no" class="btn btn-warning btn-sm">
                            <i class="fas fa-star"></i> 前往評分
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>主管評分說明：</strong>
                        <ul class="mb-0 mt-2">
                            <li>主管可根據作業員的工作態度、團隊合作、學習能力等進行主觀評分</li>
                            <li>評分範圍：0-100分，預設為80分</li>
                            <li>主管評分佔總評分的20%權重</li>
                            <li>點擊「前往評分」查看所有待評分的作業員記錄</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 待處理改善建議 -->
    {% if pending_improvements %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">待處理改善建議</h5>
                </div>
                <div class="card-body">
                    {% for improvement in pending_improvements %}
                    <div class="improvement-card improvement-{{ improvement.improvement_type }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ improvement.problem_description }}</h6>
                                <p class="mb-1 text-muted">{{ improvement.improvement_suggestion }}</p>
                                <small class="text-muted">
                                    目前分數: {{ improvement.current_score }}分 | 
                                    目標分數: {{ improvement.target_score }}分
                                </small>
                            </div>
                            <span class="badge bg-{% if improvement.improvement_type == 'urgent' %}danger{% elif improvement.improvement_type == 'important' %}warning{% elif improvement.improvement_type == 'normal' %}info{% else %}success{% endif %}">
                                {{ improvement.get_improvement_type_display }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if latest_report %}
    // 雷達圖
    const radarCtx = document.getElementById('radarChart').getContext('2d');
    new Chart(radarCtx, {
        type: 'radar',
        data: {
            labels: ['生產效率', '品質管理', '交期管理', '設備管理', '成本控制', '安全管理', '人員管理'],
            datasets: [{
                label: '評分',
                data: [
                    {{ latest_report.production_score }},
                    {{ latest_report.quality_score }},
                    {{ latest_report.delivery_score }},
                    {{ latest_report.equipment_score }},
                    {{ latest_report.cost_score }},
                    {{ latest_report.safety_score }},
                    {{ latest_report.personnel_score }}
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    {% endif %}

    {% if trend_data.labels %}
    // 趨勢圖
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_data.labels|safe }},
            datasets: [{
                label: '總分',
                data: {{ trend_data.total_scores|safe }},
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: '生產效率',
                data: {{ trend_data.production_scores|safe }},
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }, {
                label: '品質管理',
                data: {{ trend_data.quality_scores|safe }},
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.1
            }, {
                label: '交期管理',
                data: {{ trend_data.delivery_scores|safe }},
                borderColor: 'rgba(255, 205, 86, 1)',
                backgroundColor: 'rgba(255, 205, 86, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %} 