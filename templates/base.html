<!DOCTYPE html>
<html lang="zh-hant">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MES 系統{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- 全域樣式 -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    
    <!-- 基礎樣式 -->
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f8f9fa;
        }
        
        .navbar { 
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            padding: 0 20px; 
            height: 60px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar a { 
            color: white; 
            margin: 0 15px; 
            text-decoration: none; 
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .navbar a:hover { 
            color: #ffd700;
            transform: translateY(-1px);
        }
        
        .navbar .nav-left { 
            display: flex; 
            align-items: center; 
        }
        
        .navbar .nav-right { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 300px; 
        }
        
        .navbar .nav-right .logout { 
            margin-right: 20px; 
        }
        
        .navbar .nav-right .user-time { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
        }
        
        .navbar .nav-right .user-time span { 
            color: white; 
            margin: 2px 0; 
            font-size: 0.9rem;
        }
        
        .navbar .nav-right form { 
            display: inline; 
        }
        
        .navbar .nav-right button { 
            background: none; 
            border: none; 
            color: white; 
            text-decoration: none; 
            padding: 0; 
            margin: 0; 
            cursor: pointer; 
            font-weight: 500;
        }
        
        .navbar .nav-right button:hover { 
            color: #ffd700;
        }
        
        .container { 
            padding: 20px; 
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* 報表大標題樣式 */
        .report-main-title {
            background-color: #212529;
            color: #ffc107;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-main-title i {
            margin-right: 10px;
            color: #ffc107;
        }
        
        /* 報表區段標題樣式 */
        .report-section-title {
            background-color: #212529;
            color: #ffffff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .report-section-title i {
            margin-right: 8px;
            color: #ffffff;
        }
        }
        
        /* 麵包屑導航樣式 */
        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin: 0;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            color: #6c757d;
            font-weight: bold;
        }
        
        .breadcrumb-item a {
            color: #007bff;
            transition: color 0.3s ease;
        }
        
        .breadcrumb-item a:hover {
            color: #0056b3;
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: #6c757d;
            font-weight: 500;
        }
        
        .container h2 { 
            margin-bottom: 20px; 
            color: #333; 
        }
        
        .container h3 { 
            margin-top: 20px; 
            color: #333; 
        }
        
        .container .card { 
            margin-bottom: 20px; 
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 10px;
                height: auto;
                flex-direction: column;
                padding: 10px;
            }
            
            .navbar .nav-left {
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .navbar .nav-right {
                width: 100%;
                justify-content: center;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
    {% block extra_head %}{% endblock %}
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <a href="{% url 'home_page' %}">
                <i class="fas fa-home me-1"></i>首頁
            </a>
            {% if user.is_authenticated %}
                <a href="{% url 'equip:index' %}">
                    <i class="fas fa-cogs me-1"></i>設備管理
                </a>
                <a href="{% url 'material:index' %}">
                    <i class="fas fa-boxes me-1"></i>物料管理
                </a>
                <a href="{% url 'scheduling:index' %}">
                    <i class="fas fa-calendar-alt me-1"></i>排程管理
                </a>
                <a href="{% url 'production:index' %}">
                    <i class="fas fa-industry me-1"></i>生產管理
                </a>
                <a href="{% url 'process:index' %}">
                    <i class="fas fa-tasks me-1"></i>工序管理
                </a>
                <a href="{% url 'quality:index' %}">
                    <i class="fas fa-check-circle me-1"></i>品質管理
                </a>
                <a href="{% url 'workorder:index' %}">
                    <i class="fas fa-clipboard-list me-1"></i>工單管理功能入口
                </a>
                                                   
                <a href="{% url 'reporting:index' %}">
                    <i class="fas fa-chart-bar me-1"></i>報表管理
                </a>
                <a href="{% url 'kanban:index' %}">
                    <i class="fas fa-tachometer-alt me-1"></i>看板管理
                </a>
                {% if user.is_superuser %}
                    <a href="{% url 'system:index' %}">
                        <i class="fas fa-cog me-1"></i>系統管理
                    </a>
                    <a href="{% url 'erp_integration:index' %}">
                        <i class="fas fa-database me-1"></i>ERP整合
                    </a>
                    <a href="{% url 'ai:index' %}">
                        <i class="fas fa-brain me-1"></i>AI管理
                    </a>
                {% endif %}
            {% endif %}
        </div>
        <div class="nav-right">
            {% if user.is_authenticated %}
                <div class="logout">
                    <form action="{% url 'logout' %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">
                            <i class="fas fa-sign-out-alt me-1"></i>登出
                        </button>
                    </form>
                    {% if not user.is_superuser %}
                        <a href="{% url 'system:change_password' %}">
                            <i class="fas fa-key me-1"></i>變更密碼
                        </a>
                    {% endif %}
                </div>
                <div class="user-time">
                    <span><i class="fas fa-user me-1"></i>{{ user.username }}</span>
                    <span id="current-time"></span>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 麵包屑導航區域 -->
    {% block breadcrumb %}
    {% endblock %}
    
    <div class="container">
        {% block content %}
        {% endblock %}
    </div>
    
    <!-- jQuery 已移除，改用原生 JavaScript -->
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function updateTime() {
            const now = new Date();
            const options = {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-time').innerText = now.toLocaleString('zh-TW', options).replace(/\//g, '-');
        }
        
        updateTime();
        setInterval(updateTime, 1000);
    </script>
    
    <script>
        // 全域日期格式正規化：接受 2025/08/12、2025.08.12、20250812、12/08/2025，統一轉成 2025-08-12
        (function () {
            function pad2(n) { return n.toString().padStart(2, '0'); }
            function isValidYMD(y, m, d) {
                const date = new Date(y, m - 1, d);
                return date.getFullYear() === y && date.getMonth() === m - 1 && date.getDate() === d;
            }
            function normalizeDateToISO(value) {
                if (!value) return value;
                let v = String(value).trim();
                if (!v) return v;
                const digitsOnly = v.replace(/[^0-9]/g, '');
                // YYYYMMDD
                if (/^\d{8}$/.test(digitsOnly)) {
                    const y = parseInt(digitsOnly.slice(0, 4), 10);
                    const m = parseInt(digitsOnly.slice(4, 6), 10);
                    const d = parseInt(digitsOnly.slice(6, 8), 10);
                    if (isValidYMD(y, m, d)) return `${y}-${pad2(m)}-${pad2(d)}`;
                }
                // Y-M-D, Y/M/D, Y.M.D
                let mYMD = v.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})$/);
                if (mYMD) {
                    const y = parseInt(mYMD[1], 10);
                    const m = parseInt(mYMD[2], 10);
                    const d = parseInt(mYMD[3], 10);
                    if (isValidYMD(y, m, d)) return `${y}-${pad2(m)}-${pad2(d)}`;
                }
                // D-M-Y, D/M/Y, D.M.Y
                let mDMY = v.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{4})$/);
                if (mDMY) {
                    const d = parseInt(mDMY[1], 10);
                    const m = parseInt(mDMY[2], 10);
                    const y = parseInt(mDMY[3], 10);
                    if (isValidYMD(y, m, d)) return `${y}-${pad2(m)}-${pad2(d)}`;
                }
                return v;
            }
            function normalizeInputEl(el) {
                if (!el || el.type !== 'date') return;
                const normalized = normalizeDateToISO(el.value);
                if (normalized && normalized !== el.value) {
                    el.value = normalized;
                }
            }
            function attachHandlersTo(el) {
                if (!el || el.dataset._dateNormalized === '1') return;
                el.dataset._dateNormalized = '1';

                // 避免瀏覽器嘗試設定不合法值而報警告：
                // 1) 輸入 '/' 或 '.' 時，改為插入 '-'
                el.addEventListener('beforeinput', function (e) {
                    if (e.inputType === 'insertText' && (e.data === '/' || e.data === '.')) {
                        e.preventDefault();
                        const start = el.selectionStart || 0;
                        const end = el.selectionEnd || 0;
                        const v = el.value || '';
                        const next = v.slice(0, start) + '-' + v.slice(end);
                        // 僅在結果為可被瀏覽器接受的情況下再設定（否則保持原值，避免噪音警告）
                        try { el.value = next; } catch (_) {}
                        // 將游標移動到插入後的位置
                        requestAnimationFrame(() => { try { el.setSelectionRange(start + 1, start + 1); } catch (_) {} });
                    }
                }, { passive: false });

                // 2) 貼上時統一正規化
                el.addEventListener('paste', function (e) {
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    if (text) {
                        const normalized = normalizeDateToISO(text);
                        if (normalized) {
                            e.preventDefault();
                            try { el.value = normalized; } catch (_) {}
                        }
                    }
                });

                // 3) 常規事件：blur/change/input 時再校正一次
                ['blur','change','input'].forEach(evt => {
                    el.addEventListener(evt, function () { normalizeInputEl(el); }, { passive: true });
                });

                // 初次載入也先正規化一次
                normalizeInputEl(el);
            }
            function normalizeAllDatesInForm(form) {
                const inputs = form.querySelectorAll('input[type="date"], input.date-input, input[data-date]');
                inputs.forEach(el => {
                    if (el.type === 'date') {
                        normalizeInputEl(el);
                    } else {
                        // 對於文字輸入的日期欄位，也一併正規化
                        const normalized = normalizeDateToISO(el.value);
                        if (normalized && normalized !== el.value) el.value = normalized;
                    }
                });
            }
            // 盡早執行正規化，不等 DOMContentLoaded
            function initializeDateNormalization() {
                document.querySelectorAll('input[type="date"]').forEach(attachHandlersTo);
                // 在表單提交前，統一正規化所有日期欄位，避免瀏覽器拒絕 "yyyy/MM/dd"
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', function () {
                        normalizeAllDatesInForm(form);
                    });
                });
            }
            
            // 多重時機執行，確保涵蓋所有情況
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeDateNormalization);
            } else {
                initializeDateNormalization();
            }
            
            // 使用 MutationObserver 監控動態新增的日期欄位
            if (window.MutationObserver) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.type === 'date') {
                                    attachHandlersTo(node);
                                } else if (node.querySelectorAll) {
                                    node.querySelectorAll('input[type="date"]').forEach(attachHandlersTo);
                                }
                            }
                        });
                    });
                });
                observer.observe(document.body, { childList: true, subtree: true });
            }
        })();
    </script>

    {% block extra_js %}
    {% endblock %}
</body>
</html>
