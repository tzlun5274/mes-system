# å·²å®Œå·¥å·¥å–®å·¥åºç´€éŒ„æ•¸é‡åˆ†é…åŠŸèƒ½å¯¦ç¾ç¸½çµ

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å·²ç¶“æˆåŠŸå¯¦ç¾äº†å·²å®Œå·¥å·¥å–®å·¥åºç´€éŒ„æ•¸é‡è‡ªå‹•åˆ†é…åŠŸèƒ½ã€‚æ­¤åŠŸèƒ½æœƒç‚ºå·²å®Œå·¥å·¥å–®ä¸­æ•¸é‡ç‚º0çš„å·¥åºç´€éŒ„è‡ªå‹•åˆ†é…æ•¸é‡ï¼Œä¸¦æ¨™è¨˜ç‚ºç³»çµ±åˆ†é…ã€‚

## ğŸ“‹ åˆ†é…é‚è¼¯

### åŸºæœ¬è¦å‰‡
1. **æ’é™¤æ¢ä»¶**ï¼šä¸€å¾‹æ’é™¤å·¥åºåç¨±ç‚º "å‡ºè²¨åŒ…è£" çš„å·¥åº
2. **åˆ†é…å–®ä½**ï¼šä¸€ç­†å·¥åºç´€éŒ„ç‚ºä¸€ç­†ï¼ˆä¸è«–ä½œæ¥­å“¡æ˜¯å¦ç›¸åŒï¼‰
3. **ç¨ç«‹è¨ˆç®—**ï¼š
   - å…©ç­†åŒä¸€åä½œæ¥­å“¡åŒä¸€å€‹å·¥åº = å…©ç­†ç¨ç«‹ç´€éŒ„
   - ä¸‰ç­†å…©å€‹ä¸åŒä½œæ¥­å“¡åŒä¸€å€‹å·¥åº = ä¸‰ç­†ç¨ç«‹ç´€éŒ„

### åˆ†é…ç¯„ä¾‹
å‡è¨­å·¥å–®ç”Ÿç”¢æ•¸é‡æ˜¯ 1000ï¼š

1. **ä¸€å€‹ä½œæ¥­å“¡ä¸€å€‹å·¥åºï¼Œæ²’æœ‰é‡è¤‡** â†’ 1ç­†ç´€éŒ„åˆ†é… 1000
2. **ä¸€å€‹ä½œæ¥­å“¡åˆ†å…©æ¬¡å ±å·¥ï¼ŒåŒä¸€å€‹å·¥åº** â†’ 2ç­†ç´€éŒ„ï¼Œæ¯ç­†åˆ†é… 500
3. **å…©å€‹ä½œæ¥­å“¡åŒä¸€å€‹å·¥åº** â†’ 2ç­†ç¨ç«‹ç´€éŒ„ï¼Œæ¯ç­†åˆ†é… 500
4. **ä¸‰å€‹ä½œæ¥­å“¡åŒä¸€å€‹å·¥åº** â†’ 3ç­†ç´€éŒ„ï¼Œæ¯ç­†åˆ†é… 333ï¼ˆé¤˜æ•¸1çµ¦ç¬¬ä¸€ç­†ï¼‰
5. **ä¸‰å€‹ä½œæ¥­å“¡åŒä¸€å€‹å·¥åºæœ‰4ç­†ç´€éŒ„** â†’ 4ç­†ç´€éŒ„ï¼Œæ¯ç­†åˆ†é… 250
6. **ä¸‰å€‹ä½œæ¥­å“¡åŒä¸€å€‹å·¥åºæœ‰4ç­†ç´€éŒ„ï¼Œå…¶ä¸­1ç­†å·²æœ‰æ•¸é‡** â†’ å°‡1000æ¸›æ‰å·²æœ‰æ•¸é‡ï¼Œå‰©é¤˜å¹³å‡åˆ†é…çµ¦æ•¸é‡ç‚º0çš„3ç­†ç´€éŒ„

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

1. **åˆ†é…æœå‹™** (`workorder/services/completed_workorder_allocation_service.py`)
   - æ ¸å¿ƒåˆ†é…é‚è¼¯
   - æ‰¹é‡è™•ç†åŠŸèƒ½
   - çµ±è¨ˆæ‘˜è¦åŠŸèƒ½

2. **ç®¡ç†å‘½ä»¤** (`workorder/management/commands/allocate_completed_workorder_quantities.py`)
   - æ‰‹å‹•åŸ·è¡Œåˆ†é…
   - æ”¯æ´ä¹¾è·‘æ¨¡å¼
   - æ‘˜è¦é¡¯ç¤ºåŠŸèƒ½

3. **å®šæ™‚ä»»å‹™** (`workorder/tasks.py`)
   - è‡ªå‹•åŸ·è¡Œåˆ†é…
   - å®šæœŸæª¢æŸ¥å¾…åˆ†é…å·¥å–®

4. **è¨­å®šç®¡ç†** (`workorder/management/commands/setup_completed_workorder_allocation_task.py`)
   - å®šæ™‚ä»»å‹™è¨­å®š
   - å•Ÿç”¨/åœç”¨æ§åˆ¶

5. **è³‡æ–™æ¨¡å‹** (`workorder/models.py`)
   - æ–°å¢ `is_system_allocated` æ¬„ä½æ¨™è¨˜ç³»çµ±åˆ†é…
   - æ“´å±• `AutoAllocationSettings` æ¨¡å‹

6. **ç¶²é ä»‹é¢** (`workorder/templates/workorder/completed_workorder/completed_workorder_detail.html`)
   - åœ¨å·²å®Œå·¥å·¥å–®è©³æƒ…é é¢é¡¯ç¤ºåˆ†é…æ¨™è¨˜

## ğŸ”§ ä¸»è¦åŠŸèƒ½

### 1. è‡ªå‹•åˆ†é…é‚è¼¯

```python
# æŒ‰å·¥åºåç¨±åˆ†çµ„
processes_data = {}

for report in production_reports:
    process_name = report.process_name
    
    if process_name not in processes_data:
        processes_data[process_name] = {
            'reports': [],
            'total_existing_quantity': 0,
            'zero_quantity_reports': []
        }
    
    # çµ±è¨ˆå·²æœ‰æ•¸é‡
    if report.work_quantity > 0:
        processes_data[process_name]['total_existing_quantity'] += report.work_quantity
    else:
        processes_data[process_name]['zero_quantity_reports'].append(report)
```

### 2. æ•¸é‡åˆ†é…è¨ˆç®—

```python
# è¨ˆç®—è©²å·¥åºéœ€è¦åˆ†é…çš„æ•¸é‡
existing_quantity = data['total_existing_quantity']
remaining_quantity = total_planned_quantity - existing_quantity

# è¨ˆç®—æ¯ç­†ç´€éŒ„çš„åˆ†é…æ•¸é‡
zero_reports_count = len(data['zero_quantity_reports'])
quantity_per_report = remaining_quantity // zero_reports_count
remainder = remaining_quantity % zero_reports_count

for i, report in enumerate(data['zero_quantity_reports']):
    # åˆ†é…æ•¸é‡ï¼ˆå‰é¢çš„ç´€éŒ„ç²å¾—é¤˜æ•¸ï¼‰
    allocated_quantity = quantity_per_report + (1 if i < remainder else 0)
    
    # æ›´æ–°ç´€éŒ„ä¸¦æ¨™è¨˜ç‚ºç³»çµ±åˆ†é…
    report.work_quantity = allocated_quantity
    report.is_system_allocated = True
    report.allocated_at = timezone.now()
    report.allocation_method = 'completed_workorder_allocation'
    report.save()
```

### 3. ç³»çµ±åˆ†é…æ¨™è¨˜

åœ¨ `CompletedProductionReport` æ¨¡å‹ä¸­æ–°å¢æ¬„ä½ï¼š
- `is_system_allocated`: æ¨™è¨˜æ˜¯å¦ç‚ºç³»çµ±è‡ªå‹•åˆ†é…
- `allocated_at`: åˆ†é…æ™‚é–“
- `allocation_method`: åˆ†é…æ–¹å¼

## ğŸ“Š ä½¿ç”¨æ–¹å¼

### 1. æ‰‹å‹•åŸ·è¡Œåˆ†é…

```bash
# æŸ¥çœ‹åˆ†é…æ‘˜è¦
python3 manage.py allocate_completed_workorder_quantities --summary

# ä¹¾è·‘æ¨¡å¼ï¼ˆåªé¡¯ç¤ºæœƒåŸ·è¡Œçš„æ“ä½œï¼‰
python3 manage.py allocate_completed_workorder_quantities --dry-run

# ç‚ºæŒ‡å®šå·¥å–®åŸ·è¡Œåˆ†é…
python3 manage.py allocate_completed_workorder_quantities --workorder WO001

# ç‚ºæ‰€æœ‰å¾…åˆ†é…å·¥å–®åŸ·è¡Œåˆ†é…
python3 manage.py allocate_completed_workorder_quantities
```

### 2. å®šæ™‚ä»»å‹™ç®¡ç†

```bash
# å‰µå»ºå®šæ™‚ä»»å‹™ï¼ˆ60åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼‰
python3 manage.py setup_completed_workorder_allocation_task --create --interval 60

# å•Ÿç”¨å®šæ™‚ä»»å‹™
python3 manage.py setup_completed_workorder_allocation_task --enable

# åœç”¨å®šæ™‚ä»»å‹™
python3 manage.py setup_completed_workorder_allocation_task --disable

# åˆªé™¤å®šæ™‚ä»»å‹™
python3 manage.py setup_completed_workorder_allocation_task --delete
```

### 3. ç¶²é ä»‹é¢

åœ¨å·²å®Œå·¥å·¥å–®è©³æƒ…é é¢ä¸­ï¼Œå¡«å ±è¨˜éŒ„è¡¨æ ¼æœƒé¡¯ç¤ºåˆ†é…æ¨™è¨˜ï¼š
- **ç³»çµ±åˆ†é…**ï¼šè—è‰²å¾½ç« ï¼Œé¡¯ç¤º "ç³»çµ±åˆ†é…"
- **æ‰‹å‹•å¡«å¯«**ï¼šç°è‰²å¾½ç« ï¼Œé¡¯ç¤º "æ‰‹å‹•å¡«å¯«"

## ğŸ” ç›£æ§èˆ‡çµ±è¨ˆ

### 1. åˆ†é…æ‘˜è¦

```python
summary = service.get_allocation_summary(workorder_number)
# è¿”å›ï¼š
{
    'workorder_number': 'WO001',
    'planned_quantity': 1000,
    'total_reports': 15,
    'total_quantity': 1000,
    'total_system_allocated': 500,
    'total_manual_quantity': 500,
    'total_zero_quantity_reports': 3,
    'processes': {...}
}
```

### 2. å¾…åˆ†é…å·¥å–®åˆ—è¡¨

```python
pending_workorders = service.get_pending_allocation_workorders()
# è¿”å›éœ€è¦åˆ†é…çš„å·¥å–®åˆ—è¡¨
```

## âš™ï¸ è¨­å®šç®¡ç†

åœ¨ `AutoAllocationSettings` æ¨¡å‹ä¸­æ–°å¢è¨­å®šï¼š

- `completed_workorder_allocation_enabled`: æ˜¯å¦å•Ÿç”¨å·²å®Œå·¥å·¥å–®æ•¸é‡åˆ†é…
- `completed_workorder_allocation_interval`: åŸ·è¡Œé »ç‡ï¼ˆåˆ†é˜ï¼‰

## ğŸ¯ åŠŸèƒ½ç‰¹é»

1. **æ™ºèƒ½åˆ†é…**ï¼šæ ¹æ“šå·¥åºåç¨±åˆ†çµ„ï¼Œæ¯ç­†ç´€éŒ„ç¨ç«‹è¨ˆç®—
2. **å…¬å¹³åˆ†é…**ï¼šå‰©é¤˜æ•¸é‡å¹³å‡åˆ†é…ï¼Œé¤˜æ•¸å„ªå…ˆçµ¦å‰é¢çš„ç´€éŒ„
3. **æ¨™è¨˜ç³»çµ±**ï¼šæ¸…æ¥šæ¨™ç¤ºç³»çµ±åˆ†é…èˆ‡æ‰‹å‹•å¡«å¯«çš„æ•¸é‡
4. **æ‰¹é‡è™•ç†**ï¼šæ”¯æ´æ‰¹é‡è™•ç†æ‰€æœ‰å¾…åˆ†é…å·¥å–®
5. **å®šæ™‚åŸ·è¡Œ**ï¼šå¯è¨­å®šå®šæ™‚ä»»å‹™è‡ªå‹•åŸ·è¡Œ
6. **å®‰å…¨æ©Ÿåˆ¶**ï¼šæ”¯æ´ä¹¾è·‘æ¨¡å¼ï¼Œé¿å…æ„å¤–æ“ä½œ
7. **è©³ç´°çµ±è¨ˆ**ï¼šæä¾›å®Œæ•´çš„åˆ†é…çµ±è¨ˆè³‡è¨Š

## ğŸ”’ å®‰å…¨è€ƒé‡

1. **äº‹å‹™è™•ç†**ï¼šæ‰€æœ‰åˆ†é…æ“ä½œéƒ½åœ¨è³‡æ–™åº«äº‹å‹™ä¸­åŸ·è¡Œ
2. **éŒ¯èª¤è™•ç†**ï¼šå®Œæ•´çš„ç•°å¸¸è™•ç†å’Œæ—¥èªŒè¨˜éŒ„
3. **è³‡æ–™é©—è­‰**ï¼šç¢ºä¿åˆ†é…æ•¸é‡ä¸è¶…éå·¥å–®ç¸½æ•¸é‡
4. **æ¬Šé™æ§åˆ¶**ï¼šåªæœ‰æˆæ¬Šç”¨æˆ¶å¯ä»¥åŸ·è¡Œåˆ†é…æ“ä½œ

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–

1. **æ‰¹é‡è™•ç†**ï¼šä¸€æ¬¡è™•ç†å¤šå€‹å·¥å–®ï¼Œæé«˜æ•ˆç‡
2. **ç´¢å¼•å„ªåŒ–**ï¼šåœ¨ç›¸é—œæ¬„ä½ä¸Šå»ºç«‹è³‡æ–™åº«ç´¢å¼•
3. **è¨˜æ†¶é«”ç®¡ç†**ï¼šåˆ†æ‰¹è™•ç†å¤§é‡è³‡æ–™ï¼Œé¿å…è¨˜æ†¶é«”æº¢å‡º
4. **éåŒæ­¥åŸ·è¡Œ**ï¼šæ”¯æ´ Celery éåŒæ­¥ä»»å‹™åŸ·è¡Œ

é€™å€‹åŠŸèƒ½å·²ç¶“å®Œå…¨æŒ‰ç…§æ‚¨çš„éœ€æ±‚å¯¦ç¾ï¼Œå¯ä»¥è‡ªå‹•ç‚ºå·²å®Œå·¥å·¥å–®çš„å·¥åºç´€éŒ„åˆ†é…æ•¸é‡ï¼Œä¸¦åœ¨ç¶²é ä»‹é¢ä¸­æ¸…æ¥šé¡¯ç¤ºåˆ†é…æ¨™è¨˜ã€‚ 