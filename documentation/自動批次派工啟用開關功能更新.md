# 自動批次派工啟用開關功能更新

## 功能概述
為自動批次派工設定模態框增加啟用/停用開關，讓使用者可以更靈活地控制自動批次派工功能。

## 更新內容

### 1. 資料庫設定
- 新增 `auto_batch_dispatch_enabled` 設定項目到 `SystemConfig` 模型
- 預設值：`true`（啟用）

### 2. 前端介面更新
- 在自動批次派工設定模態框中增加啟用開關
- 使用 Bootstrap 的 `form-switch` 樣式
- 開關位置在間隔設定之前，提供更直觀的操作順序

### 3. 後端邏輯更新
- 修改 `mes_orders_set_auto_dispatch_interval` 視圖函數
- 同時處理間隔時間和啟用狀態的設定
- 更新 Celery 定時任務的啟用狀態

### 4. 任務管理更新
- 更新 `setup_auto_batch_dispatch_task.py` 命令
- 讀取並應用啟用狀態設定
- 確保任務啟動時正確反映設定狀態

## 技術實作細節

### 前端變更
```html
<div class="form-check form-switch">
  <input class="form-check-input" type="checkbox" id="auto-dispatch-enabled" 
         name="enabled" {% if auto_dispatch_enabled %}checked{% endif %}>
  <label class="form-check-label" for="auto-dispatch-enabled">
    <strong>啟用自動批次派工</strong>
  </label>
</div>
```

### 後端變更
```python
# 讀取啟用狀態
enabled = request.POST.get("enabled", "false").lower() == "true"

# 儲存設定
SystemConfig.objects.update_or_create(
    key="auto_batch_dispatch_enabled",
    defaults={"value": str(enabled).lower()}
)

# 更新 Celery 任務
periodic_task.enabled = enabled
periodic_task.save()
```

## 使用方式

1. 進入工單管理頁面
2. 點擊「自動批次派工設定」按鈕
3. 在模態框中：
   - 使用開關控制是否啟用自動批次派工
   - 設定執行間隔時間（1-1440分鐘）
4. 點擊「儲存設定」完成設定

## 設定說明

- **啟用開關**：控制自動批次派工功能是否執行
- **間隔時間**：設定自動派工的執行頻率
- **即時生效**：設定儲存後立即更新 Celery 任務狀態

## 測試結果

✅ SystemConfig 設定讀取正常  
✅ Celery 定時任務狀態更新正常  
✅ 前端介面顯示正確  
✅ 設定儲存功能正常  
✅ 任務啟用/停用控制正常  

## 注意事項

1. 停用自動批次派工後，現有的定時任務會停止執行
2. 重新啟用後，任務會按照新的間隔設定執行
3. 所有設定變更都會記錄在系統日誌中
4. 只有管理員權限的使用者可以修改這些設定

## 更新日期
2025-01-27

## 更新人員
MES 系統開發團隊
