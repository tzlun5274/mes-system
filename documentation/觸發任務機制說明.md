# 觸發任務機制說明

## 功能概述
MES 系統中有一個完整的觸發任務流程，它不是定時任務，而是在特定條件滿足時自動觸發。這個功能現在統一在「智能自動完工與資料轉移」區塊中管理：

**智能自動完工與資料轉移** - 當填報記錄提交時觸發完工檢查，達到條件時自動將工單轉移到已完工模組

## 前端介面整合
這個觸發任務現在統一在工單設定頁面的「智能自動完工與資料轉移」區塊中管理，使用單一開關控制整個流程，提供更簡潔的介面組織和更好的使用者體驗。

## 1. 智能自動完工與資料轉移觸發機制

### 觸發條件
- 填報記錄的核准狀態變為「已核准」
- 工序為「出貨包裝」
- 智能自動完工功能已啟用

### 觸發流程
```
填報記錄提交 → 檢查核准狀態 → 檢查工序類型 → 檢查功能啟用狀態 → 觸發完工檢查 → 工單狀態變為已完工 → 自動觸發資料轉移
```

### 實作位置
- **智能自動完工信號處理器**：`workorder/fill_work/signals.py`
- **資料轉移信號處理器**：`workorder/signals/data_transfer_signals.py`
- **完工檢查服務**：`workorder/services/completion_service.py`
- **觸發函數**：`auto_check_completion_on_fillwork_submit` 和 `trigger_data_transfer_on_completion`

### 程式碼範例
```python
# 智能自動完工觸發
@receiver(post_save, sender=FillWork)
def fill_work_post_save(sender, instance, created, **kwargs):
    # 檢查是否為出貨包裝工序且已核准
    if (instance.approval_status == 'approved' and 
        instance.operation == "出貨包裝"):
        
        # 檢查智能自動完工功能是否啟用
        auto_completion_config = SystemConfig.objects.filter(
            key="auto_completion_enabled"
        ).first()
        auto_completion_enabled = auto_completion_config and auto_completion_config.value == "True"
        
        if auto_completion_enabled:
            # 觸發智能自動完工檢查
            result = FillWorkCompletionService.auto_check_completion_on_fillwork_submit(instance)

# 資料轉移觸發
@receiver(post_save, sender=WorkOrder)
def trigger_data_transfer_on_completion(sender, instance, created, **kwargs):
    # 檢查工單狀態是否為「已完工」
    if instance.status == 'completed':
        # 檢查智能自動完工功能是否啟用（使用同一個開關）
        auto_completion_config = SystemConfig.objects.get(key="auto_completion_enabled")
        transfer_enabled = auto_completion_config.value.lower() == 'true'
        
        if transfer_enabled:
            # 延遲執行資料轉移
            auto_data_transfer_task.delay()
```

## 2. 系統設定整合

### 智能自動完工與資料轉移設定
- **設定鍵**：`auto_completion_enabled`
- **預設值**：`True` (啟用)
- **控制位置**：工單設定頁面
- **說明**：統一控制智能自動完工和資料轉移功能

### 批次處理設定
- **設定鍵**：`transfer_batch_size`
- **預設值**：`50` (個工單)
- **用途**：控制每次轉移的工單數量

### 資料保留設定
- **設定鍵**：`transfer_retention_days`
- **預設值**：`90` (天)
- **用途**：已轉移工單在主表的保留天數

## 3. 觸發任務 vs 定時任務

### 觸發任務特點
- **即時性**：條件滿足時立即觸發
- **精確性**：只在特定事件發生時執行
- **效率性**：避免不必要的重複檢查
- **響應性**：提供即時的反饋和處理

### 定時任務特點
- **定期性**：按固定時間間隔執行
- **全面性**：檢查所有相關資料
- **備援性**：作為觸發任務的備援機制
- **清理性**：定期清理和維護系統

## 5. 完整的工單生命週期

```
工單建立 → 生產中 → 填報記錄提交 → 智能自動完工檢查 → 工單狀態變為已完工 → 資料轉移觸發 → 轉移到已完工模組
```

### 詳細流程
1. **工單建立**：工單狀態為「待生產」
2. **開始生產**：工單狀態變為「生產中」
3. **填報記錄**：作業員提交填報記錄
4. **智能檢查**：系統自動檢查完工條件
5. **狀態變更**：工單狀態變為「已完工」
6. **資料轉移**：自動觸發資料轉移功能
7. **完成轉移**：工單資料轉移到已完工模組

## 6. 錯誤處理與日誌

### 日誌記錄
- 所有觸發事件都有詳細的日誌記錄
- 包含觸發條件、執行結果、錯誤訊息
- 便於追蹤和除錯

### 錯誤處理
- 觸發失敗不會影響主要業務流程
- 提供完整的錯誤訊息和堆疊追蹤
- 支援重試機制

### 監控與告警
- 可設定觸發失敗的告警機制
- 提供觸發統計和效能監控
- 支援觸發歷史查詢

## 7. 使用建議

### 啟用建議
- 建議同時啟用智能自動完工和資料轉移功能
- 根據生產環境調整批次處理大小
- 定期檢查觸發任務的執行狀況

### 監控建議
- 定期查看觸發任務的日誌
- 監控觸發任務的執行效能
- 檢查是否有觸發失敗的情況

### 維護建議
- 定期清理過期的觸發記錄
- 更新觸發任務的設定參數
- 備份重要的觸發配置

## 更新日期
2025-01-27

## 更新人員
MES 系統開發團隊
