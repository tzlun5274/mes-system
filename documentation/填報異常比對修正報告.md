# 填報異常比對修正報告

## 📋 問題描述

用戶反映：
- **填報紀錄**: 耀儀科技 331-25815001 PFP-CCTBRY2S1P1-501
- **工單紀錄**: 耀儀科技 331-25815001 PFP-CCTBRY2S1P1-501
- **比對結果**: 顯示異常

## 🔍 問題分析

通過調試發現問題根源：

### 1. 資料狀態
- **填報紀錄**: 公司名稱='耀儀科技'，公司代號=`None`
- **工單紀錄**: 公司代號='10'，產品編號='PFP-CCTBRY2S1P1-501'

### 2. 原始比對邏輯問題
原始的 `check_missing_dispatch` 函數存在兩個問題：
1. **錯誤的比對目標**: 比對的是派工單（WorkOrderDispatch）而不是工單（WorkOrder）
2. **不完整的公司比對**: 當填報紀錄的公司代號為空時，沒有使用公司名稱進行比對

### 3. 比對邏輯缺陷
```python
# 原始邏輯（錯誤）
if fill_work.company_code:
    dispatch_exists = WorkOrderDispatch.objects.filter(...)
else:
    # 只比對工單號碼和產品編號，忽略公司資訊
    dispatch_exists = WorkOrderDispatch.objects.filter(...)
```

## 🔧 修正措施

### 1. 修正比對目標
將比對目標從派工單（WorkOrderDispatch）改為工單（WorkOrder）：
```python
# 修正後
workorder_exists = WorkOrder.objects.filter(...)
```

### 2. 改善公司比對邏輯
實現三層級的公司比對策略：

```python
if fill_work.company_code:
    # 第一優先：使用公司代號比對
    workorder_exists = WorkOrder.objects.filter(
        company_code=fill_work.company_code,
        order_number=fill_work.workorder,
        product_code=fill_work.product_id
    ).exists()
elif fill_work.company_name:
    # 第二優先：使用公司名稱比對
    try:
        company_config = CompanyConfig.objects.get(company_name=fill_work.company_name)
        workorder_exists = WorkOrder.objects.filter(
            company_code=company_config.company_code,
            order_number=fill_work.workorder,
            product_code=fill_work.product_id
        ).exists()
    except CompanyConfig.DoesNotExist:
        # 備用方案：只比對工單號碼和產品編號
        workorder_exists = WorkOrder.objects.filter(...)
else:
    # 最後備用：只比對工單號碼和產品編號
    workorder_exists = WorkOrder.objects.filter(...)
```

### 3. 修正檔案清單
- `workorder/services/consistency_check_service.py` - 修正比對邏輯

## 📊 測試結果

### 修正前
```
填報紀錄公司代號: 'None'
工單紀錄公司代號: '10'
公司代號比對: ⚠️ 其中一個為空
綜合判斷: ❌ 有欄位不符，會顯示異常
```

### 修正後
```
使用公司名稱比對...
找到公司配置: 耀儀科技 -> 10
結果: ✅ 找到工單
最終判斷: ✅ 找到對應的工單，不會顯示異常
```

## ✅ 修正確認

1. **測試工單**: 331-25815001 PFP-CCTBRY2S1P1-501 已從異常列表中移除
2. **比對邏輯**: 現在可以正確使用公司名稱進行比對
3. **系統穩定性**: 其他正常的比對功能不受影響

## 📝 總結

此次修正解決了填報異常比對功能中的兩個核心問題：
1. **比對目標錯誤** - 改為比對工單而非派工單
2. **公司比對不完整** - 增加公司名稱比對邏輯

修正後，系統能夠正確識別填報紀錄與工單紀錄的對應關係，避免誤判為異常的情況。

---
**修正時間**: 2025-01-27  
**影響範圍**: 相符性檢查功能  
**測試狀態**: ✅ 通過
