# 作業員補登報工休息時間功能說明

## 功能概述

本功能在作業員補登報工時，自動判斷是否橫跨中午休息時間（12:00-13:00），並自動記錄休息時間相關資訊。

## 功能特點

### 1. 自動判斷休息時間
- **判斷邏輯**：當開始時間在12:00之前且結束時間在13:00之後時，系統自動識別為橫跨中午休息時間
- **固定休息時間**：中午休息時間固定為12:00-13:00，共1小時
- **SMT設備除外**：此功能僅適用於作業員補登報工，SMT設備不適用

### 2. 工時計算修正
- **扣除休息時間**：當有休息時間時，系統會自動從總工時中扣除休息時間
- **實際工時**：資料庫中儲存的工時為實際工作時間，不包含休息時間
- **防止負數**：如果休息時間大於總工時，工時會設為0，不會出現負數

### 3. 資料庫欄位
新增了以下欄位到 `OperatorSupplementReport` 模型：

- `has_break`：是否有休息時間（布林值）
- `break_start_time`：休息開始時間（固定為12:00）
- `break_end_time`：休息結束時間（固定為13:00）
- `break_hours`：休息時數（固定為1.00小時）

### 4. 前端介面
- **自動顯示**：當檢測到橫跨休息時間時，自動顯示休息時間資訊區塊
- **即時更新**：當用戶修改開始時間或結束時間時，即時更新休息時間狀態
- **視覺提示**：使用藍色資訊框顯示休息時間資訊
- **唯讀欄位**：休息時間相關欄位為唯讀，防止用戶手動修改

## 使用方式

### 1. 正常情況（不橫跨休息時間）
```
開始時間：08:00
結束時間：11:00
結果：不顯示休息時間資訊，has_break = False
```

### 2. 橫跨休息時間
```
開始時間：10:00
結束時間：15:00
結果：
- 自動顯示休息時間資訊
- has_break = True
- break_start_time = 12:00
- break_end_time = 13:00
- break_hours = 1.00
- work_hours = 4.00（5小時 - 1小時休息 = 4小時實際工時）
```

## 技術實作

### 1. 後端邏輯
- **表單驗證**：在 `OperatorSupplementReportForm.clean()` 方法中實作休息時間判斷
- **資料保存**：在 `save()` 方法中處理休息時間欄位的保存
- **工時計算**：在模型的 `work_hours` 屬性中自動扣除休息時間，確保資料庫中儲存的是實際工作時間
- **管理介面**：在 Django Admin 中顯示休息時間欄位

### 2. 前端邏輯
- **JavaScript 判斷**：實時檢查時間範圍是否橫跨休息時間
- **動態顯示**：根據判斷結果動態顯示或隱藏休息時間資訊區塊
- **自動填入**：自動填入休息時間相關欄位的值

### 3. 判斷邏輯
```javascript
// 將時間轉換為分鐘數
const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
const endMinutes = parseInt(endTime.split(':')[0]) * 60 + parseInt(endTime.split(':')[1]);

// 中午休息時間：12:00-13:00 (720-780分鐘)
const lunchStartMinutes = 12 * 60; // 12:00
const lunchEndMinutes = 13 * 60;   // 13:00

// 判斷是否橫跨休息時間
const crossesLunch = startMinutes < lunchStartMinutes && endMinutes > lunchEndMinutes;
```

## 前端模板修正

### 問題描述
原本前端模板中休息時間欄位沒有正確顯示，用戶無法看到休息時間資訊。

### 修正內容
1. **新增表單欄位定義**：在 `OperatorSupplementReportForm` 中明確定義休息時間相關欄位
2. **勾選框顯示**：`has_break` 欄位使用勾選框形式顯示，供用戶查看和 JavaScript 控制
3. **唯讀設定**：休息時間欄位設為唯讀，防止用戶手動修改
4. **樣式設定**：為唯讀欄位設定灰色背景，提供視覺提示

### 修正後的欄位
```python
# 休息時間相關欄位
has_break = forms.BooleanField(
    widget=forms.CheckboxInput(attrs={"class": "form-check-input"})
)
break_start_time = forms.CharField(...)
break_end_time = forms.CharField(...)
break_hours = forms.DecimalField(...)
```

## 測試案例

### 通過的測試案例
1. **10:00-15:00**：✅ 橫跨休息時間
2. **08:00-11:00**：❌ 不橫跨休息時間
3. **13:30-17:00**：❌ 不橫跨休息時間
4. **11:30-13:30**：✅ 橫跨休息時間
5. **12:00-13:00**：❌ 不橫跨休息時間（剛好在休息時間內）
6. **11:59-13:01**：✅ 橫跨休息時間

## 注意事項

1. **固定休息時間**：目前休息時間固定為12:00-13:00，如需調整請修改程式碼
2. **僅適用作業員**：此功能僅適用於作業員補登報工，SMT設備不適用
3. **自動判斷**：系統會自動判斷，用戶無需手動設定休息時間
4. **資料完整性**：休息時間資訊會完整保存到資料庫
5. **前端顯示**：休息時間資訊會在前端即時顯示，提供良好的用戶體驗

## 未來擴展

1. **可配置休息時間**：可考慮將休息時間設定為可配置的參數
2. **多段休息時間**：可考慮支援多段休息時間的設定
3. **不同班次**：可考慮支援不同班次的休息時間設定
4. **統計報表**：可考慮在報表中加入休息時間的統計資訊 