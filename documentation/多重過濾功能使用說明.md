# 多重過濾功能使用說明

## 概述

多重過濾功能結合了原本的SMT/作業員過濾和使用者權限過濾，提供更精細的權限控制。系統會先根據表單類型進行SMT/作業員過濾，再根據使用者權限進行進一步過濾。

## 功能特點

### 1. **雙重過濾機制**
- **第一層過濾**：根據表單類型（SMT/作業員）進行基本過濾
- **第二層過濾**：根據使用者權限進行進一步過濾

### 2. **向後相容性**
- 保留原本的SMT/作業員過濾功能
- 如果使用者沒有權限設定，會顯示所有符合表單類型的選項

### 3. **靈活配置**
- 可以為不同使用者設定不同的作業員和工序權限
- 支援填報報工和現場報工兩種權限類型

## 實作架構

### 1. **服務層** (`workorder/fill_work/services.py`)

```python
class MultiFilterService:
    """多重過濾服務"""
    
    @staticmethod
    def get_multi_filtered_process_queryset(user, form_type='operator', permission_type='both'):
        """多重過濾工序查詢集"""
        
    @staticmethod
    def get_multi_filtered_equipment_queryset(user, form_type='operator', permission_type='both'):
        """多重過濾設備查詢集"""
        
    @staticmethod
    def get_multi_filtered_operator_queryset(user, form_type='operator', permission_type='both'):
        """多重過濾作業員查詢集"""
        
    @staticmethod
    def get_multi_filtered_choices(user, form_type='operator', permission_type='both'):
        """獲取多重過濾後的選項列表"""
```

### 2. **表單層** (`workorder/fill_work/views.py`)

表單會自動使用多重過濾服務：

```python
def __init__(self, *args, **kwargs):
    self.user = kwargs.pop('user', None)
    super().__init__(*args, **kwargs)
    
    # 使用多重過濾服務
    filtered_choices = MultiFilterService.get_multi_filtered_choices(
        user=self.user,
        form_type='operator',  # 或 'smt'
        permission_type='both'
    )
    
    # 設定過濾後的選項
    self.fields['process'].queryset = MultiFilterService.get_multi_filtered_process_queryset(...)
    self.fields['operator'].choices = filtered_choices['operators']
    self.fields['equipment'].choices = filtered_choices['equipments']
```

### 3. **視圖層**

視圖會傳遞使用者參數給表單：

```python
def get_form_kwargs(self):
    """傳遞用戶參數給表單"""
    kwargs = super().get_form_kwargs()
    kwargs['user'] = self.request.user
    return kwargs
```

## 過濾邏輯

### 1. **作業員過濾**

| 表單類型 | 第一層過濾 | 第二層過濾 |
|---------|-----------|-----------|
| **作業員表單** | 排除SMT相關作業員 | 根據使用者權限過濾 |
| **SMT表單** | 顯示所有作業員 | 根據使用者權限過濾 |

### 2. **工序過濾**

| 表單類型 | 第一層過濾 | 第二層過濾 |
|---------|-----------|-----------|
| **作業員表單** | 排除SMT相關工序 | 根據使用者權限過濾 |
| **SMT表單** | 只顯示SMT相關工序 | 根據使用者權限過濾 |

### 3. **設備過濾**

| 表單類型 | 第一層過濾 | 第二層過濾 |
|---------|-----------|-----------|
| **作業員表單** | 排除SMT相關設備 | 根據使用者權限過濾 |
| **SMT表單** | 只顯示SMT相關設備 | 根據使用者權限過濾 |

## 使用者權限設定

### 1. **權限模型** (`system/models.py`)

```python
class UserWorkPermission(models.Model):
    """使用者工作權限模型"""
    
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    operator_codes = models.TextField(help_text="可操作的作業員編號，多個用逗號分隔")
    process_names = models.TextField(help_text="可操作的工序名稱，多個用逗號分隔")
    permission_type = models.CharField(choices=PERMISSION_TYPES, default='both')
    is_active = models.BooleanField(default=True)
```

### 2. **權限類型**

- `fill_work`：只能進行填報報工
- `onsite_reporting`：只能進行現場報工
- `both`：可以進行填報報工和現場報工

### 3. **權限檢查**

```python
# 檢查使用者是否有權限操作特定作業員
permission.can_operate_operator(operator_code)

# 檢查使用者是否有權限操作特定工序
permission.can_operate_process(process_name)

# 檢查使用者是否可以進行填報報工
permission.can_fill_work()

# 檢查使用者是否可以進行現場報工
permission.can_onsite_reporting()
```

## 使用方式

### 1. **管理員設定權限**

1. 進入系統管理 → 使用者工作權限
2. 為使用者設定可操作的作業員和工序
3. 選擇權限類型（填報報工/現場報工/兩者）
4. 啟用權限設定

### 2. **使用者使用**

使用者登入後，系統會自動根據權限設定過濾選項：

- **有權限設定**：只顯示權限內的選項
- **無權限設定**：顯示所有符合表單類型的選項

### 3. **權限檢查**

系統會在以下時機進行權限檢查：

- 表單載入時：過濾下拉選單選項
- 表單提交時：驗證使用者權限
- 資料查詢時：過濾查詢結果

## 擴展功能

### 1. **設備權限**

目前系統沒有設備權限功能，可以擴展：

```python
# 在 UserWorkPermission 模型中新增
equipment_names = models.TextField(help_text="可操作的設備名稱，多個用逗號分隔")

# 在 MultiFilterService 中新增
def get_user_allowed_equipments(user, permission_type='both'):
    """獲取使用者可以操作的設備列表"""
```

### 2. **時間權限**

可以擴展時間權限功能：

```python
# 在 UserWorkPermission 模型中新增
allowed_time_ranges = models.JSONField(help_text="允許操作的時間範圍")
```

### 3. **部門權限**

可以擴展部門權限功能：

```python
# 在 UserWorkPermission 模型中新增
allowed_departments = models.ManyToManyField(Department, help_text="允許操作的部門")
```

## 注意事項

### 1. **向後相容性**

- 系統會自動處理沒有權限設定的使用者
- 原本的SMT/作業員過濾功能仍然有效

### 2. **效能考量**

- 多重過濾會增加資料庫查詢次數
- 建議在適當的地方加入快取機制

### 3. **錯誤處理**

- 系統會自動處理權限檢查失敗的情況
- 異常時會回退到基本的SMT/作業員過濾

### 4. **日誌記錄**

- 建議記錄權限檢查的結果
- 便於追蹤和除錯

## 測試建議

### 1. **功能測試**

- 測試不同權限設定的使用者
- 測試無權限設定的使用者
- 測試權限變更後的效果

### 2. **效能測試**

- 測試大量使用者同時使用的情況
- 測試大量資料時的查詢效能

### 3. **安全性測試**

- 測試權限繞過的情況
- 測試權限提升的情況

## 總結

多重過濾功能提供了更精細的權限控制，同時保持了系統的靈活性和向後相容性。透過結合原本的SMT/作業員過濾和使用者權限過濾，可以為不同使用者提供客製化的操作介面，提高系統的安全性和易用性。 