# MES 系統部署說明

## 📋 **三層部署架構**

本系統採用三層部署架構，確保環境和專案的一致性和可維護性：

### 1. **`deploy.sh` - 環境部署腳本**
- **用途**：建立基礎環境（系統、資料庫、服務）
- **執行時機**：首次部署或環境重建時
- **包含內容**：
  - 系統環境準備（Python、PostgreSQL、Redis、Nginx）
  - 系統用戶和群組建立
  - 服務配置（Gunicorn、Celery、Nginx）
  - 日誌輪轉配置
  - 建立專案目錄和基礎檔案（.env、requirements.txt）

### 2. **`deploy_production.sh` - 專案部署腳本**
- **用途**：部署 MES 專案到已建立的環境
- **執行時機**：環境建立後，部署專案時
- **包含內容**：
  - 專案檔案複製
  - Python 依賴安裝
  - 遷移依賴修復（自動處理遷移衝突）
  - 資料庫遷移（含錯誤處理機制）
  - 靜態檔案收集
  - 服務啟動

### 3. **`update.sh` - 專案更新腳本**
- **用途**：更新現有專案的程式碼和資料庫
- **執行時機**：日常的專案更新和維護
- **包含內容**：
  - 備份現有專案
  - 更新專案檔案
  - 遷移依賴修復（自動處理遷移衝突）
  - 資料庫遷移（含錯誤處理機制）
  - 服務重啟

## 🚀 **部署流程**

### 首次部署（新環境）
```bash
# 1. 建立基礎環境
sudo ./deploy.sh

# 2. 檢查並配置 .env 檔案
sudo nano /var/www/mes/.env

# 3. 部署專案
sudo ./deploy_production.sh
```

### 日常更新
```bash
# 更新專案
sudo ./update.sh
```

## 📁 **檔案結構**

```
/var/www/mes/                    # 專案目錄
├── mes_config/                  # Django 設定
├── static/                      # 靜態檔案
├── media/                       # 媒體檔案
├── requirements.txt             # Python 依賴
├── manage.py                    # Django 管理
└── .env                         # 環境變數

/var/log/mes/                    # 日誌目錄
├── deploy.log                   # 部署日誌
├── gunicorn.accesslog.log       # Gunicorn 訪問日誌
├── gunicorn.errorlog.log        # Gunicorn 錯誤日誌
├── celery.log                   # Celery 日誌
└── celery-beat.log              # Celery Beat 日誌

/var/backups/mes/                # 備份目錄
└── mes_backup_YYYYMMDD_HHMMSS.tar.gz  # 專案備份
```

## 🔧 **服務管理**

### 服務名稱
- **Django 服務**：`mes.service`
- **Celery 服務**：`mes-celery.service`
- **Celery Beat 服務**：`celery-beat.service`

### 常用命令
```bash
# 查看服務狀態
sudo systemctl status mes.service
sudo systemctl status mes-celery.service
sudo systemctl status celery-beat.service

# 重啟服務
sudo systemctl restart mes.service
sudo systemctl restart mes-celery.service
sudo systemctl restart celery-beat.service

# 查看日誌
sudo journalctl -u mes.service -f
sudo journalctl -u mes-celery.service -f
sudo journalctl -u celery-beat.service -f
```

## 🌐 **訪問地址**

- **主網站**：`http://伺服器IP`
- **管理後台**：`http://伺服器IP/admin`
- **預設管理員帳號**：`admin`
- **預設管理員密碼**：`1234`

## ⚠️ **注意事項**

1. **執行順序**：必須先執行 `deploy.sh`，再執行 `deploy_production.sh`
2. **權限要求**：所有腳本都需要 root 權限執行
3. **環境檔案**：`deploy.sh` 會建立基礎 `.env` 檔案，請檢查並配置
4. **備份機制**：更新時會自動備份，可手動回滾
5. **服務依賴**：確保 PostgreSQL、Redis、Nginx 服務正常運行
6. **遷移處理**：系統會自動修復遷移依賴問題，無需手動干預

## 🔧 **遷移修復機制**

### **自動遷移修復**
系統內建遷移修復機制，會自動處理常見的遷移依賴問題：

```bash
# 手動執行遷移修復（通常不需要）
cd /var/www/mes
python3 manage.py fix_migrations
```

### **遷移修復功能**
- **自動檢測**：檢查缺失的初始遷移記錄
- **自動修復**：插入必要的遷移依賴記錄
- **容錯處理**：如果標準遷移失敗，自動嘗試強制遷移
- **詳細日誌**：顯示修復了哪些依賴關係

### **支援的模組**
遷移修復會處理以下模組的初始遷移：
- `production`, `workorder`, `system`
- `fill_work`, `onsite_reporting`, `workorder_dispatch`
- `kanban`, `material`, `process`, `quality`
- `scheduling`, `equip`, `erp_integration`
- `ai`, `reporting`

## 🔄 **故障排除**

### 常見問題

1. **遷移依賴錯誤**
   ```bash
   # 系統會自動修復，如需手動執行：
   cd /var/www/mes
   python3 manage.py fix_migrations --force
   python3 manage.py migrate
   ```

2. **服務無法啟動**
   ```bash
   # 檢查日誌
   sudo journalctl -u mes.service -f
   
   # 檢查端口
   sudo netstat -tlnp | grep :8000
   ```

3. **資料庫連接失敗**
   ```bash
   # 檢查 PostgreSQL 服務
   sudo systemctl status postgresql
   
   # 檢查資料庫連接
   sudo -u postgres psql -l
   ```

4. **Redis 連接失敗**
   ```bash
   # 檢查 Redis 服務
   sudo systemctl status redis-server
   
   # 測試 Redis 連接
   redis-cli ping
   ```

### 回滾操作
```bash
# 停止服務
sudo systemctl stop mes.service

# 恢復備份
sudo tar -xzf /var/backups/mes/mes_backup_YYYYMMDD_HHMMSS.tar.gz -C /var/www/mes

# 重啟服務
sudo systemctl start mes.service
```

## 📞 **支援**

如有問題，請檢查：
1. 部署日誌：`/var/log/mes/deploy.log`
2. 服務日誌：`sudo journalctl -u mes.service`
3. 系統日誌：`sudo journalctl -xe`

## **問題分析**

### **依賴關係錯誤**
- `equip.0001_initial` 已經執行
- 但它依賴的 `production.0001_initial` 還沒有執行
- 這造成了遷移歷史不一致

## **解決方法**

### **方法 1：重置遷移狀態（推薦）**
```bash
cd /var/www/mes

# 1. 標記 equip 模組的遷移為未執行
python3 manage.py migrate equip zero --fake

# 2. 執行所有遷移
python3 manage.py migrate
```

### **方法 2：強制執行依賴遷移**
```bash
<code_block_to_apply_changes_from>
```

### **方法 3：如果上面都失敗，重置整個資料庫**
```bash
cd /var/www/mes

# 1. 刪除所有遷移記錄
python3 manage.py migrate --fake zero

# 2. 重新執行所有遷移
python3 manage.py migrate --fake-initial
```

## **建議步驟**

1. **先嘗試方法 1**
2. **如果失敗，嘗試方法 2**
3. **最後才考慮方法 3**

## **為什麼會這樣**

1. **部署順序問題** - 在 `deploy_production.sh` 中，可能某些模組的遷移先執行了
2. **資料庫狀態不一致** - 測試主機的資料庫狀態與開發環境不同
3. **遷移依賴關係** - Django 的遷移系統檢測到依賴關係被破壞

建議先嘗試方法 1，這是最安全的解決方式。
