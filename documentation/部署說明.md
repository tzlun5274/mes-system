# MES ç³»çµ±éƒ¨ç½²èªªæ˜

## ğŸ“‹ **ä¸‰å±¤éƒ¨ç½²æ¶æ§‹**

æœ¬ç³»çµ±æ¡ç”¨ä¸‰å±¤éƒ¨ç½²æ¶æ§‹ï¼Œç¢ºä¿ç’°å¢ƒå’Œå°ˆæ¡ˆçš„ä¸€è‡´æ€§å’Œå¯ç¶­è­·æ€§ï¼š

### 1. **`deploy.sh` - ç’°å¢ƒéƒ¨ç½²è…³æœ¬**
- **ç”¨é€”**ï¼šå»ºç«‹åŸºç¤ç’°å¢ƒï¼ˆç³»çµ±ã€è³‡æ–™åº«ã€æœå‹™ï¼‰
- **åŸ·è¡Œæ™‚æ©Ÿ**ï¼šé¦–æ¬¡éƒ¨ç½²æˆ–ç’°å¢ƒé‡å»ºæ™‚
- **åŒ…å«å…§å®¹**ï¼š
  - ç³»çµ±ç’°å¢ƒæº–å‚™ï¼ˆPythonã€PostgreSQLã€Redisã€Nginxï¼‰
  - ç³»çµ±ç”¨æˆ¶å’Œç¾¤çµ„å»ºç«‹
  - æœå‹™é…ç½®ï¼ˆGunicornã€Celeryã€Nginxï¼‰
  - æ—¥èªŒè¼ªè½‰é…ç½®
  - å»ºç«‹å°ˆæ¡ˆç›®éŒ„å’ŒåŸºç¤æª”æ¡ˆï¼ˆ.envã€requirements.txtï¼‰

### 2. **`deploy_production.sh` - å°ˆæ¡ˆéƒ¨ç½²è…³æœ¬**
- **ç”¨é€”**ï¼šéƒ¨ç½² MES å°ˆæ¡ˆåˆ°å·²å»ºç«‹çš„ç’°å¢ƒ
- **åŸ·è¡Œæ™‚æ©Ÿ**ï¼šç’°å¢ƒå»ºç«‹å¾Œï¼Œéƒ¨ç½²å°ˆæ¡ˆæ™‚
- **åŒ…å«å…§å®¹**ï¼š
  - å°ˆæ¡ˆæª”æ¡ˆè¤‡è£½
  - Python ä¾è³´å®‰è£
  - é·ç§»ä¾è³´ä¿®å¾©ï¼ˆè‡ªå‹•è™•ç†é·ç§»è¡çªï¼‰
  - è³‡æ–™åº«é·ç§»ï¼ˆå«éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼‰
  - éœæ…‹æª”æ¡ˆæ”¶é›†
  - æœå‹™å•Ÿå‹•

### 3. **`update.sh` - å°ˆæ¡ˆæ›´æ–°è…³æœ¬**
- **ç”¨é€”**ï¼šæ›´æ–°ç¾æœ‰å°ˆæ¡ˆçš„ç¨‹å¼ç¢¼å’Œè³‡æ–™åº«
- **åŸ·è¡Œæ™‚æ©Ÿ**ï¼šæ—¥å¸¸çš„å°ˆæ¡ˆæ›´æ–°å’Œç¶­è­·
- **åŒ…å«å…§å®¹**ï¼š
  - å‚™ä»½ç¾æœ‰å°ˆæ¡ˆ
  - æ›´æ–°å°ˆæ¡ˆæª”æ¡ˆ
  - é·ç§»ä¾è³´ä¿®å¾©ï¼ˆè‡ªå‹•è™•ç†é·ç§»è¡çªï¼‰
  - è³‡æ–™åº«é·ç§»ï¼ˆå«éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼‰
  - æœå‹™é‡å•Ÿ

## ğŸš€ **éƒ¨ç½²æµç¨‹**

### é¦–æ¬¡éƒ¨ç½²ï¼ˆæ–°ç’°å¢ƒï¼‰
```bash
# 1. å»ºç«‹åŸºç¤ç’°å¢ƒ
sudo ./deploy.sh

# 2. æª¢æŸ¥ä¸¦é…ç½® .env æª”æ¡ˆ
sudo nano /var/www/mes/.env

# 3. éƒ¨ç½²å°ˆæ¡ˆ
sudo ./deploy_production.sh
```

### æ—¥å¸¸æ›´æ–°
```bash
# æ›´æ–°å°ˆæ¡ˆ
sudo ./update.sh
```

## ğŸ“ **æª”æ¡ˆçµæ§‹**

```
/var/www/mes/                    # å°ˆæ¡ˆç›®éŒ„
â”œâ”€â”€ mes_config/                  # Django è¨­å®š
â”œâ”€â”€ static/                      # éœæ…‹æª”æ¡ˆ
â”œâ”€â”€ media/                       # åª’é«”æª”æ¡ˆ
â”œâ”€â”€ requirements.txt             # Python ä¾è³´
â”œâ”€â”€ manage.py                    # Django ç®¡ç†
â””â”€â”€ .env                         # ç’°å¢ƒè®Šæ•¸

/var/log/mes/                    # æ—¥èªŒç›®éŒ„
â”œâ”€â”€ deploy.log                   # éƒ¨ç½²æ—¥èªŒ
â”œâ”€â”€ gunicorn.accesslog.log       # Gunicorn è¨ªå•æ—¥èªŒ
â”œâ”€â”€ gunicorn.errorlog.log        # Gunicorn éŒ¯èª¤æ—¥èªŒ
â”œâ”€â”€ celery.log                   # Celery æ—¥èªŒ
â””â”€â”€ celery-beat.log              # Celery Beat æ—¥èªŒ

/var/backups/mes/                # å‚™ä»½ç›®éŒ„
â””â”€â”€ mes_backup_YYYYMMDD_HHMMSS.tar.gz  # å°ˆæ¡ˆå‚™ä»½
```

## ğŸ”§ **æœå‹™ç®¡ç†**

### æœå‹™åç¨±
- **Django æœå‹™**ï¼š`mes.service`
- **Celery æœå‹™**ï¼š`mes-celery.service`
- **Celery Beat æœå‹™**ï¼š`celery-beat.service`

### å¸¸ç”¨å‘½ä»¤
```bash
# æŸ¥çœ‹æœå‹™ç‹€æ…‹
sudo systemctl status mes.service
sudo systemctl status mes-celery.service
sudo systemctl status celery-beat.service

# é‡å•Ÿæœå‹™
sudo systemctl restart mes.service
sudo systemctl restart mes-celery.service
sudo systemctl restart celery-beat.service

# æŸ¥çœ‹æ—¥èªŒ
sudo journalctl -u mes.service -f
sudo journalctl -u mes-celery.service -f
sudo journalctl -u celery-beat.service -f
```

## ğŸŒ **è¨ªå•åœ°å€**

- **ä¸»ç¶²ç«™**ï¼š`http://ä¼ºæœå™¨IP`
- **ç®¡ç†å¾Œå°**ï¼š`http://ä¼ºæœå™¨IP/admin`
- **é è¨­ç®¡ç†å“¡å¸³è™Ÿ**ï¼š`admin`
- **é è¨­ç®¡ç†å“¡å¯†ç¢¼**ï¼š`1234`

## âš ï¸ **æ³¨æ„äº‹é …**

1. **åŸ·è¡Œé †åº**ï¼šå¿…é ˆå…ˆåŸ·è¡Œ `deploy.sh`ï¼Œå†åŸ·è¡Œ `deploy_production.sh`
2. **æ¬Šé™è¦æ±‚**ï¼šæ‰€æœ‰è…³æœ¬éƒ½éœ€è¦ root æ¬Šé™åŸ·è¡Œ
3. **ç’°å¢ƒæª”æ¡ˆ**ï¼š`deploy.sh` æœƒå»ºç«‹åŸºç¤ `.env` æª”æ¡ˆï¼Œè«‹æª¢æŸ¥ä¸¦é…ç½®
4. **å‚™ä»½æ©Ÿåˆ¶**ï¼šæ›´æ–°æ™‚æœƒè‡ªå‹•å‚™ä»½ï¼Œå¯æ‰‹å‹•å›æ»¾
5. **æœå‹™ä¾è³´**ï¼šç¢ºä¿ PostgreSQLã€Redisã€Nginx æœå‹™æ­£å¸¸é‹è¡Œ
6. **é·ç§»è™•ç†**ï¼šç³»çµ±æœƒè‡ªå‹•ä¿®å¾©é·ç§»ä¾è³´å•é¡Œï¼Œç„¡éœ€æ‰‹å‹•å¹²é 

## ğŸ”§ **é·ç§»ä¿®å¾©æ©Ÿåˆ¶**

### **è‡ªå‹•é·ç§»ä¿®å¾©**
ç³»çµ±å…§å»ºé·ç§»ä¿®å¾©æ©Ÿåˆ¶ï¼Œæœƒè‡ªå‹•è™•ç†å¸¸è¦‹çš„é·ç§»ä¾è³´å•é¡Œï¼š

```bash
# æ‰‹å‹•åŸ·è¡Œé·ç§»ä¿®å¾©ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰
cd /var/www/mes
python3 manage.py fix_migrations
```

### **é·ç§»ä¿®å¾©åŠŸèƒ½**
- **è‡ªå‹•æª¢æ¸¬**ï¼šæª¢æŸ¥ç¼ºå¤±çš„åˆå§‹é·ç§»è¨˜éŒ„
- **è‡ªå‹•ä¿®å¾©**ï¼šæ’å…¥å¿…è¦çš„é·ç§»ä¾è³´è¨˜éŒ„
- **å®¹éŒ¯è™•ç†**ï¼šå¦‚æœæ¨™æº–é·ç§»å¤±æ•—ï¼Œè‡ªå‹•å˜—è©¦å¼·åˆ¶é·ç§»
- **è©³ç´°æ—¥èªŒ**ï¼šé¡¯ç¤ºä¿®å¾©äº†å“ªäº›ä¾è³´é—œä¿‚

### **æ”¯æ´çš„æ¨¡çµ„**
é·ç§»ä¿®å¾©æœƒè™•ç†ä»¥ä¸‹æ¨¡çµ„çš„åˆå§‹é·ç§»ï¼š
- `production`, `workorder`, `system`
- `fill_work`, `onsite_reporting`, `workorder_dispatch`
- `kanban`, `material`, `process`, `quality`
- `scheduling`, `equip`, `erp_integration`
- `ai`, `reporting`

## ğŸ”„ **æ•…éšœæ’é™¤**

### å¸¸è¦‹å•é¡Œ

1. **é·ç§»ä¾è³´éŒ¯èª¤**
   ```bash
   # ç³»çµ±æœƒè‡ªå‹•ä¿®å¾©ï¼Œå¦‚éœ€æ‰‹å‹•åŸ·è¡Œï¼š
   cd /var/www/mes
   python3 manage.py fix_migrations --force
   python3 manage.py migrate
   ```

2. **æœå‹™ç„¡æ³•å•Ÿå‹•**
   ```bash
   # æª¢æŸ¥æ—¥èªŒ
   sudo journalctl -u mes.service -f
   
   # æª¢æŸ¥ç«¯å£
   sudo netstat -tlnp | grep :8000
   ```

3. **è³‡æ–™åº«é€£æ¥å¤±æ•—**
   ```bash
   # æª¢æŸ¥ PostgreSQL æœå‹™
   sudo systemctl status postgresql
   
   # æª¢æŸ¥è³‡æ–™åº«é€£æ¥
   sudo -u postgres psql -l
   ```

4. **Redis é€£æ¥å¤±æ•—**
   ```bash
   # æª¢æŸ¥ Redis æœå‹™
   sudo systemctl status redis-server
   
   # æ¸¬è©¦ Redis é€£æ¥
   redis-cli ping
   ```

### å›æ»¾æ“ä½œ
```bash
# åœæ­¢æœå‹™
sudo systemctl stop mes.service

# æ¢å¾©å‚™ä»½
sudo tar -xzf /var/backups/mes/mes_backup_YYYYMMDD_HHMMSS.tar.gz -C /var/www/mes

# é‡å•Ÿæœå‹™
sudo systemctl start mes.service
```

## ğŸ“ **æ”¯æ´**

å¦‚æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. éƒ¨ç½²æ—¥èªŒï¼š`/var/log/mes/deploy.log`
2. æœå‹™æ—¥èªŒï¼š`sudo journalctl -u mes.service`
3. ç³»çµ±æ—¥èªŒï¼š`sudo journalctl -xe`

## **å•é¡Œåˆ†æ**

### **ä¾è³´é—œä¿‚éŒ¯èª¤**
- `equip.0001_initial` å·²ç¶“åŸ·è¡Œ
- ä½†å®ƒä¾è³´çš„ `production.0001_initial` é‚„æ²’æœ‰åŸ·è¡Œ
- é€™é€ æˆäº†é·ç§»æ­·å²ä¸ä¸€è‡´

## **è§£æ±ºæ–¹æ³•**

### **æ–¹æ³• 1ï¼šé‡ç½®é·ç§»ç‹€æ…‹ï¼ˆæ¨è–¦ï¼‰**
```bash
cd /var/www/mes

# 1. æ¨™è¨˜ equip æ¨¡çµ„çš„é·ç§»ç‚ºæœªåŸ·è¡Œ
python3 manage.py migrate equip zero --fake

# 2. åŸ·è¡Œæ‰€æœ‰é·ç§»
python3 manage.py migrate
```

### **æ–¹æ³• 2ï¼šå¼·åˆ¶åŸ·è¡Œä¾è³´é·ç§»**
```bash
<code_block_to_apply_changes_from>
```

### **æ–¹æ³• 3ï¼šå¦‚æœä¸Šé¢éƒ½å¤±æ•—ï¼Œé‡ç½®æ•´å€‹è³‡æ–™åº«**
```bash
cd /var/www/mes

# 1. åˆªé™¤æ‰€æœ‰é·ç§»è¨˜éŒ„
python3 manage.py migrate --fake zero

# 2. é‡æ–°åŸ·è¡Œæ‰€æœ‰é·ç§»
python3 manage.py migrate --fake-initial
```

## **å»ºè­°æ­¥é©Ÿ**

1. **å…ˆå˜—è©¦æ–¹æ³• 1**
2. **å¦‚æœå¤±æ•—ï¼Œå˜—è©¦æ–¹æ³• 2**
3. **æœ€å¾Œæ‰è€ƒæ…®æ–¹æ³• 3**

## **ç‚ºä»€éº¼æœƒé€™æ¨£**

1. **éƒ¨ç½²é †åºå•é¡Œ** - åœ¨ `deploy_production.sh` ä¸­ï¼Œå¯èƒ½æŸäº›æ¨¡çµ„çš„é·ç§»å…ˆåŸ·è¡Œäº†
2. **è³‡æ–™åº«ç‹€æ…‹ä¸ä¸€è‡´** - æ¸¬è©¦ä¸»æ©Ÿçš„è³‡æ–™åº«ç‹€æ…‹èˆ‡é–‹ç™¼ç’°å¢ƒä¸åŒ
3. **é·ç§»ä¾è³´é—œä¿‚** - Django çš„é·ç§»ç³»çµ±æª¢æ¸¬åˆ°ä¾è³´é—œä¿‚è¢«ç ´å£

å»ºè­°å…ˆå˜—è©¦æ–¹æ³• 1ï¼Œé€™æ˜¯æœ€å®‰å…¨çš„è§£æ±ºæ–¹å¼ã€‚
