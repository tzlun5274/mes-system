# 報表清理啟用開關功能更新

## 功能概述
為報表清理設定功能增加啟用/停用開關，讓使用者可以更靈活地控制自動清理功能。

## 更新內容

### 1. 資料庫設定
- 新增 `auto_cleanup_enabled` 設定項目到 `SystemConfig` 模型
- 新增 `report_file_retention_days` 和 `report_log_retention_days` 設定項目
- 預設值：`true`（啟用）

### 2. 前端介面更新
- 在報表清理設定頁面增加啟用開關
- 使用 Bootstrap 的 `form-switch` 樣式
- 開關位置在保留天數設定之前，提供更直觀的操作順序
- 在當前保留設定中顯示啟用狀態

### 3. 後端邏輯更新
- 新增 `report_cleanup_settings` 視圖函數
- 新增 `update_cleanup_settings` 視圖函數
- 新增 `execute_cleanup` 視圖函數
- 同時處理啟用狀態和保留天數的設定

### 4. 任務管理更新
- 新增 `setup_report_cleanup_tasks.py` 管理命令
- 讀取並應用啟用狀態設定
- 確保任務啟動時正確反映設定狀態
- 支援兩個清理任務：
  - 報表檔案清理（每24小時執行）
  - 報表日誌清理（每7天執行）

## 技術實作細節

### 前端變更
```html
<div class="form-check form-switch">
  <input class="form-check-input" type="checkbox" id="auto_cleanup_enabled" 
         name="auto_cleanup_enabled" {% if auto_cleanup_enabled %}checked{% endif %}>
  <label class="form-check-label" for="auto_cleanup_enabled">
    <strong>啟用自動清理功能</strong>
  </label>
</div>
```

### 後端變更
```python
# 讀取啟用狀態
auto_cleanup_enabled = request.POST.get('auto_cleanup_enabled') == 'on'

# 儲存設定
SystemConfig.objects.update_or_create(
    key="auto_cleanup_enabled",
    defaults={"value": str(auto_cleanup_enabled).lower()}
)

# 更新 Celery 任務
periodic_task.enabled = auto_cleanup_enabled
periodic_task.save()
```

### 路由設定
```python
# 報表清理設定
path("report_cleanup_settings/", views.report_cleanup_settings, name="report_cleanup_settings"),
path("update_cleanup_settings/", views.update_cleanup_settings, name="update_cleanup_settings"),
path("execute_cleanup/", views.execute_cleanup, name="execute_cleanup"),
```

## 使用方式

1. 進入系統管理模組
2. 點擊「報表清理設定」
3. 在設定頁面中：
   - 使用開關控制是否啟用自動清理功能
   - 設定報表檔案保留天數（1-365天）
   - 設定執行日誌保留天數（1-365天）
4. 點擊「儲存設定」完成設定

## 設定說明

- **啟用開關**：控制自動清理功能是否執行
- **檔案保留天數**：設定報表檔案自動保留的天數
- **日誌保留天數**：設定報表執行日誌自動保留的天數
- **即時生效**：設定儲存後立即更新 Celery 任務狀態

## 定時任務

系統會自動執行以下任務：
- **報表檔案清理**：每 24 小時執行一次
- **報表日誌清理**：每 7 天執行一次

## 手動操作

除了自動清理外，還支援手動操作：
- 手動清理報表檔案
- 手動清理執行日誌
- 生成清理報告

## 安全考量

1. **權限控制**：只有超級用戶可以訪問清理設定頁面
2. **操作日誌**：所有清理操作都會記錄操作日誌
3. **手動清理**：手動清理操作需要確認
4. **資料保護**：清理前會檢查檔案存在性

## 注意事項

1. 停用自動清理後，現有的定時任務會停止執行
2. 重新啟用後，任務會按照新的設定執行
3. 所有設定變更都會記錄在系統日誌中
4. 只有管理員權限的使用者可以修改這些設定

## 更新日期
2025-01-27

## 更新人員
MES 系統開發團隊
