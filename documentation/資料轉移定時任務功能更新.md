# 資料轉移觸發任務功能更新

## 功能概述
為資料轉移功能建立觸發機制，當工單狀態變為「已完工」時自動觸發資料轉移，讓已完工工單能夠自動轉移到已完工模組，並支援批次處理和啟用開關控制。

## 更新內容

### 1. 觸發信號建立
- **檔案**：`workorder/signals/data_transfer_signals.py`
- **新增**：`trigger_data_transfer_on_completion` 信號處理器
- **功能**：當工單狀態變為「已完工」時自動觸發資料轉移

### 2. 現有函數增強
- **檔案**：`workorder/services/completion_service.py`
- **修改**：`transfer_completed_workorders` 函數
- **增強**：支援批次大小參數，可限制每次處理的工單數量

### 3. 應用程式整合
- **檔案**：`workorder/apps.py`
- **修改**：註冊資料轉移信號處理器
- **功能**：在應用程式啟動時自動註冊觸發信號

## 技術實作細節

### 觸發信號處理器
```python
@receiver(post_save, sender=WorkOrder)
def trigger_data_transfer_on_completion(sender, instance, created, **kwargs):
    """
    當工單狀態變為「已完工」時，自動觸發資料轉移功能
    """
    # 檢查工單狀態是否為「已完工」
    # 檢查資料轉移功能是否啟用
    # 檢查是否已經轉移過
    # 延遲執行資料轉移
```

### 批次處理支援
```python
def transfer_completed_workorders(cls, batch_size=None):
    """
    資料轉移程式：支援批次處理
    Args:
        batch_size (int, optional): 批次處理大小
    """
    # 如果指定了批次大小，則限制處理數量
    if batch_size:
        completed_workorders = completed_workorders[:batch_size]
```

### 系統設定整合
- `data_transfer_enabled`：資料轉移功能啟用狀態
- `transfer_batch_size`：批次轉移數量（預設 50）
- `transfer_retention_days`：資料保留天數（預設 90）
- `data_transfer_task_enabled`：定時任務啟用狀態
- `data_transfer_task_interval`：定時任務執行間隔（預設 60 分鐘）

## 功能特色

### 1. 觸發式執行
- 當工單狀態變為「已完工」時自動觸發資料轉移
- 支援啟用/停用開關控制
- 即時響應，無需等待定時任務

### 2. 批次處理
- 支援批次大小設定，避免一次處理過多工單
- 預設批次大小：50 個工單
- 可根據系統效能調整批次大小

### 3. 智能控制
- 檢查資料轉移功能是否啟用
- 跳過已存在的工單，避免重複轉移
- 完整的錯誤處理和日誌記錄

### 4. 系統整合
- 與現有的工單設定頁面整合
- 支援在工單管理設定中控制觸發功能
- 與 Django 信號系統完全整合

## 使用方式

### 1. 設定資料轉移參數
1. 進入系統管理首頁
2. 點擊「工單設定」
3. 在「資料轉移功能」區塊中設定：
   - 啟用/停用資料轉移功能
   - 設定批次轉移數量
   - 設定資料保留天數

### 2. 設定觸發功能
- 觸發功能會根據資料轉移功能的啟用狀態自動控制
- 可在工單設定頁面中調整批次大小和保留天數
- 支援即時啟用/停用觸發功能

### 3. 手動執行
- 支援手動執行資料轉移
- 可在已完工工單管理頁面中手動觸發
- 提供批次轉移功能

## 觸發任務狀態

目前系統中有 **2 個觸發任務**：

### ✅ 已建立的觸發任務
1. **智能自動完工** - 當填報記錄提交時觸發完工檢查
2. **資料轉移功能** - 當工單狀態變為「已完工」時觸發資料轉移

### 📋 定時任務狀態

目前系統中總共有 **8 個定時任務**：

### ✅ 啟用的任務 (2個)
1. **auto-backup-database-task** - 自動資料庫備份
2. **celery.backend_cleanup** - Celery 後端清理任務

### ❌ 停用的任務 (6個)
1. **報表日誌清理** - 報表日誌清理任務
2. **報表檔案清理** - 報表檔案清理任務
3. **自動分配任務** - 自動分配任務
4. **自動同步公司製造命令** - 自動同步公司製造命令
5. **自動批次派工** - 自動批次派工
6. **自動轉換MES工單** - 自動轉換MES工單

## 注意事項

1. **功能依賴**：資料轉移觸發任務依賴於資料轉移功能的啟用狀態
2. **批次處理**：建議根據系統效能調整批次大小，避免一次處理過多工單
3. **錯誤處理**：所有轉移操作都有完整的錯誤處理和日誌記錄
4. **資料完整性**：轉移過程中會檢查工單是否已存在，避免重複轉移

## 更新日期
2025-01-27

## 更新人員
MES 系統開發團隊
