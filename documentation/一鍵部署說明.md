# MES 系統一鍵部署說明

## 🚀 一鍵部署（只需一個腳本）

### 前置需求
- Ubuntu 20.04 LTS 或更新版本
- 至少 4GB 記憶體
- 至少 10GB 硬碟空間
- 網路連線

### 部署步驟

#### 1. 下載專案
```bash
git clone <your-repo-url>
cd mes
```

#### 2. 修改配置（必須）
```bash
nano .env

# 必須修改的項目：
ALLOWED_HOSTS=localhost,127.0.0.1,YOUR_SERVER_IP
HOST_IP=YOUR_SERVER_IP
DATABASE_PASSWORD=YOUR_SECURE_PASSWORD
REDIS_PASSWORD=YOUR_REDIS_PASSWORD
SUPERUSER_PASSWORD=YOUR_ADMIN_PASSWORD
```

#### 3. 執行一鍵部署
```bash
sudo ./全新部署.sh
```

#### 4. 驗證部署
```bash
# 檢查服務狀態
sudo systemctl status mes.service

# 測試網站
curl http://localhost
```

## ✅ 部署腳本特點

### 自動修復功能
- **自動修復遷移問題**: 無需手動執行任何修補程式
- **自動檢測主機 IP**: 自動配置網路設定
- **自動建立服務**: 建立所有必要的系統服務
- **自動配置資料庫**: 建立資料庫和使用者
- **自動配置 Redis**: 設定快取系統
- **自動收集靜態檔案**: 配置網頁資源

### 完整功能
- 安裝所有系統套件
- 建立系統用戶和權限
- 配置 PostgreSQL 資料庫
- 配置 Redis 快取
- 配置 Nginx 網頁伺服器
- 建立 Gunicorn 應用服務
- 建立 Celery 背景任務服務
- 自動修復所有遷移問題
- 建立管理員帳號
- 詳細的部署日誌

## 🔧 部署後管理

### 服務管理
```bash
# 查看所有服務狀態
sudo systemctl status mes.service mes-celery.service celery-beat.service nginx

# 重啟服務
sudo systemctl restart mes.service

# 查看日誌
sudo journalctl -u mes.service -f
```

### 備份
```bash
# 資料庫備份
sudo -u postgres pg_dump mes_db > backup.sql

# 檔案備份
sudo tar -czf mes_backup.tar.gz /var/www/mes
```

### 更新
```bash
# 停止服務
sudo systemctl stop mes.service mes-celery.service celery-beat.service

# 更新程式碼
cd /var/www/mes
sudo -u mes git pull

# 更新依賴
sudo pip3 install -r requirements.txt

# 重新啟動服務
sudo systemctl start mes.service mes-celery.service celery-beat.service
```

## 🌐 訪問地址

部署完成後，您可以通過以下地址訪問：

- **主網站**: http://YOUR_SERVER_IP
- **管理後台**: http://YOUR_SERVER_IP/admin
- **API 文檔**: http://YOUR_SERVER_IP/api/

## 🚨 故障排除

### 常見問題

#### 1. 服務無法啟動
```bash
# 檢查日誌
sudo journalctl -u mes.service -f

# 檢查配置
cd /var/www/mes
python3 manage.py check
```

#### 2. 網站無法訪問
```bash
# 檢查服務狀態
sudo systemctl status mes.service nginx

# 重新啟動服務
sudo systemctl restart mes.service nginx
```

#### 3. 資料庫連線問題
```bash
# 測試資料庫連線
sudo -u mes psql -h localhost -U mes_user -d mes_db

# 檢查 PostgreSQL 狀態
sudo systemctl status postgresql
```

## 📊 系統監控

### 日誌位置
- **應用程式日誌**: `/var/log/mes/`
- **Nginx 日誌**: `/var/log/nginx/`
- **PostgreSQL 日誌**: `/var/log/postgresql/`
- **Redis 日誌**: `/var/log/redis/`
- **部署日誌**: `/var/log/mes/deploy.log`

### 系統檢查
```bash
# 檢查磁碟空間
df -h

# 檢查記憶體使用
free -h

# 檢查端口
sudo netstat -tlnp | grep -E ':(80|8000|6379|5432)'
```

---

## ⚡ 快速命令

```bash
# 一鍵部署
sudo ./全新部署.sh

# 檢查狀態
sudo systemctl status mes.service

# 重啟服務
sudo systemctl restart mes.service

# 查看日誌
sudo journalctl -u mes.service -f

# 備份資料庫
sudo -u postgres pg_dump mes_db > backup.sql
```

---

**重要提醒**: 
1. 部署前務必修改 `.env` 檔案中的密碼和 IP 地址
2. 全新部署腳本會自動修復所有問題，無需手動執行任何修補程式
3. 定期備份資料庫和檔案
4. 監控系統資源使用情況
