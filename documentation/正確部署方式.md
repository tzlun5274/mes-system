# 🚨 正確的 MES 系統部署方式

## ⚠️ 重要提醒
測試主機等同於正式主機，必須使用系統服務部署，避免重開機後系統消失！

## 🛠️ 正確的部署步驟

### 1. 複製檔案到測試主機
使用 WinSCP 複製必要檔案到：`/var/www/mes_test/`

### 2. 建立系統服務檔案

#### 建立 Django 服務檔案
```bash
# 在測試主機上建立服務檔案
sudo nano /etc/systemd/system/mes-test.service
```

服務檔案內容：
```ini
[Unit]
Description=MES Test Server
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=mes
Group=mes
WorkingDirectory=/var/www/mes_test
Environment=DJANGO_SETTINGS_MODULE=mes_config.settings_test
ExecStart=/usr/bin/python3 manage.py runserver 0.0.0.0:8001
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 建立 Celery 服務檔案
```bash
sudo nano /etc/systemd/system/mes-test-celery.service
```

服務檔案內容：
```ini
[Unit]
Description=MES Test Celery Worker
After=network.target redis.service

[Service]
Type=simple
User=mes
Group=mes
WorkingDirectory=/var/www/mes_test
Environment=DJANGO_SETTINGS_MODULE=mes_config.settings_test
ExecStart=/usr/bin/celery -A mes_config worker -l info
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 3. 啟用系統服務
```bash
# 重新載入系統服務
sudo systemctl daemon-reload

# 啟用服務 (開機自動啟動)
sudo systemctl enable mes-test.service
sudo systemctl enable mes-test-celery.service

# 啟動服務
sudo systemctl start mes-test.service
sudo systemctl start mes-test-celery.service

# 檢查服務狀態
sudo systemctl status mes-test.service
sudo systemctl status mes-test-celery.service
```

### 4. 設定 Nginx (可選)
```bash
# 建立 Nginx 設定檔案
sudo nano /etc/nginx/sites-available/mes-test
```

Nginx 設定內容：
```nginx
server {
    listen 80;
    server_name 192.168.1.28;

    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /var/www/mes_test/static/;
    }
}
```

```bash
# 啟用 Nginx 設定
sudo ln -s /etc/nginx/sites-available/mes-test /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 🔧 服務管理命令

### 啟動/停止服務
```bash
# 啟動服務
sudo systemctl start mes-test.service
sudo systemctl start mes-test-celery.service

# 停止服務
sudo systemctl stop mes-test.service
sudo systemctl stop mes-test-celery.service

# 重啟服務
sudo systemctl restart mes-test.service
sudo systemctl restart mes-test-celery.service
```

### 查看服務狀態
```bash
# 查看服務狀態
sudo systemctl status mes-test.service
sudo systemctl status mes-test-celery.service

# 查看服務日誌
sudo journalctl -u mes-test.service -f
sudo journalctl -u mes-test-celery.service -f
```

### 開機自動啟動
```bash
# 啟用開機自動啟動
sudo systemctl enable mes-test.service
sudo systemctl enable mes-test-celery.service

# 禁用開機自動啟動
sudo systemctl disable mes-test.service
sudo systemctl disable mes-test-celery.service
```

## 🌐 訪問地址

- **直接訪問**: http://192.168.1.28:8001
- **Nginx 代理**: http://192.168.1.28 (如果設定了 Nginx)

## 🔄 更新部署

當有新功能時：

1. **複製更新檔案**
   ```bash
   # 使用 WinSCP 複製更新的模組
   ```

2. **執行資料庫遷移**
   ```bash
   cd /var/www/mes_test
   export DJANGO_SETTINGS_MODULE=mes_config.settings_test
   python3 manage.py migrate
   ```

3. **重啟服務**
   ```bash
   sudo systemctl restart mes-test.service
   sudo systemctl restart mes-test-celery.service
   ```

## 🛡️ 安全設定

### 防火牆設定
```bash
# 開放必要端口
sudo ufw allow 8001
sudo ufw allow 80
sudo ufw allow 22
```

### 資料庫安全
```bash
# 設定資料庫密碼
sudo -u postgres psql
ALTER USER mes_test_user WITH PASSWORD 'strong_password';
\q
```

## 📊 監控和維護

### 查看系統資源
```bash
# 查看記憶體使用
free -h

# 查看磁碟使用
df -h

# 查看服務狀態
sudo systemctl status mes-test*
```

### 備份資料
```bash
# 備份資料庫
pg_dump -h localhost -U mes_test_user mes_test_db > backup_$(date +%Y%m%d).sql

# 備份程式碼
tar -czf mes_backup_$(date +%Y%m%d).tar.gz /var/www/mes_test/
```

---

**💡 重要**: 使用系統服務部署後，系統會在重開機後自動啟動，不會消失！
