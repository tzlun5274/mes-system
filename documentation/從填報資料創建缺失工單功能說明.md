# 從填報資料創建缺失工單功能說明

## 功能概述

本功能旨在解決填報資料與工單資料不一致的問題，透過分析填報記錄，自動創建缺失的工單記錄，確保資料完整性。

## 核心特性

### 1. 唯一性識別機制
- **主要識別方式**：公司名稱/代號 + 製令號碼 + 產品編號
- **備用識別方式**：公司代號 + 工單號碼（當產品編號不同時）
- **避免重複創建**：系統會檢查現有工單，跳過已存在的記錄

### 2. 智能公司代號查找
系統提供兩種方式查找公司代號：

#### 方法一：從公司配置表查找
```python
company_config = CompanyConfig.objects.filter(
    company_name__icontains=fill_work.company_name
).first()
```

#### 方法二：從製令資料查找
```python
mkord_main = PrdMKOrdMain.objects.filter(
    MKOrdNO=fill_work.workorder,
    ProductID=fill_work.product_id
).first()
```

### 3. 資料完整性檢查
- 檢查必要欄位（公司名稱、工單號碼、產品編號）
- 驗證公司代號的有效性
- 確保工單唯一性約束

## 功能架構

### 1. 服務層 (`workorder/services.py`)
```python
def create_missing_workorders_from_fillwork():
    """
    從填報資料創建缺失的工單
    以公司名稱/代號+製令號碼+產品編號作為唯一性識別
    """
```

### 2. 管理命令 (`workorder/management/commands/create_missing_workorders.py`)
```bash
# 試運行模式
python3 manage.py create_missing_workorders --dry-run --verbose

# 實際執行
python3 manage.py create_missing_workorders
```

### 3. 網頁介面 (`workorder/views/workorder_views.py`)
```python
class CreateMissingWorkOrdersView(LoginRequiredMixin, View):
    """從填報資料創建缺失工單的視圖"""
```

### 4. 模板檔案 (`workorder/templates/workorder/workorder/create_missing_workorders.html`)
- 統計資訊顯示
- 缺失工單列表
- 一鍵創建功能

## 使用方式

### 1. 命令行使用

#### 試運行模式（推薦）
```bash
python3 manage.py create_missing_workorders --dry-run --verbose
```
- 只顯示會創建的工單，不實際創建
- 顯示詳細的執行過程和錯誤資訊

#### 實際執行
```bash
python3 manage.py create_missing_workorders
```
- 實際創建缺失的工單
- 建議先備份資料庫

### 2. 網頁介面使用

1. 進入工單管理頁面
2. 點擊「創建缺失工單」卡片
3. 查看統計資訊和缺失工單列表
4. 點擊「創建缺失的工單」按鈕執行

## 資料流程

### 1. 資料來源
- **填報資料表** (`workorder_fill_work`)
- **公司配置表** (`erp_company_config`)
- **製令主檔** (`prd_mk_ord_main`)
- **製造訂單** (`manufacturing_order`)

### 2. 處理邏輯
```
填報資料 → 檢查必要欄位 → 查找公司代號 → 檢查工單存在性 → 創建新工單
```

### 3. 輸出結果
- **成功創建**：新工單記錄
- **跳過記錄**：已存在的工單
- **錯誤記錄**：處理失敗的記錄

## 統計資訊

### 測試結果（2025年8月14日）
- **總填報記錄數**：3,359
- **現有工單數**：365
- **缺失工單數**：184
- **已存在工單數**：3,175
- **處理成功率**：94.4%

## 錯誤處理

### 1. 常見錯誤類型
- **缺少必要欄位**：公司名稱、工單號碼、產品編號為空
- **找不到公司代號**：無法從公司配置或製令資料中找到對應的公司代號
- **重複鍵值錯誤**：違反唯一性約束

### 2. 錯誤記錄
系統會記錄所有錯誤資訊，包括：
- 填報資料ID
- 錯誤類型
- 詳細錯誤訊息

## 安全考量

### 1. 資料備份
- 執行前建議備份資料庫
- 使用試運行模式先驗證結果

### 2. 權限控制
- 只有登入使用者可以執行
- 建議只有管理員執行此功能

### 3. 事務處理
- 使用資料庫事務確保資料一致性
- 單筆記錄失敗不影響其他記錄

## 效能優化

### 1. 批次處理
- 一次處理所有填報記錄
- 避免重複查詢

### 2. 索引優化
- 利用現有資料庫索引
- 減少查詢時間

### 3. 記憶體管理
- 分批處理大量資料
- 避免記憶體溢出

## 維護建議

### 1. 定期執行
- 建議定期執行此功能
- 保持填報資料與工單資料的一致性

### 2. 監控日誌
- 檢查執行日誌
- 分析錯誤原因

### 3. 資料清理
- 定期清理無效的填報記錄
- 維護資料品質

## 技術規格

### 1. 系統需求
- Django 5.1.8+
- PostgreSQL 資料庫
- Python 3.10+

### 2. 相依模組
- `workorder.fill_work.models.FillWork`
- `workorder.models.WorkOrder`
- `erp_integration.models.CompanyConfig`
- `workorder.workorder_erp.models.PrdMKOrdMain`
- `workorder.workorder_erp.models.ManufacturingOrder`

### 3. 資料庫約束
- 工單唯一性：`(company_code, order_number, product_code)`
- 外鍵關聯：工序、設備等

## 更新記錄

### v1.0.0 (2025-08-14)
- 初始版本發布
- 支援從填報資料創建缺失工單
- 提供命令行和網頁介面
- 完整的錯誤處理和日誌記錄

## 聯絡資訊

如有問題或建議，請聯絡系統管理員。 