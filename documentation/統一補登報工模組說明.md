# 統一補登報工模組說明

## 概述

統一補登報工模組 (`unified_work_reporting`) 是一個完全獨立的新模組，提供統一的補登報工功能。此模組不會影響現有系統的任何功能，可以安全地與現有系統並存。

## 功能特色

### 1. 完整的報工資料記錄
- **基本資訊欄位**：作業員、公司代號
- **工單相關欄位**：工單號碼、原始工單號碼、產品編號、預設生產數量
- **製程相關欄位**：工序、工序名稱、使用設備
- **時間相關欄位**：日期、開始時間、結束時間
- **休息時間欄位**：是否有休息時間、休息開始/結束時間、休息時數
- **工時計算欄位**：工作時數、加班時數（自動計算）
- **數量相關欄位**：工作數量、不良品數量
- **狀態欄位**：是否已完工
- **核准相關欄位**：核准狀態、核准人員、核准時間、核准備註
- **駁回相關欄位**：駁回原因、駁回人員、駁回時間
- **備註欄位**：一般備註、異常記錄
- **系統欄位**：建立人員、建立時間、更新時間

### 2. 自動工時計算
- 根據開始時間和結束時間自動計算總工時
- 支援休息時間扣除
- 自動區分正常工時和加班時數（假設8小時為正常工時）
- 支援跨日工作時間計算

### 3. 完整的核准流程
- 待核准 → 已核准/已駁回
- 已核准的記錄不可編輯
- 完整的核准歷史記錄
- 支援核准備註和駁回原因

### 4. 操作日誌追蹤
- 記錄所有操作歷史
- 包含操作類型、操作人員、操作時間
- 支援備註說明

### 5. 資料匯入匯出
- 支援 Excel 和 CSV 格式
- 批量匯入功能
- 支援重複資料檢查
- 完整的匯出功能

### 6. 搜尋和篩選
- 多條件搜尋
- 日期範圍篩選
- 核准狀態篩選
- 完工狀態篩選

## 資料表結構

### UnifiedWorkReport（統一補登報工主表）
```sql
CREATE TABLE unified_work_report (
    id SERIAL PRIMARY KEY,
    operator VARCHAR(100) NOT NULL,
    company_code VARCHAR(10) NOT NULL,
    workorder_id INTEGER REFERENCES workorder_workorder(id),
    original_workorder_number VARCHAR(50),
    product_id VARCHAR(100),
    planned_quantity INTEGER,
    process_id INTEGER REFERENCES process_processname(id),
    operation VARCHAR(100),
    equipment VARCHAR(100),
    work_date DATE,
    start_time TIME,
    end_time TIME,
    has_break BOOLEAN DEFAULT FALSE,
    break_start_time TIME,
    break_end_time TIME,
    break_hours DECIMAL(4,2) DEFAULT 0.00,
    work_hours_calculated DECIMAL(6,2) DEFAULT 0.00,
    overtime_hours_calculated DECIMAL(6,2) DEFAULT 0.00,
    work_quantity INTEGER DEFAULT 0,
    defect_quantity INTEGER DEFAULT 0,
    is_completed BOOLEAN DEFAULT FALSE,
    approval_status VARCHAR(20) DEFAULT 'pending',
    approved_by VARCHAR(100),
    approved_at TIMESTAMP,
    approval_remarks TEXT,
    rejection_reason TEXT,
    rejected_by VARCHAR(100),
    rejected_at TIMESTAMP,
    remarks TEXT,
    abnormal_notes TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### UnifiedWorkReportLog（操作日誌表）
```sql
CREATE TABLE unified_work_report_log (
    id SERIAL PRIMARY KEY,
    work_report_id INTEGER REFERENCES unified_work_report(id),
    action VARCHAR(20),
    operator VARCHAR(100),
    remarks TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 使用方式

### 1. URL 路徑
- 列表頁面：`/unified-work-reporting/`
- 新增頁面：`/unified-work-reporting/create/`
- 詳細頁面：`/unified-work-reporting/<id>/`
- 編輯頁面：`/unified-work-reporting/<id>/edit/`
- 核准頁面：`/unified-work-reporting/<id>/approval/`
- 匯入頁面：`/unified-work-reporting/import/`
- 匯出功能：`/unified-work-reporting/export/`

### 2. 權限控制
模組提供以下權限：
- `can_view_unified_work_report`：可以查看統一補登報工
- `can_add_unified_work_report`：可以新增統一補登報工
- `can_edit_unified_work_report`：可以編輯統一補登報工
- `can_delete_unified_work_report`：可以刪除統一補登報工
- `can_approve_unified_work_report`：可以核准統一補登報工
- `can_reject_unified_work_report`：可以駁回統一補登報工

### 3. Django Admin 管理
- 完整的 Django Admin 介面
- 支援批量操作（核准、駁回、標記完工）
- 完整的搜尋和篩選功能
- 操作日誌查看

## 技術特點

### 1. 完全獨立
- 不依賴現有報工系統
- 獨立的資料表結構
- 獨立的 URL 路徑
- 獨立的權限系統

### 2. 資料完整性
- 外鍵關聯到工單和工序
- 自動工時計算
- 完整的核准流程
- 操作日誌追蹤

### 3. 效能優化
- 資料庫索引優化
- 查詢效能優化
- 分頁支援
- 批量操作支援

### 4. 擴展性
- 模組化設計
- 易於擴展新功能
- 支援多公司架構
- 支援多語言

## 安裝和設定

### 1. 已完成的設定
- ✅ 模組已建立
- ✅ 模型已定義
- ✅ 視圖已實作
- ✅ URL 已配置
- ✅ 表單已建立
- ✅ 管理介面已設定
- ✅ 信號處理已實作
- ✅ 資料庫遷移已完成
- ✅ 測試已通過

### 2. 使用前準備
1. 確保有工單資料（WorkOrder）
2. 確保有工序資料（ProcessName）
3. 設定適當的權限
4. 建立超級用戶（用於管理介面）

### 3. 首次使用
1. 訪問 `/unified-work-reporting/` 查看列表
2. 點擊「新增報工記錄」開始使用
3. 或使用 Django Admin 介面管理

## 注意事項

1. **資料獨立性**：此模組的資料完全獨立於現有系統，不會影響任何現有功能。

2. **工時計算**：系統假設正常工時為8小時，超過部分計算為加班時數。

3. **核准流程**：已核准的記錄不可編輯，需要先駁回才能修改。

4. **資料匯入**：匯入時會檢查重複資料，可選擇跳過或覆蓋。

5. **權限控制**：建議根據實際需求設定適當的權限。

## 未來擴展

1. **報表功能**：可擴展統計報表功能
2. **通知功能**：可擴展郵件或簡訊通知
3. **API 介面**：可擴展 REST API 介面
4. **行動裝置支援**：可擴展行動裝置介面
5. **整合功能**：可選擇性整合到現有系統

## 技術支援

如有任何問題或需要技術支援，請聯繫系統管理員或開發團隊。 