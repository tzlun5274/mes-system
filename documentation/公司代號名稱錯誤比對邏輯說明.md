# 公司代號/名稱錯誤比對邏輯說明

## 📋 比對邏輯概述

公司代號/名稱錯誤檢查是將 **工單紀錄** 與 **填報紀錄** 進行比對，找出公司資訊不一致的情況。

## 🔍 比對流程

### 1. 比對的兩張表
- **主要比對表**: `WorkOrder` (工單紀錄表)
- **次要比對表**: `FillWork` (填報紀錄表)
- **參考表**: `CompanyConfig` (公司配置表)

### 2. 比對邏輯步驟

```python
def check_wrong_company(self):
    # 步驟1: 取得所有工單紀錄（排除RD樣品）
    workorders = WorkOrder.objects.exclude(order_number='RD樣品')
    
    for workorder in workorders:
        # 步驟2: 根據工單的公司代號找到正確的公司名稱
        company_config = CompanyConfig.objects.get(company_code=workorder.company_code)
        correct_company_name = company_config.company_name
        
        # 步驟3: 根據工單號碼+產品編號找到對應的填報紀錄
        fill_works = FillWork.objects.filter(
            workorder=workorder.order_number,   # 工單號碼要相同
            product_id=workorder.product_code   # 產品編號要相同
        )
        
        # 步驟4: 檢查填報紀錄的公司名稱是否正確
        for fill_work in fill_works:
            if fill_work.company_name != correct_company_name:
                # 標記為公司錯誤
```

## 📊 比對條件詳解

### 匹配條件
1. **工單號碼相同**: `fill_work.workorder == workorder.order_number`
2. **產品編號相同**: `fill_work.product_id == workorder.product_code`

### 異常條件
3. **公司名稱不同**: `fill_work.company_name != workorder對應的正確公司名稱`

## 🎯 比對邏輯說明

### 以工單為基準
這個檢查是 **以工單紀錄為標準**，檢查填報紀錄的公司名稱是否正確：

```
工單紀錄（標準）:
├── 公司代號: 10
├── 正確公司名稱: 耀儀科技 (從CompanyConfig查得) ✅ 標準答案
├── 工單號碼: 331-25815001
└── 產品編號: PFP-CCTBRY2S1P1-501

填報紀錄（檢查對象）:
├── 工單號碼: 331-25815001 ✅ 相符
├── 產品編號: PFP-CCTBRY2S1P1-501 ✅ 相符
└── 公司名稱: 中儀科技 ❌ 錯誤 -> 標記為異常
```

## 🔍 實際範例

假設有以下資料：

### 公司配置表 (CompanyConfig)
| 公司代號 | 公司名稱 |
|----------|----------|
| 02 | 中儀科技 |
| 10 | 耀儀科技 |

### 工單紀錄表 (WorkOrder)
| ID | 公司代號 | 工單號碼 | 產品編號 |
|----|----------|----------|----------|
| 409 | 10 | 331-25815001 | PFP-CCTBRY2S1P1-501 |

### 填報紀錄表 (FillWork)  
| ID | 公司名稱 | 工單號碼 | 產品編號 | 作業員 |
|----|----------|----------|----------|--------|
| 25362 | 耀儀科技 | 331-25815001 | PFP-CCTBRY2S1P1-501 | 林淑惠 | ✅ 正確
| 25363 | 中儀科技 | 331-25815001 | PFP-CCTBRY2S1P1-501 | 張三 | ❌ 錯誤

### 比對結果
1. **工單 409** 的公司代號是 `10`，對應正確公司名稱是 `耀儀科技`
2. **填報 25362**: 公司名稱是 `耀儀科技` ✅ 正確，不會標記為異常
3. **填報 25363**: 公司名稱是 `中儀科技` ❌ 錯誤，會標記為異常

## 📝 異常記錄內容

當發現公司代號/名稱錯誤時，會在 `ConsistencyCheckResult` 表中建立記錄：

```python
ConsistencyCheckResult.objects.create(
    check_type='wrong_company',
    company_code=workorder.company_code,           # 工單的正確公司代號
    company_name=correct_company_name,             # 工單對應的正確公司名稱  
    workorder=workorder.order_number,              # 工單號碼
    product_code=workorder.product_code,           # 產品編號
    wrong_company_code=fill_work.company_code,     # 填報紀錄的錯誤公司代號
    wrong_company_name=fill_work.company_name,     # 填報紀錄的錯誤公司名稱
    operator=fill_work.operator,                   # 填報的作業員
    work_date=fill_work.work_date,                 # 填報日期
)
```

## 🔄 比對邏輯特點

### 反向比對
與其他檢查不同，這個檢查是：
1. **先匹配**: 工單號碼 + 產品編號
2. **再檢查**: 公司名稱是否正確

### 標準來源
- **標準答案**: 工單紀錄的公司代號 → CompanyConfig 查得的公司名稱
- **檢查對象**: 填報紀錄的公司名稱

## 🎯 總結

**公司代號/名稱錯誤檢查**的核心邏輯：
1. **比對對象**: 工單紀錄 vs 填報紀錄
2. **比對基準**: 以工單紀錄+公司配置為標準答案
3. **比對條件**: 工單號碼+產品編號相同，但公司名稱不同
4. **檢查目的**: 找出填報時公司選錯的情況

這個檢查幫助發現作業員在填報時可能選錯公司的問題。
