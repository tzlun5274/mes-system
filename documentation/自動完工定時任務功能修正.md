# 自動完工定時任務功能修正

## 問題描述
在「新增自動完工定時任務」模態對話框中，雖然顯示了「固定時間執行」的選項，但實際上 JavaScript 函數 `addNewCompletionTask` 只處理固定時間執行，沒有處理間隔執行的邏輯，導致間隔執行功能無法正常使用。

## 問題分析

### 前端問題
1. **模態框 HTML 結構完整**：包含了間隔執行和固定時間執行的選項
2. **JavaScript 函數不完整**：`addNewCompletionTask` 函數只處理固定時間
3. **缺少切換函數**：沒有 `toggleExecutionType` 函數來處理執行類型的切換

### 後端功能完整
1. **模型支援**：`ScheduledTask` 模型支援兩種執行類型
2. **視圖處理**：`add_completion_task` 視圖支援兩種執行類型
3. **任務函數**：`workorder_archive_task` 任務函數存在且完整

## 修正內容

### 1. 修正 JavaScript 函數
- **檔案**：`system/templates/system/workorder_settings.html`
- **修正**：`addNewCompletionTask` 函數
- **新增**：完整的執行類型處理邏輯

#### 修正前
```javascript
function addNewCompletionTask() {
    const name = document.getElementById('completionTaskName').value.trim();
    const fixedTime = document.getElementById('completionTaskFixedTime').value;
    
    if (!name) {
        alert('請輸入任務名稱！');
        return;
    }
    
    if (!fixedTime) {
        alert('請設定固定執行時間！');
        return;
    }
    
    // 只處理固定時間
    body: `name=${encodeURIComponent(name)}&fixed_time=${fixedTime}`
}
```

#### 修正後
```javascript
function addNewCompletionTask() {
    const name = document.getElementById('completionTaskName').value.trim();
    const executionType = document.querySelector('input[name="executionType"]:checked').value;
    
    if (!name) {
        alert('請輸入任務名稱！');
        return;
    }
    
    let requestBody = `name=${encodeURIComponent(name)}&execution_type=${executionType}`;
    
    if (executionType === 'interval') {
        const intervalMinutes = document.getElementById('completionTaskInterval').value;
        if (!intervalMinutes || isNaN(intervalMinutes)) {
            alert('請輸入有效的執行間隔！');
            return;
        }
        
        const interval = parseInt(intervalMinutes);
        if (interval < 5 || interval > 1440) {
            alert('執行間隔必須在 5-1440 分鐘之間！');
            return;
        }
        
        requestBody += `&interval_minutes=${interval}`;
    } else if (executionType === 'fixed_time') {
        const fixedTime = document.getElementById('completionTaskFixedTime').value;
        if (!fixedTime) {
            alert('請設定固定執行時間！');
            return;
        }
        
        requestBody += `&fixed_time=${fixedTime}`;
    }
    
    // 發送完整的請求參數
    body: requestBody
}
```

### 2. 新增切換函數
- **新增**：`toggleExecutionType` 函數
- **功能**：處理執行類型的切換，顯示/隱藏對應的設定區塊

```javascript
function toggleExecutionType() {
    const executionType = document.querySelector('input[name="executionType"]:checked').value;
    const intervalSettings = document.getElementById('intervalSettings');
    const fixedTimeSettings = document.getElementById('fixedTimeSettings');
    
    if (executionType === 'interval') {
        intervalSettings.style.display = 'block';
        fixedTimeSettings.style.display = 'none';
    } else {
        intervalSettings.style.display = 'none';
        fixedTimeSettings.style.display = 'block';
    }
}
```

## 功能特色

### 1. 間隔執行
- **設定範圍**：5-1440 分鐘（1分鐘到24小時）
- **建議設定**：30-60 分鐘
- **實作方式**：使用 Celery Beat 的 `IntervalSchedule`

### 2. 固定時間執行
- **設定格式**：HH:MM（24小時制）
- **預設時間**：18:00
- **實作方式**：使用 Celery Beat 的 `CrontabSchedule`

### 3. 完整的驗證
- **任務名稱**：必填，不能為空
- **間隔時間**：必須在 5-1440 分鐘之間
- **固定時間**：必須選擇有效的時間

## 技術實作

### 前端處理
1. **執行類型檢測**：根據選中的 radio button 決定處理邏輯
2. **參數驗證**：對間隔時間和固定時間進行驗證
3. **動態表單**：根據執行類型顯示/隱藏對應的設定區塊

### 後端處理
1. **模型支援**：`ScheduledTask` 模型支援兩種執行類型
2. **Celery 整合**：自動建立對應的 `PeriodicTask`
3. **任務執行**：使用 `workorder_archive_task` 執行完整的工單歸檔流程

### 任務流程
```
定時觸發 → workorder_archive_task → FillWorkCompletionService.archive_workorders()
→ 完工判斷 → 資料轉移 → 資料清除
```

## 使用方式

### 1. 新增間隔執行任務
1. 點擊「+新增任務」按鈕
2. 輸入任務名稱（例如：「每小時完工檢查」）
3. 選擇「間隔執行」
4. 設定執行間隔（例如：60 分鐘）
5. 點擊「新增」

### 2. 新增固定時間執行任務
1. 點擊「+新增任務」按鈕
2. 輸入任務名稱（例如：「每日完工檢查」）
3. 選擇「固定時間執行」
4. 設定執行時間（例如：18:00）
5. 點擊「新增」

## 注意事項

1. **任務名稱唯一性**：每個任務名稱必須唯一
2. **執行間隔限制**：間隔執行必須在 5-1440 分鐘之間
3. **時間格式**：固定時間使用 24 小時制（HH:MM）
4. **任務管理**：可以建立多個任務，支援不同的執行方式
5. **自動清理**：任務會自動建立對應的 Celery Beat 定時任務

## 測試建議

### 1. 功能測試
- 測試間隔執行任務的建立和執行
- 測試固定時間執行任務的建立和執行
- 測試任務名稱驗證和錯誤處理

### 2. 介面測試
- 測試執行類型切換的顯示效果
- 測試表單驗證和錯誤提示
- 測試模態框的開啟和關閉

### 3. 整合測試
- 測試任務建立後 Celery Beat 的同步
- 測試任務執行和日誌記錄
- 測試任務的啟用/停用功能

## 更新日期
2025-01-27

## 更新人員
MES 系統開發團隊

