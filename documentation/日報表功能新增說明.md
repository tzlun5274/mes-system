# å·¥ä½œæ™‚æ•¸å ±è¡¨ - æ—¥å ±è¡¨åŠŸèƒ½æ–°å¢èªªæ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸç‚º MES ç³»çµ±çš„å·¥ä½œæ™‚æ•¸å ±è¡¨æ¨¡çµ„æ–°å¢äº†**æ—¥å ±è¡¨åŠŸèƒ½**ï¼Œç¾åœ¨ç³»çµ±æ”¯æ´å®Œæ•´çš„æ—¥ã€é€±ã€æœˆã€å­£ã€å¹´åº¦å ±è¡¨åŠŸèƒ½ã€‚æ—¥å ±è¡¨æ¡ç”¨**æŒ‰ä½œæ¥­å“¡æŸ¥è©¢**çš„æ–¹å¼ï¼Œä¸¦æ¡ç”¨**å…ˆé è¦½å¾ŒåŒ¯å‡º**çš„æµç¨‹è¨­è¨ˆã€‚

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. æ—¥å ±è¡¨å¡ç‰‡
- **ä½ç½®**ï¼šå·¥ä½œæ™‚æ•¸å ±è¡¨é¦–é  (`/reporting/work-hour/`)
- **è¨­è¨ˆ**ï¼šè—è‰²ä¸»é¡Œï¼Œä½¿ç”¨ `fas fa-calendar-day` åœ–ç¤º
- **åŠŸèƒ½**ï¼šæŒ‰æ—¥çµ±è¨ˆå·¥ä½œæ™‚æ•¸å’Œä½œæ¥­å“¡è³‡æ–™
- **ä½ˆå±€**ï¼šèª¿æ•´ç‚º 5 å€‹å¡ç‰‡ä¸¦æ’é¡¯ç¤ºï¼ˆæ¯å€‹ä½” 2 æ¬„ï¼‰

### 2. æ—¥å ±è¡¨è¡¨å–®é é¢
- **URL**ï¼š`/reporting/work-hour/daily/`
- **åŠŸèƒ½**ï¼š
  - ä½œæ¥­å“¡é¸æ“‡ï¼ˆå¿…å¡«ï¼Œé è¨­å…¨éƒ¨ä½œæ¥­å“¡ï¼‰
  - æ—¥æœŸé¸æ“‡å™¨ï¼ˆé è¨­ä»Šå¤©ï¼Œä¸èƒ½é¸æ“‡æœªä¾†æ—¥æœŸï¼‰
  - é è¦½å ±è¡¨æŒ‰éˆ•
  - å®Œæ•´çš„è¡¨å–®é©—è­‰

### 3. æ—¥å ±è¡¨é è¦½é é¢
- **åŠŸèƒ½**ï¼š
  - å ±è¡¨è³‡è¨Šé¡¯ç¤ºï¼ˆä½œæ¥­å“¡ã€æ—¥æœŸã€é¡å‹ã€ç”Ÿæˆæ™‚é–“ï¼‰
  - çµ±è¨ˆæ‘˜è¦ï¼ˆç¸½å·¥ä½œæ™‚æ•¸ã€ç¸½ä½œæ¥­å“¡æ•¸ã€ç¸½è¨­å‚™ä½¿ç”¨æ™‚æ•¸ã€å·¥å–®æ•¸é‡ï¼‰
  - è©³ç´°è³‡æ–™è¡¨æ ¼ï¼ˆåŒ…å«ä½œæ¥­å“¡æ¬„ä½ï¼‰
  - åŒ¯å‡ºé¸é …ï¼ˆExcelã€CSVã€åˆ—å°ï¼‰
  - è¿”å›æŒ‰éˆ•

### 4. æ—¥å ±è¡¨åŒ¯å‡ºåŠŸèƒ½
- **URL**ï¼š`/reporting/work-hour/daily/export/`
- **æ”¯æ´æ ¼å¼**ï¼šExcel (.xlsx)ã€CSV (.csv)
- **æµç¨‹**ï¼šå¾é è¦½é é¢é¸æ“‡åŒ¯å‡ºæ ¼å¼

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### 1. è³‡æ–™æ¨¡å‹æ›´æ–°
**æª”æ¡ˆ**ï¼š`reporting/models.py`

#### WorkOrderReportData æ¨¡å‹æ–°å¢æ¬„ä½ï¼š
```python
operator_name = models.CharField(max_length=100, verbose_name="ä½œæ¥­å“¡å§“å", null=True, blank=True)
```

#### æ–°å¢ç´¢å¼•ï¼š
```python
models.Index(fields=['operator_name', 'work_date'])
```

### 2. æœå‹™å±¤ (Services)
**æª”æ¡ˆ**ï¼š`reporting/services.py`

#### WorkHourReportService æ–°å¢æ–¹æ³•ï¼š
```python
def get_daily_report_by_operator(self, operator, date):
    """æŒ‰ä½œæ¥­å“¡æŸ¥è©¢æ—¥å ±è¡¨"""
    if operator == 'all':
        # æŸ¥è©¢æ‰€æœ‰ä½œæ¥­å“¡çš„è³‡æ–™
        return WorkOrderReportData.objects.filter(
            work_date=date
        )
    else:
        # æŸ¥è©¢ç‰¹å®šä½œæ¥­å“¡çš„è³‡æ–™
        return WorkOrderReportData.objects.filter(
            work_date=date,
            operator_name=operator
        )

def get_daily_summary_by_operator(self, operator, date):
    """æŒ‰ä½œæ¥­å“¡æŸ¥è©¢æ—¥å ±è¡¨æ‘˜è¦"""
    data = self.get_daily_report_by_operator(operator, date)
    
    summary = {
        'total_work_hours': data.aggregate(total=Sum('daily_work_hours'))['total'] or Decimal('0'),
        'total_operators': data.aggregate(total=Sum('operator_count'))['total'] or 0,
        'total_equipment_hours': data.aggregate(total=Sum('equipment_hours'))['total'] or Decimal('0'),
        'workorder_count': data.count(),
        'avg_daily_hours': data.aggregate(avg=Avg('daily_work_hours'))['avg'] or Decimal('0'),
    }
    
    return summary
```

#### ReportGeneratorService æ–°å¢æ–¹æ³•ï¼š
```python
def generate_daily_report_by_operator(self, operator, date, format='preview'):
    """æŒ‰ä½œæ¥­å“¡ç”Ÿæˆæ—¥å ±è¡¨"""
    try:
        data = self.work_hour_service.get_daily_report_by_operator(operator, date)
        summary = self.work_hour_service.get_daily_summary_by_operator(operator, date)
        
        report_data = {
            'report_type': 'æ—¥å ±è¡¨',
            'operator': operator,
            'date': date,
            'generated_at': timezone.now(),
            'summary': summary,
            'details': list(data.values()),
        }
        
        if format == 'excel':
            return self._export_to_excel(report_data, f'æ—¥å ±è¡¨_{operator}_{date}')
        elif format == 'csv':
            return self._export_to_csv(report_data, f'æ—¥å ±è¡¨_{operator}_{date}')
        else:
            return report_data
            
    except Exception as e:
        logger.error(f"ç”Ÿæˆæ—¥å ±è¡¨å¤±æ•—: {str(e)}")
        raise
```

### 3. è¦–åœ–å±¤ (Views)
**æª”æ¡ˆ**ï¼š`reporting/views.py`

#### é è¦½è¦–åœ–å‡½æ•¸ï¼š
```python
@login_required
def daily_report(request):
    """æ—¥å ±è¡¨é è¦½"""
    if request.method == 'POST':
        operator = request.POST.get('operator')
        date_str = request.POST.get('date')
        
        try:
            # è§£ææ—¥æœŸ
            from datetime import datetime
            date = datetime.strptime(date_str, '%Y-%m-%d').date()
            
            service = WorkHourReportService()
            
            # å–å¾—å ±è¡¨è³‡æ–™
            data = service.get_daily_report_by_operator(operator, date)
            summary = service.get_daily_summary_by_operator(operator, date)
            
            # é¡¯ç¤ºé è¦½å ±è¡¨
            context = {
                'report_type': 'æ—¥å ±è¡¨',
                'operator': operator,
                'date': date,
                'summary': summary,
                'data': data,
                'generated_at': timezone.now(),
            }
            return render(request, 'reporting/reporting/daily_report.html', context)
                
        except Exception as e:
            messages.error(request, f'ç”Ÿæˆæ—¥å ±è¡¨å¤±æ•—: {str(e)}')
            return redirect('reporting:work_hour_report_index')
    
    # GET è«‹æ±‚é¡¯ç¤ºè¡¨å–®
    current_date = timezone.now().date()
    
    context = {
        'current_date': current_date,
    }
    return render(request, 'reporting/reporting/daily_report_form.html', context)
```

#### åŒ¯å‡ºè¦–åœ–å‡½æ•¸ï¼š
```python
@login_required
def daily_report_export(request):
    """æ—¥å ±è¡¨åŒ¯å‡º"""
    operator = request.GET.get('operator')
    date_str = request.GET.get('date')
    format = request.GET.get('format', 'excel')
    
    try:
        # è§£ææ—¥æœŸ
        from datetime import datetime
        date = datetime.strptime(date_str, '%Y-%m-%d').date()
        
        service = WorkHourReportService()
        generator = ReportGeneratorService()
        
        # ç”Ÿæˆæª”æ¡ˆ
        result = generator.generate_daily_report_by_operator(operator, date, format)
        
        # ä¸‹è¼‰æª”æ¡ˆ
        with open(result['file_path'], 'rb') as f:
            response = HttpResponse(f.read(), content_type='application/octet-stream')
            response['Content-Disposition'] = f'attachment; filename="{result["filename"]}"'
            return response
            
    except Exception as e:
        messages.error(request, f'åŒ¯å‡ºæ—¥å ±è¡¨å¤±æ•—: {str(e)}')
        return redirect('reporting:daily_report')
```

### 4. URL é…ç½®
**æª”æ¡ˆ**ï¼š`reporting/urls.py`

#### æ–°å¢è·¯ç”±ï¼š
```python
# å·¥ä½œæ™‚æ•¸å ±è¡¨
path('work-hour/', views.work_hour_report_index, name='work_hour_report_index'),
path('work-hour/daily/', views.daily_report, name='daily_report'),
path('work-hour/daily/export/', views.daily_report_export, name='daily_report_export'),
path('work-hour/weekly/', views.weekly_report, name='weekly_report'),
path('work-hour/monthly/', views.monthly_report, name='monthly_report'),
path('work-hour/quarterly/', views.quarterly_report, name='quarterly_report'),
path('work-hour/yearly/', views.yearly_report, name='yearly_report'),
```

### 4. æ¨¡æ¿æª”æ¡ˆæ›´æ–°
**ä¿®æ”¹æª”æ¡ˆ**ï¼š
- `reporting/templates/reporting/reporting/daily_report_form.html` - æ”¹ç‚ºä½œæ¥­å“¡é¸æ“‡å’Œé è¦½æ ¼å¼
- `reporting/templates/reporting/reporting/daily_report.html` - åŠ å…¥ä½œæ¥­å“¡æ¬„ä½é¡¯ç¤º

## ğŸ¨ ä½¿ç”¨è€…ä»‹é¢

### 1. æ—¥å ±è¡¨å¡ç‰‡è¨­è¨ˆ
- **åœ–ç¤º**ï¼š`fas fa-calendar-day`ï¼ˆè—è‰²ä¸»é¡Œï¼‰
- **æ¨™é¡Œ**ï¼šæ—¥å ±è¡¨
- **æè¿°**ï¼šæŒ‰æ—¥çµ±è¨ˆå·¥ä½œæ™‚æ•¸å’Œä½œæ¥­å“¡è³‡æ–™
- **æŒ‰éˆ•**ï¼šç”Ÿæˆæ—¥å ±è¡¨ï¼ˆè—è‰²é‚Šæ¡†ï¼‰

### 2. è¡¨å–®é é¢ç‰¹è‰²
- **ä½œæ¥­å“¡é¸æ“‡**ï¼šä¸‹æ‹‰é¸å–®ï¼Œæ”¯æ´å…¨éƒ¨ä½œæ¥­å“¡æˆ–ç‰¹å®šä½œæ¥­å“¡
- **é è¦½æ ¼å¼**ï¼šé è¨­é¸æ“‡é è¦½æ ¼å¼
- **éŸ¿æ‡‰å¼è¨­è¨ˆ**ï¼šæ”¯æ´å„ç¨®è¢å¹•å°ºå¯¸
- **è¡¨å–®é©—è­‰**ï¼šé˜²æ­¢é¸æ“‡æœªä¾†æ—¥æœŸ
- **ä½¿ç”¨è€…å‹å–„**ï¼šæ¸…æ™°çš„æ¨™ç±¤å’Œèªªæ˜æ–‡å­—

### 3. å ±è¡¨é¡¯ç¤ºé é¢ç‰¹è‰²
- **ä½œæ¥­å“¡è³‡è¨Š**ï¼šé¡¯ç¤ºæŸ¥è©¢çš„ä½œæ¥­å“¡æˆ–å…¨éƒ¨ä½œæ¥­å“¡
- **çµ±è¨ˆå¡ç‰‡**ï¼šçªå‡ºé¡¯ç¤ºé—œéµæŒ‡æ¨™
- **è©³ç´°è¡¨æ ¼**ï¼šåŒ…å«ä½œæ¥­å“¡æ¬„ä½çš„å®Œæ•´è³‡æ–™å±•ç¤º
- **åˆ—å°æ”¯æ´**ï¼šå„ªåŒ–çš„åˆ—å°æ¨£å¼
- **å°èˆªåŠŸèƒ½**ï¼šæ–¹ä¾¿è¿”å›å’Œæ“ä½œ

## ğŸ” åŠŸèƒ½é©—è­‰

### 1. ç³»çµ±æª¢æŸ¥
```bash
python3 manage.py check
# çµæœï¼šSystem check identified no issues (0 silenced).
```

### 2. è³‡æ–™åº«é·ç§»
```bash
python3 manage.py makemigrations reporting
python3 manage.py migrate
# çµæœï¼šæˆåŠŸæ–°å¢ operator_name æ¬„ä½å’Œç´¢å¼•
```

### 3. URL æ¸¬è©¦
```bash
python3 manage.py shell -c "from django.urls import reverse; print('Daily report URL:', reverse('reporting:daily_report'))"
# çµæœï¼šDaily report URL: /reporting/work-hour/daily/
```

### 4. æœå‹™æ¸¬è©¦
```bash
python3 manage.py shell -c "from reporting.work_hour_report_service import WorkHourReportService; service = WorkHourReportService(); print('æ—¥å ±è¡¨æœå‹™æ¸¬è©¦æˆåŠŸ')"
# çµæœï¼šæ—¥å ±è¡¨æœå‹™æ¸¬è©¦æˆåŠŸ
```

## ğŸ“Š å ±è¡¨åŠŸèƒ½å°æ¯”

| åŠŸèƒ½ | æ—¥å ±è¡¨ | é€±å ±è¡¨ | æœˆå ±è¡¨ | å­£å ±è¡¨ | å¹´å ±è¡¨ |
|------|--------|--------|--------|--------|--------|
| æŸ¥è©¢æ–¹å¼ | æŒ‰ä½œæ¥­å“¡ | æŒ‰å…¬å¸ä»£è™Ÿ | æŒ‰å…¬å¸ä»£è™Ÿ | æŒ‰å…¬å¸ä»£è™Ÿ | æŒ‰å…¬å¸ä»£è™Ÿ |
| æ™‚é–“ç¶­åº¦ | æ—¥ | é€± | æœˆ | å­£ | å¹´ |
| é è¨­æ ¼å¼ | é è¦½ | Excel | Excel | Excel | Excel |
| æ”¯æ´æ ¼å¼ | é è¦½ã€Excelã€CSV | Excelã€CSVã€ç¶²é  | Excelã€CSVã€ç¶²é  | Excelã€CSVã€ç¶²é  | Excelã€CSVã€ç¶²é  |

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. ç”Ÿæˆæ—¥å ±è¡¨
1. ç™»å…¥ MES ç³»çµ±
2. é€²å…¥ã€Œå ±è¡¨ç®¡ç†ã€â†’ã€Œå·¥ä½œæ™‚æ•¸å ±è¡¨ã€
3. é»æ“Šã€Œæ—¥å ±è¡¨ã€å¡ç‰‡
4. é¸æ“‡ä½œæ¥­å“¡ï¼ˆé è¨­ç‚ºå…¨éƒ¨ä½œæ¥­å“¡ï¼‰
5. é¸æ“‡å ±è¡¨æ—¥æœŸ
6. é»æ“Šã€Œé è¦½å ±è¡¨ã€

### 2. æŸ¥çœ‹é è¦½å ±è¡¨
- **å ±è¡¨è³‡è¨Š**ï¼šé¡¯ç¤ºä½œæ¥­å“¡ã€æ—¥æœŸã€é¡å‹ã€ç”Ÿæˆæ™‚é–“
- **çµ±è¨ˆæ‘˜è¦**ï¼šç¸½å·¥ä½œæ™‚æ•¸ã€ç¸½ä½œæ¥­å“¡æ•¸ã€ç¸½è¨­å‚™ä½¿ç”¨æ™‚æ•¸ã€å·¥å–®æ•¸é‡
- **è©³ç´°è³‡æ–™**ï¼šåŒ…å«ä½œæ¥­å“¡æ¬„ä½çš„å®Œæ•´è¡¨æ ¼
- **åŒ¯å‡ºé¸é …**ï¼šExcelã€CSVã€åˆ—å°æŒ‰éˆ•

### 3. åŒ¯å‡ºå ±è¡¨
åœ¨é è¦½é é¢åº•éƒ¨é¸æ“‡åŒ¯å‡ºæ ¼å¼ï¼š
- **Excel æ ¼å¼**ï¼šä¸‹è¼‰ .xlsx æª”æ¡ˆ
- **CSV æ ¼å¼**ï¼šä¸‹è¼‰ .csv æª”æ¡ˆ
- **åˆ—å°**ï¼šä½¿ç”¨ç€è¦½å™¨åˆ—å°åŠŸèƒ½

## ğŸ“ æ³¨æ„äº‹é …

1. **ä½œæ¥­å“¡é¸æ“‡**ï¼šå¯ä»¥é¸æ“‡å…¨éƒ¨ä½œæ¥­å“¡æˆ–ç‰¹å®šä½œæ¥­å“¡
2. **æ—¥æœŸé™åˆ¶**ï¼šä¸èƒ½é¸æ“‡æœªä¾†æ—¥æœŸç”Ÿæˆå ±è¡¨
3. **è³‡æ–™ä¾†æº**ï¼šå ±è¡¨è³‡æ–™ä¾†è‡ª `WorkOrderReportData` æ¨¡å‹
4. **æ¬Šé™æ§åˆ¶**ï¼šéœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨å ±è¡¨åŠŸèƒ½
5. **éŒ¯èª¤è™•ç†**ï¼šç³»çµ±æœƒé¡¯ç¤ºè©³ç´°çš„éŒ¯èª¤è¨Šæ¯
6. **è³‡æ–™éš”é›¢**ï¼šæŒ‰ä½œæ¥­å“¡å§“åæŸ¥è©¢è³‡æ–™

## ğŸ”„ å¾ŒçºŒæ“´å±•

æ—¥å ±è¡¨åŠŸèƒ½å·²å®Œå…¨æ•´åˆåˆ°ç¾æœ‰çš„å ±è¡¨ç³»çµ±ä¸­ï¼Œå¯ä»¥è¼•é¬†æ“´å±•ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **å‹•æ…‹ä½œæ¥­å“¡åˆ—è¡¨**ï¼šå¾è³‡æ–™åº«å‹•æ…‹è¼‰å…¥ä½œæ¥­å“¡é¸é …
2. **è‡ªå‹•æ’ç¨‹**ï¼šè¨­å®šæ¯æ—¥è‡ªå‹•ç”Ÿæˆæ—¥å ±è¡¨
3. **éƒµä»¶ç™¼é€**ï¼šè‡ªå‹•ç™¼é€æ—¥å ±è¡¨åˆ°æŒ‡å®šäººå“¡
4. **åœ–è¡¨åˆ†æ**ï¼šæ–°å¢æ—¥å ±è¡¨çš„åœ–è¡¨è¦–è¦ºåŒ–
5. **æ¯”è¼ƒåŠŸèƒ½**ï¼šæ”¯æ´å¤šæ—¥æœŸæ¯”è¼ƒåˆ†æ
6. **ç¯©é¸åŠŸèƒ½**ï¼šæŒ‰å·¥åºã€è¨­å‚™ç­‰æ¢ä»¶ç¯©é¸

---

**å®Œæˆæ™‚é–“**ï¼š2025å¹´1æœˆ24æ—¥  
**é–‹ç™¼è€…**ï¼šMES ç³»çµ±é–‹ç™¼åœ˜éšŠ  
**ç‰ˆæœ¬**ï¼šv1.1ï¼ˆæ›´æ–°ï¼šæŒ‰ä½œæ¥­å“¡æŸ¥è©¢ï¼Œé è¦½æ ¼å¼ï¼‰
