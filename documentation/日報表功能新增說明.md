# 工作時數報表 - 日報表功能新增說明

## 📋 功能概述

已成功為 MES 系統的工作時數報表模組新增了**日報表功能**，現在系統支援完整的日、週、月、季、年度報表功能。日報表採用**按作業員查詢**的方式，並採用**先預覽後匯出**的流程設計。

## ✨ 新增功能

### 1. 日報表卡片
- **位置**：工作時數報表首頁 (`/reporting/work-hour/`)
- **設計**：藍色主題，使用 `fas fa-calendar-day` 圖示
- **功能**：按日統計工作時數和作業員資料
- **佈局**：調整為 5 個卡片並排顯示（每個佔 2 欄）

### 2. 日報表表單頁面
- **URL**：`/reporting/work-hour/daily/`
- **功能**：
  - 作業員選擇（必填，預設全部作業員）
  - 日期選擇器（預設今天，不能選擇未來日期）
  - 預覽報表按鈕
  - 完整的表單驗證

### 3. 日報表預覽頁面
- **功能**：
  - 報表資訊顯示（作業員、日期、類型、生成時間）
  - 統計摘要（總工作時數、總作業員數、總設備使用時數、工單數量）
  - 詳細資料表格（包含作業員欄位）
  - 匯出選項（Excel、CSV、列印）
  - 返回按鈕

### 4. 日報表匯出功能
- **URL**：`/reporting/work-hour/daily/export/`
- **支援格式**：Excel (.xlsx)、CSV (.csv)
- **流程**：從預覽頁面選擇匯出格式

## 🔧 技術實作

### 1. 資料模型更新
**檔案**：`reporting/models.py`

#### WorkOrderReportData 模型新增欄位：
```python
operator_name = models.CharField(max_length=100, verbose_name="作業員姓名", null=True, blank=True)
```

#### 新增索引：
```python
models.Index(fields=['operator_name', 'work_date'])
```

### 2. 服務層 (Services)
**檔案**：`reporting/services.py`

#### WorkHourReportService 新增方法：
```python
def get_daily_report_by_operator(self, operator, date):
    """按作業員查詢日報表"""
    if operator == 'all':
        # 查詢所有作業員的資料
        return WorkOrderReportData.objects.filter(
            work_date=date
        )
    else:
        # 查詢特定作業員的資料
        return WorkOrderReportData.objects.filter(
            work_date=date,
            operator_name=operator
        )

def get_daily_summary_by_operator(self, operator, date):
    """按作業員查詢日報表摘要"""
    data = self.get_daily_report_by_operator(operator, date)
    
    summary = {
        'total_work_hours': data.aggregate(total=Sum('daily_work_hours'))['total'] or Decimal('0'),
        'total_operators': data.aggregate(total=Sum('operator_count'))['total'] or 0,
        'total_equipment_hours': data.aggregate(total=Sum('equipment_hours'))['total'] or Decimal('0'),
        'workorder_count': data.count(),
        'avg_daily_hours': data.aggregate(avg=Avg('daily_work_hours'))['avg'] or Decimal('0'),
    }
    
    return summary
```

#### ReportGeneratorService 新增方法：
```python
def generate_daily_report_by_operator(self, operator, date, format='preview'):
    """按作業員生成日報表"""
    try:
        data = self.work_hour_service.get_daily_report_by_operator(operator, date)
        summary = self.work_hour_service.get_daily_summary_by_operator(operator, date)
        
        report_data = {
            'report_type': '日報表',
            'operator': operator,
            'date': date,
            'generated_at': timezone.now(),
            'summary': summary,
            'details': list(data.values()),
        }
        
        if format == 'excel':
            return self._export_to_excel(report_data, f'日報表_{operator}_{date}')
        elif format == 'csv':
            return self._export_to_csv(report_data, f'日報表_{operator}_{date}')
        else:
            return report_data
            
    except Exception as e:
        logger.error(f"生成日報表失敗: {str(e)}")
        raise
```

### 3. 視圖層 (Views)
**檔案**：`reporting/views.py`

#### 預覽視圖函數：
```python
@login_required
def daily_report(request):
    """日報表預覽"""
    if request.method == 'POST':
        operator = request.POST.get('operator')
        date_str = request.POST.get('date')
        
        try:
            # 解析日期
            from datetime import datetime
            date = datetime.strptime(date_str, '%Y-%m-%d').date()
            
            service = WorkHourReportService()
            
            # 取得報表資料
            data = service.get_daily_report_by_operator(operator, date)
            summary = service.get_daily_summary_by_operator(operator, date)
            
            # 顯示預覽報表
            context = {
                'report_type': '日報表',
                'operator': operator,
                'date': date,
                'summary': summary,
                'data': data,
                'generated_at': timezone.now(),
            }
            return render(request, 'reporting/reporting/daily_report.html', context)
                
        except Exception as e:
            messages.error(request, f'生成日報表失敗: {str(e)}')
            return redirect('reporting:work_hour_report_index')
    
    # GET 請求顯示表單
    current_date = timezone.now().date()
    
    context = {
        'current_date': current_date,
    }
    return render(request, 'reporting/reporting/daily_report_form.html', context)
```

#### 匯出視圖函數：
```python
@login_required
def daily_report_export(request):
    """日報表匯出"""
    operator = request.GET.get('operator')
    date_str = request.GET.get('date')
    format = request.GET.get('format', 'excel')
    
    try:
        # 解析日期
        from datetime import datetime
        date = datetime.strptime(date_str, '%Y-%m-%d').date()
        
        service = WorkHourReportService()
        generator = ReportGeneratorService()
        
        # 生成檔案
        result = generator.generate_daily_report_by_operator(operator, date, format)
        
        # 下載檔案
        with open(result['file_path'], 'rb') as f:
            response = HttpResponse(f.read(), content_type='application/octet-stream')
            response['Content-Disposition'] = f'attachment; filename="{result["filename"]}"'
            return response
            
    except Exception as e:
        messages.error(request, f'匯出日報表失敗: {str(e)}')
        return redirect('reporting:daily_report')
```

### 4. URL 配置
**檔案**：`reporting/urls.py`

#### 新增路由：
```python
# 工作時數報表
path('work-hour/', views.work_hour_report_index, name='work_hour_report_index'),
path('work-hour/daily/', views.daily_report, name='daily_report'),
path('work-hour/daily/export/', views.daily_report_export, name='daily_report_export'),
path('work-hour/weekly/', views.weekly_report, name='weekly_report'),
path('work-hour/monthly/', views.monthly_report, name='monthly_report'),
path('work-hour/quarterly/', views.quarterly_report, name='quarterly_report'),
path('work-hour/yearly/', views.yearly_report, name='yearly_report'),
```

### 4. 模板檔案更新
**修改檔案**：
- `reporting/templates/reporting/reporting/daily_report_form.html` - 改為作業員選擇和預覽格式
- `reporting/templates/reporting/reporting/daily_report.html` - 加入作業員欄位顯示

## 🎨 使用者介面

### 1. 日報表卡片設計
- **圖示**：`fas fa-calendar-day`（藍色主題）
- **標題**：日報表
- **描述**：按日統計工作時數和作業員資料
- **按鈕**：生成日報表（藍色邊框）

### 2. 表單頁面特色
- **作業員選擇**：下拉選單，支援全部作業員或特定作業員
- **預覽格式**：預設選擇預覽格式
- **響應式設計**：支援各種螢幕尺寸
- **表單驗證**：防止選擇未來日期
- **使用者友善**：清晰的標籤和說明文字

### 3. 報表顯示頁面特色
- **作業員資訊**：顯示查詢的作業員或全部作業員
- **統計卡片**：突出顯示關鍵指標
- **詳細表格**：包含作業員欄位的完整資料展示
- **列印支援**：優化的列印樣式
- **導航功能**：方便返回和操作

## 🔍 功能驗證

### 1. 系統檢查
```bash
python3 manage.py check
# 結果：System check identified no issues (0 silenced).
```

### 2. 資料庫遷移
```bash
python3 manage.py makemigrations reporting
python3 manage.py migrate
# 結果：成功新增 operator_name 欄位和索引
```

### 3. URL 測試
```bash
python3 manage.py shell -c "from django.urls import reverse; print('Daily report URL:', reverse('reporting:daily_report'))"
# 結果：Daily report URL: /reporting/work-hour/daily/
```

### 4. 服務測試
```bash
python3 manage.py shell -c "from reporting.work_hour_report_service import WorkHourReportService; service = WorkHourReportService(); print('日報表服務測試成功')"
# 結果：日報表服務測試成功
```

## 📊 報表功能對比

| 功能 | 日報表 | 週報表 | 月報表 | 季報表 | 年報表 |
|------|--------|--------|--------|--------|--------|
| 查詢方式 | 按作業員 | 按公司代號 | 按公司代號 | 按公司代號 | 按公司代號 |
| 時間維度 | 日 | 週 | 月 | 季 | 年 |
| 預設格式 | 預覽 | Excel | Excel | Excel | Excel |
| 支援格式 | 預覽、Excel、CSV | Excel、CSV、網頁 | Excel、CSV、網頁 | Excel、CSV、網頁 | Excel、CSV、網頁 |

## 🚀 使用方式

### 1. 生成日報表
1. 登入 MES 系統
2. 進入「報表管理」→「工作時數報表」
3. 點擊「日報表」卡片
4. 選擇作業員（預設為全部作業員）
5. 選擇報表日期
6. 點擊「預覽報表」

### 2. 查看預覽報表
- **報表資訊**：顯示作業員、日期、類型、生成時間
- **統計摘要**：總工作時數、總作業員數、總設備使用時數、工單數量
- **詳細資料**：包含作業員欄位的完整表格
- **匯出選項**：Excel、CSV、列印按鈕

### 3. 匯出報表
在預覽頁面底部選擇匯出格式：
- **Excel 格式**：下載 .xlsx 檔案
- **CSV 格式**：下載 .csv 檔案
- **列印**：使用瀏覽器列印功能

## 📝 注意事項

1. **作業員選擇**：可以選擇全部作業員或特定作業員
2. **日期限制**：不能選擇未來日期生成報表
3. **資料來源**：報表資料來自 `WorkOrderReportData` 模型
4. **權限控制**：需要登入才能使用報表功能
5. **錯誤處理**：系統會顯示詳細的錯誤訊息
6. **資料隔離**：按作業員姓名查詢資料

## 🔄 後續擴展

日報表功能已完全整合到現有的報表系統中，可以輕鬆擴展以下功能：

1. **動態作業員列表**：從資料庫動態載入作業員選項
2. **自動排程**：設定每日自動生成日報表
3. **郵件發送**：自動發送日報表到指定人員
4. **圖表分析**：新增日報表的圖表視覺化
5. **比較功能**：支援多日期比較分析
6. **篩選功能**：按工序、設備等條件篩選

---

**完成時間**：2025年1月24日  
**開發者**：MES 系統開發團隊  
**版本**：v1.1（更新：按作業員查詢，預覽格式）
