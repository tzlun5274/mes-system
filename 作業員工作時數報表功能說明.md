# 作業員工作時數報表功能說明

## 📋 功能概述

作業員工作時數報表是 MES 系統中的一個重要功能模組，專門用於分析和管理作業員的工作時數、效率表現和生產統計。本功能整合了填報作業和現場報工兩種資料來源，提供完整的作業員工作時數分析報表。

## 🎯 主要功能

### 1. 多維度報表類型
- **日報表**: 每日作業員工作時數統計
- **週報表**: 週期性工作時數彙總分析
- **月報表**: 月度工作時數趨勢分析
- **季報表**: 季度績效評估
- **年報表**: 年度工作時數總覽

### 2. 完整的統計指標
- **工作時數統計**: 總工作時數、正常工時、加班時數、休息時數、有效工作時數
- **效率指標**: 效率率、不良率、良率、完工率
- **數量統計**: 總工作數量、總不良數量、總合格數量
- **工單統計**: 處理工單數、完工工單數、工序統計
- **設備使用**: 使用設備數、設備利用率
- **時間分析**: 平均每日工時、單日最高/最低工時
- **加班分析**: 加班天數、平均加班時數、加班頻率
- **品質分析**: 品質評分、重工時數、重工率

### 3. 資料來源整合
- **填報作業資料**: 來自 `workorder.fill_work.models.FillWork`
- **現場報工資料**: 來自 `workorder.onsite_reporting.models.OnsiteReport`
- **作業員資料**: 來自 `process.models.Operator`

## 🏗️ 系統架構

### 資料模型設計

#### 1. OperatorWorkTimeReport (作業員工作時數報表)
```python
# 主要報表模型，儲存各種維度的統計資料
- report_date: 報表日期
- company_code: 公司代號
- operator_name: 作業員姓名
- report_type: 報表類型 (daily/weekly/monthly/quarterly/yearly)
- total_work_hours: 總工作時數
- efficiency_rate: 效率率
- # ... 其他統計欄位
```

#### 2. OperatorWorkTimeDetail (詳細記錄)
```python
# 儲存每日詳細的工作記錄
- report: 關聯報表
- work_date: 工作日期
- workorder_number: 工單號碼
- work_hours: 工作時數
- # ... 詳細資料
```

#### 3. OperatorWorkTimeSummary (彙總統計)
```python
# 用於快速查詢和統計分析
- summary_date: 統計日期
- summary_type: 統計類型
- # ... 彙總資料
```

### 服務層設計

#### OperatorWorkTimeReportService
- `generate_daily_report()`: 生成日報表
- `generate_weekly_report()`: 生成週報表
- `generate_monthly_report()`: 生成月報表

## 📊 報表功能

### 1. 查詢功能
- **多條件篩選**: 公司代號、作業員姓名、產線、日期範圍
- **工時範圍篩選**: 最小/最大工時
- **效率範圍篩選**: 最小/最大效率率
- **即時查詢**: 支援即時資料查詢和統計

### 2. 視覺化展示
- **統計卡片**: 總作業員數、總工作時數、平均效率率等關鍵指標
- **趨勢圖表**: 工作時數趨勢、效率率趨勢
- **詳細表格**: 作業員統計表格、日期統計表格
- **互動圖表**: 使用 Chart.js 提供互動式圖表

### 3. 匯出功能
- **Excel 匯出**: 支援 .xlsx 格式
- **CSV 匯出**: 支援 .csv 格式
- **PDF 匯出**: 支援 .pdf 格式
- **自動格式化**: 包含標題、統計摘要、詳細資料

## 🔧 使用方式

### 1. 網頁介面使用
```
1. 登入 MES 系統
2. 進入「報表管理」→「作業員工作時數報表」
3. 設定查詢條件
4. 點擊「查詢」按鈕
5. 查看報表結果
6. 點擊「匯出」按鈕下載報表
```

### 2. 管理命令使用
```bash
# 生成日報表
python3 manage.py generate_operator_work_time_report --company-code 01 --report-type daily --date 2025-01-15

# 生成週報表
python3 manage.py generate_operator_work_time_report --company-code 01 --report-type weekly --start-date 2025-01-13 --end-date 2025-01-19

# 生成月報表
python3 manage.py generate_operator_work_time_report --company-code 01 --report-type monthly --year 2025 --month 1
```

### 3. API 使用
```python
from reporting.services import OperatorWorkTimeReportService

# 生成日報表
result = OperatorWorkTimeReportService.generate_daily_report("01", date(2025, 1, 15))

# 生成週報表
result = OperatorWorkTimeReportService.generate_weekly_report("01", start_date, end_date)

# 生成月報表
result = OperatorWorkTimeReportService.generate_monthly_report("01", 2025, 1)
```

## 📈 報表範例

### 統計摘要
```
總作業員數: 15
總工作時數: 1,200.5 小時
總加班時數: 45.2 小時
平均效率率: 85.3%
總工作數量: 2,500 件
良率: 92.1%
```

### 作業員統計表格
| 作業員姓名 | 總工作時數 | 總加班時數 | 平均效率率 | 總工作數量 | 工作天數 |
|------------|------------|------------|------------|------------|----------|
| 張小明     | 160.5      | 8.2        | 88.5%      | 300        | 20       |
| 李小華     | 155.8      | 12.5       | 82.3%      | 280        | 19       |
| 王小美     | 168.2      | 5.8        | 91.2%      | 320        | 21       |

## 🔍 查詢功能

### 詳細查詢
- **作業員詳細記錄**: 查看特定作業員的詳細工作記錄
- **工單追蹤**: 按工單號碼查詢相關工作記錄
- **產品分析**: 按產品編號分析工作時數
- **工序統計**: 按工序名稱統計工作時數

### 篩選條件
- **時間範圍**: 開始日期、結束日期
- **作業員**: 作業員姓名（支援模糊查詢）
- **公司**: 公司代號
- **工單**: 工單號碼
- **產品**: 產品編號
- **工序**: 工序名稱

## 📋 資料來源說明

### 填報作業資料
- **來源**: `workorder.fill_work.models.FillWork`
- **欄位**: 作業員、工單號碼、產品編號、工序、工作時數、數量等
- **特點**: 手動填報，資料較為完整

### 現場報工資料
- **來源**: `workorder.onsite_reporting.models.OnsiteReport`
- **欄位**: 作業員、工單號碼、產品編號、工序、工作分鐘數等
- **特點**: 即時報工，資料較為即時

### 資料整合邏輯
1. **時間範圍**: 按工作日期篩選
2. **作業員匹配**: 按作業員姓名匹配
3. **工單關聯**: 按工單號碼關聯
4. **時數計算**: 填報作業使用 `work_hours_calculated`，現場報工將分鐘轉換為小時
5. **統計彙總**: 按作業員分組統計各項指標

## 🚀 效能優化

### 1. 資料庫優化
- **索引設計**: 針對常用查詢欄位建立索引
- **分表策略**: 按時間維度分表儲存
- **查詢優化**: 使用適當的查詢條件和分頁

### 2. 快取策略
- **報表快取**: 快取已生成的報表資料
- **統計快取**: 快取常用的統計資料
- **圖表快取**: 快取圖表資料

### 3. 非同步處理
- **背景生成**: 大型報表在背景生成
- **批次處理**: 大量資料批次處理
- **進度追蹤**: 提供生成進度追蹤

## 🔒 權限控制

### 1. 查看權限
- **報表查看**: 需要報表查看權限
- **詳細查詢**: 需要詳細查詢權限
- **匯出功能**: 需要匯出權限

### 2. 資料範圍
- **公司範圍**: 只能查看所屬公司的資料
- **時間範圍**: 可設定查詢的時間範圍限制
- **作業員範圍**: 可限制查看特定作業員的資料

## 📝 注意事項

### 1. 資料準確性
- **時間同步**: 確保系統時間準確
- **資料完整性**: 檢查資料來源的完整性
- **計算邏輯**: 驗證統計計算邏輯的正確性

### 2. 效能考量
- **查詢範圍**: 避免查詢過大的時間範圍
- **資料量**: 注意大量資料的處理效能
- **並發訪問**: 考慮多用戶同時查詢的情況

### 3. 維護保養
- **定期清理**: 定期清理過期的報表資料
- **備份策略**: 建立報表資料的備份策略
- **監控告警**: 監控報表生成和查詢的效能

## 🔄 未來擴展

### 1. 功能擴展
- **即時監控**: 提供即時的工作時數監控
- **預警功能**: 異常工作時數的預警功能
- **趨勢分析**: 更深入的趨勢分析功能

### 2. 整合擴展
- **薪資整合**: 與薪資系統整合
- **考勤整合**: 與考勤系統整合
- **績效評估**: 與績效評估系統整合

### 3. 技術升級
- **AI 分析**: 引入 AI 分析功能
- **大數據**: 支援大數據分析
- **雲端部署**: 支援雲端部署

---

**版本**: 1.0  
**更新日期**: 2025-01-15  
**維護人員**: MES 開發團隊
