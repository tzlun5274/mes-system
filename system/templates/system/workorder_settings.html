{% extends 'base.html' %}
{% load static %}

{% block title %}工單管理設定{% endblock %}

{% block extra_head %}
<style>
    .settings-container {
        padding: 20px;
    }
    
    .settings-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-title {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }
    
    .setting-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .setting-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .setting-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .setting-title {
        font-weight: bold;
        color: #333;
    }
    
    .setting-description {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: #2196F3;
    }
    
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    
    .btn-save {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-cog text-primary"></i>
                    工單管理設定
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'system:index' %}">系統管理</a></li>
                        <li class="breadcrumb-item active" aria-current="page">工單管理設定</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}
        
        <!-- 基本設定 -->
        <div class="settings-section">
            <div class="section-title">
                <i class="fas fa-sliders-h mr-2"></i>基本設定
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動審核</div>
                        <div class="setting-description">啟用後，符合條件的報工將自動審核通過（可在下方設定詳細條件）</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="auto_approval" {% if auto_approval %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">通知功能</div>
                        <div class="setting-description">啟用後，系統將發送異常和審核通知</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="notification_enabled" {% if notification_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">審計日誌</div>
                        <div class="setting-description">啟用後，系統將記錄所有操作日誌</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="audit_log_enabled" {% if audit_log_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- 自動審核設定 -->
        <div class="settings-section" id="auto-approval-settings" style="display: {% if auto_approval %}block{% else %}none{% endif %};">
            <div class="section-title">
                <i class="fas fa-robot mr-2"></i>自動審核設定
            </div>
            
            <!-- 工作時數設定 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動審核工作時數</div>
                        <div class="setting-description">工作時數在正常範圍內時自動審核</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="auto_approve_work_hours" {% if auto_approve_work_hours %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>最大工作時數：</label>
                        <div class="input-group" style="width: 150px;">
                            <input type="number" class="form-control" name="max_work_hours" value="{{ max_work_hours }}" min="0" max="24" step="0.5">
                            <div class="input-group-append">
                                <span class="input-group-text">小時</span>
                            </div>
                        </div>
                        <small class="form-text text-muted">超過此時數的報工需要人工審核</small>
                    </div>
                </div>
            </div>
            
            <!-- 不良率設定 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動審核不良率</div>
                        <div class="setting-description">不良率在正常範圍內時自動審核</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="auto_approve_defect_rate" {% if auto_approve_defect_rate %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>最大不良率：</label>
                        <div class="input-group" style="width: 150px;">
                            <input type="number" class="form-control" name="max_defect_rate" value="{{ max_defect_rate }}" min="0" max="100" step="0.1">
                            <div class="input-group-append">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <small class="form-text text-muted">超過此不良率的報工需要人工審核</small>
                    </div>
                </div>
            </div>
            
            <!-- 加班設定 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動審核加班</div>
                        <div class="setting-description">加班時數在正常範圍內時自動審核</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="auto_approve_overtime" {% if auto_approve_overtime %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>最大加班時數：</label>
                        <div class="input-group" style="width: 150px;">
                            <input type="number" class="form-control" name="max_overtime_hours" value="{{ max_overtime_hours }}" min="0" max="12" step="0.5">
                            <div class="input-group-append">
                                <span class="input-group-text">小時</span>
                            </div>
                        </div>
                        <small class="form-text text-muted">超過此時數的加班需要人工審核</small>
                    </div>
                </div>
            </div>
            
            <!-- 排除設定 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">排除設定</div>
                        <div class="setting-description">設定不需要自動審核的作業員和工序</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>排除作業員：</label>
                        <textarea class="form-control" name="exclude_operators" rows="3" placeholder="請輸入要排除的作業員編號，每行一個">{{ exclude_operators_text }}</textarea>
                        <small class="form-text text-muted">這些作業員的報工不會自動審核</small>
                    </div>
                    <div class="col-md-6">
                        <label>排除工序：</label>
                        <textarea class="form-control" name="exclude_processes" rows="3" placeholder="請輸入要排除的工序名稱，每行一個">{{ exclude_processes_text }}</textarea>
                        <small class="form-text text-muted">這些工序的報工不會自動審核</small>
                    </div>
                </div>
            </div>
            
            <!-- 通知設定 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動審核通知</div>
                        <div class="setting-description">自動審核後發送通知給主管</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="auto_approval_notification_enabled" {% if auto_approval_notification_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <label>通知收件人：</label>
                        <textarea class="form-control" name="auto_approval_notification_recipients" rows="3" placeholder="請輸入通知收件人郵件地址，每行一個">{{ auto_approval_notification_recipients_text }}</textarea>
                        <small class="form-text text-muted">自動審核通知的收件人清單</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 進階設定 -->
        <div class="settings-section">
            <div class="section-title">
                <i class="fas fa-cogs mr-2"></i>進階設定
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">最大檔案大小</div>
                        <div class="setting-description">設定上傳檔案的最大大小限制</div>
                    </div>
                    <div class="input-group" style="width: 150px;">
                        <input type="number" class="form-control" name="max_file_size" value="{{ max_file_size }}" min="1" max="100">
                        <div class="input-group-append">
                            <span class="input-group-text">MB</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">會話超時</div>
                        <div class="setting-description">設定使用者會話自動登出的時間</div>
                    </div>
                    <div class="input-group" style="width: 150px;">
                        <input type="number" class="form-control" name="session_timeout" value="{{ session_timeout }}" min="5" max="480">
                        <div class="input-group-append">
                            <span class="input-group-text">分鐘</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 定時任務設定 -->
        <div class="settings-section">
            <div class="section-title">
                <i class="fas fa-clock mr-2"></i>定時任務設定
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動分配定時任務</div>
                        <div class="setting-description">自動為數量為0的報工記錄分配數量</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="auto_allocation_enabled" {% if auto_allocation_task.enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">執行間隔</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="auto_allocation_interval" 
                                       value="{{ auto_allocation_task.interval_minutes }}" min="5" max="1440">
                                <div class="input-group-append">
                                    <span class="input-group-text">分鐘</span>
                                </div>
                            </div>
                            <small class="form-text text-muted">建議設定：30-60分鐘</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">任務狀態</label>
                            <div class="task-status">
                                <span class="badge {% if auto_allocation_task.enabled %}badge-success{% else %}badge-secondary{% endif %}">
                                    {% if auto_allocation_task.enabled %}啟用{% else %}停用{% endif %}
                                </span>
                                {% if auto_allocation_task.last_run %}
                                <br><small class="text-muted">最後執行：{{ auto_allocation_task.last_run|date:"Y-m-d H:i" }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" onclick="executeAutoAllocation()">
                                <i class="fas fa-play mr-2"></i>手動執行自動分配
                            </button>
                            <div id="auto-allocation-result" class="mt-2"></div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動審核定時任務</div>
                        <div class="setting-description">定期執行自動審核，處理待審核的報工記錄</div>
                        <div class="mt-2">
                            <a href="{% url 'system:auto_approval_tasks' %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-cog mr-1"></i>管理多個任務
                            </a>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <!-- 多個執行間隔管理 -->
                    <div id="auto-approval-tasks">
                        {% for task in auto_approval_tasks %}
                        <div class="task-item mb-3 p-3 border rounded" data-task-id="{{ task.id }}">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">任務名稱</label>
                                    <input type="text" class="form-control" name="task_name_{{ task.id }}" 
                                           value="{{ task.name }}" placeholder="例如：快速審核">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">執行設定</label>
                                    <div class="task-schedule">
                                        {% if task.execution_type == 'fixed_time' %}
                                            <span class="badge badge-info">固定時間</span>
                                            <br><small>{{ task.fixed_time|time:"H:i" }}</small>
                                        {% else %}
                                            <span class="badge badge-primary">間隔執行</span>
                                            <br><small>{{ task.interval_minutes }} 分鐘</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">啟用狀態</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="task_enabled_{{ task.id }}" 
                                               {% if task.is_enabled %}checked{% endif %}>
                                        <label class="form-check-label">啟用</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">任務狀態</label>
                                    <div class="task-status">
                                        <span class="badge {% if task.is_enabled %}badge-success{% else %}badge-secondary{% endif %}">
                                            {{ task.status_display }}
                                        </span>
                                        {% if task.last_run_at %}
                                        <br><small class="text-muted">最後執行：{{ task.last_run_at|date:"Y-m-d H:i" }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">操作</label>
                                    <div class="btn-group-vertical w-100">
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteTask({{ task.id }})">
                                            <i class="fas fa-trash"></i> 刪除
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="executeTask({{ task.id }})">
                                            <i class="fas fa-play"></i> 執行
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 新增任務按鈕 -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-success" onclick="showAddTaskModal()">
                                <i class="fas fa-plus mr-2"></i>新增任務
                            </button>
                            <small class="form-text text-muted">支援間隔執行（建議30-60分鐘）或固定時間執行（每天指定時間）</small>
                        </div>
                    </div>
                    
                    <!-- 新增任務模態框 -->
                    <div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增自動審核定時任務</h5>
                                    <button type="button" class="close" onclick="hideAddTaskModal()">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="taskName">任務名稱</label>
                                        <input type="text" class="form-control" id="taskName" placeholder="例如：快速審核">
                                    </div>
                                    <div class="form-group">
                                        <label>執行類型</label>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input" id="executionTypeInterval" name="executionType" value="interval" checked>
                                            <label class="form-check-label" for="executionTypeInterval">間隔執行</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="radio" class="form-check-input" id="executionTypeFixed" name="executionType" value="fixed_time">
                                            <label class="form-check-label" for="executionTypeFixed">固定時間</label>
                                        </div>
                                    </div>
                                    <div class="form-group" id="intervalSettings">
                                        <label for="taskInterval">執行間隔（分鐘）</label>
                                        <input type="number" class="form-control" id="taskInterval" value="30" min="5" max="1440">
                                        <small class="form-text text-muted">建議設定：30-60分鐘</small>
                                    </div>
                                    <div class="form-group" id="fixedTimeSettings" style="display: none;">
                                        <label for="taskFixedTime">固定執行時間</label>
                                        <input type="time" class="form-control" id="taskFixedTime" value="09:00">
                                        <small class="form-text text-muted">每天固定時間執行</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="hideAddTaskModal()">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="addNewTask()">新增</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 新增自動完工定時任務模態框 -->
                    <div class="modal fade" id="addCompletionTaskModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">新增自動完工定時任務</h5>
                                    <button type="button" class="close" onclick="hideAddCompletionTaskModal()">
                                        <span>&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="completionTaskName">任務名稱</label>
                                        <input type="text" class="form-control" id="completionTaskName" placeholder="例如：每日完工檢查">
                                    </div>
                                    <div class="form-group">
                                        <label for="completionTaskFixedTime">固定執行時間</label>
                                        <input type="time" class="form-control" id="completionTaskFixedTime" value="18:00">
                                        <small class="form-text text-muted">每天固定時間執行完工檢查</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" onclick="hideAddCompletionTaskModal()">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="addNewCompletionTask()">新增</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 手動執行按鈕 -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" onclick="executeAllAutoApproval()">
                                <i class="fas fa-play mr-2"></i>手動執行所有自動審核
                            </button>
                            <div id="auto-approval-result" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 完工判斷設定 -->
        <div class="settings-section">
            <div class="section-title">
                <i class="fas fa-check-circle mr-2"></i>完工判斷設定
            </div>
            
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動完工判斷</div>
                        <div class="setting-description">啟用後，系統會自動檢查工單是否達到完工條件</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="completion_check_enabled" {% if completion_check_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">檢查間隔</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="completion_check_interval" 
                                       value="{{ completion_check_interval }}" min="5" max="1440">
                                <div class="input-group-append">
                                    <span class="input-group-text">分鐘</span>
                                </div>
                            </div>
                            <small class="form-text text-muted">建議設定：30-60分鐘</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">完工判斷工序設定</label>
                            <select class="form-select" name="packaging_process_name" id="packaging_process_name">
                                <option value="">請選擇工序...</option>
                            </select>
                            <small class="form-text text-muted">用於完工判斷的工序名稱</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 編輯自動完工定時任務模態框 -->
            <div class="modal fade" id="editCompletionTaskModal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">編輯自動完工定時任務</h5>
                            <button type="button" class="close" onclick="hideEditCompletionTaskModal()">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editTaskId" value="">
                            <div class="form-group">
                                <label for="editCompletionTaskName">任務名稱</label>
                                <input type="text" class="form-control" id="editCompletionTaskName" placeholder="例如：每日完工檢查">
                            </div>
                            <div class="form-group">
                                <label for="editCompletionTaskFixedTime">固定執行時間</label>
                                <input type="time" class="form-control" id="editCompletionTaskFixedTime" value="18:00">
                                <small class="form-text text-muted">每天固定時間執行完工檢查</small>
                            </div>
                            <div class="form-group">
                                <label for="editCompletionTaskEnabled">任務狀態</label>
                                <select class="form-control" id="editCompletionTaskEnabled">
                                    <option value="true">啟用</option>
                                    <option value="false">停用</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="hideEditCompletionTaskModal()">取消</button>
                            <button type="button" class="btn btn-primary" onclick="updateCompletionTask()">更新</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 自動完工定時任務管理 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">自動完工定時任務</div>
                        <div class="setting-description">設定每天固定時間執行完工檢查</div>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCompletionTaskModal">
                        <i class="fas fa-plus mr-1"></i>新增任務
                    </button>
                </div>
                
                <div class="mt-3">
                    {% if completion_tasks %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>任務名稱</th>
                                        <th>執行時間</th>
                                        <th>狀態</th>
                                        <th>最後執行</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in completion_tasks %}
                                    <tr>
                                        <td>{{ task.name }}</td>
                                        <td>{{ task.fixed_time }}</td>
                                        <td>
                                            {% if task.is_enabled %}
                                                <span class="badge bg-success">啟用</span>
                                            {% else %}
                                                <span class="badge bg-secondary">停用</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if task.last_run_at %}
                                                {{ task.last_run_at|date:"Y-m-d H:i" }}
                                            {% else %}
                                                <span class="text-muted">尚未執行</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="executeCompletionTask({{ task.id }})" title="執行任務">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" 
                                                    onclick="editCompletionTask({{ task.id }})" title="編輯任務">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteCompletionTask({{ task.id }})" title="刪除任務">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>尚未設定自動完工定時任務</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">資料轉移功能</div>
                        <div class="setting-description">啟用後，已完工工單會自動轉移到已完工模組</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="data_transfer_enabled" {% if data_transfer_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">批次轉移數量</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="transfer_batch_size" 
                                       value="{{ transfer_batch_size }}" min="1" max="1000">
                                <div class="input-group-append">
                                    <span class="input-group-text">個</span>
                                </div>
                            </div>
                            <small class="form-text text-muted">每次批次轉移的工單數量</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">資料保留天數</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="transfer_retention_days" 
                                       value="{{ transfer_retention_days }}" min="1" max="3650">
                                <div class="input-group-append">
                                    <span class="input-group-text">天</span>
                                </div>
                            </div>
                            <small class="form-text text-muted">已轉移工單在主表的保留天數</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 自動完工功能控制 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">智能自動完工</div>
                        <div class="setting-description">啟用後，填報記錄提交時會自動檢查完工條件並觸發完工流程</div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-success btn-sm" onclick="enableAutoCompletion()">
                            <i class="fas fa-play mr-1"></i>啟用
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="disableAutoCompletion()">
                            <i class="fas fa-pause mr-1"></i>停用
                        </button>
                    </div>
                </div>
                <div id="auto-completion-result" class="mt-2"></div>
            </div>

            <!-- 手動執行按鈕 -->
            <div class="setting-item">
                <div class="setting-header">
                    <div>
                        <div class="setting-title">手動執行</div>
                        <div class="setting-description">一鍵執行工單歸檔（完工判斷+資料轉移+資料清除）</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-success" onclick="executeWorkorderArchive()">
                                <i class="fas fa-archive mr-2"></i>一鍵工單歸檔
                            </button>
                            <div id="workorder-archive-result" class="mt-2"></div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 儲存按鈕 -->
        <div class="text-center">
            <button type="submit" class="btn btn-save">
                <i class="fas fa-save mr-2"></i>儲存設定
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 載入工序選項
function loadProcessOptions() {
    const select = document.getElementById('packaging_process_name');
    const currentValue = '{{ packaging_process_name }}';
    
    // 顯示載入中
    select.innerHTML = '<option value="">載入中...</option>';
    
    // 通過API獲取工序列表
    fetch('/system/api/processes/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'same-origin'  // 確保包含認證 cookies
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // 清空選項
        select.innerHTML = '<option value="">請選擇工序...</option>';
        
        // 添加工序選項
        if (data.success && data.processes) {
            data.processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.name;
                option.textContent = process.name;
                
                // 設定當前值
                if (process.name === currentValue) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        } else {
            // 如果API失敗，添加預設選項
            const defaultOption = document.createElement('option');
            defaultOption.value = '出貨包裝';
            defaultOption.textContent = '出貨包裝';
            if (currentValue === '出貨包裝') {
                defaultOption.selected = true;
            }
            select.appendChild(defaultOption);
        }
    })
    .catch(error => {
        console.error('載入工序選項失敗:', error);
        // 載入失敗時顯示預設選項
        select.innerHTML = '<option value="">載入失敗</option>';
        const defaultOption = document.createElement('option');
        defaultOption.value = '出貨包裝';
        defaultOption.textContent = '出貨包裝';
        if (currentValue === '出貨包裝') {
            defaultOption.selected = true;
        }
        select.appendChild(defaultOption);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // 載入工序選項
    loadProcessOptions();
    
    // 表單提交處理
    document.querySelector('form').addEventListener('submit', function(e) {
        // 顯示載入中
        const submitBtn = document.querySelector('.btn-save');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>儲存中...';
        submitBtn.disabled = true;
        
        // 表單會正常提交，不需要阻止預設行為
    });
    
    // 切換開關動畫
    const toggles = document.querySelectorAll('.toggle-switch input');
    toggles.forEach(function(toggle) {
        toggle.addEventListener('change', function() {
            const slider = this.nextElementSibling;
            if (this.checked) {
                slider.style.transform = 'scale(1.1)';
                setTimeout(function() {
                    slider.style.transform = 'scale(1)';
                }, 100);
            }
        });
    });
    
    // 自動審核開關控制
    const autoApprovalToggle = document.querySelector('input[name="auto_approval"]');
    const autoApprovalSettings = document.getElementById('auto-approval-settings');
    
    if (autoApprovalToggle) {
        autoApprovalToggle.addEventListener('change', function() {
            if (this.checked) {
                autoApprovalSettings.style.display = 'block';
            } else {
                autoApprovalSettings.style.display = 'none';
            }
        });
    }
});

// 顯示新增任務模態框
function showAddTaskModal() {
    const modal = document.getElementById('addTaskModal');
    const bootstrapModal = new bootstrap.Modal(modal, {
        backdrop: true,
        keyboard: true
    });
    bootstrapModal.show();
}

// 隱藏新增任務模態框
function hideAddTaskModal() {
    const modal = document.getElementById('addTaskModal');
    const bootstrapModal = bootstrap.Modal.getInstance(modal);
    if (bootstrapModal) {
        bootstrapModal.hide();
    }
}

// 顯示新增自動完工定時任務模態框
function showAddCompletionTaskModal() {
    const modal = document.getElementById('addCompletionTaskModal');
    const bootstrapModal = new bootstrap.Modal(modal, {
        backdrop: true,
        keyboard: true
    });
    bootstrapModal.show();
}

// 隱藏新增自動完工定時任務模態框
function hideAddCompletionTaskModal() {
    const modal = document.getElementById('addCompletionTaskModal');
    const bootstrapModal = bootstrap.Modal.getInstance(modal);
    if (bootstrapModal) {
        bootstrapModal.hide();
    }
}

// 新增自動完工定時任務
function addNewCompletionTask() {
    const name = document.getElementById('completionTaskName').value.trim();
    const fixedTime = document.getElementById('completionTaskFixedTime').value;
    
    if (!name) {
        alert('請輸入任務名稱！');
        return;
    }
    
    if (!fixedTime) {
        alert('請設定固定執行時間！');
        return;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:add_completion_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `name=${encodeURIComponent(name)}&fixed_time=${fixedTime}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = document.getElementById('addCompletionTaskModal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            }
            location.reload(); // 重新載入頁面以顯示新任務
        } else {
            alert('新增失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('新增失敗：網路錯誤');
    });
}

// 執行自動完工定時任務
function executeCompletionTask(taskId) {
    if (!confirm('確定要執行此自動完工定時任務嗎？')) {
        return;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:execute_completion_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('執行失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('執行失敗：網路錯誤');
    });
}

// 刪除自動完工定時任務
function deleteCompletionTask(taskId) {
    if (!confirm('確定要刪除此自動完工定時任務嗎？')) {
        return;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:delete_completion_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // 重新載入頁面以更新任務列表
        } else {
            alert('刪除失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('刪除失敗：網路錯誤');
    });
}

// 切換執行類型設定
document.addEventListener('DOMContentLoaded', function() {
    const executionTypeRadios = document.querySelectorAll('input[name="executionType"]');
    const intervalSettings = document.getElementById('intervalSettings');
    const fixedTimeSettings = document.getElementById('fixedTimeSettings');
    
    executionTypeRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.value === 'interval') {
                intervalSettings.style.display = 'block';
                fixedTimeSettings.style.display = 'none';
            } else {
                intervalSettings.style.display = 'none';
                fixedTimeSettings.style.display = 'block';
            }
        });
    });
});

// 新增自動審核定時任務
function addNewTask() {
    const taskName = document.getElementById('taskName').value.trim();
    if (!taskName) {
        alert('請輸入任務名稱！');
        return;
    }
    
    const executionType = document.querySelector('input[name="executionType"]:checked').value;
    let requestBody = `name=${encodeURIComponent(taskName)}&execution_type=${executionType}`;
    
    if (executionType === 'interval') {
        const intervalMinutes = document.getElementById('taskInterval').value;
        if (!intervalMinutes || isNaN(intervalMinutes)) {
            alert('請輸入有效的執行間隔！');
            return;
        }
        
        const interval = parseInt(intervalMinutes);
        if (interval < 5 || interval > 1440) {
            alert('執行間隔必須在 5-1440 分鐘之間！');
            return;
        }
        
        requestBody += `&interval_minutes=${interval}`;
    } else if (executionType === 'fixed_time') {
        const fixedTime = document.getElementById('taskFixedTime').value;
        if (!fixedTime) {
            alert('請設定固定執行時間！');
            return;
        }
        
        requestBody += `&fixed_time=${fixedTime}`;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:add_auto_approval_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: requestBody
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = document.getElementById('addTaskModal');
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            }
            location.reload(); // 重新載入頁面以顯示新任務
        } else {
            alert('新增失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('新增失敗：網路錯誤');
    });
}

// 刪除自動審核定時任務
function deleteTask(taskId) {
    if (!confirm('確定要刪除此自動審核定時任務嗎？')) {
        return;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:delete_auto_approval_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // 重新載入頁面
        } else {
            alert('刪除失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('刪除失敗：網路錯誤');
    });
}

// 執行指定的自動審核定時任務
function executeTask(taskId) {
    if (!confirm('確定要執行此自動審核定時任務嗎？')) {
        return;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:execute_specific_auto_approval_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // 重新載入頁面以更新執行狀態
        } else {
            alert('執行失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('執行失敗：網路錯誤');
    });
}

// 執行所有自動審核定時任務
function executeAllAutoApproval() {
    if (!confirm('確定要執行所有自動審核定時任務嗎？')) {
        return;
    }
    
    const resultDiv = document.getElementById('auto-approval-result');
    resultDiv.innerHTML = '<div class="alert alert-info">正在執行自動審核...</div>';
    
    // 發送 AJAX 請求
    fetch('{% url "system:execute_all_auto_approval_tasks" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            setTimeout(() => {
                location.reload(); // 3秒後重新載入頁面以更新執行狀態
            }, 3000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">執行失敗：${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultDiv.innerHTML = '<div class="alert alert-danger">執行失敗：網路錯誤</div>';
    });
}

// 手動執行自動分配
function executeAutoAllocation() {
    const resultDiv = document.getElementById('auto-allocation-result');
    const button = event.target;
    const originalText = button.innerHTML;
    
    // 顯示載入中
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>執行中...';
    button.disabled = true;
    resultDiv.innerHTML = '';
    
    // 發送 AJAX 請求
    fetch('{% url "system:execute_auto_allocation" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('執行自動分配失敗:', error);
        resultDiv.innerHTML = `<div class="alert alert-danger">執行失敗：${error.message}</div>`;
    })
    .finally(() => {
        // 恢復按鈕狀態
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// 手動執行工單歸檔
function executeWorkorderArchive() {
    const resultDiv = document.getElementById('workorder-archive-result');
    const button = event.target;
    const originalText = button.innerHTML;
    
    // 顯示載入中
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>歸檔中...';
    button.disabled = true;
    resultDiv.innerHTML = '';
    
    // 發送 AJAX 請求
    fetch('{% url "system:execute_workorder_archive" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('執行工單歸檔失敗:', error);
        resultDiv.innerHTML = `<div class="alert alert-danger">執行失敗：${error.message}</div>`;
    })
    .finally(() => {
        // 恢復按鈕狀態
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// 編輯自動完工定時任務
function editCompletionTask(taskId) {
    // 先獲取任務詳情
    fetch('{% url "system:get_completion_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 填充編輯表單
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editCompletionTaskName').value = data.task.name;
            document.getElementById('editCompletionTaskFixedTime').value = data.task.fixed_time;
            document.getElementById('editCompletionTaskEnabled').value = data.task.is_enabled ? 'true' : 'false';
            
            // 顯示編輯模態框
            showEditCompletionTaskModal();
        } else {
            alert('獲取任務詳情失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('獲取任務詳情失敗：網路錯誤');
    });
}

// 顯示編輯自動完工定時任務模態框
function showEditCompletionTaskModal() {
    const modal = document.getElementById('editCompletionTaskModal');
    const bootstrapModal = new bootstrap.Modal(modal, {
        backdrop: true,
        keyboard: true
    });
    bootstrapModal.show();
}

// 隱藏編輯自動完工定時任務模態框
function hideEditCompletionTaskModal() {
    const modal = document.getElementById('editCompletionTaskModal');
    const bootstrapModal = bootstrap.Modal.getInstance(modal);
    if (bootstrapModal) {
        bootstrapModal.hide();
    }
}

// 更新自動完工定時任務
function updateCompletionTask() {
    const taskId = document.getElementById('editTaskId').value;
    const name = document.getElementById('editCompletionTaskName').value.trim();
    const fixedTime = document.getElementById('editCompletionTaskFixedTime').value;
    const enabled = document.getElementById('editCompletionTaskEnabled').value === 'true';
    
    if (!name) {
        alert('請輸入任務名稱！');
        return;
    }
    
    if (!fixedTime) {
        alert('請設定固定執行時間！');
        return;
    }
    
    // 發送 AJAX 請求
    fetch('{% url "system:update_completion_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `task_id=${taskId}&name=${encodeURIComponent(name)}&fixed_time=${fixedTime}&enabled=${enabled}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            hideEditCompletionTaskModal();
            location.reload(); // 重新載入頁面以更新任務列表
        } else {
            alert('更新失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失敗：網路錯誤');
    });
}

// 啟用自動完工功能
function enableAutoCompletion() {
    const resultDiv = document.getElementById('auto-completion-result');
    const button = event.target;
    const originalText = button.innerHTML;
    
    // 顯示載入中
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>啟用中...';
    button.disabled = true;
    resultDiv.innerHTML = '';
    
    // 發送 AJAX 請求
    fetch('{% url "system:enable_auto_completion" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('啟用自動完工功能失敗:', error);
        resultDiv.innerHTML = `<div class="alert alert-danger">啟用失敗：${error.message}</div>`;
    })
    .finally(() => {
        // 恢復按鈕狀態
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// 停用自動完工功能
function disableAutoCompletion() {
    const resultDiv = document.getElementById('auto-completion-result');
    const button = event.target;
    const originalText = button.innerHTML;
    
    // 顯示載入中
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>停用中...';
    button.disabled = true;
    resultDiv.innerHTML = '';
    
    // 發送 AJAX 請求
    fetch('{% url "system:disable_auto_completion" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('停用自動完工功能失敗:', error);
        resultDiv.innerHTML = `<div class="alert alert-danger">停用失敗：${error.message}</div>`;
    })
    .finally(() => {
        // 恢復按鈕狀態
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// 手動執行自動審核
function executeAutoApproval() {
    executeAllAutoApproval();
}
</script>
{% endblock %} 