<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>匯入功能測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>🔍 匯入功能測試頁面</h1>
        
        <div class="alert alert-info">
            <h5>測試步驟：</h5>
            <ol>
                <li>選擇 CSV 檔案</li>
                <li>點擊「測試匯入」按鈕</li>
                <li>查看瀏覽器控制台和網路請求</li>
            </ol>
        </div>
        
        <form method="post" enctype="multipart/form-data" action="{% url 'system:user_import' %}" id="testForm">
            {% csrf_token %}
            <div class="mb-3">
                <label for="testFile" class="form-label">選擇測試檔案</label>
                <input type="file" class="form-control" id="testFile" name="file" accept=".csv,.xlsx" required>
                <div class="form-text">支援 CSV、Excel 格式檔案</div>
            </div>
            <button type="submit" class="btn btn-primary" id="testBtn">
                <i class="fas fa-upload me-1"></i>測試匯入
            </button>
        </form>
        
        <div class="mt-4">
            <h5>📋 測試檔案格式：</h5>
            <pre><code>username,email,password
testuser1,test1@example.com,123456
testuser2,test2@example.com,password123</code></pre>
        </div>
        
        <div class="mt-4">
            <h5>🔍 調試信息：</h5>
            <div id="debugInfo" class="alert alert-secondary">
                <p>等待測試...</p>
            </div>
        </div>
    </div>

    <script>
        // 詳細的調試信息
        const form = document.getElementById('testForm');
        const fileInput = document.getElementById('testFile');
        const debugInfo = document.getElementById('debugInfo');
        const testBtn = document.getElementById('testBtn');
        
        // 檔案選擇事件
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                debugInfo.innerHTML = `
                    <h6>📁 檔案信息：</h6>
                    <ul>
                        <li>檔案名稱: ${file.name}</li>
                        <li>檔案大小: ${(file.size / 1024).toFixed(2)} KB</li>
                        <li>檔案類型: ${file.type}</li>
                        <li>最後修改: ${new Date(file.lastModified).toLocaleString()}</li>
                    </ul>
                `;
                console.log('📁 檔案選擇:', file);
            }
        });
        
        // 表單提交事件
        form.addEventListener('submit', function(e) {
            console.log('🚀 表單提交開始');
            debugInfo.innerHTML += '<p>🚀 表單提交開始...</p>';
            
            const file = fileInput.files[0];
            if (!file) {
                e.preventDefault();
                alert('請選擇檔案！');
                return false;
            }
            
            // 顯示載入狀態
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>匯入中...';
            testBtn.disabled = true;
            
            debugInfo.innerHTML += '<p>📤 正在提交到伺服器...</p>';
            console.log('📤 提交到:', form.action);
            console.log('📤 方法:', form.method);
            console.log('📤 檔案:', file);
            
            // 監聽網路請求
            const startTime = Date.now();
            debugInfo.innerHTML += '<p>⏱️ 開始計時...</p>';
            
            // 10秒後恢復按鈕
            setTimeout(() => {
                testBtn.innerHTML = '<i class="fas fa-upload me-1"></i>測試匯入';
                testBtn.disabled = false;
                debugInfo.innerHTML += '<p>⏰ 10秒超時，按鈕已恢復</p>';
            }, 10000);
        });
        
        // 頁面載入完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 測試頁面載入完成');
            debugInfo.innerHTML = '<p>✅ 測試頁面載入完成，請選擇檔案進行測試</p>';
        });
    </script>
</body>
</html>
