# 產品編號錯誤比對邏輯說明

## 📋 比對邏輯概述

產品編號錯誤檢查是將 **工單紀錄** 與 **填報紀錄** 進行比對，找出產品編號不一致的情況。

## 🔍 比對流程

### 1. 比對的兩張表
- **主要比對表**: `WorkOrder` (工單紀錄表)
- **次要比對表**: `FillWork` (填報紀錄表)

### 2. 比對邏輯步驟

```python
def check_wrong_product_code(self):
    # 步驟1: 取得所有工單紀錄（排除RD樣品）
    workorders = WorkOrder.objects.exclude(order_number='RD樣品')
    
    for workorder in workorders:
        # 步驟2: 根據工單的公司代號找到正確的公司名稱
        company_config = CompanyConfig.objects.get(company_code=workorder.company_code)
        correct_company_name = company_config.company_name
        
        # 步驟3: 找出該公司該工單的所有填報紀錄
        fill_works = FillWork.objects.filter(
            company_name=correct_company_name,  # 公司名稱要一樣
            workorder=workorder.order_number    # 工單號碼要一樣
        )
        
        # 步驟4: 找出產品編號不匹配的填報紀錄
        wrong_product_fill_works = fill_works.exclude(
            product_id=workorder.product_code   # 產品編號不一樣的
        )
        
        # 步驟5: 將不匹配的記錄標記為異常
        for fill_work in wrong_product_fill_works:
            # 建立異常記錄...
```

## 📊 比對條件詳解

### 匹配條件
1. **公司名稱相同**: `fill_work.company_name == workorder對應的公司名稱`
2. **工單號碼相同**: `fill_work.workorder == workorder.order_number`

### 異常條件
3. **產品編號不同**: `fill_work.product_id != workorder.product_code`

## 🎯 比對邏輯說明

### 以工單為基準
這個檢查是 **以工單紀錄為標準**，檢查填報紀錄的產品編號是否正確：

```
工單紀錄（標準）:
├── 公司代號: 10
├── 公司名稱: 耀儀科技  
├── 工單號碼: 331-25815001
└── 產品編號: PFP-CCTBRY2S1P1-501 ✅ 正確

填報紀錄（檢查對象）:
├── 公司名稱: 耀儀科技  ✅ 相符
├── 工單號碼: 331-25815001 ✅ 相符
└── 產品編號: PFP-WRONG-PRODUCT ❌ 錯誤 -> 標記為異常
```

## 🔍 實際範例

假設有以下資料：

### 工單紀錄表 (WorkOrder)
| ID | 公司代號 | 工單號碼 | 產品編號 |
|----|----------|----------|----------|
| 409 | 10 | 331-25815001 | PFP-CCTBRY2S1P1-501 |

### 填報紀錄表 (FillWork)  
| ID | 公司名稱 | 工單號碼 | 產品編號 | 作業員 |
|----|----------|----------|----------|--------|
| 25362 | 耀儀科技 | 331-25815001 | PFP-CCTBRY2S1P1-501 | 林淑惠 | ✅ 正確
| 25363 | 耀儀科技 | 331-25815001 | PFP-WRONG-CODE | 張三 | ❌ 錯誤

### 比對結果
- **25362**: 產品編號相符，不會標記為異常
- **25363**: 產品編號不符，會標記為異常

## 📝 異常記錄內容

當發現產品編號錯誤時，會在 `ConsistencyCheckResult` 表中建立記錄：

```python
ConsistencyCheckResult.objects.create(
    check_type='wrong_product_code',
    company_code=workorder.company_code,        # 工單的公司代號
    company_name=correct_company_name,          # 工單對應的公司名稱  
    workorder=workorder.order_number,           # 工單號碼
    product_code=workorder.product_code,        # 工單的正確產品編號
    wrong_product_code=fill_work.product_id,    # 填報紀錄的錯誤產品編號
    operator=fill_work.operator,                # 填報的作業員
    work_date=fill_work.work_date,              # 填報日期
)
```

## 🎯 總結

**產品編號錯誤檢查**的核心邏輯：
1. **比對對象**: 工單紀錄 vs 填報紀錄
2. **比對基準**: 以工單紀錄為標準答案
3. **比對條件**: 公司+工單號碼相同，但產品編號不同
4. **檢查目的**: 找出填報時產品編號填錯的情況

這個檢查幫助發現作業員在填報時可能選錯產品編號的問題。
