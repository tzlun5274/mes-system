{% extends "base.html" %}
{% load static %}

{% block title %}
å ±è¡¨éƒµä»¶ç™¼é€è¨­å®š - MES ç³»çµ±
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-envelope-paper"></i> å ±è¡¨éƒµä»¶ç™¼é€è¨­å®š</h2>
        <a href="{% url 'reporting:email_schedule_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> æ–°å¢è¨­å®š
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'success' %}success{% else %}danger{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> ç™¼é€è¨­å®šåˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    {% if schedules %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>å ±è¡¨é¡å‹</th>
                                        <th>ç™¼é€é »ç‡</th>
                                        <th>ç™¼é€æ™‚é–“</th>
                                        <th>æ”¶ä»¶äºº</th>
                                        <th>ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for schedule in schedules %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ schedule.get_report_type_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ schedule.get_schedule_type_display }}</span>
                                        </td>
                                        <td>
                                            <i class="bi bi-clock"></i> {{ schedule.send_time|time:"H:i" }}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {% for email in schedule.get_recipient_list|slice:":2" %}
                                                    {{ email }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                                {% if schedule.get_recipient_list|length > 2 %}
                                                    <span class="text-muted">...ç­‰ {{ schedule.get_recipient_list|length }} äºº</span>
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            {% if schedule.is_active %}
                                                <span class="badge bg-success">å•Ÿç”¨</span>
                                            {% else %}
                                                <span class="badge bg-secondary">åœç”¨</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="testSendEmail({{ schedule.id }})">
                                                    <i class="bi bi-send"></i> æ¸¬è©¦
                                                </button>
                                                <a href="{% url 'reporting:email_schedule_edit' schedule.id %}" 
                                                   class="btn btn-sm btn-outline-warning">
                                                    <i class="bi bi-pencil"></i> ç·¨è¼¯
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteSchedule({{ schedule.id }}, '{{ schedule.get_report_type_display }}')">
                                                    <i class="bi bi-trash"></i> åˆªé™¤
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-envelope-x display-1 text-muted"></i>
                            <h4 class="text-muted mt-3">å°šæœªè¨­å®šå ±è¡¨éƒµä»¶ç™¼é€</h4>
                            <p class="text-muted">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢è¨­å®šã€æŒ‰éˆ•ä¾†è¨­å®šè‡ªå‹•ç™¼é€å ±è¡¨éƒµä»¶</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> åŠŸèƒ½èªªæ˜</h5>
                </div>
                <div class="card-body">
                    <h6>ğŸ“§ è‡ªå‹•ç™¼é€å ±è¡¨</h6>
                    <p class="small text-muted">
                        è¨­å®šç³»çµ±è‡ªå‹•ç™¼é€å ±è¡¨éƒµä»¶çµ¦ç›¸é—œäººå“¡ï¼Œæ”¯æ´ä»¥ä¸‹åŠŸèƒ½ï¼š
                    </p>
                    <ul class="small text-muted">
                        <li>æ”¯æ´å¤šç¨®å ±è¡¨é¡å‹ï¼ˆSMTã€ä½œæ¥­å“¡ã€ç”Ÿç”¢æ—¥å ±ï¼‰</li>
                        <li>å¯è¨­å®šç™¼é€é »ç‡ï¼ˆæ¯å¤©ã€æ¯é€±ã€æ¯æœˆï¼‰</li>
                        <li>æ”¯æ´å¤šå€‹æ”¶ä»¶äººå’Œå‰¯æœ¬æ”¶ä»¶äºº</li>
                        <li>è‡ªå‹•é™„åŠ  Excel æ ¼å¼çš„å ±è¡¨æª”æ¡ˆ</li>
                        <li>ç¾è§€çš„ HTML éƒµä»¶å…§å®¹</li>
                    </ul>

                    <h6>â° ç™¼é€æ™‚é–“</h6>
                    <p class="small text-muted">
                        ç³»çµ±æœƒåœ¨è¨­å®šçš„æ™‚é–“è‡ªå‹•ç™¼é€å‰ä¸€å¤©çš„å ±è¡¨æ•¸æ“šã€‚
                    </p>

                    <h6>ğŸ“Š å ±è¡¨å…§å®¹</h6>
                    <p class="small text-muted">
                        éƒµä»¶åŒ…å«å ±è¡¨æ‘˜è¦å’Œ Excel é™„ä»¶ï¼Œæ–¹ä¾¿æŸ¥çœ‹å’Œåˆ†æã€‚
                    </p>

                    <div class="mt-3">
                                        <a href="{% url 'reporting:email_log_list' %}" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-clock-history"></i> æŸ¥çœ‹ç™¼é€è¨˜éŒ„
                </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{% url 'reporting:index' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> è¿”å›å ±è¡¨é¦–é 
        </a>
    </div>
</div>

<script>
function testSendEmail(scheduleId) {
    if (!confirm('ç¢ºå®šè¦ç™¼é€æ¸¬è©¦éƒµä»¶å—ï¼Ÿ')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('schedule_id', scheduleId);
    
    fetch('/reporting/api/test_send_report_email/', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('æ¸¬è©¦éƒµä»¶ç™¼é€æˆåŠŸï¼');
        } else {
            alert('æ¸¬è©¦éƒµä»¶ç™¼é€å¤±æ•—ï¼š' + data.message);
        }
    })
    .catch(error => {
        alert('ç™¼é€å¤±æ•—ï¼š' + error.message);
    });
}

function deleteSchedule(scheduleId, scheduleName) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${scheduleName}ã€çš„éƒµä»¶ç™¼é€è¨­å®šå—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
        return;
    }
    
    window.location.href = `/reporting/email_schedule/${scheduleId}/delete/`;
}
</script>
{% endblock %} 