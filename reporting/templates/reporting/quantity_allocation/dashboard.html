{% extends 'base.html' %}
{% load static %}

{% block title %}數量分配儀表板{% endblock %}

{% block extra_css %}
<style>
    .allocation-card {
        border-left: 4px solid #007bff;
    }
    .allocation-success {
        border-left-color: #28a745;
    }
    .allocation-warning {
        border-left-color: #ffc107;
    }
    .allocation-danger {
        border-left-color: #dc3545;
    }
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-chart-pie"></i> 數量分配儀表板</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> 重新整理
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showBatchAllocationModal()">
                        <i class="fas fa-magic"></i> 批量分配
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日期範圍選擇 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" id="dateRangeForm">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="date_range" class="form-label">日期範圍</label>
                                <select class="form-select" id="date_range" name="date_range" onchange="toggleCustomDates()">
                                    <option value="week" {% if date_range_type == 'week' %}selected{% endif %}>最近一週</option>
                                    <option value="month" {% if date_range_type == 'month' %}selected{% endif %}>最近一個月</option>
                                    <option value="quarter" {% if date_range_type == 'quarter' %}selected{% endif %}>最近一季</option>
                                    <option value="custom" {% if date_range_type == 'custom' %}selected{% endif %}>自訂範圍</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="customDatesDiv" style="display: {% if date_range_type == 'custom' %}block{% else %}none{% endif %};">
                                <label for="custom_start" class="form-label">開始日期</label>
                                <input type="date" class="form-control" id="custom_start" name="custom_start" value="{{ custom_start }}">
                            </div>
                            <div class="col-md-3" id="customDatesDiv2" style="display: {% if date_range_type == 'custom' %}block{% else %}none{% endif %};">
                                <label for="custom_end" class="form-label">結束日期</label>
                                <input type="date" class="form-control" id="custom_end" name="custom_end" value="{{ custom_end }}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> 查詢
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 統計卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">總報工記錄</h6>
                            <h3>{{ allocation_summary.total_reports|default:0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clipboard-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">原始數量</h6>
                            <h3>{{ allocation_summary.total_original_quantity|default:0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-box fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">分配數量</h6>
                            <h3>{{ allocation_summary.total_allocated_quantity|default:0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-magic fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">分配比例</h6>
                            <h3>{{ allocation_summary.allocation_ratio|default:0|floatformat:1 }}%</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 來源分布圖表 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie"></i> 數量來源分布
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="sourceDistributionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users"></i> 作業員分配統計
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>作業員</th>
                                    <th>分配數量</th>
                                    <th>分配次數</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for operator, stats in allocation_summary.operator_distribution.items %}
                                <tr>
                                    <td>{{ operator }}</td>
                                    <td>{{ stats.total_allocated }}</td>
                                    <td>{{ stats.allocation_count }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">暫無分配數據</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 需要分配的工單列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks"></i> 需要分配的工單
                        <span class="badge bg-warning ms-2">{{ workorders_needing_allocation|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if workorders_needing_allocation %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>工單號碼</th>
                                    <th>產品編號</th>
                                    <th>狀態</th>
                                    <th>未填寫記錄</th>
                                    <th>總記錄數</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in workorders_needing_allocation %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="workorder-checkbox" value="{{ item.workorder.order_number }}">
                                    </td>
                                    <td>
                                        <a href="{% url 'reporting:allocation_detail' item.workorder.order_number %}" class="text-decoration-none">
                                            {{ item.workorder.order_number }}
                                        </a>
                                    </td>
                                    <td>{{ item.workorder.product_code }}</td>
                                    <td>
                                        <span class="badge bg-{{ item.workorder.get_status_display|lower }}">
                                            {{ item.workorder.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ item.unfilled_count }}</span>
                                    </td>
                                    <td>{{ item.total_reports }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="allocateSingleWorkorder('{{ item.workorder.order_number }}')">
                                            <i class="fas fa-magic"></i> 分配
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <h5>沒有需要分配的工單</h5>
                        <p>所有工單的報工記錄都已填寫完整</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批量分配模態框 -->
<div class="modal fade" id="batchAllocationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic"></i> 批量分配數量
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    將為選中的工單自動分配數量，基於包裝工序的最終產出進行智能分配。
                </div>
                <div id="selectedWorkordersList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="executeBatchAllocation()">
                    <i class="fas fa-magic"></i> 開始分配
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 載入中模態框 -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <h6>正在處理分配...</h6>
                <p class="text-muted">請稍候，這可能需要一些時間</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 日期範圍選擇
function toggleCustomDates() {
    const dateRange = document.getElementById('date_range').value;
    const customDatesDiv = document.getElementById('customDatesDiv');
    const customDatesDiv2 = document.getElementById('customDatesDiv2');
    
    if (dateRange === 'custom') {
        customDatesDiv.style.display = 'block';
        customDatesDiv2.style.display = 'block';
    } else {
        customDatesDiv.style.display = 'none';
        customDatesDiv2.style.display = 'none';
    }
}

// 重新整理儀表板
function refreshDashboard() {
    location.reload();
}

// 全選/取消全選
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.workorder-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// 顯示批量分配模態框
function showBatchAllocationModal() {
    const checkboxes = document.querySelectorAll('.workorder-checkbox:checked');
    const selectedWorkordersList = document.getElementById('selectedWorkordersList');
    
    if (checkboxes.length === 0) {
        alert('請選擇要分配的工單');
        return;
    }
    
    let html = '<h6>選中的工單：</h6><ul class="list-group">';
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const workorderNumber = row.cells[1].textContent.trim();
        const productCode = row.cells[2].textContent.trim();
        html += `<li class="list-group-item">${workorderNumber} - ${productCode}</li>`;
    });
    html += '</ul>';
    
    selectedWorkordersList.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('batchAllocationModal'));
    modal.show();
}

// 執行批量分配
function executeBatchAllocation() {
    const checkboxes = document.querySelectorAll('.workorder-checkbox:checked');
    const workorderIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (workorderIds.length === 0) {
        alert('請選擇要分配的工單');
        return;
    }
    
    // 顯示載入中模態框
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // 關閉批量分配模態框
    const batchModal = bootstrap.Modal.getInstance(document.getElementById('batchAllocationModal'));
    batchModal.hide();
    
    // 發送批量分配請求
    const formData = new FormData();
    workorderIds.forEach(id => formData.append('workorder_ids[]', id));
    formData.append('date_range_type', '{{ date_range_type }}');
    {% if custom_start %}formData.append('custom_start', '{{ custom_start }}');{% endif %}
    {% if custom_end %}formData.append('custom_end', '{{ custom_end }}');{% endif %}
    
    fetch('{% url "reporting:allocate_multiple_workorders" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.success) {
            alert(`批量分配完成！\n成功：${data.successful_allocations} 個\n失敗：${data.failed_allocations} 個`);
            location.reload();
        } else {
            alert('批量分配失敗：' + data.message);
        }
    })
    .catch(error => {
        loadingModal.hide();
        alert('分配過程中發生錯誤：' + error.message);
    });
}

// 單個工單分配
function allocateSingleWorkorder(workorderId) {
    if (!confirm(`確定要為工單 ${workorderId} 分配數量嗎？`)) {
        return;
    }
    
    // 顯示載入中模態框
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // 發送分配請求
    const formData = new FormData();
    formData.append('workorder_id', workorderId);
    formData.append('date_range_type', '{{ date_range_type }}');
    {% if custom_start %}formData.append('custom_start', '{{ custom_start }}');{% endif %}
    {% if custom_end %}formData.append('custom_end', '{{ custom_end }}');{% endif %}
    
    fetch('{% url "reporting:allocate_workorder_quantities" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.success) {
            alert('分配成功！');
            location.reload();
        } else {
            alert('分配失敗：' + data.message);
        }
    })
    .catch(error => {
        loadingModal.hide();
        alert('分配過程中發生錯誤：' + error.message);
    });
}

// 初始化圖表
document.addEventListener('DOMContentLoaded', function() {
    // 來源分布圖表
    const sourceCtx = document.getElementById('sourceDistributionChart').getContext('2d');
    const sourceData = {{ allocation_summary.source_distribution|safe }};
    
    const sourceLabels = Object.keys(sourceData);
    const sourceValues = Object.values(sourceData).map(item => item.total_quantity);
    const sourceColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
    
    new Chart(sourceCtx, {
        type: 'doughnut',
        data: {
            labels: sourceLabels,
            datasets: [{
                data: sourceValues,
                backgroundColor: sourceColors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
</script>
{% endblock %} 