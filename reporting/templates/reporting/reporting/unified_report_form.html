{% extends 'base.html' %}
{% load static %}

{% block title %}工作時數報表{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}"><i class="fas fa-chart-bar"></i> 報表管理</a></li>
            <li class="breadcrumb-item"><a href="{% url 'reporting:work_hour_report_index' %}">工作時數報表</a></li>
            <li class="breadcrumb-item active" aria-current="page">報表生成</li>
        </ol>
    </nav>

    <!-- 訊息顯示區塊 -->
    {% if messages %}
        <div class="messages-container mb-3">
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% elif message.tags == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3"><i class="fas fa-chart-line text-info"></i> 工作時數報表生成</h2>
        </div>
    </div>

    <!-- 報表設定區塊 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-search"></i> 查詢條件</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="reportForm">
                        {% csrf_token %}
                        <input type="hidden" name="report_type" value="custom">
                        
                        <!-- 報表設定 -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="company" class="form-label">公司名稱 <span class="text-danger">*</span></label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="all" {% if company == 'all' or not company %}selected{% endif %}>全部公司</option>
                                    {% for company_option in companies %}
                                        <option value="{{ company_option.company_name }}" {% if company == company_option.company_name %}selected{% endif %}>{{ company_option.company_name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇要查詢的公司</div>
                        </div>

                            <div class="col-md-3 mb-3">
                                    <label for="operator" class="form-label">作業員 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="operator" name="operator" required>
                                    <option value="all" {% if operator == 'all' or not operator %}selected{% endif %}>全部作業員</option>
                                    {% for operator_option in operators %}
                                        <option value="{{ operator_option.name }}" {% if operator == operator_option.name %}selected{% endif %}>{{ operator_option.name }}</option>
                                    {% endfor %}
                                    </select>
                                <div class="form-text">請選擇要查詢的作業員</div>
                                </div>
                                
                            <div class="col-md-3 mb-3">
                                <label for="start_date" class="form-label">起始日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="{% if start_date %}{{ start_date|date:'Y-m-d' }}{% else %}{{ current_date|date:'Y-m-d' }}{% endif %}" required>
                                <div class="form-text">請選擇查詢的起始日期</div>
                                </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="end_date" class="form-label">終止日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="{% if end_date %}{{ end_date|date:'Y-m-d' }}{% else %}{{ current_date|date:'Y-m-d' }}{% endif %}" required>
                                <div class="form-text">請選擇查詢的終止日期</div>
                            </div>
                        </div>

                        <!-- 查詢按鈕 -->
                        <div class="row mb-4">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-search me-2"></i> 查詢
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
                                </div>
                                </div>
                                
    <!-- 統計摘要區塊 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> 統計摘要</h5>
                                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h4 class="text-primary">{{ summary.total_work_hours|floatformat:2|default:'0.00' }}</h4>
                                <p class="text-muted">總工作時數</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h4 class="text-success">{{ summary.total_operators|default:'0' }}</h4>
                                <p class="text-muted">總作業員數</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h4 class="text-info">{{ summary.total_equipment_hours|floatformat:2|default:'0.00' }}</h4>
                                <p class="text-muted">總設備使用時數</p>
                            </div>
                                </div>
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h4 class="text-warning">{{ summary.workorder_count|default:'0' }}</h4>
                                <p class="text-muted">工單數量</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作列表區塊 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> 工作列表</h5>
                </div>
                <div class="card-body">
                    <!-- 標籤切換和匯出按鈕 -->
                    <div class="d-flex justify-content-between align-items-center">
                        <ul class="nav nav-tabs" id="workListTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="true">
                                    <i class="fas fa-table"></i> 明細
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab" aria-controls="statistics" aria-selected="false">
                                    <i class="fas fa-chart-bar"></i> 統計
                                </button>
                            </li>
                        </ul>
                        
                        <!-- 匯出按鈕 -->
                        <div class="btn-group">
                            <a href="#" id="exportExcelBtn" class="btn btn-success btn-sm">
                                <i class="fas fa-file-excel me-1"></i> 匯出 EXCEL
                            </a>
                            <a href="#" id="exportCsvBtn" class="btn btn-info btn-sm">
                                <i class="fas fa-file-csv me-1"></i> 匯出 CSV
                            </a>
                        </div>
                    </div>
                    
                    <!-- 標籤內容 -->
                    <div class="tab-content" id="workListTabContent">
                        <!-- 明細標籤 -->
                        <div class="tab-pane fade show active" id="detail" role="tabpanel" aria-labelledby="detail-tab">
                            <div class="table-responsive mt-3">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>作業員</th>
                                            <th>公司名稱</th>
                                            <th>工單編號</th>
                                            <th>產品編號</th>
                                            <th>工序</th>
                                            <th>工作日期</th>
                                            <th>開始時間</th>
                                            <th>結束時間</th>
                                            <th>工作時數</th>
                                            <th>加班時數</th>
                                            <th>合計時數</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if report_data %}
                                            {% for item in report_data %}
                                            <tr>
                                                <td>{{ item.operator_name|default:'-' }}</td>
                                                <td>{{ item.company|default:'-' }}</td>
                                                <td>{{ item.workorder_id|default:'-' }}</td>
                                                <td>{{ item.product_code|default:'-' }}</td>
                                                <td>{{ item.process_name|default:'-' }}</td>
                                                <td>{{ item.work_date|date:'Y-m-d' }}</td>
                                                <td>{{ item.start_time|time:'H:i' }}</td>
                                                <td>{{ item.end_time|time:'H:i' }}</td>
                                                <td>{{ item.work_hours|floatformat:2 }}</td>
                                                <td>{{ item.overtime_hours|floatformat:2 }}</td>
                                                <td>{{ item.total_hours|floatformat:2 }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="11" class="text-center py-4">
                                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                                    <h6 class="text-muted">暫無資料</h6>
                                                    <p class="text-muted mb-0">請選擇條件並點擊「查詢」按鈕</p>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分頁 -->
                            {% if report_data.has_other_pages %}
                            <nav aria-label="工作列表分頁">
                                <ul class="pagination justify-content-center">
                                    {% if report_data.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ report_data.previous_page_number }}&company={{ company }}&operator={{ operator }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">上一頁</a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in report_data.paginator.page_range %}
                                        {% if report_data.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > report_data.number|add:'-3' and num < report_data.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}&company={{ company }}&operator={{ operator }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if report_data.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ report_data.next_page_number }}&company={{ company }}&operator={{ operator }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">下一頁</a>
                                        </li>
                                    {% endif %}
                            </ul>
                            </nav>
                            {% endif %}
                        </div>
                        
                        <!-- 統計標籤 -->
                        <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
                            <div class="table-responsive mt-3">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>排名</th>
                                            <th>作業員</th>
                                            <th>工作時數</th>
                                            <th>加班時數</th>
                                            <th>合計時數</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if operator_stats %}
                                            {% for stat in operator_stats %}
                                            <tr>
                                                <td>{{ stat.rank }}</td>
                                                <td>{{ stat.operator_name }}</td>
                                                <td>{{ stat.work_hours|floatformat:2 }}</td>
                                                <td>{{ stat.overtime_hours|floatformat:2 }}</td>
                                                <td>{{ stat.total_hours|floatformat:2 }}</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">暫無統計資料</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 統計分頁 -->
                            {% if operator_stats.has_other_pages %}
                            <nav aria-label="統計分頁">
                                <ul class="pagination justify-content-center">
                                    {% if operator_stats.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ operator_stats.previous_page_number }}&company={{ company }}&operator={{ operator }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&tab=statistics">上一頁</a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in operator_stats.paginator.page_range %}
                                        {% if operator_stats.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > operator_stats.number|add:'-3' and num < operator_stats.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}&company={{ company }}&operator={{ operator }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&tab=statistics">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if operator_stats.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ operator_stats.next_page_number }}&company={{ company }}&operator={{ operator }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&tab=statistics">下一頁</a>
                                        </li>
                                    {% endif %}
                            </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 表單提交處理
    const form = document.getElementById('reportForm');
    form.addEventListener('submit', function(e) {
        // 驗證必填欄位
        const requiredFields = document.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('請填寫所有必填欄位');
            return false;
        }
    });
    
    // 即時驗證
    const allInputs = document.querySelectorAll('input, select');
    allInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.hasAttribute('required')) {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            }
        });
    });
    
    // 動態更新匯出按鈕
    function updateExportButtons() {
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        
        if (exportExcelBtn && exportCsvBtn) {
            const company = document.getElementById('company').value;
            const operator = document.getElementById('operator').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            exportExcelBtn.href = "{% url 'reporting:custom_report_export' %}?company=" + company + "&operator=" + operator + "&start_date=" + startDate + "&end_date=" + endDate + "&format=excel";
            exportCsvBtn.href = "{% url 'reporting:custom_report_export' %}?company=" + company + "&operator=" + operator + "&start_date=" + startDate + "&end_date=" + endDate + "&format=csv";
        }
    }
    
    // 頁面載入時更新匯出按鈕
    updateExportButtons();
    
    // 當表單欄位變更時更新匯出按鈕
    document.getElementById('company').addEventListener('change', updateExportButtons);
    document.getElementById('operator').addEventListener('change', updateExportButtons);
    document.getElementById('start_date').addEventListener('change', updateExportButtons);
    document.getElementById('end_date').addEventListener('change', updateExportButtons);
});
</script>
{% endblock %}
