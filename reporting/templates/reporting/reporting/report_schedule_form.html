{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if schedule %}ç·¨è¼¯å ±è¡¨æ’ç¨‹{% else %}æ–°å¢å ±è¡¨æ’ç¨‹{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}"><i class="fas fa-chart-bar"></i> å ±è¡¨ç®¡ç†</a></li>
            <li class="breadcrumb-item"><a href="{% url 'reporting:report_schedule_list' %}">å ±è¡¨æ’ç¨‹ç®¡ç†</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if schedule %}ç·¨è¼¯æ’ç¨‹{% else %}æ–°å¢æ’ç¨‹{% endif %}
            </li>
        </ol>
    </nav>

    <!-- è¨Šæ¯é¡¯ç¤ºå€å¡Š -->
    {% if messages %}
        <div class="messages-container mb-3">
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% elif message.tags == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">
                <i class="fas fa-clock text-primary"></i> 
                {% if schedule %}ç·¨è¼¯å ±è¡¨æ’ç¨‹{% else %}æ–°å¢å ±è¡¨æ’ç¨‹{% endif %}
            </h2>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> 
                        {% if schedule %}ç·¨è¼¯æ’ç¨‹è¨­å®š{% else %}æ–°å¢æ’ç¨‹è¨­å®š{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="scheduleForm">
                        {% csrf_token %}
                        
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="name" class="form-label">
                                    <i class="fas fa-tag text-primary"></i> æ’ç¨‹åç¨± <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ schedule.name|default:'' }}" required
                                       placeholder="è«‹è¼¸å…¥æ’ç¨‹åç¨±">
                                <div class="form-text">ä¾‹å¦‚ï¼šé€±å ±è¡¨è‡ªå‹•ç™¼é€ã€æœˆå ±è¡¨çµ±è¨ˆç­‰</div>
                            </div>
                            <div class="col-md-6">
                                <label for="report_type" class="form-label">
                                    <i class="fas fa-chart-line text-primary"></i> å ±è¡¨é¡å‹ <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="report_type" name="report_type" required>
                                    <option value="">è«‹é¸æ“‡å ±è¡¨é¡å‹</option>
                                    {% for value, label in report_types %}
                                        <option value="{{ value }}" 
                                                {% if schedule.report_type == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6" id="company_field">
                                <label for="company" class="form-label">
                                    <i class="fas fa-building text-primary"></i> å…¬å¸ä»£è™Ÿ <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="">è«‹é¸æ“‡å…¬å¸</option>
                                    <option value="ALL" 
                                            {% if schedule.company == 'ALL' %}selected{% endif %}>
                                        ALL - æ‰€æœ‰å…¬å¸
                                    </option>
                                    {% for company in companies %}
                                        <option value="{{ company.company_code }}" 
                                                {% if schedule.company == company.company_code %}selected{% endif %}>
                                            {{ company.company_code }} - {{ company.company_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">é¸æ“‡è¦ç”Ÿæˆå ±è¡¨çš„å…¬å¸ï¼Œé¸æ“‡ã€ŒALLã€å°‡åŒ…å«æ‰€æœ‰å…¬å¸</div>
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">
                                    <i class="fas fa-toggle-on text-primary"></i> ç‹€æ…‹
                                </label>
                                <select class="form-select" id="status" name="status">
                                    {% for value, label in status_choices %}
                                        <option value="{{ value }}" 
                                                {% if schedule.status == value or not schedule and value == 'active' %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3" id="file_format_row">
                            <div class="col-md-6">
                                <label for="file_format" class="form-label">
                                    <i class="fas fa-file-alt text-primary"></i> æª”æ¡ˆæ ¼å¼
                                </label>
                                <select class="form-select" id="file_format" name="file_format">
                                    {% for value, label in file_formats %}
                                        <option value="{{ value }}" 
                                                {% if schedule.file_format == value or not schedule and value == 'html' %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">é¸æ“‡å ±è¡¨ç™¼é€çš„æª”æ¡ˆæ ¼å¼</div>
                            </div>
                        </div>

                        <!-- å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥æ™‚é–“è¨­å®š -->
                        <div class="row mb-3" id="sync_time_settings_row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-clock text-white"></i> å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥æ™‚é–“è¨­å®š</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="sync_execution_type" class="form-label">
                                                    <i class="fas fa-cog text-primary"></i> åŸ·è¡Œæ–¹å¼
                                                </label>
                                                <select class="form-select" id="sync_execution_type" name="sync_execution_type">
                                                    <option value="interval" {% if schedule.sync_execution_type == 'interval' or not schedule %}selected{% endif %}>é–“éš”åŸ·è¡Œ</option>
                                                    <option value="fixed_time" {% if schedule.sync_execution_type == 'fixed_time' %}selected{% endif %}>å›ºå®šæ™‚é–“</option>
                                                </select>
                                                <div class="form-text">é¸æ“‡å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥çš„åŸ·è¡Œæ–¹å¼</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3" id="interval_settings">
                                            <div class="col-md-6">
                                                <label for="sync_interval_minutes" class="form-label">
                                                    <i class="fas fa-stopwatch text-primary"></i> åŒæ­¥é–“éš”ï¼ˆåˆ†é˜ï¼‰
                                                </label>
                                                <input type="number" class="form-control" id="sync_interval_minutes" name="sync_interval_minutes" 
                                                       value="{% if schedule.sync_interval_minutes %}{{ schedule.sync_interval_minutes }}{% else %}60{% endif %}"
                                                       min="1" max="1440" required>
                                                <div class="form-text">æ¯å¤šå°‘åˆ†é˜åŸ·è¡Œä¸€æ¬¡å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥ï¼ˆ1-1440åˆ†é˜ï¼‰</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3" id="fixed_time_settings" style="display: none;">
                                            <div class="col-md-6">
                                                <label for="sync_fixed_time" class="form-label">
                                                    <i class="fas fa-clock text-primary"></i> å›ºå®šåŒæ­¥æ™‚é–“
                                                </label>
                                                <input type="time" class="form-control" id="sync_fixed_time" name="sync_fixed_time" 
                                                       value="{% if schedule.sync_fixed_time %}{{ schedule.sync_fixed_time|time:'H:i' }}{% endif %}">
                                                <div class="form-text">æ¯å¤©å›ºå®šæ™‚é–“åŸ·è¡Œå¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ’ç¨‹è¨­å®š -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt text-primary"></i> æ’ç¨‹è¨­å®š</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="schedule_time" class="form-label">
                                            <i class="fas fa-clock text-primary"></i> åŸ·è¡Œæ™‚é–“ <span class="text-danger">*</span>
                                        </label>
                                        <input type="time" class="form-control" id="schedule_time" name="schedule_time" 
                                               value="{{ schedule.schedule_time|time:'H:i'|default:'' }}" required>
                                        <div class="form-text">è¨­å®šæ¯æ—¥åŸ·è¡Œæ™‚é–“</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="schedule_day" class="form-label">
                                            <i class="fas fa-calendar-day text-primary"></i> åŸ·è¡Œæ—¥æœŸ
                                        </label>
                                        <input type="number" class="form-control" id="schedule_day" name="schedule_day" 
                                               value="{{ schedule.schedule_day|default:'' }}" 
                                               min="1" max="31"
                                               placeholder="è«‹é¸æ“‡åŸ·è¡Œæ—¥æœŸ">
                                        <div class="form-text">
                                            <span id="schedule_day_help">é€±å ±è¡¨ï¼šé€±å¹¾(1-7)ï¼Œæœˆå ±è¡¨ï¼šæ¯æœˆå¹¾è™Ÿ(1-31)ï¼Œå¹´å ±è¡¨ï¼šæ¯å¹´å¹¾è™Ÿ(1-31)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ”¶ä»¶äººè¨­å®š -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-envelope text-primary"></i> æ”¶ä»¶äººè¨­å®š</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="email_recipients" class="form-label">
                                        <i class="fas fa-users text-primary"></i> æ”¶ä»¶äººä¿¡ç®±
                                    </label>
                                    <textarea class="form-control" id="email_recipients" name="email_recipients" 
                                              rows="3" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººä¿¡ç®±ï¼Œå¤šå€‹ä¿¡ç®±ç”¨é€—è™Ÿåˆ†éš”">{{ schedule.email_recipients|default:'' }}</textarea>
                                    <div class="form-text">ä¾‹å¦‚ï¼šuser1@example.com, user2@example.com</div>
                                </div>
                            </div>
                        </div>

                        <!-- æŒ‰éˆ•å€åŸŸ -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'reporting:report_schedule_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 
                                    {% if schedule %}æ›´æ–°æ’ç¨‹{% else %}å»ºç«‹æ’ç¨‹{% endif %}
                                </button>
                                {% if schedule %}
                                    <a href="{% url 'reporting:report_schedule_delete' schedule.id %}" 
                                       class="btn btn-danger ms-2"
                                       onclick="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ’ç¨‹å—ï¼Ÿ')">
                                        <i class="fas fa-trash"></i> åˆªé™¤æ’ç¨‹
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- å´é‚Šèªªæ˜ -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle text-info"></i> èªªæ˜</h6>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb text-warning"></i> å ±è¡¨é¡å‹èªªæ˜</h6>
                    <div class="mb-3">
                        <h6 class="text-primary">ğŸ“Š å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥</h6>
                        <p class="small mb-2">æ¯å°æ™‚è‡ªå‹•åŒæ­¥å·¥å–®å’Œå¡«å ±è³‡æ–™ï¼Œç„¡éœ€è¨­å®šåŸ·è¡Œæ™‚é–“</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">ğŸ“… å‰ä¸€å€‹å·¥ä½œæ—¥å ±è¡¨</h6>
                        <p class="small mb-2">æ¯å¤©æ—©ä¸Š10é»å¾Œè‡ªå‹•ç”Ÿæˆå‰ä¸€å€‹å·¥ä½œæ—¥çš„å ±è¡¨ï¼Œè€ƒæ…®å‡æœŸå’Œè£œç­æ—¥</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">ğŸ“ˆ é€±å ±è¡¨</h6>
                        <ul class="small mb-2">
                            <li><strong>æœ¬é€±å ±è¡¨ï¼š</strong>å¾é€±ä¸€åˆ°ç¾åœ¨çš„å·¥ä½œè³‡æ–™</li>
                            <li><strong>ä¸Šé€±å ±è¡¨ï¼š</strong>ä¸Šé€±ä¸€åˆ°ä¸Šé€±æ—¥çš„å®Œæ•´è³‡æ–™</li>
                        </ul>
                        <p class="small text-muted">åŸ·è¡Œæ™‚é–“ï¼šæ¯é€±ä¸€æ—©ä¸Š9é»å¾Œ</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">ğŸ“Š æœˆå ±è¡¨</h6>
                        <ul class="small mb-2">
                            <li><strong>æœ¬æœˆå ±è¡¨ï¼š</strong>å¾æœ¬æœˆ1è™Ÿåˆ°ç¾åœ¨çš„å·¥ä½œè³‡æ–™</li>
                            <li><strong>ä¸Šæœˆå ±è¡¨ï¼š</strong>ä¸Šå€‹æœˆ1è™Ÿåˆ°æœˆåº•çš„å®Œæ•´è³‡æ–™</li>
                        </ul>
                        <p class="small text-muted">åŸ·è¡Œæ™‚é–“ï¼šæ¯æœˆ1è™Ÿæ—©ä¸Š9é»å¾Œ</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">ğŸ“ˆ å­£å ±è¡¨</h6>
                        <ul class="small mb-2">
                            <li><strong>æœ¬å­£å ±è¡¨ï¼š</strong>å¾æœ¬å­£ç¬¬ä¸€å¤©åˆ°ç¾åœ¨çš„å·¥ä½œè³‡æ–™</li>
                            <li><strong>ä¸Šå­£å ±è¡¨ï¼š</strong>ä¸Šå€‹å­£åº¦çš„å®Œæ•´æœŸé–“è³‡æ–™</li>
                        </ul>
                        <p class="small text-muted">åŸ·è¡Œæ™‚é–“ï¼šå¯è‡ªè¨‚æ¯å­£ç¬¬å¹¾å¤©åŸ·è¡Œï¼ˆ1-31ï¼‰</p>
                        <p class="small text-muted">å­£åº¦å®šç¾©ï¼šQ1(1-3æœˆ)ã€Q2(4-6æœˆ)ã€Q3(7-9æœˆ)ã€Q4(10-12æœˆ)</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">ğŸ“Š å¹´å ±è¡¨</h6>
                        <ul class="small mb-2">
                            <li><strong>æœ¬å¹´å ±è¡¨ï¼š</strong>å¾ä»Šå¹´1æœˆ1è™Ÿåˆ°ç¾åœ¨çš„å·¥ä½œè³‡æ–™</li>
                            <li><strong>ä¸Šå¹´å ±è¡¨ï¼š</strong>å»å¹´çš„å®Œæ•´å¹´åº¦è³‡æ–™</li>
                        </ul>
                        <p class="small text-muted">åŸ·è¡Œæ™‚é–“ï¼šæ¯å¹´1æœˆ1è™Ÿæ—©ä¸Š9é»å¾Œ</p>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-clock text-info"></i> åŸ·è¡Œæ™‚é–“èªªæ˜</h6>
                    <div id="execution_time_info">
                        <p class="small text-muted">è«‹é¸æ“‡å ±è¡¨é¡å‹ä»¥æŸ¥çœ‹è©³ç´°èªªæ˜</p>
                    </div>
                    <p class="small text-muted">â€» æœªè¨­å®šåŸ·è¡Œæ™‚é–“æ™‚ï¼Œç³»çµ±é è¨­åœ¨æ—©ä¸Š9é»å¾ŒåŸ·è¡Œ</p>
                    <p class="small text-muted">â€» æœªè¨­å®šåŸ·è¡Œæ—¥æœŸæ™‚ï¼Œé€±å ±è¡¨é è¨­é€±ä¸€ï¼Œæœˆå ±è¡¨é è¨­1è™Ÿï¼Œå¹´å ±è¡¨é è¨­1è™Ÿ</p>
                    
                    <hr>
                    
                    <h6><i class="fas fa-file-alt text-info"></i> æª”æ¡ˆæ ¼å¼èªªæ˜</h6>
                    <ul class="list-unstyled small">
                        <li>â€¢ <strong>HTMLæ ¼å¼ï¼š</strong>ç¶²é æ ¼å¼ï¼Œå¯ç”¨ç€è¦½å™¨é–‹å•ŸæŸ¥çœ‹</li>
                        <li>â€¢ <strong>Excelæ ¼å¼ï¼š</strong>Excelæª”æ¡ˆï¼Œå¯ç”¨Excelé–‹å•Ÿé€²è¡Œè³‡æ–™åˆ†æ</li>
                        <li>â€¢ <strong>HTML + Excelæ ¼å¼ï¼š</strong>åŒæ™‚ç™¼é€å…©ç¨®æ ¼å¼çš„æª”æ¡ˆ</li>
                    </ul>
                    
                    <hr>
                    
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> æ³¨æ„äº‹é …</h6>
                    <ul class="list-unstyled small">
                        <li>â€¢ æ’ç¨‹åç¨±å¿…é ˆå”¯ä¸€</li>
                        <li>â€¢ åŸ·è¡Œæ™‚é–“ç‚º24å°æ™‚åˆ¶</li>
                        <li>â€¢ æ”¶ä»¶äººä¿¡ç®±æ ¼å¼å¿…é ˆæ­£ç¢º</li>
                        <li>â€¢ åœç”¨çš„æ’ç¨‹ä¸æœƒè‡ªå‹•åŸ·è¡Œ</li>
                        <li>â€¢ å ±è¡¨æœƒè‡ªå‹•ç™¼é€åˆ°æŒ‡å®šä¿¡ç®±</li>
                        <li>â€¢ æ‰€æœ‰å ±è¡¨éƒ½æœƒè¨˜éŒ„åŸ·è¡Œæ—¥èªŒ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('report_type');
    const scheduleDayInput = document.getElementById('schedule_day');
    const scheduleDayHelp = document.getElementById('schedule_day_help');
    
    // æ ¹æ“šå ±è¡¨é¡å‹æ›´æ–°åŸ·è¡Œæ—¥æœŸçš„èªªæ˜
    function updateScheduleDayHelp() {
        const reportType = reportTypeSelect.value;
        const scheduleTimeInput = document.getElementById('schedule_time');
        const scheduleDayInput = document.getElementById('schedule_day');
        const scheduleDayHelp = document.getElementById('schedule_day_help');
        const executionTimeInfo = document.getElementById('execution_time_info');
        
        // å…ˆé‡ç½®æ‰€æœ‰å¿…å¡«é©—è­‰
        scheduleTimeInput.setAttribute('required', 'required');
        document.getElementById('company').setAttribute('required', 'required');
        
        // éš±è—æˆ–é¡¯ç¤ºç›¸é—œæ¬„ä½
        if (reportType === 'data_sync') {
            // å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥éœ€è¦é¡¯ç¤ºæ™‚é–“è¨­å®šé¸é …ï¼Œä½†ä¸éœ€è¦æª”æ¡ˆæ ¼å¼å’Œå…¬å¸ä»£è™Ÿ
            scheduleTimeInput.parentElement.style.display = 'none';
            scheduleDayInput.parentElement.style.display = 'none';
            document.getElementById('file_format_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'none';
            document.getElementById('sync_time_settings_row').style.display = 'block';
            
            // ç§»é™¤å¿…å¡«é©—è­‰
            scheduleTimeInput.removeAttribute('required');
            document.getElementById('company').removeAttribute('required');
            
            executionTimeInfo.innerHTML = '<p class="small text-success"><strong>ğŸ“Š å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥ï¼š</strong>å¯è¨­å®šé–“éš”åŸ·è¡Œæˆ–å›ºå®šæ™‚é–“åŸ·è¡Œï¼Œç„¡éœ€è¨­å®šåŸ·è¡Œæ™‚é–“å’Œå…¬å¸ä»£è™Ÿ</p>';
        } else if (reportType === 'previous_workday') {
            // å‰ä¸€å€‹å·¥ä½œæ—¥å ±è¡¨åªéœ€è¦åŸ·è¡Œæ™‚é–“
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'none';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            
            
            scheduleTimeInput.placeholder = 'å»ºè­°è¨­å®šç‚º 10:00';
            executionTimeInfo.innerHTML = '<p class="small text-info"><strong>ğŸ“… å‰ä¸€å€‹å·¥ä½œæ—¥å ±è¡¨ï¼š</strong>æ¯å¤©æ—©ä¸Š10é»å¾Œè‡ªå‹•åŸ·è¡Œï¼Œè€ƒæ…®å‡æœŸå’Œè£œç­æ—¥</p>';
        } else if (reportType.includes('week')) {
            // é€±å ±è¡¨ï¼šå¯è‡ªè¨‚é€±å¹¾
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = 'å»ºè­°è¨­å®šç‚º 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '7';
            scheduleDayInput.placeholder = '1-7';
            scheduleDayHelp.textContent = 'é€±å ±è¡¨ï¼šé€±å¹¾(1=é€±ä¸€, 2=é€±äºŒ, ..., 7=é€±æ—¥)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>ğŸ“ˆ é€±å ±è¡¨ï¼š</strong>å¯è‡ªè¨‚é€±å¹¾åŸ·è¡Œï¼ˆ1=é€±ä¸€, 7=é€±æ—¥ï¼‰ï¼Œå»ºè­°è¨­å®šç‚ºé€±ä¸€</p>';
        } else if (reportType.includes('month')) {
            // æœˆå ±è¡¨ï¼šå¯è‡ªè¨‚æ¯æœˆå¹¾è™Ÿ
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = 'å»ºè­°è¨­å®šç‚º 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '31';
            scheduleDayInput.placeholder = '1-31';
            scheduleDayHelp.textContent = 'æœˆå ±è¡¨ï¼šæ¯æœˆå¹¾è™Ÿ(1-31)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>ğŸ“Š æœˆå ±è¡¨ï¼š</strong>å¯è‡ªè¨‚æ¯æœˆå¹¾è™ŸåŸ·è¡Œï¼ˆ1-31ï¼‰ï¼Œå»ºè­°è¨­å®šç‚º1è™Ÿ</p>';
        } else if (reportType.includes('quarter')) {
            // å­£å ±è¡¨ï¼šå¯è‡ªè¨‚æ¯å­£ç¬¬å¹¾å¤©
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = 'å»ºè­°è¨­å®šç‚º 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '31';
            scheduleDayInput.placeholder = '1-31';
            scheduleDayHelp.textContent = 'å­£å ±è¡¨ï¼šæ¯å­£ç¬¬å¹¾å¤©(1-31)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>ğŸ“ˆ å­£å ±è¡¨ï¼š</strong>å¯è‡ªè¨‚æ¯å­£ç¬¬å¹¾å¤©åŸ·è¡Œï¼ˆ1-31ï¼‰ï¼Œå»ºè­°è¨­å®šç‚º1è™Ÿ</p>';
        } else if (reportType.includes('year')) {
            // å¹´å ±è¡¨ï¼šå¯è‡ªè¨‚æ¯å¹´å¹¾è™Ÿ
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = 'å»ºè­°è¨­å®šç‚º 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '31';
            scheduleDayInput.placeholder = '1-31';
            scheduleDayHelp.textContent = 'å¹´å ±è¡¨ï¼šæ¯å¹´å¹¾è™Ÿ(1-31)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>ğŸ“Š å¹´å ±è¡¨ï¼š</strong>å¯è‡ªè¨‚æ¯å¹´å¹¾è™ŸåŸ·è¡Œï¼ˆ1-31ï¼‰ï¼Œå»ºè­°è¨­å®šç‚º1è™Ÿ</p>';
        } else {
            // å…¶ä»–å ±è¡¨é¡å‹
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'none';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = 'å»ºè­°è¨­å®šç‚º 09:00';
            executionTimeInfo.innerHTML = '<p class="small text-muted">è«‹é¸æ“‡å ±è¡¨é¡å‹ä»¥æŸ¥çœ‹è©³ç´°èªªæ˜</p>';
        }
    }
    
    // ç›£è½å ±è¡¨é¡å‹è®Šæ›´
    reportTypeSelect.addEventListener('change', updateScheduleDayHelp);
    
    // ç›£è½å¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥åŸ·è¡Œæ–¹å¼è®ŠåŒ–
    const syncExecutionTypeSelect = document.getElementById('sync_execution_type');
    if (syncExecutionTypeSelect) {
        syncExecutionTypeSelect.addEventListener('change', function() {
            const intervalSettings = document.getElementById('interval_settings');
            const fixedTimeSettings = document.getElementById('fixed_time_settings');
            const intervalMinutesInput = document.getElementById('sync_interval_minutes');
            const fixedTimeInput = document.getElementById('sync_fixed_time');
            
            if (this.value === 'interval') {
                intervalSettings.style.display = 'block';
                fixedTimeSettings.style.display = 'none';
                intervalMinutesInput.setAttribute('required', 'required');
                fixedTimeInput.removeAttribute('required');
            } else if (this.value === 'fixed_time') {
                intervalSettings.style.display = 'none';
                fixedTimeSettings.style.display = 'block';
                intervalMinutesInput.removeAttribute('required');
                fixedTimeInput.setAttribute('required', 'required');
            }
        });
        
        // åˆå§‹åŒ–åŸ·è¡Œæ–¹å¼è¨­å®š
        syncExecutionTypeSelect.dispatchEvent(new Event('change'));
    }
    
    // åˆå§‹åŒ–èªªæ˜
    updateScheduleDayHelp();
    
    // è¡¨å–®é©—è­‰
    const form = document.getElementById('scheduleForm');
    form.addEventListener('submit', function(e) {
        console.log('è¡¨å–®æäº¤é–‹å§‹é©—è­‰...');
        
        const name = document.getElementById('name').value.trim();
        const reportType = document.getElementById('report_type').value;
        const company = document.getElementById('company').value.trim();
        const scheduleTime = document.getElementById('schedule_time').value;
        
        console.log('è¡¨å–®è³‡æ–™:', { name, reportType, company, scheduleTime });
        
        if (!name) {
            e.preventDefault();
            alert('è«‹è¼¸å…¥æ’ç¨‹åç¨±');
            console.log('é©—è­‰å¤±æ•—: ç¼ºå°‘æ’ç¨‹åç¨±');
            return false;
        }
        
        if (!reportType) {
            e.preventDefault();
            alert('è«‹é¸æ“‡å ±è¡¨é¡å‹');
            console.log('é©—è­‰å¤±æ•—: ç¼ºå°‘å ±è¡¨é¡å‹');
            return false;
        }
        
        // åªæœ‰éå¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥é¡å‹æ‰éœ€è¦é©—è­‰å…¬å¸ä»£è™Ÿ
        if (reportType !== 'data_sync' && !company) {
            e.preventDefault();
            alert('è«‹é¸æ“‡å…¬å¸ä»£è™Ÿ');
            console.log('é©—è­‰å¤±æ•—: ç¼ºå°‘å…¬å¸ä»£è™Ÿ');
            return false;
        }
        
        // åªæœ‰éå¡«å ±èˆ‡ç¾å ´è¨˜éŒ„è³‡æ–™åŒæ­¥é¡å‹æ‰éœ€è¦é©—è­‰åŸ·è¡Œæ™‚é–“
        if (reportType !== 'data_sync' && !scheduleTime) {
            e.preventDefault();
            alert('è«‹è¨­å®šåŸ·è¡Œæ™‚é–“');
            console.log('é©—è­‰å¤±æ•—: ç¼ºå°‘åŸ·è¡Œæ™‚é–“');
            return false;
        }
        
        // é©—è­‰æ”¶ä»¶äººä¿¡ç®±æ ¼å¼ï¼ˆå¦‚æœå¡«å¯«äº†çš„è©±ï¼‰
        const emailRecipients = document.getElementById('email_recipients').value.trim();
        if (emailRecipients) {
            const emails = emailRecipients.split(',').map(email => email.trim());
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            for (let email of emails) {
                if (email && !emailRegex.test(email)) {
                    e.preventDefault();
                    alert(`ä¿¡ç®±æ ¼å¼éŒ¯èª¤: ${email}`);
                    console.log('é©—è­‰å¤±æ•—: ä¿¡ç®±æ ¼å¼éŒ¯èª¤');
                    return false;
                }
            }
        }
        
        console.log('âœ… è¡¨å–®é©—è­‰é€šéï¼Œæº–å‚™æäº¤');
        // æ³¨æ„ï¼šæ”¶ä»¶äººä¿¡ç®±ä¸æ˜¯å¿…å¡«æ¬„ä½ï¼Œå¯ä»¥ä¸å¡«å¯«
    });
});
</script>
{% endblock %}
