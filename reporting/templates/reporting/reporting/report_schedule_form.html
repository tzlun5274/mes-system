{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if schedule %}編輯報表排程{% else %}新增報表排程{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}"><i class="fas fa-chart-bar"></i> 報表管理</a></li>
            <li class="breadcrumb-item"><a href="{% url 'reporting:report_schedule_list' %}">報表排程管理</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if schedule %}編輯排程{% else %}新增排程{% endif %}
            </li>
        </ol>
    </nav>

    <!-- 訊息顯示區塊 -->
    {% if messages %}
        <div class="messages-container mb-3">
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% elif message.tags == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">
                <i class="fas fa-clock text-primary"></i> 
                {% if schedule %}編輯報表排程{% else %}新增報表排程{% endif %}
            </h2>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> 
                        {% if schedule %}編輯排程設定{% else %}新增排程設定{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="scheduleForm">
                        {% csrf_token %}
                        
                        <!-- 基本資訊 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="name" class="form-label">
                                    <i class="fas fa-tag text-primary"></i> 排程名稱 <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ schedule.name|default:'' }}" required
                                       placeholder="請輸入排程名稱">
                                <div class="form-text">例如：週報表自動發送、月報表統計等</div>
                            </div>
                            <div class="col-md-6">
                                <label for="report_type" class="form-label">
                                    <i class="fas fa-chart-line text-primary"></i> 報表類型 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="report_type" name="report_type" required>
                                    <option value="">請選擇報表類型</option>
                                    {% for value, label in report_types %}
                                        <option value="{{ value }}" 
                                                {% if schedule.report_type == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6" id="company_field">
                                <label for="company" class="form-label">
                                    <i class="fas fa-building text-primary"></i> 公司代號 <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="">請選擇公司</option>
                                    <option value="ALL" 
                                            {% if schedule.company == 'ALL' %}selected{% endif %}>
                                        ALL - 所有公司
                                    </option>
                                    {% for company in companies %}
                                        <option value="{{ company.company_code }}" 
                                                {% if schedule.company == company.company_code %}selected{% endif %}>
                                            {{ company.company_code }} - {{ company.company_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">選擇要生成報表的公司，選擇「ALL」將包含所有公司</div>
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">
                                    <i class="fas fa-toggle-on text-primary"></i> 狀態
                                </label>
                                <select class="form-select" id="status" name="status">
                                    {% for value, label in status_choices %}
                                        <option value="{{ value }}" 
                                                {% if schedule.status == value or not schedule and value == 'active' %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3" id="file_format_row">
                            <div class="col-md-6">
                                <label for="file_format" class="form-label">
                                    <i class="fas fa-file-alt text-primary"></i> 檔案格式
                                </label>
                                <select class="form-select" id="file_format" name="file_format">
                                    {% for value, label in file_formats %}
                                        <option value="{{ value }}" 
                                                {% if schedule.file_format == value or not schedule and value == 'html' %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">選擇報表發送的檔案格式</div>
                            </div>
                        </div>

                        <!-- 填報與現場記錄資料同步時間設定 -->
                        <div class="row mb-3" id="sync_time_settings_row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-clock text-white"></i> 填報與現場記錄資料同步時間設定</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="sync_execution_type" class="form-label">
                                                    <i class="fas fa-cog text-primary"></i> 執行方式
                                                </label>
                                                <select class="form-select" id="sync_execution_type" name="sync_execution_type">
                                                    <option value="interval" {% if schedule.sync_execution_type == 'interval' or not schedule %}selected{% endif %}>間隔執行</option>
                                                    <option value="fixed_time" {% if schedule.sync_execution_type == 'fixed_time' %}selected{% endif %}>固定時間</option>
                                                </select>
                                                <div class="form-text">選擇填報與現場記錄資料同步的執行方式</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3" id="interval_settings">
                                            <div class="col-md-6">
                                                <label for="sync_interval_minutes" class="form-label">
                                                    <i class="fas fa-stopwatch text-primary"></i> 同步間隔（分鐘）
                                                </label>
                                                <input type="number" class="form-control" id="sync_interval_minutes" name="sync_interval_minutes" 
                                                       value="{% if schedule.sync_interval_minutes %}{{ schedule.sync_interval_minutes }}{% else %}60{% endif %}"
                                                       min="1" max="1440" required>
                                                <div class="form-text">每多少分鐘執行一次填報與現場記錄資料同步（1-1440分鐘）</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3" id="fixed_time_settings" style="display: none;">
                                            <div class="col-md-6">
                                                <label for="sync_fixed_time" class="form-label">
                                                    <i class="fas fa-clock text-primary"></i> 固定同步時間
                                                </label>
                                                <input type="time" class="form-control" id="sync_fixed_time" name="sync_fixed_time" 
                                                       value="{% if schedule.sync_fixed_time %}{{ schedule.sync_fixed_time|time:'H:i' }}{% endif %}">
                                                <div class="form-text">每天固定時間執行填報與現場記錄資料同步</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 排程設定 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-calendar-alt text-primary"></i> 排程設定</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="schedule_time" class="form-label">
                                            <i class="fas fa-clock text-primary"></i> 執行時間 <span class="text-danger">*</span>
                                        </label>
                                        <input type="time" class="form-control" id="schedule_time" name="schedule_time" 
                                               value="{{ schedule.schedule_time|time:'H:i'|default:'' }}" required>
                                        <div class="form-text">設定每日執行時間</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="schedule_day" class="form-label">
                                            <i class="fas fa-calendar-day text-primary"></i> 執行日期
                                        </label>
                                        <input type="number" class="form-control" id="schedule_day" name="schedule_day" 
                                               value="{{ schedule.schedule_day|default:'' }}" 
                                               min="1" max="31"
                                               placeholder="請選擇執行日期">
                                        <div class="form-text">
                                            <span id="schedule_day_help">週報表：週幾(1-7)，月報表：每月幾號(1-31)，年報表：每年幾號(1-31)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 收件人設定 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-envelope text-primary"></i> 收件人設定</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="email_recipients" class="form-label">
                                        <i class="fas fa-users text-primary"></i> 收件人信箱
                                    </label>
                                    <textarea class="form-control" id="email_recipients" name="email_recipients" 
                                              rows="3" placeholder="請輸入收件人信箱，多個信箱用逗號分隔">{{ schedule.email_recipients|default:'' }}</textarea>
                                    <div class="form-text">例如：user1@example.com, user2@example.com</div>
                                </div>
                            </div>
                        </div>

                        <!-- 按鈕區域 -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'reporting:report_schedule_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> 返回列表
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 
                                    {% if schedule %}更新排程{% else %}建立排程{% endif %}
                                </button>
                                {% if schedule %}
                                    <a href="{% url 'reporting:report_schedule_delete' schedule.id %}" 
                                       class="btn btn-danger ms-2"
                                       onclick="return confirm('確定要刪除此排程嗎？')">
                                        <i class="fas fa-trash"></i> 刪除排程
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 側邊說明 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle text-info"></i> 說明</h6>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb text-warning"></i> 報表類型說明</h6>
                    <div class="mb-3">
                        <h6 class="text-primary">📊 填報與現場記錄資料同步</h6>
                        <p class="small mb-2">每小時自動同步工單和填報資料，無需設定執行時間</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">📅 前一個工作日報表</h6>
                        <p class="small mb-2">每天早上10點後自動生成前一個工作日的報表，考慮假期和補班日</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">📈 週報表</h6>
                        <ul class="small mb-2">
                            <li><strong>本週報表：</strong>從週一到現在的工作資料</li>
                            <li><strong>上週報表：</strong>上週一到上週日的完整資料</li>
                        </ul>
                        <p class="small text-muted">執行時間：每週一早上9點後</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">📊 月報表</h6>
                        <ul class="small mb-2">
                            <li><strong>本月報表：</strong>從本月1號到現在的工作資料</li>
                            <li><strong>上月報表：</strong>上個月1號到月底的完整資料</li>
                        </ul>
                        <p class="small text-muted">執行時間：每月1號早上9點後</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">📈 季報表</h6>
                        <ul class="small mb-2">
                            <li><strong>本季報表：</strong>從本季第一天到現在的工作資料</li>
                            <li><strong>上季報表：</strong>上個季度的完整期間資料</li>
                        </ul>
                        <p class="small text-muted">執行時間：可自訂每季第幾天執行（1-31）</p>
                        <p class="small text-muted">季度定義：Q1(1-3月)、Q2(4-6月)、Q3(7-9月)、Q4(10-12月)</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-primary">📊 年報表</h6>
                        <ul class="small mb-2">
                            <li><strong>本年報表：</strong>從今年1月1號到現在的工作資料</li>
                            <li><strong>上年報表：</strong>去年的完整年度資料</li>
                        </ul>
                        <p class="small text-muted">執行時間：每年1月1號早上9點後</p>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-clock text-info"></i> 執行時間說明</h6>
                    <div id="execution_time_info">
                        <p class="small text-muted">請選擇報表類型以查看詳細說明</p>
                    </div>
                    <p class="small text-muted">※ 未設定執行時間時，系統預設在早上9點後執行</p>
                    <p class="small text-muted">※ 未設定執行日期時，週報表預設週一，月報表預設1號，年報表預設1號</p>
                    
                    <hr>
                    
                    <h6><i class="fas fa-file-alt text-info"></i> 檔案格式說明</h6>
                    <ul class="list-unstyled small">
                        <li>• <strong>HTML格式：</strong>網頁格式，可用瀏覽器開啟查看</li>
                        <li>• <strong>Excel格式：</strong>Excel檔案，可用Excel開啟進行資料分析</li>
                        <li>• <strong>HTML + Excel格式：</strong>同時發送兩種格式的檔案</li>
                    </ul>
                    
                    <hr>
                    
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> 注意事項</h6>
                    <ul class="list-unstyled small">
                        <li>• 排程名稱必須唯一</li>
                        <li>• 執行時間為24小時制</li>
                        <li>• 收件人信箱格式必須正確</li>
                        <li>• 停用的排程不會自動執行</li>
                        <li>• 報表會自動發送到指定信箱</li>
                        <li>• 所有報表都會記錄執行日誌</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('report_type');
    const scheduleDayInput = document.getElementById('schedule_day');
    const scheduleDayHelp = document.getElementById('schedule_day_help');
    
    // 根據報表類型更新執行日期的說明
    function updateScheduleDayHelp() {
        const reportType = reportTypeSelect.value;
        const scheduleTimeInput = document.getElementById('schedule_time');
        const scheduleDayInput = document.getElementById('schedule_day');
        const scheduleDayHelp = document.getElementById('schedule_day_help');
        const executionTimeInfo = document.getElementById('execution_time_info');
        
        // 先重置所有必填驗證
        scheduleTimeInput.setAttribute('required', 'required');
        document.getElementById('company').setAttribute('required', 'required');
        
        // 隱藏或顯示相關欄位
        if (reportType === 'data_sync') {
            // 填報與現場記錄資料同步需要顯示時間設定選項，但不需要檔案格式和公司代號
            scheduleTimeInput.parentElement.style.display = 'none';
            scheduleDayInput.parentElement.style.display = 'none';
            document.getElementById('file_format_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'none';
            document.getElementById('sync_time_settings_row').style.display = 'block';
            
            // 移除必填驗證
            scheduleTimeInput.removeAttribute('required');
            document.getElementById('company').removeAttribute('required');
            
            executionTimeInfo.innerHTML = '<p class="small text-success"><strong>📊 填報與現場記錄資料同步：</strong>可設定間隔執行或固定時間執行，無需設定執行時間和公司代號</p>';
        } else if (reportType === 'previous_workday') {
            // 前一個工作日報表只需要執行時間
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'none';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            
            
            scheduleTimeInput.placeholder = '建議設定為 10:00';
            executionTimeInfo.innerHTML = '<p class="small text-info"><strong>📅 前一個工作日報表：</strong>每天早上10點後自動執行，考慮假期和補班日</p>';
        } else if (reportType.includes('week')) {
            // 週報表：可自訂週幾
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = '建議設定為 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '7';
            scheduleDayInput.placeholder = '1-7';
            scheduleDayHelp.textContent = '週報表：週幾(1=週一, 2=週二, ..., 7=週日)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>📈 週報表：</strong>可自訂週幾執行（1=週一, 7=週日），建議設定為週一</p>';
        } else if (reportType.includes('month')) {
            // 月報表：可自訂每月幾號
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = '建議設定為 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '31';
            scheduleDayInput.placeholder = '1-31';
            scheduleDayHelp.textContent = '月報表：每月幾號(1-31)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>📊 月報表：</strong>可自訂每月幾號執行（1-31），建議設定為1號</p>';
        } else if (reportType.includes('quarter')) {
            // 季報表：可自訂每季第幾天
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = '建議設定為 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '31';
            scheduleDayInput.placeholder = '1-31';
            scheduleDayHelp.textContent = '季報表：每季第幾天(1-31)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>📈 季報表：</strong>可自訂每季第幾天執行（1-31），建議設定為1號</p>';
        } else if (reportType.includes('year')) {
            // 年報表：可自訂每年幾號
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'block';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = '建議設定為 09:00';
            scheduleDayInput.min = '1';
            scheduleDayInput.max = '31';
            scheduleDayInput.placeholder = '1-31';
            scheduleDayHelp.textContent = '年報表：每年幾號(1-31)';
            executionTimeInfo.innerHTML = '<p class="small text-primary"><strong>📊 年報表：</strong>可自訂每年幾號執行（1-31），建議設定為1號</p>';
        } else {
            // 其他報表類型
            scheduleTimeInput.parentElement.style.display = 'block';
            scheduleDayInput.parentElement.style.display = 'none';
            document.getElementById('file_format_row').style.display = 'block';
            document.getElementById('sync_time_settings_row').style.display = 'none';
            document.getElementById('company_field').style.display = 'block';
            scheduleTimeInput.placeholder = '建議設定為 09:00';
            executionTimeInfo.innerHTML = '<p class="small text-muted">請選擇報表類型以查看詳細說明</p>';
        }
    }
    
    // 監聽報表類型變更
    reportTypeSelect.addEventListener('change', updateScheduleDayHelp);
    
    // 監聽填報與現場記錄資料同步執行方式變化
    const syncExecutionTypeSelect = document.getElementById('sync_execution_type');
    if (syncExecutionTypeSelect) {
        syncExecutionTypeSelect.addEventListener('change', function() {
            const intervalSettings = document.getElementById('interval_settings');
            const fixedTimeSettings = document.getElementById('fixed_time_settings');
            const intervalMinutesInput = document.getElementById('sync_interval_minutes');
            const fixedTimeInput = document.getElementById('sync_fixed_time');
            
            if (this.value === 'interval') {
                intervalSettings.style.display = 'block';
                fixedTimeSettings.style.display = 'none';
                intervalMinutesInput.setAttribute('required', 'required');
                fixedTimeInput.removeAttribute('required');
            } else if (this.value === 'fixed_time') {
                intervalSettings.style.display = 'none';
                fixedTimeSettings.style.display = 'block';
                intervalMinutesInput.removeAttribute('required');
                fixedTimeInput.setAttribute('required', 'required');
            }
        });
        
        // 初始化執行方式設定
        syncExecutionTypeSelect.dispatchEvent(new Event('change'));
    }
    
    // 初始化說明
    updateScheduleDayHelp();
    
    // 表單驗證
    const form = document.getElementById('scheduleForm');
    form.addEventListener('submit', function(e) {
        console.log('表單提交開始驗證...');
        
        const name = document.getElementById('name').value.trim();
        const reportType = document.getElementById('report_type').value;
        const company = document.getElementById('company').value.trim();
        const scheduleTime = document.getElementById('schedule_time').value;
        
        console.log('表單資料:', { name, reportType, company, scheduleTime });
        
        if (!name) {
            e.preventDefault();
            alert('請輸入排程名稱');
            console.log('驗證失敗: 缺少排程名稱');
            return false;
        }
        
        if (!reportType) {
            e.preventDefault();
            alert('請選擇報表類型');
            console.log('驗證失敗: 缺少報表類型');
            return false;
        }
        
        // 只有非填報與現場記錄資料同步類型才需要驗證公司代號
        if (reportType !== 'data_sync' && !company) {
            e.preventDefault();
            alert('請選擇公司代號');
            console.log('驗證失敗: 缺少公司代號');
            return false;
        }
        
        // 只有非填報與現場記錄資料同步類型才需要驗證執行時間
        if (reportType !== 'data_sync' && !scheduleTime) {
            e.preventDefault();
            alert('請設定執行時間');
            console.log('驗證失敗: 缺少執行時間');
            return false;
        }
        
        // 驗證收件人信箱格式（如果填寫了的話）
        const emailRecipients = document.getElementById('email_recipients').value.trim();
        if (emailRecipients) {
            const emails = emailRecipients.split(',').map(email => email.trim());
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            for (let email of emails) {
                if (email && !emailRegex.test(email)) {
                    e.preventDefault();
                    alert(`信箱格式錯誤: ${email}`);
                    console.log('驗證失敗: 信箱格式錯誤');
                    return false;
                }
            }
        }
        
        console.log('✅ 表單驗證通過，準備提交');
        // 注意：收件人信箱不是必填欄位，可以不填寫
    });
});
</script>
{% endblock %}
