{% extends 'base.html' %}
{% load static %}

{% block title %}日報表 - {{ operator }} - {{ date }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}"><i class="fas fa-chart-bar"></i> 報表管理</a></li>
            <li class="breadcrumb-item"><a href="{% url 'reporting:work_hour_report_index' %}">工作時數報表</a></li>
            <li class="breadcrumb-item active" aria-current="page">日報表</li>
        </ol>
    </nav>

    <!-- 選擇功能 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-search"></i> 查詢條件</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="reportForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="company" class="form-label">公司名稱</label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="all" {% if company == 'all' %}selected{% endif %}>全部公司</option>
                                    {% for comp in companies %}
                                    <option value="{{ comp }}" {% if company == comp %}selected{% endif %}>{{ comp }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="operator" class="form-label">作業員</label>
                                <select class="form-select" id="operator" name="operator" required>
                                    <option value="all" {% if operator == 'all' %}selected{% endif %}>全部作業員</option>
                                    {% for op in operators %}
                                    <option value="{{ op }}" {% if operator == op %}selected{% endif %}>{{ op }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="date" class="form-label">報表日期</label>
                                <input type="date" class="form-control" id="date" name="date" value="{{ date|date:'Y-m-d' }}" required>
                            </div>
                            <div class="col-md-3 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> 查詢
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo"></i> 重置
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 報表標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-calendar-day text-primary"></i> 日報表
                </h2>
                <div>
                    <a href="{% url 'reporting:work_hour_report_index' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> 返回
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                        <i class="fas fa-print"></i> 列印
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 報表資訊 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> 報表資訊</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <strong>公司名稱：</strong> {{ company }}
                        </div>
                        <div class="col-md-2">
                            <strong>作業員：</strong> {{ operator }}
                        </div>
                        <div class="col-md-2">
                            <strong>報表日期：</strong> {{ date|date:"Y-m-d" }}
                        </div>
                        <div class="col-md-2">
                            <strong>報表類型：</strong> {{ report_type }}
                        </div>
                        <div class="col-md-4">
                            <strong>生成時間：</strong> {{ generated_at|date:"Y-m-d H:i:s" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 統計摘要 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> 統計摘要</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h3 class="text-primary">{{ summary.total_work_hours|floatformat:2 }}</h3>
                                <p class="text-muted">總工作時數</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h3 class="text-success">{{ summary.total_operators }}</h3>
                                <p class="text-muted">總作業員數</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h3 class="text-info">{{ summary.total_equipment_hours|floatformat:2 }}</h3>
                                <p class="text-muted">總設備使用時數</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="stat-item">
                                <h3 class="text-warning">{{ summary.workorder_count }}</h3>
                                <p class="text-muted">工單數量</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> 工作列表</h5>
                </div>
                <div class="card-body">
                    <!-- 標籤切換 -->
                    <ul class="nav nav-tabs" id="workListTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="true">
                                <i class="fas fa-table"></i> 詳細
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab" aria-controls="statistics" aria-selected="false">
                                <i class="fas fa-chart-bar"></i> 統計
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 標籤內容 -->
                    <div class="tab-content" id="workListTabContent">
                        <!-- 詳細標籤 -->
                        <div class="tab-pane fade show active" id="detail" role="tabpanel" aria-labelledby="detail-tab">
                            {% if data %}
                                <div class="table-responsive mt-3">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>作業員</th>
                                                <th>公司名稱</th>
                                                <th>工單編號</th>
                                                <th>產品編號</th>
                                                <th>工序</th>
                                                <th>工作日期</th>
                                                <th>開始時間</th>
                                                <th>結束時間</th>
                                                <th>工作時數</th>
                                                <th>加班時數</th>
                                                <th>合計時數</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in data %}
                                            <tr>
                                                <td>{{ item.operator_name|default:"-" }}</td>
                                                <td>{{ item.company|default:"-" }}</td>
                                                <td>{{ item.workorder_id }}</td>
                                                <td>{{ item.product_code|default:"-" }}</td>
                                                <td>{{ item.process_name|default:"-" }}</td>
                                                <td>{{ item.work_date|date:"Y-m-d" }}</td>
                                                <td>{{ item.start_time|default:"-" }}</td>
                                                <td>{{ item.end_time|default:"-" }}</td>
                                                <td>{{ item.work_hours|floatformat:2|default:"0.00" }}</td>
                                                <td>{{ item.overtime_hours|floatformat:2|default:"0.00" }}</td>
                                                <td>{{ item.total_hours|floatformat:2|default:"0.00" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">暫無資料</h5>
                                    <p class="text-muted">所選日期沒有工作時數資料</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- 統計標籤 -->
                        <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-table"></i> 作業員統計摘要</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>排名</th>
                                                            <th>作業員</th>
                                                            <th>工作時數</th>
                                                            <th>加班時數</th>
                                                            <th>合計時數</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="operatorStatsTable">
                                                        <!-- 統計資料將由 JavaScript 動態載入 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 匯出選項 -->
    {% if data %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-download"></i> 匯出報表</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-grid">
                                <a href="{% url 'reporting:daily_report_export' %}?operator={{ operator }}&date={{ date|date:'Y-m-d' }}&format=excel" class="btn btn-success">
                                    <i class="fas fa-file-excel"></i> 匯出 Excel 格式
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-grid">
                                <a href="{% url 'reporting:daily_report_export' %}?operator={{ operator }}&date={{ date|date:'Y-m-d' }}&format=csv" class="btn btn-info">
                                    <i class="fas fa-file-csv"></i> 匯出 CSV 格式
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-grid">
                                <button type="button" class="btn btn-warning" onclick="window.print()">
                                    <i class="fas fa-print"></i> 列印報表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.stat-item {
    padding: 20px;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin-bottom: 15px;
}

.stat-item h3 {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.table th {
    font-weight: 600;
}

@media print {
    .btn, .breadcrumb, .card-header {
        display: none !important;
    }
    
    .card {
        box-shadow: none !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .container-fluid {
        max-width: 100% !important;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 初始化頁面
document.addEventListener('DOMContentLoaded', function() {
    // 監聽標籤切換事件
    const statisticsTab = document.getElementById('statistics-tab');
    if (statisticsTab) {
        statisticsTab.addEventListener('shown.bs.tab', function() {
            loadOperatorStatistics();
        });
    }
});

function loadOperatorStatistics() {
    // 從當前頁面資料計算作業員統計
    const data = [
        {% for item in data %}
        {
            operator_name: '{{ item.operator_name|default:"" }}',
            work_hours: {{ item.work_hours|default:0 }},
            overtime_hours: {{ item.overtime_hours|default:0 }},
            total_hours: {{ item.total_hours|default:0 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    if (!data || data.length === 0) {
        document.getElementById('operatorStatsTable').innerHTML = '<tr><td colspan="5" class="text-center text-muted">暫無資料</td></tr>';
        return;
    }
    
    // 計算作業員統計
    const operatorStats = {};
    
    data.forEach(item => {
        const operator = item.operator_name || '未指定';
        if (!operatorStats[operator]) {
            operatorStats[operator] = {
                work_hours: 0,
                overtime_hours: 0,
                total_hours: 0
            };
        }
        operatorStats[operator].work_hours += parseFloat(item.work_hours || 0);
        operatorStats[operator].overtime_hours += parseFloat(item.overtime_hours || 0);
        operatorStats[operator].total_hours += parseFloat(item.total_hours || 0);
    });
    
    // 排序作業員（按合計時數降序）
    const sortedOperators = Object.entries(operatorStats).sort((a, b) => b[1].total_hours - a[1].total_hours);
    
    // 更新統計表格
    const tbody = document.getElementById('operatorStatsTable');
    tbody.innerHTML = '';
    
    sortedOperators.forEach(([operator, stats], index) => {
        // 根據排名設定不同的樣式
        let rankClass = '';
        if (index === 0) rankClass = 'table-warning'; // 第一名
        else if (index === 1) rankClass = 'table-light'; // 第二名
        else if (index === 2) rankClass = 'table-info'; // 第三名
        
        const row = `
            <tr class="${rankClass}">
                <td><strong>${index + 1}</strong></td>
                <td>${operator}</td>
                <td>${stats.work_hours.toFixed(2)}</td>
                <td>${stats.overtime_hours.toFixed(2)}</td>
                <td>${stats.total_hours.toFixed(2)}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}
</script>
{% endblock %}
