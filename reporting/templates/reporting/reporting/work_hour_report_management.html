{% extends 'base.html' %}
{% load static %}

{% block title %}工作時數報表檔案管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}"><i class="fas fa-chart-bar"></i> 報表管理</a></li>
            <li class="breadcrumb-item"><a href="{% url 'reporting:work_hour_report_index' %}"><i class="fas fa-clock"></i> 工作時數報表</a></li>
            <li class="breadcrumb-item active" aria-current="page">檔案管理</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">
                <i class="fas fa-file-alt text-primary"></i> 工作時數報表檔案管理
            </h2>
            <p class="text-muted">管理最近生成的工作時數報表檔案</p>
        </div>
    </div>

    <!-- 統計資訊 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_files }}</h4>
                            <p class="mb-0">總檔案數</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ report_files|length }}</h4>
                            <p class="mb-0">顯示檔案</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ excel_count }}</h4>
                            <p class="mb-0">Excel 檔案</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-excel fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ html_count }}</h4>
                            <p class="mb-0">HTML 檔案</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-code fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按鈕 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-tools text-primary"></i> 操作工具</h5>
                        </div>
                        <div>
                            <a href="{% url 'reporting:work_hour_report_index' %}" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left"></i> 返回工作時數報表
                            </a>
                            <button class="btn btn-success" onclick="location.reload()">
                                <i class="fas fa-sync-alt"></i> 重新整理
                            </button>
                            <button class="btn btn-danger" onclick="batchDeleteFiles()">
                                <i class="fas fa-trash-alt"></i> 批次刪除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 檔案列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list text-primary"></i> 最近生成的工作時數報表檔案
                    </h5>
                </div>
                <div class="card-body">
                    {% if report_files %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                            <label for="selectAll" class="ms-2">全選</label>
                                        </th>
                                        <th><i class="fas fa-file text-primary"></i> 檔案名稱</th>
                                        <th><i class="fas fa-tag text-primary"></i> 類型</th>
                                        <th><i class="fas fa-weight text-primary"></i> 大小</th>
                                        <th><i class="fas fa-clock text-primary"></i> 修改時間</th>
                                        <th><i class="fas fa-cogs text-primary"></i> 操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in report_files %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="file-checkbox" value="{{ file.name }}" onchange="updateSelectAllStatus()">
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if file.type == 'Excel' %}
                                                    <i class="fas fa-file-excel text-success me-2"></i>
                                                {% elif file.type == 'HTML' %}
                                                    <i class="fas fa-file-code text-info me-2"></i>
                                                {% elif file.type == 'PDF' %}
                                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                                {% else %}
                                                    <i class="fas fa-file text-secondary me-2"></i>
                                                {% endif %}
                                                <span class="text-truncate" style="max-width: 300px;" title="{{ file.name }}">
                                                    {{ file.name }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge 
                                                {% if file.type == 'Excel' %}bg-success
                                                {% elif file.type == 'HTML' %}bg-info
                                                {% elif file.type == 'PDF' %}bg-danger
                                                {% else %}bg-secondary{% endif %}">
                                                {{ file.type }}
                                            </span>
                                        </td>
                                        <td>
                                            {{ file.size_text }}
                                        </td>
                                        <td>
                                            <span class="text-muted">
                                                {{ file.time|date:"Y-m-d H:i:s" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-eye"></i> 檢視
                                                </a>
                                                <a href="{{ file.url }}" class="btn btn-sm btn-outline-success" download>
                                                    <i class="fas fa-download"></i> 下載
                                                </a>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('{{ file.name }}')">
                                                    <i class="fas fa-trash"></i> 刪除
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">目前沒有工作時數報表檔案</h5>
                            <p class="text-muted">請先執行工作時數報表生成，檔案將會顯示在這裡</p>
                            <a href="{% url 'reporting:work_hour_report_index' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 生成報表
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function deleteFile(filename) {
    if (confirm('確定要刪除檔案 "' + filename + '" 嗎？此操作無法復原。')) {
        // 這裡可以添加刪除檔案的 AJAX 請求
        alert('檔案刪除功能正在開發中，請手動刪除檔案。');
    }
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    
    fileCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

function updateSelectAllStatus() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const fileCheckboxes = document.querySelectorAll('.file-checkbox');
    const checkedCount = document.querySelectorAll('.file-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedCount === fileCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }
}

function batchDeleteFiles() {
    const selectedFiles = document.querySelectorAll('.file-checkbox:checked');
    
    if (selectedFiles.length === 0) {
        alert('請先選擇要刪除的檔案。');
        return;
    }
    
    const fileNames = Array.from(selectedFiles).map(checkbox => checkbox.value);
    const confirmMessage = `確定要刪除以下 ${fileNames.length} 個檔案嗎？\n\n` + 
                          fileNames.join('\n') + '\n\n此操作無法復原。';
    
    if (confirm(confirmMessage)) {
        // 顯示載入中
        const batchDeleteBtn = document.querySelector('button[onclick="batchDeleteFiles()"]');
        const originalText = batchDeleteBtn.innerHTML;
        batchDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刪除中...';
        batchDeleteBtn.disabled = true;
        
        // 發送 AJAX 請求
        fetch('{% url "reporting:batch_delete_files" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                files: fileNames
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`刪除成功！\n\n成功刪除：${data.deleted_files.length} 個檔案\n${data.failed_files.length > 0 ? '刪除失敗：' + data.failed_files.join(', ') : ''}`);
                // 重新載入頁面
                location.reload();
            } else {
                alert('刪除失敗：' + data.message);
            }
        })
        .catch(error => {
            console.error('刪除錯誤:', error);
            alert('刪除失敗：' + error.message);
        })
        .finally(() => {
            // 恢復按鈕狀態
            batchDeleteBtn.innerHTML = originalText;
            batchDeleteBtn.disabled = false;
        });
    }
}

// 自動重新整理（每5分鐘）
setTimeout(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}
