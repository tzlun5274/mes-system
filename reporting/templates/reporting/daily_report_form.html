{% extends 'base.html' %}

{% block title %}日報表{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 麵包屑導航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}">報表管理</a></li>
            <li class="breadcrumb-item"><a href="{% url 'reporting:work_hour_report_index' %}">工作時數報表</a></li>
            <li class="breadcrumb-item active" aria-current="page">日報表</li>
        </ol>
    </nav>

    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="report-main-title">
                <i class="fas fa-calendar-day"></i> 日報表
            </h2>
        </div>
    </div>

    <!-- 報表設定 -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> 報表設定</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="operator" class="form-label">作業員</label>
                                <select class="form-select" id="operator" name="operator">
                                    <option value="all">所有作業員</option>
                                    {% for operator in operators %}
                                        <option value="{{ operator }}">{{ operator }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="date" class="form-label">日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="date" name="date" value="{{ current_date|date:'Y-m-d' }}" required>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="format" class="form-label">輸出格式</label>
                                <select class="form-select" id="format" name="format">
                                    <option value="web">網頁顯示</option>
                                    <option value="excel">Excel檔案</option>
                                    <option value="csv">CSV檔案</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="d-grid">
                                    <button type="button" id="generateReport" class="btn btn-primary">
                                        <i class="fas fa-chart-bar"></i> 生成日報表
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 報表顯示區域 -->
    <div id="reportDisplay" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 報表預覽</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="switchView('summary')">
                            <i class="fas fa-chart-pie"></i> 統計摘要
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="switchView('operator')">
                            <i class="fas fa-users"></i> 作業員統計
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="switchView('detail')">
                            <i class="fas fa-list"></i> 明細記錄
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 載入中提示 -->
                    <div id="loadingIndicator" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p class="mt-2">正在生成報表，請稍候...</p>
                    </div>
                    
                    <!-- 統計摘要視圖 -->
                    <div id="summaryView" class="report-view">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalOperators">-</h4>
                                        <p class="mb-0">作業員數</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalWorkHours">-</h4>
                                        <p class="mb-0">總工作時數</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalWorkOrders">-</h4>
                                        <p class="mb-0">完成工單數</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 id="avgEfficiency">-</h4>
                                        <p class="mb-0">平均效率</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 作業員統計視圖 -->
                    <div id="operatorView" class="report-view" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>作業員</th>
                                        <th>工作時數</th>
                                        <th>完成工單數</th>
                                        <th>效率</th>
                                        <th>出勤狀態</th>
                                    </tr>
                                </thead>
                                <tbody id="operatorTableBody">
                                    <!-- 動態載入資料 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 明細記錄視圖 -->
                    <div id="detailView" class="report-view" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>工單號</th>
                                        <th>作業員</th>
                                        <th>開始時間</th>
                                        <th>結束時間</th>
                                        <th>工作時數</th>
                                        <th>完成狀態</th>
                                    </tr>
                                </thead>
                                <tbody id="detailTableBody">
                                    <!-- 動態載入資料 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 報表說明 -->
    <div class="row mt-4">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> 報表說明</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-list text-primary"></i> 報表內容</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> 每日工作時數統計</li>
                                <li><i class="fas fa-check text-success"></i> 作業員出勤記錄</li>
                                <li><i class="fas fa-check text-success"></i> 工單完成狀況</li>
                                <li><i class="fas fa-check text-success"></i> 設備使用時數</li>
                                <li><i class="fas fa-check text-success"></i> 效率分析</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-file-excel text-primary"></i> 匯出格式</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-globe text-success"></i> 網頁顯示：即時預覽報表內容</li>
                                <li><i class="fas fa-file-excel text-success"></i> Excel格式：包含統計摘要、作業員統計、明細記錄</li>
                                <li><i class="fas fa-file-csv text-info"></i> CSV格式：純文字格式，適合資料分析</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    const operatorSelect = document.getElementById('operator');
    const formatSelect = document.getElementById('format');
    const generateBtn = document.getElementById('generateReport');
    const reportDisplay = document.getElementById('reportDisplay');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // 生成報表
    function generateReport() {
        const date = dateInput.value;
        const operator = operatorSelect.value;
        const format = formatSelect.value;
        
        if (!date) {
            alert('請選擇日期');
            return;
        }
        
        // 顯示載入中
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
        generateBtn.disabled = true;
        
        if (format === 'web') {
            // 網頁顯示模式
            reportDisplay.style.display = 'block';
            loadingIndicator.style.display = 'block';
            
            // 隱藏所有視圖
            document.querySelectorAll('.report-view').forEach(view => {
                view.style.display = 'none';
            });
            
            // 發送 AJAX 請求
            const formData = new FormData();
            formData.append('operator', operator);
            formData.append('date', date);
            formData.append('format', 'web');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            
            fetch('{% url "reporting:operator_daily_report" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    generateReportHTML(data);
                    switchView('summary');
                } else {
                    alert('生成報表失敗：' + (data.error || '未知錯誤'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('生成報表時發生錯誤');
            })
            .finally(() => {
                generateBtn.innerHTML = '<i class="fas fa-chart-bar"></i> 生成日報表';
                generateBtn.disabled = false;
                loadingIndicator.style.display = 'none';
            });
        } else {
            // Excel 或 CSV 匯出模式
            // 建立表單並提交
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "reporting:operator_daily_report" %}';
            
            // 添加 CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken.value;
                form.appendChild(csrfInput);
            }
            
            // 添加參數
            const operatorInput = document.createElement('input');
            operatorInput.type = 'hidden';
            operatorInput.name = 'operator';
            operatorInput.value = operator;
            form.appendChild(operatorInput);
            
            const dateInputHidden = document.createElement('input');
            dateInputHidden.type = 'hidden';
            dateInputHidden.name = 'date';
            dateInputHidden.value = date;
            form.appendChild(dateInputHidden);
            
            const formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'format';
            formatInput.value = format;
            form.appendChild(formatInput);
            
            // 提交表單
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            
            // 3秒後恢復按鈕狀態
            setTimeout(() => {
                generateBtn.innerHTML = '<i class="fas fa-chart-bar"></i> 生成日報表';
                generateBtn.disabled = false;
            }, 3000);
        }
    }
    
    // 生成報表 HTML
    function generateReportHTML(data) {
        // 更新統計摘要
        if (data.summary) {
            document.getElementById('totalOperators').textContent = data.summary.total_operators || 0;
            document.getElementById('totalWorkHours').textContent = (data.summary.total_work_hours || 0).toFixed(1) + 'h';
            document.getElementById('totalWorkOrders').textContent = data.summary.total_work_orders || 0;
            document.getElementById('avgEfficiency').textContent = (data.summary.avg_efficiency || 0).toFixed(1) + '%';
        }
        
        // 更新作業員統計表格
        if (data.operator_stats) {
            const operatorTableBody = document.getElementById('operatorTableBody');
            operatorTableBody.innerHTML = '';
            
            data.operator_stats.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.operator_name || '未知'}</td>
                    <td>${(stat.total_work_hours || 0).toFixed(1)}h</td>
                    <td>${stat.completed_work_orders || 0}</td>
                    <td>${(stat.efficiency || 0).toFixed(1)}%</td>
                    <td><span class="badge bg-success">出勤</span></td>
                `;
                operatorTableBody.appendChild(row);
            });
        }
        
        // 更新明細記錄表格
        if (data.detail_records) {
            const detailTableBody = document.getElementById('detailTableBody');
            detailTableBody.innerHTML = '';
            
            data.detail_records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.workorder_id || '-'}</td>
                    <td>${record.operator_name || '未知'}</td>
                    <td>${record.start_time || '-'}</td>
                    <td>${record.end_time || '-'}</td>
                    <td>${(record.work_hours || 0).toFixed(1)}h</td>
                    <td><span class="badge bg-success">已完成</span></td>
                `;
                detailTableBody.appendChild(row);
            });
        }
    }
    
    // 切換視圖
    window.switchView = function(viewType) {
        // 隱藏所有視圖
        document.querySelectorAll('.report-view').forEach(view => {
            view.style.display = 'none';
        });
        
        // 顯示選中的視圖
        document.getElementById(viewType + 'View').style.display = 'block';
        
        // 更新按鈕狀態
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    };
    
    // 綁定事件
    generateBtn.addEventListener('click', generateReport);
});
</script>
{% endblock %}
