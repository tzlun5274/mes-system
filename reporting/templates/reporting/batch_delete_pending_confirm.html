{% extends 'base.html' %}
{% load static %}

{% block title %}批次刪除待核准報工記錄 - 確認頁面{% endblock %}

{% block extra_head %}
<style>
    .confirm-container {
        padding: 20px;
    }
    
    .warning-card {
        border: 2px solid #dc3545;
        border-radius: 8px;
        background-color: #fff5f5;
    }
    
    .warning-header {
        background-color: #dc3545;
        color: white;
        padding: 15px;
        border-radius: 6px 6px 0 0;
    }
    
    .warning-body {
        padding: 20px;
    }
    
    .stats-card {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
    }
    
    .stats-number {
        font-size: 2em;
        font-weight: bold;
        color: #dc3545;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .danger-zone {
        background-color: #fff5f5;
        border: 1px solid #dc3545;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .btn-danger-large {
        font-size: 1.2em;
        padding: 15px 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-exclamation-triangle text-danger"></i> 批次刪除待核准報工記錄
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'workorder:index' %}">工單管理</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'reporting:index' %}">報表管理</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'reporting:pending_approval_list' %}">待審核清單</a></li>
                        <li class="breadcrumb-item active" aria-current="page">批次刪除確認</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- 警告訊息 -->
    <div class="row">
        <div class="col-12">
            <div class="warning-card">
                <div class="warning-header">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 危險操作警告
                    </h4>
                </div>
                <div class="warning-body">
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> 重要提醒</h5>
                        <p class="mb-2">此操作將<strong>永久刪除</strong>所有待核准的報工記錄，且無法復原！</p>
                        <ul class="mb-0">
                            <li>此操作僅限超級管理員執行</li>
                            <li>刪除後無法復原</li>
                            <li>建議在執行前先備份資料</li>
                            <li>請確認您真的要執行此操作</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 統計資訊 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number">{{ operator_pending_count }}</div>
                <div class="stats-label">作業員報工記錄</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number">{{ smt_pending_count }}</div>
                <div class="stats-label">SMT報工記錄</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="stats-number">{{ total_pending_count }}</div>
                <div class="stats-label">總計記錄</div>
            </div>
        </div>
    </div>

    <!-- 危險操作區域 -->
    <div class="row">
        <div class="col-12">
            <div class="danger-zone">
                <h4 class="text-danger mb-3">
                    <i class="fas fa-skull-crossbones"></i> 危險操作區域
                </h4>
                
                {% if total_pending_count > 0 %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-info-circle"></i> 即將刪除的記錄</h6>
                        <p class="mb-2">您即將刪除以下記錄：</p>
                        <ul class="mb-0">
                            <li><strong>作業員報工記錄：</strong>{{ operator_pending_count }} 筆</li>
                            <li><strong>SMT報工記錄：</strong>{{ smt_pending_count }} 筆</li>
                            <li><strong>總計：</strong>{{ total_pending_count }} 筆</li>
                        </ul>
                    </div>
                    
                    <form method="post" action="{% url 'reporting:batch_delete_pending_reports' %}" id="batchDeleteForm">
                        {% csrf_token %}
                        <div class="text-center">
                            <button type="submit" class="btn btn-danger btn-danger-large" onclick="return confirmDelete()">
                                <i class="fas fa-trash-alt"></i> 確認刪除所有待核准記錄
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> 無記錄可刪除</h6>
                        <p class="mb-0">目前沒有待核准的報工記錄，無需執行刪除操作。</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 操作按鈕 -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'reporting:pending_approval_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 返回待審核清單
            </a>
            <a href="{% url 'reporting:index' %}" class="btn btn-primary">
                <i class="fas fa-home"></i> 返回報表管理首頁
            </a>
        </div>
    </div>
    
    <!-- 超級管理員強制刪除功能 -->
    {% if user.is_superuser %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 超級管理員強制刪除功能
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-warning"></i> 極度危險操作</h6>
                        <p class="mb-2">此功能將刪除<strong>所有</strong>報工記錄，包括：</p>
                        <ul class="mb-0">
                            <li><strong>已核准的記錄</strong></li>
                            <li><strong>已駁回的記錄</strong></li>
                            <li><strong>待核准的記錄</strong></li>
                        </ul>
                        <p class="mb-0 mt-2"><strong>⚠️ 此操作無法復原，請務必謹慎使用！</strong></p>
                    </div>
                    
                    <form method="post" action="{% url 'reporting:force_delete_all_reports' %}" id="forceDeleteForm">
                        {% csrf_token %}
                        <div class="text-center">
                            <button type="submit" class="btn btn-danger btn-lg" onclick="return confirmForceDelete()">
                                <i class="fas fa-trash-alt"></i> 強制刪除所有報工記錄
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete() {
    const totalCount = {{ total_pending_count }};
    const message = `您確定要永久刪除所有 ${totalCount} 筆待核准報工記錄嗎？\n\n此操作無法復原！`;
    
    if (!confirm(message)) {
        return false;
    }
    
    // 顯示載入中訊息
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刪除中...';
    submitBtn.disabled = true;
    
    // 確保 CSRF token 存在
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken || !csrfToken.value) {
        alert('CSRF token 遺失，請重新整理頁面後再試！');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return false;
    }
    
    return true;
}

function confirmForceDelete() {
    const message = `⚠️ 極度危險操作警告！\n\n您確定要強制刪除所有報工記錄嗎？\n\n此操作將刪除：\n- 所有已核准的記錄\n- 所有已駁回的記錄\n- 所有待核准的記錄\n\n此操作無法復原，請務必確認！`;
    
    if (!confirm(message)) {
        return false;
    }
    
    // 二次確認
    const secondConfirm = confirm('最後確認：您真的確定要刪除所有報工記錄嗎？\n\n此操作將永久刪除所有資料，無法復原！');
    
    if (!secondConfirm) {
        return false;
    }
    
    // 顯示載入中訊息
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 強制刪除中...';
    submitBtn.disabled = true;
    
    // 確保 CSRF token 存在
    const csrfToken = document.querySelector('#forceDeleteForm [name=csrfmiddlewaretoken]');
    if (!csrfToken || !csrfToken.value) {
        alert('CSRF token 遺失，請重新整理頁面後再試！');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return false;
    }
    
    return true;
}

// 頁面載入時檢查權限
document.addEventListener('DOMContentLoaded', function() {
    // 檢查是否為超級管理員（這裡可以添加額外的前端權限檢查）
    console.log('批次刪除確認頁面已載入');
});
</script>
{% endblock %} 