{% extends 'reporting/base/report_base_v2.html' %}
{% load static %}

{% block title %}{{ report_title|default:"圖表報表" }} - MES系統{% endblock %}

{% block report_content %}
<!-- 圖表報表內容 -->
<div class="row">
    <!-- 主要圖表區域 -->
    <div class="col-12 mb-4">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="fas fa-chart-{{ main_chart.type|default:'bar' }} me-2"></i>
                {{ main_chart.title|default:"主要圖表" }}
            </h5>
            <div class="chart-wrapper" style="position: relative; height: 400px;">
                <canvas id="mainChart" data-chart="{{ main_chart.type|default:'bar' }}" 
                        data-chart-title="{{ main_chart.title|default:'主要圖表' }}"
                        data-chart-data="{{ main_chart.data|safe }}"></canvas>
            </div>
        </div>
    </div>

    <!-- 次要圖表區域 -->
    {% if secondary_charts %}
    <div class="col-12">
        <div class="row">
            {% for chart in secondary_charts %}
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h6 class="mb-3">
                        <i class="fas fa-chart-{{ chart.type|default:'line' }} me-2"></i>
                        {{ chart.title }}
                    </h6>
                    <div class="chart-wrapper" style="position: relative; height: 300px;">
                        <canvas id="chart{{ forloop.counter }}" data-chart="{{ chart.type|default:'line' }}"
                                data-chart-title="{{ chart.title }}"
                                data-chart-data="{{ chart.data|safe }}"></canvas>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 圖表數據表格 -->
    {% if chart_data_table %}
    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-table me-2"></i>圖表數據明細
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                {% for column in chart_data_table.columns %}
                                <th>{{ column }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in chart_data_table.data %}
                            <tr>
                                {% for cell in row %}
                                <td>{{ cell }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 圖表分析摘要 -->
    {% if chart_analysis %}
    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>圖表分析摘要
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for analysis in chart_analysis %}
                    <div class="col-md-4 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-{{ analysis.icon }} fa-2x text-{{ analysis.color }}"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">{{ analysis.label }}</h6>
                                <p class="mb-0 text-muted">{{ analysis.value }}</p>
                                {% if analysis.trend %}
                                <small class="text-{{ analysis.trend_color }}">
                                    <i class="fas fa-arrow-{{ analysis.trend_direction }}"></i>
                                    {{ analysis.trend }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// 圖表報表專用 JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // 初始化圖表功能
    initializeChartReport();
});

function initializeChartReport() {
    // 初始化主要圖表
    initializeMainChart();
    
    // 初始化次要圖表
    initializeSecondaryCharts();
    
    // 設定圖表互動功能
    setupChartInteractions();
}

function initializeMainChart() {
    const canvas = document.getElementById('mainChart');
    if (!canvas) return;
    
    const chartType = canvas.dataset.chart;
    const chartTitle = canvas.dataset.chartTitle;
    const chartData = JSON.parse(canvas.dataset.chartData || '{}');
    
    const ctx = canvas.getContext('2d');
    const chart = new Chart(ctx, {
        type: chartType,
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                title: {
                    display: true,
                    text: chartTitle,
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('zh-TW').format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '時間'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '數值'
                    },
                    beginAtZero: true
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
    
    // 儲存圖表實例
    currentCharts.push(chart);
}

function initializeSecondaryCharts() {
    const chartElements = document.querySelectorAll('[id^="chart"]');
    chartElements.forEach((canvas, index) => {
        if (canvas.id === 'mainChart') return; // 跳過主要圖表
        
        const chartType = canvas.dataset.chart;
        const chartTitle = canvas.dataset.chartTitle;
        const chartData = JSON.parse(canvas.dataset.chartData || '{}');
        
        const ctx = canvas.getContext('2d');
        const chart = new Chart(ctx, {
            type: chartType,
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: chartTitle,
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '時間'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: '數值'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // 儲存圖表實例
        currentCharts.push(chart);
    });
}

function setupChartInteractions() {
    // 圖表點擊事件
    currentCharts.forEach(chart => {
        chart.canvas.addEventListener('click', function(event) {
            const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (points.length) {
                const firstPoint = points[0];
                const dataIndex = firstPoint.index;
                const datasetIndex = firstPoint.datasetIndex;
                const value = chart.data.datasets[datasetIndex].data[dataIndex];
                const label = chart.data.labels[dataIndex];
                
                // 顯示詳細資訊
                showChartDetail(label, value, chart.data.datasets[datasetIndex].label);
            }
        });
    });
}

function showChartDetail(label, value, datasetLabel) {
    // 創建詳細資訊模態框
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'chartDetailModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>圖表詳細資訊
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <strong>標籤:</strong> ${label}
                        </div>
                        <div class="col-6">
                            <strong>數值:</strong> ${formatNumber(value)}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <strong>數據集:</strong> ${datasetLabel}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // 模態框關閉後移除元素
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

// 圖表數據驗證
function validateChartData(data) {
    if (!data || !data.labels || !data.datasets) {
        console.error('圖表數據格式錯誤');
        return false;
    }
    return true;
}

// 圖表數據格式化
function formatChartData(data, type) {
    switch (type) {
        case 'line':
            return formatLineChartData(data);
        case 'bar':
            return formatBarChartData(data);
        case 'pie':
            return formatPieChartData(data);
        case 'doughnut':
            return formatDoughnutChartData(data);
        default:
            return data;
    }
}

function formatLineChartData(data) {
    return {
        labels: data.labels,
        datasets: data.datasets.map(dataset => ({
            ...dataset,
            borderColor: dataset.borderColor || getRandomColor(),
            backgroundColor: dataset.backgroundColor || getRandomColor(0.1),
            tension: 0.4
        }))
    };
}

function formatBarChartData(data) {
    return {
        labels: data.labels,
        datasets: data.datasets.map(dataset => ({
            ...dataset,
            backgroundColor: dataset.backgroundColor || getRandomColor(0.8),
            borderColor: dataset.borderColor || getRandomColor(),
            borderWidth: 1
        }))
    };
}

function formatPieChartData(data) {
    return {
        labels: data.labels,
        datasets: [{
            data: data.datasets[0].data,
            backgroundColor: data.datasets[0].backgroundColor || generateColors(data.labels.length),
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
}

function formatDoughnutChartData(data) {
    return {
        labels: data.labels,
        datasets: [{
            data: data.datasets[0].data,
            backgroundColor: data.datasets[0].backgroundColor || generateColors(data.labels.length),
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
}

// 生成隨機顏色
function getRandomColor(alpha = 1) {
    const r = Math.floor(Math.random() * 256);
    const g = Math.floor(Math.random() * 256);
    const b = Math.floor(Math.random() * 256);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// 生成顏色陣列
function generateColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(getRandomColor(0.8));
    }
    return colors;
}

// 更新圖表數據
function updateChartData(chartIndex, newData) {
    if (currentCharts[chartIndex]) {
        currentCharts[chartIndex].data = newData;
        currentCharts[chartIndex].update();
    }
}

// 重新整理所有圖表
function refreshAllCharts() {
    currentCharts.forEach(chart => {
        chart.update();
    });
}
</script>
{% endblock %} 