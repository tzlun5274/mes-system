{% extends 'reporting/base/report_base_v2.html' %}
{% load static %}

{% block title %}{{ report_title|default:"報表匯出" }} - MES系統{% endblock %}

{% block query_form %}
<!-- 匯出專用查詢表單 -->
<form method="get" id="queryForm" class="needs-validation" novalidate>
    <div class="row g-3">
        <!-- 報表類型選擇 -->
        <div class="col-md-4">
            <label for="report_type" class="form-label">
                <i class="fas fa-file-alt me-1"></i>報表類型
            </label>
            <select class="form-select" id="report_type" name="report_type" required>
                <option value="">請選擇報表類型</option>
                <option value="daily_work_time">工作時間日報表</option>
                <option value="weekly_work_time">工作時間週報表</option>
                <option value="monthly_work_time">工作時間月報表</option>
                <option value="daily_work_order">工單機種日報表</option>
                <option value="weekly_work_order">工單機種週報表</option>
                <option value="monthly_work_order">工單機種月報表</option>
                <option value="operator_performance">作業員績效報表</option>
                <option value="smt_equipment">SMT設備效率報表</option>
                <option value="abnormal_report">異常報工報表</option>
            </select>
            <div class="invalid-feedback">
                請選擇報表類型
            </div>
        </div>
        
        <!-- 日期範圍選擇 -->
        <div class="col-md-4">
            <label for="date_range" class="form-label">
                <i class="fas fa-calendar me-1"></i>日期範圍
            </label>
            <select class="form-select" id="date_range" name="date_range" required>
                <option value="">請選擇日期範圍</option>
                <option value="today">今日</option>
                <option value="yesterday">昨日</option>
                <option value="this_week">本週</option>
                <option value="last_week">上週</option>
                <option value="this_month">本月</option>
                <option value="last_month">上月</option>
                <option value="custom">自訂範圍</option>
            </select>
            <div class="invalid-feedback">
                請選擇日期範圍
            </div>
        </div>
        
        <!-- 匯出格式選擇 -->
        <div class="col-md-4">
            <label for="export_format" class="form-label">
                <i class="fas fa-download me-1"></i>匯出格式
            </label>
            <select class="form-select" id="export_format" name="export_format" required>
                <option value="">請選擇匯出格式</option>
                <option value="excel">Excel (.xlsx)</option>
                <option value="csv">CSV (.csv)</option>
                <option value="pdf">PDF (.pdf)</option>
            </select>
            <div class="invalid-feedback">
                請選擇匯出格式
            </div>
        </div>
    </div>
    
    <!-- 自訂日期範圍 -->
    <div class="row g-3 mt-2" id="customDateRange" style="display: none;">
        <div class="col-md-6">
            <label for="date_from" class="form-label">
                <i class="fas fa-calendar-alt me-1"></i>開始日期
            </label>
            <input type="date" class="form-control" id="date_from" name="date_from">
        </div>
        <div class="col-md-6">
            <label for="date_to" class="form-label">
                <i class="fas fa-calendar-alt me-1"></i>結束日期
            </label>
            <input type="date" class="form-control" id="date_to" name="date_to">
        </div>
    </div>
    
    <!-- 進階選項 -->
    <div class="row g-3 mt-2">
        <div class="col-12">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="include_charts" name="include_charts">
                <label class="form-check-label" for="include_charts">
                    <i class="fas fa-chart-bar me-1"></i>包含圖表
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="include_summary" name="include_summary" checked>
                <label class="form-check-label" for="include_summary">
                    <i class="fas fa-chart-pie me-1"></i>包含統計摘要
                </label>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-1"></i>預覽報表
            </button>
            <button type="button" class="btn btn-success" onclick="exportReport()">
                <i class="fas fa-download me-1"></i>直接匯出
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="fas fa-undo me-1"></i>重置
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block report_content %}
<!-- 匯出預覽內容 -->
{% if preview_data %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            以下是報表預覽，確認無誤後可點擊「匯出報表」按鈕進行下載
        </div>
    </div>
</div>

<!-- 預覽表格 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-table me-2"></i>報表預覽
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                {% for column in preview_columns %}
                                <th>{{ column }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in preview_data %}
                            <tr>
                                {% for cell in row %}
                                <td>{{ cell }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 預覽統計 -->
                {% if preview_summary %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>預覽統計</h6>
                        <div class="row">
                            {% for summary in preview_summary %}
                            <div class="col-md-3 mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-{{ summary.icon }} fa-lg text-{{ summary.color }}"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <small class="text-muted">{{ summary.label }}</small>
                                        <div class="fw-bold">{{ summary.value }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 匯出按鈕 -->
<div class="row">
    <div class="col-12 text-center">
        <button type="button" class="btn btn-success btn-lg" onclick="exportReport()">
            <i class="fas fa-download me-2"></i>匯出報表
        </button>
        <button type="button" class="btn btn-outline-primary btn-lg ms-2" onclick="scheduleExport()">
            <i class="fas fa-clock me-2"></i>排程匯出
        </button>
    </div>
</div>
{% else %}
<!-- 無預覽數據時的提示 -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h5>請選擇報表類型和日期範圍</h5>
            <p class="mb-0">選擇完成後點擊「預覽報表」按鈕查看報表內容</p>
        </div>
    </div>
</div>
{% endif %}

<!-- 匯出歷史記錄 -->
{% if export_history %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>匯出歷史記錄
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>匯出時間</th>
                                <th>報表類型</th>
                                <th>日期範圍</th>
                                <th>格式</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in export_history %}
                            <tr>
                                <td>{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                <td>{{ record.report_type }}</td>
                                <td>{{ record.date_range }}</td>
                                <td>{{ record.format|upper }}</td>
                                <td>
                                    <span class="badge bg-{{ record.status_color }}">
                                        {{ record.status_text }}
                                    </span>
                                </td>
                                <td>
                                    {% if record.status == 'completed' %}
                                    <a href="{{ record.download_url }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i> 下載
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// 匯出報表專用 JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // 初始化匯出功能
    initializeExport();
});

function initializeExport() {
    // 設定日期範圍變更事件
    document.getElementById('date_range').addEventListener('change', function() {
        toggleCustomDateRange();
    });
    
    // 設定報表類型變更事件
    document.getElementById('report_type').addEventListener('change', function() {
        updateExportOptions();
    });
    
    // 初始化表單驗證
    setupExportFormValidation();
}

function toggleCustomDateRange() {
    const dateRange = document.getElementById('date_range').value;
    const customRange = document.getElementById('customDateRange');
    
    if (dateRange === 'custom') {
        customRange.style.display = 'block';
        // 設定預設日期範圍（最近7天）
        const today = new Date();
        const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
        
        document.getElementById('date_from').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('date_to').value = today.toISOString().split('T')[0];
    } else {
        customRange.style.display = 'none';
    }
}

function updateExportOptions() {
    const reportType = document.getElementById('report_type').value;
    const formatSelect = document.getElementById('export_format');
    
    // 根據報表類型調整可用的匯出格式
    if (reportType.includes('chart') || reportType.includes('dashboard')) {
        // 圖表類報表支援所有格式
        Array.from(formatSelect.options).forEach(option => {
            option.disabled = false;
        });
    } else {
        // 一般報表不支援 PDF
        Array.from(formatSelect.options).forEach(option => {
            if (option.value === 'pdf') {
                option.disabled = true;
            } else {
                option.disabled = false;
            }
        });
    }
}

function setupExportFormValidation() {
    const form = document.getElementById('queryForm');
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }
        
        // 驗證自訂日期範圍
        if (document.getElementById('date_range').value === 'custom') {
            const dateFrom = document.getElementById('date_from').value;
            const dateTo = document.getElementById('date_to').value;
            
            if (!dateFrom || !dateTo) {
                showError('請選擇完整的日期範圍');
                return;
            }
            
            if (new Date(dateFrom) > new Date(dateTo)) {
                showError('開始日期不能晚於結束日期');
                return;
            }
        }
        
        // 提交預覽請求
        submitPreviewRequest();
    });
}

function submitPreviewRequest() {
    showLoading();
    
    const formData = new FormData(document.getElementById('queryForm'));
    formData.append('preview', 'true');
    
    fetch(window.location.pathname, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.text())
    .then(html => {
        // 更新頁面內容
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // 更新報表內容區域
        const newContent = doc.querySelector('.report-content-section .card-body');
        if (newContent) {
            document.querySelector('.report-content-section .card-body').innerHTML = newContent.innerHTML;
        }
        
        hideLoading();
    })
    .catch(error => {
        console.error('預覽請求失敗:', error);
        showError('預覽請求失敗，請稍後再試');
        hideLoading();
    });
}

function exportReport() {
    const formData = new FormData(document.getElementById('queryForm'));
    
    // 驗證必填欄位
    if (!formData.get('report_type') || !formData.get('date_range') || !formData.get('export_format')) {
        showError('請填寫完整的匯出資訊');
        return;
    }
    
    showLoading();
    
    fetch('{% url "reporting:export_report" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('匯出失敗');
    })
    .then(blob => {
        // 下載檔案
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // 生成檔案名稱
        const reportType = formData.get('report_type');
        const dateRange = formData.get('date_range');
        const format = formData.get('export_format');
        const timestamp = new Date().toISOString().split('T')[0];
        
        a.download = `${reportType}_${dateRange}_${timestamp}.${getFileExtension(format)}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showSuccess('匯出成功');
        
        // 重新載入匯出歷史
        loadExportHistory();
    })
    .catch(error => {
        console.error('匯出失敗:', error);
        showError('匯出失敗，請稍後再試');
        hideLoading();
    });
}

function scheduleExport() {
    // 顯示排程匯出模態框
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'scheduleExportModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clock me-2"></i>排程匯出
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <div class="mb-3">
                            <label for="scheduleTime" class="form-label">匯出時間</label>
                            <input type="datetime-local" class="form-control" id="scheduleTime" name="schedule_time" required>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleFrequency" class="form-label">重複頻率</label>
                            <select class="form-select" id="scheduleFrequency" name="frequency">
                                <option value="once">僅此一次</option>
                                <option value="daily">每日</option>
                                <option value="weekly">每週</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleEmail" class="form-label">通知郵箱</label>
                            <input type="email" class="form-control" id="scheduleEmail" name="email" 
                                   placeholder="匯出完成後發送通知到此郵箱">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitSchedule()">
                        <i class="fas fa-save me-1"></i>設定排程
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // 設定預設時間（明天早上9點）
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(9, 0, 0, 0);
    document.getElementById('scheduleTime').value = tomorrow.toISOString().slice(0, 16);
    
    // 模態框關閉後移除元素
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function submitSchedule() {
    const formData = new FormData(document.getElementById('queryForm'));
    const scheduleData = new FormData(document.getElementById('scheduleForm'));
    
    // 合併表單數據
    for (let [key, value] of scheduleData.entries()) {
        formData.append(key, value);
    }
    
    fetch('{% url "reporting:schedule_export" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('排程設定成功');
            bootstrap.Modal.getInstance(document.getElementById('scheduleExportModal')).hide();
        } else {
            showError(data.message || '排程設定失敗');
        }
    })
    .catch(error => {
        console.error('排程設定失敗:', error);
        showError('排程設定失敗，請稍後再試');
    });
}

function loadExportHistory() {
    fetch('{% url "reporting:export_history" %}')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const historySection = doc.querySelector('.export-history-section');
            if (historySection) {
                const currentHistory = document.querySelector('.export-history-section');
                if (currentHistory) {
                    currentHistory.innerHTML = historySection.innerHTML;
                }
            }
        })
        .catch(error => {
            console.error('載入匯出歷史失敗:', error);
        });
}

// 重置表單
function resetForm() {
    document.getElementById('queryForm').reset();
    document.getElementById('customDateRange').style.display = 'none';
    document.getElementById('queryForm').classList.remove('was-validated');
}

// 取得檔案副檔名
function getFileExtension(format) {
    switch(format) {
        case 'excel': return 'xlsx';
        case 'csv': return 'csv';
        case 'pdf': return 'pdf';
        default: return 'xlsx';
    }
}
</script>
{% endblock %} 