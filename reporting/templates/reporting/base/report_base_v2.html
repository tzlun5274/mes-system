{% extends 'base.html' %}
{% load static %}

{% block title %}{{ report_title|default:"報表管理" }} - MES系統{% endblock %}

{% block extra_css %}
<!-- 報表專用樣式 -->
<link rel="stylesheet" href="{% static 'reporting/css/report.css' %}">
<!-- Chart.js 圖表庫 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Font Awesome 圖示 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- DataTables 表格增強 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<style>
/* 報表容器樣式 */
.report-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

/* 查詢區域樣式 */
.query-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

.query-section .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0;
    padding: 15px 20px;
}

/* 統計區域樣式 */
.statistics-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

.statistics-section .card-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 8px 8px 0 0;
    padding: 15px 20px;
}

/* 報表內容區域樣式 */
.report-content-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.report-content-section .card-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border-radius: 8px 8px 0 0;
    padding: 15px 20px;
}

/* 匯出選項樣式 */
.export-options {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.export-options .btn {
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-left: 10px;
}

/* 載入遮罩樣式 */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 統計卡片樣式 */
.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card .stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* 表格樣式 */
.report-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.report-table .table {
    margin-bottom: 0;
}

.report-table .table thead th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px;
    font-weight: 600;
}

.report-table .table tbody tr:hover {
    background-color: #f8f9fa;
}

/* 圖表容器樣式 */
.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

/* 響應式設計 */
@media (max-width: 768px) {
    .report-container {
        padding: 10px 0;
    }
    
    .stat-card {
        margin-bottom: 10px;
    }
    
    .export-options {
        position: static;
        margin-top: 20px;
        text-align: center;
    }
    
    .export-options .btn {
        margin: 5px;
    }
}

/* 表單樣式 */
.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
}

.btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    border: none;
}

.btn-success:hover {
    background: linear-gradient(135deg, #4a9a26 0%, #97d4c0 100%);
    transform: translateY(-1px);
}

/* 警告和錯誤樣式 */
.alert {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.alert-warning {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #856404;
}

.alert-danger {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #721c24;
}

.alert-success {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #155724;
}

/* 報表類型標籤 */
.report-type-badge {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.report-type-daily {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.report-type-weekly {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.report-type-monthly {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

/* 數據品質指示器 */
.data-quality-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.data-quality-excellent {
    background-color: #28a745;
}

.data-quality-good {
    background-color: #ffc107;
}

.data-quality-poor {
    background-color: #dc3545;
}

/* 進度條樣式 */
.progress {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
}

.progress-bar {
    border-radius: 4px;
    transition: width 0.6s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- 報表標題區域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="fas fa-chart-bar text-primary me-2"></i>
                        {{ report_title|default:"報表管理" }}
                        {% if report_type %}
                        <span class="report-type-badge report-type-{{ report_type|lower }} ms-2">
                            {{ report_type|title }}報表
                        </span>
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        {{ report_description|default:"報表數據分析與統計" }}
                        {% if data_quality %}
                        <span class="data-quality-indicator data-quality-{{ data_quality }}"></span>
                        數據品質: {{ data_quality|title }}
                        {% endif %}
                    </p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshReport()" title="重新整理報表">
                        <i class="fas fa-sync-alt"></i>
                        <span class="d-none d-md-inline">重新整理</span>
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="showExportModal()" title="匯出報表">
                        <i class="fas fa-download"></i>
                        <span class="d-none d-md-inline">匯出</span>
                    </button>
                    <a href="{% url 'reporting:index' %}" class="btn btn-outline-secondary" title="返回報表首頁">
                        <i class="fas fa-arrow-left"></i>
                        <span class="d-none d-md-inline">返回</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 查詢條件區域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="query-section">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>查詢條件
                    </h5>
                </div>
                <div class="card-body">
                    {% block query_form %}
                    <!-- 預設查詢表單 -->
                    <form method="get" id="queryForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="date_from" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>開始日期
                                </label>
                                <input type="date" class="form-control" id="date_from" name="date_from" 
                                       value="{{ date_from|default:'' }}" required>
                                <div class="invalid-feedback">
                                    請選擇開始日期
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="date_to" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>結束日期
                                </label>
                                <input type="date" class="form-control" id="date_to" name="date_to" 
                                       value="{{ date_to|default:'' }}" required>
                                <div class="invalid-feedback">
                                    請選擇結束日期
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="report_type" class="form-label">
                                    <i class="fas fa-file-alt me-1"></i>報表類型
                                </label>
                                <select class="form-select" id="report_type" name="report_type">
                                    <option value="">全部類型</option>
                                    <option value="daily">日報表</option>
                                    <option value="weekly">週報表</option>
                                    <option value="monthly">月報表</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="operator" class="form-label">
                                    <i class="fas fa-user me-1"></i>作業員
                                </label>
                                <select class="form-select" id="operator" name="operator">
                                    <option value="">全部作業員</option>
                                    {% for op in operators %}
                                    <option value="{{ op.id }}">{{ op.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>查詢
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo me-1"></i>重置
                                </button>
                            </div>
                        </div>
                    </form>
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- 統計摘要區域 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="statistics-section">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>統計摘要
                    </h5>
                </div>
                <div class="card-body">
                    {% block statistics %}
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-value">{{ total_operators|default:"0" }}</div>
                                <div class="stat-label">總作業員數</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-value">{{ total_hours|default:"0" }}</div>
                                <div class="stat-label">總工作時數</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stat-value">{{ total_quantity|default:"0" }}</div>
                                <div class="stat-label">總生產數量</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <div class="stat-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-value">{{ efficiency_rate|default:"0" }}%</div>
                                <div class="stat-label">平均效率</div>
                            </div>
                        </div>
                    </div>
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- 報表內容區域 -->
    <div class="row">
        <div class="col-12">
            <div class="report-content-section">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>報表內容
                    </h5>
                </div>
                <div class="card-body">
                    {% block report_content %}
                    <!-- 預設報表內容 -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        請選擇查詢條件並點擊查詢按鈕以顯示報表內容
                    </div>
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>

    <!-- 匯出選項 -->
    <div class="export-options">
        <button class="btn btn-success btn-lg rounded-circle" onclick="showExportModal()" title="匯出報表">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- 載入遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner mb-3"></div>
            <h5>正在處理中，請稍候...</h5>
        </div>
    </div>
</div>

<!-- 匯出模態框 -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-download me-2"></i>匯出報表
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">匯出格式</label>
                        <select class="form-select" id="exportFormat" name="format" required>
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportDateRange" class="form-label">日期範圍</label>
                        <select class="form-select" id="exportDateRange" name="date_range">
                            <option value="custom">自訂範圍</option>
                            <option value="today">今日</option>
                            <option value="yesterday">昨日</option>
                            <option value="this_week">本週</option>
                            <option value="this_month">本月</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportFileName" class="form-label">檔案名稱</label>
                        <input type="text" class="form-control" id="exportFileName" name="filename" 
                               value="{{ report_title|default:'報表' }}_{{ current_date|date:'Y-m-d' }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="executeExport()">
                    <i class="fas fa-download me-1"></i>開始匯出
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables 表格增強 -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
// 全域變數
let currentReportData = null;
let currentCharts = [];
let currentDataTable = null;

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeReport();
    setupEventListeners();
});

// 初始化報表
function initializeReport() {
    // 設定預設日期範圍（最近7天）
    const today = new Date();
    const sevenDaysAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
    
    if (!document.getElementById('date_from').value) {
        document.getElementById('date_from').value = sevenDaysAgo.toISOString().split('T')[0];
    }
    if (!document.getElementById('date_to').value) {
        document.getElementById('date_to').value = today.toISOString().split('T')[0];
    }
    
    // 初始化表單驗證
    setupFormValidation();
    
    // 初始化 DataTable
    initializeDataTable();
}

// 設定事件監聽器
function setupEventListeners() {
    // 表單提交事件
    document.getElementById('queryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitQuery();
    });
    
    // 日期範圍變更事件
    document.getElementById('exportDateRange').addEventListener('change', function() {
        updateExportDateRange();
    });
}

// 設定表單驗證
function setupFormValidation() {
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
}

// 初始化 DataTable
function initializeDataTable() {
    const table = document.querySelector('#reportTable');
    if (table) {
        currentDataTable = $(table).DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json'
            },
            pageLength: 25,
            responsive: true,
            dom: 'Bfrtip',
            buttons: [
                'copy', 'csv', 'excel', 'print'
            ],
            order: [[0, 'desc']]
        });
    }
}

// 提交查詢
function submitQuery() {
    showLoading();
    
    const formData = new FormData(document.getElementById('queryForm'));
    const queryParams = new URLSearchParams(formData);
    
    // 使用 AJAX 提交查詢
    fetch(window.location.pathname + '?' + queryParams.toString())
        .then(response => response.text())
        .then(html => {
            // 更新頁面內容
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // 更新統計區域
            const newStats = doc.querySelector('.statistics-section .card-body');
            if (newStats) {
                document.querySelector('.statistics-section .card-body').innerHTML = newStats.innerHTML;
            }
            
            // 更新報表內容區域
            const newContent = doc.querySelector('.report-content-section .card-body');
            if (newContent) {
                document.querySelector('.report-content-section .card-body').innerHTML = newContent.innerHTML;
            }
            
            // 重新初始化圖表和表格
            initializeCharts();
            initializeDataTable();
            
            hideLoading();
        })
        .catch(error => {
            console.error('查詢失敗:', error);
            showError('查詢失敗，請稍後再試');
            hideLoading();
        });
}

// 重新整理報表
function refreshReport() {
    submitQuery();
}

// 重置表單
function resetForm() {
    document.getElementById('queryForm').reset();
    initializeReport();
}

// 顯示匯出模態框
function showExportModal() {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

// 執行匯出
function executeExport() {
    const formData = new FormData(document.getElementById('exportForm'));
    const queryData = new FormData(document.getElementById('queryForm'));
    
    // 合併查詢條件和匯出設定
    for (let [key, value] of queryData.entries()) {
        formData.append(key, value);
    }
    
    showLoading();
    
    fetch('{% url "reporting:export_report" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('匯出失敗');
    })
    .then(blob => {
        // 下載檔案
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = formData.get('filename') + '.' + getFileExtension(formData.get('format'));
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
        showSuccess('匯出成功');
    })
    .catch(error => {
        console.error('匯出失敗:', error);
        showError('匯出失敗，請稍後再試');
        hideLoading();
    });
}

// 更新匯出日期範圍
function updateExportDateRange() {
    const range = document.getElementById('exportDateRange').value;
    const today = new Date();
    
    switch(range) {
        case 'today':
            document.getElementById('date_from').value = today.toISOString().split('T')[0];
            document.getElementById('date_to').value = today.toISOString().split('T')[0];
            break;
        case 'yesterday':
            const yesterday = new Date(today.getTime() - (24 * 60 * 60 * 1000));
            document.getElementById('date_from').value = yesterday.toISOString().split('T')[0];
            document.getElementById('date_to').value = yesterday.toISOString().split('T')[0];
            break;
        case 'this_week':
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            document.getElementById('date_from').value = startOfWeek.toISOString().split('T')[0];
            document.getElementById('date_to').value = new Date().toISOString().split('T')[0];
            break;
        case 'this_month':
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('date_from').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('date_to').value = new Date().toISOString().split('T')[0];
            break;
    }
}

// 初始化圖表
function initializeCharts() {
    // 清除現有圖表
    currentCharts.forEach(chart => chart.destroy());
    currentCharts = [];
    
    // 初始化新的圖表
    const chartElements = document.querySelectorAll('canvas[data-chart]');
    chartElements.forEach(canvas => {
        const chartType = canvas.dataset.chart;
        const chartData = JSON.parse(canvas.dataset.chartData || '{}');
        
        const chart = new Chart(canvas, {
            type: chartType,
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: canvas.dataset.chartTitle || '圖表'
                    }
                }
            }
        });
        
        currentCharts.push(chart);
    });
}

// 顯示載入遮罩
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

// 隱藏載入遮罩
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// 顯示成功訊息
function showSuccess(message) {
    showAlert('success', message);
}

// 顯示錯誤訊息
function showError(message) {
    showAlert('danger', message);
}

// 顯示警告訊息
function showWarning(message) {
    showAlert('warning', message);
}

// 顯示訊息
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.report-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 自動隱藏
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// 取得檔案副檔名
function getFileExtension(format) {
    switch(format) {
        case 'excel': return 'xlsx';
        case 'csv': return 'csv';
        case 'pdf': return 'pdf';
        default: return 'xlsx';
    }
}

// 取得 CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 格式化數字
function formatNumber(num) {
    return new Intl.NumberFormat('zh-TW').format(num);
}

// 格式化日期
function formatDate(date) {
    return new Intl.DateTimeFormat('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).format(new Date(date));
}

// 格式化時間
function formatTime(time) {
    return new Intl.DateTimeFormat('zh-TW', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }).format(new Date(time));
}

// 計算百分比
function calculatePercentage(value, total) {
    if (total === 0) return 0;
    return Math.round((value / total) * 100);
}

// 驗證日期範圍
function validateDateRange(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    return start <= end;
}

// 取得日期範圍天數
function getDateRangeDays(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays + 1;
}
</script>
{% endblock %} 