# SMT工作時數計算修正說明

## 問題描述

用戶反映：**SMT中午沒有休息，所以SMT不能扣1小時**

作業員在中午休息時不填寫休息時間，系統會把中午休息時間也計算進工作時間，這是不正確的。特別是SMT設備，它們中午不休息，所以不應該扣除午休時間。

## 解決方案

### 1. 識別報工記錄類型

新增 `_get_report_type()` 方法，自動識別報工記錄的類型：

```python
def _get_report_type(self, report) -> str:
    """
    識別報工記錄的類型
    
    Returns:
        str: 報工記錄類型 ('operator', 'smt', 'supervisor')
    """
    model_name = report.__class__.__name__
    
    if model_name == 'SMTProductionReport':
        return 'smt'
    elif model_name == 'OperatorSupplementReport':
        return 'operator'
    elif model_name == 'SupervisorProductionReport':
        return 'supervisor'
    else:
        return 'operator'
```

### 2. 修改計算邏輯

修改 `_calculate_by_production_line()` 方法，根據報工記錄類型決定是否扣除午休時間：

#### 正常工時計算
```python
# 如果有午休時間，且不是SMT報工記錄，才扣除午休時間
if lunch_start and lunch_end and report_type != 'smt':
    # 扣除午休時間的邏輯
```

#### 休息時數計算
```python
# 計算休息時數（午休時間）- SMT報工記錄不計算休息時數
if lunch_start and lunch_end and report_type != 'smt':
    # 計算午休時間
else:
    break_hours = 0.0
```

## 計算結果對比

### 作業員報工記錄（扣除午休）

**案例：林美環 08:30-17:30**
- **總工作時數**: 9.0h (08:30-17:30)
- **實際工作時數**: 8.0h (扣除1小時午休)
- **休息時數**: 1.0h (12:00-13:00午休)
- **正常工時**: 7.0h (08:30-12:00 + 13:00-16:30)
- **加班時數**: 1.0h (16:30-17:30)

### SMT報工記錄（不扣午休）

**案例：SMT-A_LINE 08:30-13:30**
- **總工作時數**: 5.0h (08:30-13:30)
- **實際工作時數**: 5.0h (不扣午休)
- **休息時數**: 0.0h (SMT不扣午休)
- **正常工時**: 5.0h (08:30-13:30 與 08:30-16:30 的重疊)
- **加班時數**: 0.0h (沒有超過正常工時範圍)

## 測試案例

### 作業員偷懶案例
**作業員實際工作**: 11:00-12:00, 13:00-15:00 (分兩段)
**作業員填寫**: 11:00-15:00 (連續，包含午休)

**計算結果**:
- **總工作時數**: 4.0h (11:00-15:00)
- **實際工作時數**: 3.0h (扣除1小時午休)
- **休息時數**: 1.0h (12:00-13:00午休)
- **正常工時**: 3.0h (11:00-12:00 + 13:00-15:00)
- **加班時數**: 0.0h

### SMT偷懶案例
**SMT實際工作**: 11:00-12:00, 13:00-15:00 (分兩段)
**SMT填寫**: 11:00-15:00 (連續，包含午休)

**計算結果**:
- **總工作時數**: 4.0h (11:00-15:00)
- **實際工作時數**: 4.0h (不扣午休)
- **休息時數**: 0.0h (SMT不扣午休)
- **正常工時**: 4.0h (11:00-15:00 與 08:30-16:30 的重疊)
- **加班時數**: 0.0h

## 修改的檔案

1. **`reporting/services/work_time_calculator.py`**
   - 新增 `_get_report_type()` 方法
   - 修改 `_calculate_by_production_line()` 方法
   - 根據報工記錄類型決定是否扣除午休時間

2. **`test_work_time_calculation.py`**
   - 新增SMT報工記錄測試案例
   - 修改測試函數支援不同報工記錄類型

## 驗證結果

所有測試案例都通過，包括：
- ✅ 林美環案例 (08:30-17:30)
- ✅ 何尉嘉案例 (08:40-16:40)
- ✅ 上午工作 (08:30-12:00)
- ✅ 下午工作 (13:00-17:30)
- ✅ 跨午休工作 (11:00-15:00) - 作業員偷懶案例
- ✅ **SMT跨午休工作 (11:00-15:00) - SMT不扣午休**
- ✅ 跨午休工作 (11:00-14:00)

## 實際資料驗證

測試實際的SMT報工記錄：

**SMT-A_LINE 08:30-13:30**:
- 總工作時數: 5.0h ✅
- 實際工作時數: 5.0h ✅ (不扣午休)
- 休息時數: 0.0h ✅ (SMT不扣午休)
- 正常工時: 5.0h ✅
- 加班時數: 0.0h ✅

## 總結

現在系統能夠正確區分不同類型的報工記錄：

1. **作業員報工記錄** (`OperatorSupplementReport`): 扣除午休時間
2. **SMT報工記錄** (`SMTProductionReport`): 不扣除午休時間
3. **主管報工記錄** (`SupervisorProductionReport`): 扣除午休時間

這樣確保了SMT設備的工作時數計算符合實際情況，不會因為午休時間而影響工作時數統計。 