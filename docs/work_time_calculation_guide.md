# 工作時數計算功能使用說明

## 概述

本系統已升級工作時數計算邏輯，現在會根據產線設定正確計算工作時間、休息時間和加班時間，確保工作時數計算符合生產管理的實際需求。

## 主要改進

### 1. 產線時間設定整合
- 根據產線的工作時間設定計算正常工時
- 自動識別午休時間並扣除休息時數
- 正確計算加班時數（超過正常工時的部分）

### 2. 工作日判斷
- 根據產線的工作日設定判斷是否為工作日
- 非工作日的工作全部算作加班時數

### 3. 精確時數計算
- 總工作時數：從開始時間到結束時間的總時數
- 實際工作時數：總時數減去休息時數
- 休息時數：午休時間的重疊部分
- 加班時數：超過正常工時的部分
- 正常工時：工作時間內的部分

## 使用方法

### 1. 設定產線時間

在管理後台設定產線的工作時間：

1. 進入 **生產管理 > 產線管理**
2. 選擇或建立產線
3. 設定以下時間：
   - **工作開始時間**：例如 08:00
   - **工作結束時間**：例如 17:00
   - **午休開始時間**：例如 12:00
   - **午休結束時間**：例如 13:00
   - **加班開始時間**：例如 17:00
   - **加班結束時間**：例如 20:00
4. 設定工作日（週一到週五等）
5. 儲存設定

### 2. 重新計算現有記錄

使用管理命令重新計算現有記錄的工作時數：

```bash
# 重新計算最近30天的工作時數
python manage.py recalculate_work_hours

# 重新計算指定日期範圍
python manage.py recalculate_work_hours --date-from 2025-01-01 --date-to 2025-01-31

# 重新計算特定作業員
python manage.py recalculate_work_hours --worker "時美珍"

# 試運行模式（不實際更新資料庫）
python manage.py recalculate_work_hours --dry-run
```

### 3. 測試計算邏輯

使用測試命令驗證計算是否正確：

```bash
# 測試所有案例
python manage.py test_work_time_calculation

# 測試特定案例
python manage.py test_work_time_calculation --test-case basic

# 測試特定產線
python manage.py test_work_time_calculation --production-line SMT01
```

## 計算邏輯說明

### 正常工時計算
- 工作時間範圍內的部分算作正常工時
- 例如：08:00-17:00 工作，則 8 小時為正常工時

### 加班時數計算
- 超過正常工時的部分算作加班
- 例如：08:00-19:00 工作，則 8 小時正常工時 + 2 小時加班

### 休息時數計算
- 午休時間與工作時間的重疊部分
- 例如：12:00-13:00 午休，則扣除 1 小時休息時數

### 實際工作時數計算
- 總工作時數減去休息時數
- 例如：總時數 9 小時，休息 1 小時，實際工作 8 小時

## 時美珍案例說明

根據您提供的資料：
- 作業員：時美珍
- 工號：331-25617001
- 產品：PFP-CCT006CB0061E-500
- 工序：3合1組合
- 時間：08:30-17:30
- 原始計算：9.0h

### 新的計算結果
假設產線設定為：
- 工作時間：08:00-17:00
- 午休時間：12:00-13:00
- 加班時間：17:00-20:00

計算結果：
- **總工作時數**：9.0h
- **實際工作時數**：8.0h（扣除午休1小時）
- **休息時數**：1.0h（午休時間）
- **加班時數**：0.5h（17:00-17:30）
- **正常工時**：8.5h（08:30-17:00）

## 報表顯示

### 工作時數報表
報表現在會顯示詳細的時數分類：
- 總工作時數
- 實際工作時數
- 休息時數
- 加班時數
- 正常工時

### 匯出功能
匯出的 Excel/CSV 檔案包含所有時數欄位，方便進一步分析。

## 注意事項

1. **產線設定**：確保產線有正確的時間設定，否則會使用預設計算方式
2. **工作日設定**：正確設定工作日，避免假日工作被誤算為正常工時
3. **時間格式**：所有時間都使用 24 小時制（HH:MM）
4. **跨日處理**：系統會自動處理跨日的工作時間

## 故障排除

### 找不到產線設定
如果系統找不到對應的產線設定，會使用原始計算方式並記錄警告日誌。

### 計算結果異常
1. 檢查產線時間設定是否正確
2. 確認工作日設定
3. 使用測試命令驗證計算邏輯
4. 檢查日誌檔案中的錯誤訊息

### 重新計算失敗
1. 確認日期格式正確（YYYY-MM-DD）
2. 檢查資料庫連線
3. 使用 `--dry-run` 參數先測試
4. 檢查權限設定

## 技術支援

如有問題，請聯繫系統管理員或查看系統日誌檔案。 