# 🚀 MES 系統全新生產主機部署說明

## 📋 目錄
- [部署概述](#部署概述)
- [先決條件](#先決條件)
- [部署步驟](#部署步驟)
- [驗證部署](#驗證部署)
- [故障排除](#故障排除)
- [維護指南](#維護指南)

---

## 🎯 部署概述

本文件說明如何將 MES 系統部署到全新的生產主機上。部署過程完全自動化，只需配置環境變數即可。

### 📊 系統架構
- **Web 伺服器**: Nginx + Gunicorn
- **資料庫**: PostgreSQL
- **快取/訊息佇列**: Redis
- **背景任務**: Celery Worker + Celery Beat
- **應用框架**: Django 5.1.8

### 🎯 部署目標
- 將 MES 系統部署到全新的 Ubuntu 主機
- 自動化所有安裝和配置步驟
- 確保系統穩定運行
- 提供完整的監控和維護功能

---

## ⚙️ 先決條件

### 🖥️ 硬體要求
| 項目 | 最低要求 | 建議配置 |
|------|----------|----------|
| CPU | 2核心 | 4核心以上 |
| 記憶體 | 4GB | 8GB以上 |
| 硬碟 | 20GB可用空間 | 50GB以上 |
| 網路 | 100Mbps | 1Gbps |

### 💻 作業系統
- **推薦**: Ubuntu 22.04 LTS
- **支援**: Ubuntu 20.04 LTS
- **不支援**: Windows, macOS

### 🌐 網路設定
- 固定 IP 地址
- 防火牆開放端口：
  - 80 (HTTP)
  - 443 (HTTPS，可選)
  - 22 (SSH)

### 🔑 必要資訊
部署前請準備以下資訊：
- 主機 IP 地址
- 資料庫密碼
- Redis 密碼
- 管理員密碼

---

## 🚀 部署步驟

### 階段 1: 準備工作 (5分鐘)

#### 1.1 更新系統
```bash
# 更新套件清單
sudo apt update

# 升級系統套件
sudo apt upgrade -y

# 安裝基礎工具
sudo apt install -y curl wget git unzip lsof net-tools
```

#### 1.2 下載部署包
```bash
# 下載部署包（請替換為實際的URL）
wget [部署包URL] -O mes_deployment.tar.gz

# 解壓縮
tar -xzf mes_deployment.tar.gz

# 進入部署目錄
cd mes_deployment
```

### 階段 2: 環境配置 (10分鐘)

#### 2.1 編輯環境配置
```bash
# 編輯環境配置檔案
nano .env
```

#### 2.2 修改關鍵設定
```bash
# 必須修改的項目
HOST_IP=192.168.1.28                    # 改為你的主機IP
DATABASE_PASSWORD=your_secure_password   # 設定資料庫密碼
REDIS_PASSWORD=your_redis_password       # 設定Redis密碼
SUPERUSER_PASSWORD=your_admin_password   # 設定管理員密碼
DEBUG=False                              # 生產環境設為False

# 可選修改項目
ALLOWED_HOSTS=localhost,127.0.0.1,192.168.1.28  # 允許的主機
LANGUAGE_CODE=zh-hant                           # 語言設定
TIME_ZONE=Asia/Taipei                          # 時區設定
```

#### 2.3 配置範例
```bash
# .env 檔案範例
DJANGO_SECRET_KEY='your-secret-key-here'
DEBUG=False
ALLOWED_HOSTS=localhost,127.0.0.1,192.168.1.28
HOST_IP=192.168.1.28
DATABASE_NAME=mesdb
DATABASE_USER=mes_user
DATABASE_PASSWORD=your_secure_password
DATABASE_HOST=localhost
DATABASE_PORT=5432
REDIS_PASSWORD=your_redis_password
SUPERUSER_NAME=admin
SUPERUSER_EMAIL=admin@example.com
SUPERUSER_PASSWORD=your_admin_password
```

### 階段 3: 執行自動部署 (30分鐘)

#### 3.1 執行部署腳本
```bash
# 執行完整部署腳本
sudo ./全新部署.sh
```

#### 3.2 部署過程說明
腳本會自動執行以下步驟：

1. **系統套件安裝**
   - Python 3.10+ 及相關套件
   - PostgreSQL 資料庫
   - Redis 快取服務
   - Nginx Web 伺服器

2. **系統用戶建立**
   - 建立 `mes` 用戶
   - 設定適當的權限

3. **資料庫配置**
   - 建立資料庫和用戶
   - 設定資料庫權限

4. **專案部署**
   - 複製專案檔案
   - 安裝 Python 套件
   - 初始化資料庫

5. **服務配置**
   - 建立 Systemd 服務
   - 配置 Nginx
   - 啟動所有服務

#### 3.3 部署過程監控
```bash
# 查看部署日誌
tail -f /var/log/mes/deploy.log

# 查看即時狀態
sudo systemctl status mes.service
sudo systemctl status nginx
```

### 階段 4: 驗證部署 (5分鐘)

#### 4.1 檢查服務狀態
```bash
# 檢查所有服務狀態
sudo systemctl status mes.service
sudo systemctl status mes-celery.service
sudo systemctl status celery-beat.service
sudo systemctl status nginx
sudo systemctl status postgresql
sudo systemctl status redis-server
```

#### 4.2 測試網站訪問
```bash
# 測試本地訪問
curl -I http://localhost

# 測試外部訪問
curl -I http://192.168.1.28

# 測試管理後台
curl -I http://192.168.1.28/admin
```

#### 4.3 檢查資料庫
```bash
# 檢查資料庫連接
sudo -u mes python3 manage.py dbshell -c "\dt"

# 檢查遷移狀態
sudo -u mes python3 manage.py showmigrations
```

---

## ✅ 驗證部署

### 🎯 成功指標
部署成功後，應該看到以下結果：

#### 1. 服務狀態
```bash
# 所有服務都應該顯示 "active (running)"
● mes.service - MES Gunicorn daemon
   Loaded: loaded (/etc/systemd/system/mes.service; enabled)
   Active: active (running)

● nginx.service - A high performance web server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled)
   Active: active (running)
```

#### 2. 網站訪問
- 瀏覽器訪問 `http://192.168.1.28` 應該看到 MES 系統首頁
- 訪問 `http://192.168.1.28/admin` 應該看到 Django 管理後台

#### 3. 資料庫狀態
```bash
# 應該看到多個資料表
sudo -u mes python3 manage.py dbshell -c "\dt"
```

### 🔍 驗證清單
- [ ] 所有系統服務運行正常
- [ ] 網站可以正常訪問
- [ ] 管理後台可以登入
- [ ] 資料庫連接正常
- [ ] 日誌檔案正常生成
- [ ] 靜態檔案正確載入

---

## 🔧 故障排除

### ❌ 常見問題

#### 1. 部署腳本執行失敗
**症狀**: 腳本中途停止或報錯
**解決方案**:
```bash
# 檢查日誌
tail -f /var/log/mes/deploy.log

# 重新執行
sudo ./全新部署.sh
```

#### 2. 資料庫連接失敗
**症狀**: `connection to database failed`
**解決方案**:
```bash
# 檢查 PostgreSQL 服務
sudo systemctl status postgresql

# 檢查資料庫配置
sudo -u postgres psql -c "\l"

# 重新配置資料庫
sudo ./資料庫初始化.sh
```

#### 3. 網站無法訪問
**症狀**: 瀏覽器顯示連接錯誤
**解決方案**:
```bash
# 檢查 Nginx 服務
sudo systemctl status nginx

# 檢查端口
sudo netstat -tlnp | grep :80

# 檢查防火牆
sudo ufw status
```

#### 4. 權限問題
**症狀**: `Permission denied` 錯誤
**解決方案**:
```bash
# 修復權限
sudo chown -R mes:www-data /var/www/mes/
sudo chown -R mes:www-data /var/log/mes/
sudo chmod -R 755 /var/www/mes/
```

### 📞 緊急修復
如果系統完全無法運行，執行緊急修復：
```bash
# 停止所有服務
sudo systemctl stop mes.service mes-celery.service celery-beat.service nginx

# 清理並重新部署
sudo rm -rf /var/www/mes/*
sudo ./全新部署.sh
```

---

## 🛠️ 維護指南

### 📊 日常維護

#### 1. 服務監控
```bash
# 檢查服務狀態
sudo systemctl status mes.service nginx postgresql redis-server

# 查看系統資源
htop
df -h
free -h
```

#### 2. 日誌檢查
```bash
# 查看應用日誌
tail -f /var/log/mes/django/mes.log

# 查看 Nginx 日誌
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 查看系統日誌
journalctl -u mes.service -f
```

#### 3. 備份資料庫
```bash
# 建立資料庫備份
sudo -u mes python3 manage.py dumpdata > backup_$(date +%Y%m%d_%H%M%S).json

# 或使用 PostgreSQL 工具
sudo -u postgres pg_dump mesdb > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 🔄 系統更新

#### 1. 更新系統套件
```bash
sudo apt update && sudo apt upgrade -y
```

#### 2. 重啟服務
```bash
sudo systemctl restart mes.service nginx postgresql redis-server
```

#### 3. 檢查更新後狀態
```bash
sudo systemctl status mes.service nginx postgresql redis-server
```

### 📈 效能優化

#### 1. 資料庫優化
```bash
# 分析資料庫效能
sudo -u postgres psql -d mesdb -c "ANALYZE;"

# 清理舊資料
sudo -u mes python3 manage.py clearsessions
```

#### 2. 快取清理
```bash
# 清理 Redis 快取
redis-cli -a your_redis_password FLUSHALL
```

#### 3. 日誌清理
```bash
# 清理舊日誌
sudo find /var/log/mes -name "*.log" -mtime +30 -delete
sudo find /var/log/nginx -name "*.log" -mtime +30 -delete
```

---

## 📞 技術支援

### 🆘 緊急聯絡
- **系統管理員**: [聯絡資訊]
- **技術支援**: [聯絡資訊]
- **緊急電話**: [電話號碼]

### 📚 相關文件
- [MES 系統使用手冊]
- [API 文件]
- [開發者文件]

### 🔗 有用連結
- [Django 官方文件](https://docs.djangoproject.com/)
- [PostgreSQL 文件](https://www.postgresql.org/docs/)
- [Nginx 文件](https://nginx.org/en/docs/)

---

## 📝 版本資訊

- **文件版本**: 1.0
- **最後更新**: 2025-08-27
- **適用版本**: MES 系統 v1.0
- **作者**: MES 開發團隊

---

**注意**: 本文件適用於 MES 系統的全新生產主機部署。如有疑問，請聯絡技術支援團隊。
