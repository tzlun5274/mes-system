# SMT 補登報工功能說明

## 功能概述

SMT 補登報工功能專為 SMT（表面貼裝技術）設備的歷史報工記錄管理而設計，支援離線數據輸入、歷史數據修正和批量數據處理。

## 主要特色

### 1. 歷史數據管理
- ✅ **離線數據輸入**：支援離線狀態下的報工數據輸入
- ✅ **歷史數據修正**：可修正已存在的報工記錄
- ✅ **時間回溯**：支援設定過去的報工時間
- ✅ **批量處理**：支援批量創建補登記錄

### 2. 完整的 CRUD 操作
- **創建**：新增 SMT 補登報工記錄
- **查詢**：查看補登記錄列表和詳情
- **更新**：編輯現有的補登記錄
- **刪除**：安全刪除補登記錄（需確認）

### 3. 智能驗證機制
- **時間驗證**：報工時間不能超過現在時間
- **數量驗證**：報工數量必須大於 0
- **必填欄位**：設備、工單、報工時間、數量、狀態為必填
- **關聯驗證**：確保設備和工單的有效性

## 功能架構

### 模組層級關係
```
工單管理 (主模組)
└── 報工管理 (次模組)
    └── SMT報工 (次模組)
        ├── SMT現場報工 (即時報工)
        └── SMT補登報工 (歷史補登) ← 本功能
```

### 資料模型
```python
class SMTProductionReport(models.Model):
    equipment = models.ForeignKey('equip.Equipment')  # 設備
    workorder = models.ForeignKey(WorkOrder)          # 工單
    report_time = models.DateTimeField()              # 報工時間
    quantity = models.IntegerField()                  # 報工數量
    hours = models.DecimalField(default=0.0)          # 工作時數
    production_status = models.CharField()            # 報工狀態
    notes = models.TextField()                        # 備註說明
    created_at = models.DateTimeField()               # 建立時間
    updated_at = models.DateTimeField()               # 更新時間
```

## 使用流程

### 1. 進入 SMT 補登報工管理
- 路徑：工單管理 → 報工管理 → SMT報工 → SMT補登報工
- URL：`/workorder/report/smt/supplement/`

### 2. 查看補登記錄列表
- **統計資訊**：今日補登記錄數、今日補登數量、本週補登數量、總記錄數
- **篩選功能**：按設備、日期範圍、報工狀態篩選
- **分頁顯示**：每頁顯示 20 筆記錄
- **操作按鈕**：查看詳情、編輯、刪除

### 3. 新增補登記錄
- 點擊「新增補登記錄」按鈕
- 填寫表單資訊：
  - **設備**：選擇 SMT 設備
  - **工單**：選擇要補登的工單
  - **報工時間**：設定實際的報工時間
  - **報工數量**：輸入實際的報工數量
  - **工作時數**：輸入工作時數（可選）
  - **報工狀態**：選擇開始生產/暫停/完工
  - **備註說明**：輸入補登原因或其他說明

### 4. 編輯補登記錄
- 在記錄列表中點擊「編輯」按鈕
- 修改相關欄位
- 系統會顯示記錄預覽
- 儲存更新

### 5. 查看記錄詳情
- 在記錄列表中點擊「查看詳情」按鈕
- 顯示完整的記錄資訊：
  - 基本資訊（設備、工單）
  - 報工資訊（時間、數量、狀態）
  - 備註說明
  - 時間軸（建立、報工、更新時間）
  - 相關資訊（工單狀態、設備資訊）

### 6. 刪除補登記錄
- 在記錄列表中點擊「刪除」按鈕
- 系統顯示刪除確認頁面
- 必須勾選確認選項
- 顯示完整的記錄資訊供確認
- 確認後執行刪除

## 技術架構

### 前端技術
- **Bootstrap 5**：響應式 UI 設計
- **原生 JavaScript**：表單驗證和互動功能
- **AJAX**：設備與工單的動態載入
- **CSS3**：自定義樣式和動畫效果

### 後端技術
- **Django 5.1.8**：Web 框架
- **PostgreSQL**：資料庫
- **Django Forms**：表單處理和驗證
- **Django Admin**：管理介面

### API 端點
- **GET** `/workorder/report/smt/supplement/`：補登記錄列表
- **GET** `/workorder/report/smt/supplement/create/`：新增補登記錄頁面
- **POST** `/workorder/report/smt/supplement/create/`：提交新增表單
- **GET** `/workorder/report/smt/supplement/edit/<id>/`：編輯補登記錄頁面
- **POST** `/workorder/report/smt/supplement/edit/<id>/`：提交編輯表單
- **GET** `/workorder/report/smt/supplement/detail/<id>/`：查看記錄詳情
- **GET** `/workorder/report/smt/supplement/delete/<id>/`：刪除確認頁面
- **POST** `/workorder/report/smt/supplement/delete/<id>/`：執行刪除
- **GET** `/api/smt/get_workorders_by_equipment/`：根據設備取得工單列表
- **POST** `/api/smt/supplement/batch_create/`：批量創建補登記錄

## 表單設計

### 欄位說明
| 欄位名稱 | 類型 | 必填 | 說明 |
|----------|------|------|------|
| 設備 | 下拉選擇 | ✅ | 選擇 SMT 設備 |
| 工單 | 下拉選擇 | ✅ | 選擇要補登的工單 |
| 報工時間 | 日期時間 | ✅ | 實際的報工時間 |
| 報工數量 | 整數 | ✅ | 實際的報工數量 |
| 工作時數 | 小數 | ❌ | 工作時數（可選） |
| 報工狀態 | 下拉選擇 | ✅ | 開始生產/暫停/完工 |
| 備註說明 | 文字區域 | ❌ | 補登原因或其他說明 |

### 驗證規則
1. **報工時間**：不能超過現在時間
2. **報工數量**：必須大於 0
3. **工作時數**：不能為負數
4. **必填欄位**：設備、工單、報工時間、數量、狀態
5. **關聯驗證**：設備和工單必須存在且有效

## 與其他功能的差異

| 功能 | SMT現場報工 | SMT補登報工 |
|------|-------------|-------------|
| 使用場景 | 即時報工 | 歷史補登 |
| 時間設定 | 自動填入現在時間 | 可設定過去時間 |
| 作業員 | 不需要 | 不需要 |
| 設備 | 需要 | 需要 |
| 工單 | 需要 | 需要 |
| 批量處理 | 不支援 | 支援 |
| 編輯功能 | 不支援 | 支援 |
| 刪除功能 | 不支援 | 支援 |

## 安全性設計

### 1. 權限控制
- 只有登入用戶可以訪問
- 支援 Django 的權限系統

### 2. 資料驗證
- 前端 JavaScript 驗證
- 後端 Django Forms 驗證
- 資料庫層級約束

### 3. 刪除保護
- 刪除前必須確認
- 顯示完整的記錄資訊
- 必須勾選確認選項
- 雙重確認機制

### 4. CSRF 保護
- 所有表單都有 CSRF Token
- API 端點使用 `@csrf_exempt` 裝飾器

## 效能優化

### 1. 資料庫查詢優化
- 使用 `select_related` 減少查詢次數
- 分頁顯示避免大量資料載入
- 索引優化

### 2. 前端優化
- 延遲載入（Lazy Loading）
- 分頁處理
- 快取機制

### 3. 記憶體管理
- 限制查詢結果數量
- 及時釋放資源
- 避免記憶體洩漏

## 未來擴展

### 計劃功能
1. **Excel 匯入/匯出**：支援 Excel 檔案批量處理
2. **資料備份**：自動備份補登記錄
3. **審計日誌**：記錄所有操作歷史
4. **報表分析**：補登資料統計分析
5. **API 整合**：與其他系統的 API 整合

### 資料分析
- 補登頻率分析
- 設備使用率統計
- 工單完成率分析
- 效率趨勢分析

## 使用建議

### 1. 最佳實踐
- 定期備份補登記錄
- 及時處理異常數據
- 保持資料一致性
- 定期清理過期記錄

### 2. 注意事項
- 補登時間不能超過現在時間
- 刪除操作無法復原
- 大量數據處理時注意效能
- 定期檢查資料完整性

### 3. 故障排除
- 檢查設備和工單是否存在
- 確認時間格式正確
- 驗證必填欄位
- 檢查權限設定

## 技術支援

如有任何問題或建議，請聯繫系統管理員或查看相關技術文件。 