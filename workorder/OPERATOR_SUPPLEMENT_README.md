# 作業員補登報工功能說明

## 功能概述

作業員補登報工功能專為作業員的歷史報工記錄管理而設計，支援離線數據輸入、歷史數據修正和批量數據處理。與SMT補登報工不同，作業員補登報工不涉及SMT相關的設備和工序，主要針對一般生產線的作業員進行報工管理。

## 主要特色

### 1. 歷史數據管理
- ✅ **離線數據輸入**：支援離線狀態下的報工數據輸入
- ✅ **歷史數據修正**：可修正已存在的報工記錄
- ✅ **時間回溯**：支援設定過去的報工時間
- ✅ **批量處理**：支援批量創建補登記錄

### 2. 完整的 CRUD 操作
- **創建**：新增作業員補登報工記錄
- **查詢**：查看補登記錄列表和詳情
- **更新**：編輯現有的補登記錄
- **刪除**：安全刪除補登記錄（需確認）

### 3. 智能驗證機制
- **時間驗證**：報工時間不能超過現在時間
- **數量驗證**：報工數量必須大於 0
- **必填欄位**：作業員、工單、工序、報工時間、數量為必填
- **關聯驗證**：確保作業員、工單和工序的有效性

### 4. 審核流程
- **草稿狀態**：新建的記錄，可編輯和刪除
- **待審核狀態**：已提交的記錄，等待管理員審核
- **已審核狀態**：審核通過的記錄，正式生效
- **已駁回狀態**：審核駁回的記錄，需重新提交

## 功能架構

### 模組層級關係
```
工單管理 (主模組)
└── 報工管理 (次模組)
    └── 作業員報工 (次模組)
        ├── 作業員現場報工 (即時報工)
        └── 作業員補登報工 (歷史補登) ← 本功能
```

### 資料模型
```python
class OperatorSupplementReport(models.Model):
    operator = models.ForeignKey('process.Operator')  # 作業員
    workorder = models.ForeignKey(WorkOrder)          # 工單
    process = models.ForeignKey('process.ProcessName') # 工序
    work_date = models.DateField()                    # 報工日期
    start_time = models.TimeField()                   # 開始時間
    end_time = models.TimeField()                     # 結束時間
    work_quantity = models.IntegerField()             # 工作數量
    defect_quantity = models.IntegerField()           # 不良品數量
    is_completed = models.BooleanField()              # 是否完工
    approval_status = models.CharField()              # 審核狀態
    remarks = models.TextField()                      # 備註說明
    abnormal_notes = models.TextField()               # 異常記錄
    created_at = models.DateTimeField()               # 建立時間
    updated_at = models.DateTimeField()               # 更新時間
```

## 使用流程

### 1. 進入作業員補登報工管理
- 路徑：工單管理 → 報工管理 → 作業員報工 → 作業員補登報工
- URL：`/workorder/report/operator/supplement/`

### 2. 查看補登記錄列表
- **統計資訊**：待審核記錄數、已審核記錄數、已駁回記錄數、草稿記錄數
- **篩選功能**：按作業員、工單、工序、審核狀態、日期範圍篩選
- **分頁顯示**：每頁顯示 20 筆記錄
- **操作按鈕**：查看詳情、編輯、刪除、審核

### 3. 新增補登記錄
- 點擊「新增補登記錄」按鈕
- 填寫表單資訊：
  - **作業員**：選擇進行補登報工的作業員
  - **工單**：選擇要補登的工單
  - **工序**：選擇此次補登的工序（排除SMT相關工序）
  - **日期**：設定實際的報工日期
  - **開始時間**：輸入實際開始時間 (24小時制)
  - **結束時間**：輸入實際結束時間 (24小時制)
  - **工作數量**：輸入實際完成的合格產品數量
  - **不良品數量**：輸入本次產生的不良品數量
  - **是否完工**：若此工單在此工序上已全部完成，請勾選
  - **備註**：輸入任何需要補充的資訊
  - **異常記錄**：記錄生產過程中的異常情況

### 4. 編輯補登記錄
- 在記錄列表中點擊「編輯」按鈕
- 修改相關欄位
- 系統會顯示記錄預覽
- 儲存更新

### 5. 查看記錄詳情
- 在記錄列表中點擊「查看詳情」按鈕
- 顯示完整的記錄資訊：
  - 基本資訊（作業員、工單、工序）
  - 報工資訊（日期、時間、數量、狀態）
  - 備註資訊
  - 審核歷程
  - 時間軸（建立、報工、更新時間）

### 6. 審核補登記錄
- **審核通過**：在記錄列表中點擊「審核通過」按鈕
- **駁回**：在記錄列表中點擊「駁回」按鈕，需填寫駁回原因
- **批量操作**：支援批量審核和駁回

### 7. 刪除補登記錄
- 在記錄列表中點擊「刪除」按鈕
- 系統顯示刪除確認頁面
- 必須勾選確認選項
- 顯示完整的記錄資訊供確認
- 確認後執行刪除

## 技術架構

### 前端技術
- **Bootstrap 5**：響應式 UI 設計
- **原生 JavaScript**：表單驗證和互動功能
- **AJAX**：作業員、工單、工序的動態載入
- **CSS3**：自定義樣式和動畫效果

### 後端技術
- **Django 5.1.8**：Web 框架
- **PostgreSQL**：資料庫
- **Django Forms**：表單處理和驗證
- **Django Admin**：管理介面

### API 端點
- **GET** `/workorder/report/operator/supplement/`：補登記錄列表
- **GET** `/workorder/report/operator/supplement/create/`：新增補登記錄頁面
- **POST** `/workorder/report/operator/supplement/create/`：提交新增表單
- **GET** `/workorder/report/operator/supplement/edit/<id>/`：編輯補登記錄頁面
- **POST** `/workorder/report/operator/supplement/edit/<id>/`：提交編輯表單
- **GET** `/workorder/report/operator/supplement/detail/<id>/`：查看記錄詳情
- **GET** `/workorder/report/operator/supplement/delete/<id>/`：刪除確認頁面
- **POST** `/workorder/report/operator/supplement/delete/<id>/`：執行刪除
- **GET** `/workorder/report/operator/supplement/approve/<id>/`：審核通過頁面
- **POST** `/workorder/report/operator/supplement/approve/<id>/`：執行審核通過
- **GET** `/workorder/report/operator/supplement/reject/<id>/`：駁回頁面
- **POST** `/workorder/report/operator/supplement/reject/<id>/`：執行駁回
- **GET** `/api/operator/get_workorders_by_operator/`：根據作業員取得工單列表
- **POST** `/api/operator/supplement/batch_create/`：批量創建補登記錄

## 表單設計

### 欄位說明
| 欄位名稱 | 類型 | 必填 | 說明 |
|----------|------|------|------|
| 作業員 | 下拉選擇 | ✅ | 選擇進行補登報工的作業員 |
| 工單 | 下拉選擇 | ✅ | 選擇要補登的工單 |
| 工序 | 下拉選擇 | ✅ | 選擇此次補登的工序（排除SMT相關工序） |
| 日期 | 日期選擇 | ✅ | 實際的報工日期 |
| 開始時間 | 時間輸入 | ✅ | 實際開始時間 (24小時制) |
| 結束時間 | 時間輸入 | ✅ | 實際結束時間 (24小時制) |
| 工作數量 | 整數 | ✅ | 實際完成的合格產品數量 |
| 不良品數量 | 整數 | ❌ | 本次產生的不良品數量 |
| 是否完工 | 勾選 | ❌ | 若此工單在此工序上已全部完成，請勾選 |
| 備註 | 文字區域 | ❌ | 任何需要補充的資訊 |
| 異常記錄 | 文字區域 | ❌ | 記錄生產過程中的異常情況 |

### 驗證規則
1. **報工時間**：不能超過現在時間
2. **工作數量**：必須大於 0
3. **不良品數量**：不能為負數
4. **必填欄位**：作業員、工單、工序、日期、開始時間、結束時間、工作數量
5. **關聯驗證**：作業員、工單、工序必須存在且有效
6. **工序限制**：工序不能包含SMT相關工序

## 與SMT補登報工的差異

| 功能 | SMT補登報工 | 作業員補登報工 |
|------|-------------|----------------|
| 使用場景 | SMT設備報工 | 作業員報工 |
| 設備需求 | 需要選擇SMT設備 | 不需要設備選擇 |
| 工序範圍 | 僅限SMT相關工序 | 排除SMT相關工序 |
| 作業員 | 不需要 | 需要選擇作業員 |
| 工單 | 需要 | 需要 |
| 批量處理 | 支援 | 支援 |
| 編輯功能 | 支援 | 支援 |
| 刪除功能 | 支援 | 支援 |
| 審核流程 | 核准/駁回 | 審核/駁回 |

## 安全性設計

### 1. 權限控制
- 只有登入用戶可以訪問
- 支援 Django 的權限系統
- 審核功能僅限管理員和超級管理員

### 2. 資料驗證
- 前端 JavaScript 驗證
- 後端 Django Forms 驗證
- 資料庫層級約束

### 3. 刪除保護
- 刪除前必須確認
- 顯示完整的記錄資訊
- 必須勾選確認選項
- 雙重確認機制

### 4. CSRF 保護
- 所有表單都有 CSRF Token
- API 端點使用 `@csrf_exempt` 裝飾器

## 效能優化

### 1. 資料庫查詢優化
- 使用 `select_related` 減少查詢次數
- 分頁顯示避免大量資料載入
- 索引優化

### 2. 前端優化
- 延遲載入（Lazy Loading）
- 分頁處理
- 快取機制

### 3. 記憶體管理
- 限制查詢結果數量
- 及時釋放資源
- 避免記憶體洩漏

## 未來擴展

### 計劃功能
1. **Excel 匯入/匯出**：支援 Excel 檔案批量處理
2. **資料備份**：自動備份補登記錄
3. **審計日誌**：記錄所有操作歷史
4. **報表分析**：補登資料統計分析
5. **API 整合**：與其他系統的 API 整合

### 資料分析
- 補登頻率分析
- 作業員效率統計
- 工單完成率分析
- 效率趨勢分析

## 使用建議

### 1. 最佳實踐
- 定期備份補登記錄
- 及時處理異常數據
- 保持資料一致性
- 定期清理過期記錄

### 2. 注意事項
- 補登時間不能超過現在時間
- 刪除操作無法復原
- 大量數據處理時注意效能
- 定期檢查資料完整性

### 3. 故障排除
- 檢查作業員、工單和工序是否存在
- 確認時間格式正確
- 驗證必填欄位
- 檢查權限設定

## 技術支援

如有任何問題或建議，請聯繫系統管理員或查看相關技術文件。 