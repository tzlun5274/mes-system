# 工單回朔功能說明文件

## 🎯 功能概述

工單回朔功能允許將已完工的工單狀態回朔到「生產中」狀態，並將所有相關資料回寫到原始資料表中。這個功能主要用於修正錯誤的完工操作或需要重新調整生產進度的情況。

## 🔄 回朔流程

### 1. 完工時的資料轉移和刪除
當工單完工時，系統會執行以下操作：

#### 資料轉移：
- **FillWork** → **CompletedProductionReport**：填報記錄轉移到已完工報工記錄
- **OnsiteReport** → **CompletedProductionReport**：現場報工記錄轉移到已完工報工記錄
- **工序資料** → **CompletedWorkOrderProcess**：工序資料轉移到已完工工序記錄

#### 資料刪除：
- **WorkOrderProcess**：工單工序記錄
- **WorkOrderAssignment**：工單分配記錄
- **WorkOrderProduction**：生產記錄
- **WorkOrderProductionDetail**：生產明細記錄
- **WorkOrderDispatch**：派工單記錄
- **WorkOrder**：原始工單記錄

#### 資料保留：
- **FillWork**：填報記錄（有保留天數設計，不會刪除）
- **OnsiteReport**：現場報工記錄（有保留天數設計，不會刪除）

### 2. 回朔時的資料回寫
回朔時，系統會執行以下操作：

#### 重建原始工單：
- 建立或更新 **WorkOrder** 記錄，狀態設為 `in_progress`
- 建立或更新 **WorkOrderProduction** 記錄，狀態設為 `in_production`

#### 重建被刪除的資料：
- **WorkOrderProcess**：從 **CompletedWorkOrderProcess** 重建工單工序記錄
- **WorkOrderAssignment**：從工序資料重建工單分配記錄
- **WorkOrderDispatch**：重建派工單記錄
- **WorkOrderDispatchProcess**：重建派工單工序明細

#### 更新保留的資料狀態：
- **FillWork**：更新填報記錄的完工狀態為 `False`
  - 可選擇保持核准狀態或改為待核准狀態
- **OnsiteReport**：更新現場報工記錄的狀態為 `in_progress`

#### 清理已完工資料：
- 刪除 **CompletedWorkOrder** 記錄
- 刪除相關的 **CompletedWorkOrderProcess** 記錄
- 刪除相關的 **CompletedProductionReport** 記錄

## 🛠️ 技術實現

### 核心服務類別
```python
class WorkOrderRollbackService:
    @staticmethod
    def rollback_completed_workorder(completed_workorder_id)
    @staticmethod
    def can_rollback(completed_workorder_id)
    @staticmethod
    def _rollback_workorder_processes(completed_workorder, workorder)
    @staticmethod
    def _rollback_workorder_assignments(completed_workorder, workorder)
    @staticmethod
    def _rollback_dispatch_records(completed_workorder, workorder)
    @staticmethod
    def _rollback_dispatch_processes(completed_workorder, workorder)
    @staticmethod
    def _update_report_records_status(completed_workorder, workorder)
```

### 視圖功能
- **WorkOrderRollbackConfirmView**：回朔確認頁面
- **rollback_completed_workorder**：執行回朔操作
- **batch_rollback_completed_workorders**：批次回朔
- **check_rollback_status**：檢查回朔狀態

### URL 路由
```
/workorder/rollback/<int:pk>/                    # 回朔確認頁面
/workorder/rollback/<int:pk>/execute/            # 執行回朔
/workorder/rollback/batch/                       # 批次回朔
/workorder/rollback/<int:pk>/check/              # 檢查回朔狀態
```

## 📋 使用方式

### 1. 網頁介面操作
1. 進入已完工工單詳情頁面
2. 點擊「回朔到生產中」按鈕
3. 在確認頁面查看回朔資訊和警告
4. 點擊「確認回朔」執行操作

### 2. 管理命令操作
```bash
# 列出所有已完工工單
python3 manage.py test_rollback --list

# 檢查工單是否可以回朔
python3 manage.py test_rollback --check 8

# 執行回朔操作
python3 manage.py test_rollback --completed-workorder-id 8
```

### 3. API 操作
```python
from workorder.services.rollback_service import WorkOrderRollbackService

# 檢查是否可以回朔
result = WorkOrderRollbackService.can_rollback(completed_workorder_id)

# 執行回朔
result = WorkOrderRollbackService.rollback_completed_workorder(completed_workorder_id)
```

## ⚠️ 重要注意事項

### 1. 不可逆操作
- 回朔操作會刪除已完工工單記錄
- 此操作不可逆轉，請謹慎使用

### 2. 資料一致性
- 回朔會重建所有被刪除的原始資料
- 確保資料的完整性和一致性

### 3. 狀態檢查
- 系統會檢查是否已有對應的生產中工單
- 避免重複回朔造成資料衝突

### 4. 事務安全
- 所有回朔操作都在資料庫事務中執行
- 確保操作的原子性和一致性

## 🔍 回朔條件檢查

系統會檢查以下條件：

1. **已完工工單存在**：確保要回朔的工單存在
2. **無重複工單**：檢查是否已有對應的生產中工單
3. **資料完整性**：確保已完工工單的相關資料完整

## 📊 回朔結果

### 成功回朔
```json
{
    "success": true,
    "message": "工單 331-25106004 已成功回朔到生產中狀態",
    "workorder_id": 123,
    "order_number": "331-25106004"
}
```

### 回朔失敗
```json
{
    "success": false,
    "error": "工單 331-25106004 已經在生產中狀態，無法回朔"
}
```

## 🎯 應用場景

1. **錯誤修正**：修正錯誤的完工操作
2. **生產調整**：需要重新調整生產進度
3. **資料修正**：修正生產資料後重新完工
4. **測試驗證**：測試完工流程後回朔

## 🔧 維護和監控

### 日誌記錄
- 所有回朔操作都會記錄詳細日誌
- 包含操作者、IP地址、操作時間等資訊

### 錯誤處理
- 完整的異常處理機制
- 詳細的錯誤訊息和堆疊追蹤

### 資料備份
- 建議在執行回朔前備份相關資料
- 確保資料安全

## 📝 更新記錄

- **2025-01-XX**：初始版本實現
- 支援單一工單回朔
- 支援批次回朔
- 完整的資料回寫機制
- 網頁介面和管理命令
