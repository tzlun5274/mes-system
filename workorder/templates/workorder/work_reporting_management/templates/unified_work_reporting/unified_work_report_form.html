{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section h5 {
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .time-group {
        display: flex;
        gap: 1rem;
        align-items: end;
    }
    
    .break-time-group {
        display: none;
    }
    
    .break-time-group.show {
        display: flex;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-edit me-2"></i>
            {{ title }}
        </h1>
        <a href="{% url 'unified_work_reporting:unified_work_report_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>返回列表
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard me-2"></i>
                        報工資料
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="workReportForm">
                        {% csrf_token %}
                        
                        <!-- 基本資訊 -->
                        <div class="form-section">
                            <h5><i class="fas fa-user me-2"></i>基本資訊</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.operator.label_tag }}
                                        {{ form.operator }}
                                        {% if form.operator.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.operator.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.company_code.label_tag }}
                                        {{ form.company_code }}
                                        {% if form.company_code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.company_code.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 工單相關 -->
                        <div class="form-section">
                            <h5><i class="fas fa-file-alt me-2"></i>工單相關</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.workorder.label_tag }}
                                        {{ form.workorder }}
                                        {% if form.workorder.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.workorder.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.original_workorder_number.label_tag }}
                                        {{ form.original_workorder_number }}
                                        {% if form.original_workorder_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.original_workorder_number.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.product_id.label_tag }}
                                        {{ form.product_id }}
                                        {% if form.product_id.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.product_id.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.planned_quantity.label_tag }}
                                        {{ form.planned_quantity }}
                                        {% if form.planned_quantity.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.planned_quantity.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 製程相關 -->
                        <div class="form-section">
                            <h5><i class="fas fa-cogs me-2"></i>製程相關</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.process.label_tag }}
                                        {{ form.process }}
                                        {% if form.process.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.process.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.operation.label_tag }}
                                        {{ form.operation }}
                                        {% if form.operation.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.operation.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.equipment.label_tag }}
                                        {{ form.equipment }}
                                        {% if form.equipment.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.equipment.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 時間相關 -->
                        <div class="form-section">
                            <h5><i class="fas fa-clock me-2"></i>時間相關</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.work_date.label_tag }}
                                        {{ form.work_date }}
                                        {% if form.work_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.work_date.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label>工作時間</label>
                                        <div class="time-group">
                                            {{ form.start_time }}
                                            <span class="align-self-center">至</span>
                                            {{ form.end_time }}
                                        </div>
                                        {% if form.start_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.start_time.errors.0 }}
                                        </div>
                                        {% endif %}
                                        {% if form.end_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.end_time.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 休息時間 -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            {{ form.has_break }}
                                            <label class="form-check-label" for="{{ form.has_break.id_for_label }}">
                                                {{ form.has_break.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row break-time-group" id="breakTimeGroup">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label>休息時間</label>
                                        <div class="time-group">
                                            {{ form.break_start_time }}
                                            <span class="align-self-center">至</span>
                                            {{ form.break_end_time }}
                                        </div>
                                        {% if form.break_start_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.break_start_time.errors.0 }}
                                        </div>
                                        {% endif %}
                                        {% if form.break_end_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.break_end_time.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label>休息時數</label>
                                        <input type="text" class="form-control" id="breakHoursDisplay" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 數量相關 -->
                        <div class="form-section">
                            <h5><i class="fas fa-boxes me-2"></i>數量相關</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.work_quantity.label_tag }}
                                        {{ form.work_quantity }}
                                        {% if form.work_quantity.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.work_quantity.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.defect_quantity.label_tag }}
                                        {{ form.defect_quantity }}
                                        {% if form.defect_quantity.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.defect_quantity.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label>總數量</label>
                                        <input type="text" class="form-control" id="totalQuantityDisplay" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 狀態 -->
                        <div class="form-section">
                            <h5><i class="fas fa-flag me-2"></i>狀態</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            {{ form.is_completed }}
                                            <label class="form-check-label" for="{{ form.is_completed.id_for_label }}">
                                                {{ form.is_completed.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 備註 -->
                        <div class="form-section">
                            <h5><i class="fas fa-sticky-note me-2"></i>備註</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.remarks.label_tag }}
                                        {{ form.remarks }}
                                        {% if form.remarks.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.remarks.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.abnormal_notes.label_tag }}
                                        {{ form.abnormal_notes }}
                                        {% if form.abnormal_notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.abnormal_notes.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 提交按鈕 -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>{{ submit_text }}
                            </button>
                            <a href="{% url 'unified_work_reporting:unified_work_report_list' %}" class="btn btn-secondary btn-lg ms-2">
                                <i class="fas fa-times me-2"></i>取消
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 側邊欄 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        工時計算
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">工作時數</label>
                        <input type="text" class="form-control" id="workHoursDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">加班時數</label>
                        <input type="text" class="form-control" id="overtimeHoursDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">總工時</label>
                        <input type="text" class="form-control" id="totalHoursDisplay" readonly>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        操作說明
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>填寫作業員姓名</li>
                        <li><i class="fas fa-check text-success me-2"></i>選擇或輸入工單資訊</li>
                        <li><i class="fas fa-check text-success me-2"></i>設定工作時間</li>
                        <li><i class="fas fa-check text-success me-2"></i>輸入生產數量</li>
                        <li><i class="fas fa-check text-success me-2"></i>系統自動計算工時</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 休息時間控制
    $('#{{ form.has_break.id_for_label }}').change(function() {
        if ($(this).is(':checked')) {
            $('#breakTimeGroup').addClass('show');
        } else {
            $('#breakTimeGroup').removeClass('show');
        }
    });
    
    // 初始化休息時間顯示
    if ($('#{{ form.has_break.id_for_label }}').is(':checked')) {
        $('#breakTimeGroup').addClass('show');
    }
    
    // 數量計算
    function calculateTotalQuantity() {
        var workQty = parseInt($('#{{ form.work_quantity.id_for_label }}').val()) || 0;
        var defectQty = parseInt($('#{{ form.defect_quantity.id_for_label }}').val()) || 0;
        $('#totalQuantityDisplay').val(workQty + defectQty);
    }
    
    $('#{{ form.work_quantity.id_for_label }}, #{{ form.defect_quantity.id_for_label }}').on('input', calculateTotalQuantity);
    calculateTotalQuantity();
    
    // 工時計算
    function calculateWorkHours() {
        var startTime = $('#{{ form.start_time.id_for_label }}').val();
        var endTime = $('#{{ form.end_time.id_for_label }}').val();
        var breakStartTime = $('#{{ form.break_start_time.id_for_label }}').val();
        var breakEndTime = $('#{{ form.break_end_time.id_for_label }}').val();
        
        if (startTime && endTime) {
            // 簡單的工時計算（實際計算邏輯在後端）
            var start = new Date('2000-01-01 ' + startTime);
            var end = new Date('2000-01-01 ' + endTime);
            
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            
            var totalHours = (end - start) / (1000 * 60 * 60);
            
            // 扣除休息時間
            if (breakStartTime && breakEndTime) {
                var breakStart = new Date('2000-01-01 ' + breakStartTime);
                var breakEnd = new Date('2000-01-01 ' + breakEndTime);
                
                if (breakEnd < breakStart) {
                    breakEnd.setDate(breakEnd.getDate() + 1);
                }
                
                var breakHours = (breakEnd - breakStart) / (1000 * 60 * 60);
                totalHours -= breakHours;
                
                $('#breakHoursDisplay').val(breakHours.toFixed(2) + ' 小時');
            } else {
                $('#breakHoursDisplay').val('0.00 小時');
            }
            
            // 假設正常工時為8小時
            var normalHours = Math.min(totalHours, 8);
            var overtimeHours = Math.max(0, totalHours - 8);
            
            $('#workHoursDisplay').val(normalHours.toFixed(2) + ' 小時');
            $('#overtimeHoursDisplay').val(overtimeHours.toFixed(2) + ' 小時');
            $('#totalHoursDisplay').val(totalHours.toFixed(2) + ' 小時');
        }
    }
    
    $('#{{ form.start_time.id_for_label }}, #{{ form.end_time.id_for_label }}, #{{ form.break_start_time.id_for_label }}, #{{ form.break_end_time.id_for_label }}').on('change', calculateWorkHours);
    calculateWorkHours();
    
    // 表單驗證
    $('#workReportForm').submit(function(e) {
        var startTime = $('#{{ form.start_time.id_for_label }}').val();
        var endTime = $('#{{ form.end_time.id_for_label }}').val();
        
        if (startTime && endTime && startTime >= endTime) {
            e.preventDefault();
            alert('結束時間必須晚於開始時間！');
            return false;
        }
        
        var hasBreak = $('#{{ form.has_break.id_for_label }}').is(':checked');
        if (hasBreak) {
            var breakStartTime = $('#{{ form.break_start_time.id_for_label }}').val();
            var breakEndTime = $('#{{ form.break_end_time.id_for_label }}').val();
            
            if (!breakStartTime || !breakEndTime) {
                e.preventDefault();
                alert('勾選有休息時間時，必須填寫休息開始和結束時間！');
                return false;
            }
            
            if (breakStartTime >= breakEndTime) {
                e.preventDefault();
                alert('休息結束時間必須晚於休息開始時間！');
                return false;
            }
        }
    });
});
</script>
{% endblock %} 