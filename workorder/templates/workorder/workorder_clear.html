{% extends 'base.html' %}
{% load static %}

{% block title %}清除所有工單資料{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-trash-alt text-danger"></i>
                清除所有工單資料
            </h1>
            <p class="text-muted mb-0">安全地清除所有工單資料，包括相關的工序和報工記錄</p>
        </div>
        <div>
            <a href="{% url 'workorder:index' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i>
                返回工單管理
            </a>
        </div>
    </div>

    <!-- 警告訊息 -->
    <div class="alert alert-danger">
        <h5><i class="fas fa-exclamation-triangle"></i> 重要警告</h5>
        <ul class="mb-0">
            <li>此操作將<strong>永久刪除</strong>所有工單相關資料</li>
            <li>刪除後無法復原，除非您選擇創建備份</li>
            <li>只有超級用戶可以執行此操作</li>
            <li>建議在執行前先創建備份</li>
        </ul>
    </div>

    <!-- 目前資料統計 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar"></i>
                        目前資料統計
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-primary">{{ workorder_count }}</div>
                                <div class="text-xs text-gray-600">工單數量</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-info">{{ fillwork_count }}</div>
                                <div class="text-xs text-gray-600">填報紀錄</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-success">{{ company_order_count }}</div>
                                <div class="text-xs text-gray-600">公司製令單</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-warning">{{ mkord_main_count }}</div>
                                <div class="text-xs text-gray-600">製令主檔</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-secondary">{{ mkord_mats_count }}</div>
                                <div class="text-xs text-gray-600">製令用料</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-danger">{{ completed_workorder_count }}</div>
                                <div class="text-xs text-gray-600">已完工工單</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-dark">{{ completed_process_count }}</div>
                                <div class="text-xs text-gray-600">已完工工序</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-muted">{{ completed_report_count }}</div>
                                <div class="text-xs text-gray-600">已完工報工</div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="text-center">
                                <div class="h4 text-danger">{{ total_count }}</div>
                                <div class="text-xs text-gray-600">總計</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 清除選項 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cogs"></i>
                        清除選項
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="createBackup" checked>
                                <label class="form-check-label" for="createBackup">
                                    <i class="fas fa-save text-success"></i>
                                    創建備份（推薦）
                                </label>
                                <small class="form-text text-muted">
                                    在刪除前創建資料備份，以便需要時可以復原
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmDelete">
                                <label class="form-check-label" for="confirmDelete">
                                    <i class="fas fa-check-circle text-danger"></i>
                                    我確認要刪除所有工單資料
                                </label>
                                <small class="form-text text-muted">
                                    必須勾選此選項才能執行清除操作
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按鈕 -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <button id="clearBtn" class="btn btn-danger btn-lg" disabled onclick="clearAllWorkorders()">
                <i class="fas fa-trash-alt"></i>
                清除所有工單資料
            </button>
        </div>
    </div>

    <!-- 結果顯示 -->
    <div id="resultArea" class="row" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle"></i>
                        清除結果
                    </h6>
                </div>
                <div class="card-body" id="resultContent">
                    <!-- 結果內容將在這裡顯示 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 確認對話框 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    最終確認
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>您確定要刪除所有工單資料嗎？</strong></p>
                <p>此操作將刪除：</p>
                <ul>
                    <li>{{ workorder_count }} 筆工單</li>
                    <li>{{ fillwork_count }} 筆填報紀錄</li>
                    <li>{{ company_order_count }} 筆公司製令單</li>
                    <li>{{ mkord_main_count }} 筆製令主檔</li>
                    <li>{{ mkord_mats_count }} 筆製令用料</li>
                    <li>{{ completed_workorder_count }} 筆已完工工單</li>
                    <li>{{ completed_process_count }} 筆已完工工序</li>
                    <li>{{ completed_report_count }} 筆已完工報工記錄</li>
                </ul>
                <p class="text-danger"><strong>此操作無法復原！</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="executeClear()">
                    <i class="fas fa-trash-alt"></i>
                    確認刪除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 檢查確認選項
document.getElementById('confirmDelete').addEventListener('change', function() {
    document.getElementById('clearBtn').disabled = !this.checked;
});

function clearAllWorkorders() {
    // 顯示確認對話框
    var confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    confirmModal.show();
}

function executeClear() {
    // 關閉確認對話框
    var confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
    confirmModal.hide();
    
    // 顯示載入狀態
    document.getElementById('clearBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> 清除中...';
    document.getElementById('clearBtn').disabled = true;
    
    // 準備請求資料
    var formData = new FormData();
    formData.append('confirm', 'true');
    formData.append('backup', document.getElementById('createBackup').checked);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // 發送AJAX請求
    fetch('{% url "workorder:clear_workorders_ajax" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(data);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        showError('清除過程中發生錯誤: ' + error.message);
    })
    .finally(() => {
        // 恢復按鈕狀態
        document.getElementById('clearBtn').innerHTML = '<i class="fas fa-trash-alt"></i> 清除所有工單資料';
        document.getElementById('clearBtn').disabled = false;
    });
}

function showResult(data) {
    var resultContent = document.getElementById('resultContent');
    resultContent.innerHTML = `
        <div class="alert alert-success">
            <h5><i class="fas fa-check-circle"></i> 清除成功！</h5>
            <p>${data.message}</p>
        </div>
        
        <h6 class="text-primary">刪除統計：</h6>
        <div class="row">
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-primary">${data.deleted_counts.workorder}</div>
                    <div class="text-xs text-gray-600">工單</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-info">${data.deleted_counts.fillwork}</div>
                    <div class="text-xs text-gray-600">填報紀錄</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-success">${data.deleted_counts.company_order}</div>
                    <div class="text-xs text-gray-600">公司製令單</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-warning">${data.deleted_counts.mkord_main}</div>
                    <div class="text-xs text-gray-600">製令主檔</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-secondary">${data.deleted_counts.mkord_mats}</div>
                    <div class="text-xs text-gray-600">製令用料</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-danger">${data.deleted_counts.completed_workorder}</div>
                    <div class="text-xs text-gray-600">已完工工單</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-dark">${data.deleted_counts.completed_process}</div>
                    <div class="text-xs text-gray-600">已完工工序</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-muted">${data.deleted_counts.completed_report}</div>
                    <div class="text-xs text-gray-600">已完工報工</div>
                </div>
            </div>
            <div class="col-md-1">
                <div class="text-center">
                    <div class="h5 text-danger">${data.deleted_counts.total}</div>
                    <div class="text-xs text-gray-600">總計</div>
                </div>
            </div>
        </div>
        
        ${data.backup_path ? `
        <div class="alert alert-info mt-3">
            <h6><i class="fas fa-save"></i> 備份已創建</h6>
            <p>備份路徑：${data.backup_path}</p>
        </div>
        ` : ''}
        
        <div class="alert alert-warning mt-3">
            <h6><i class="fas fa-info-circle"></i> 下一步</h6>
            <p>現在您可以重新匯入工單資料了。</p>
            <a href="{% url 'workorder:workorder_import' %}" class="btn btn-primary">
                <i class="fas fa-upload"></i>
                匯入工單資料
            </a>
        </div>
    `;
    
    document.getElementById('resultArea').style.display = 'block';
}

function showError(error) {
    var resultContent = document.getElementById('resultContent');
    resultContent.innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> 清除失敗</h5>
            <p>${error}</p>
        </div>
    `;
    
    document.getElementById('resultArea').style.display = 'block';
}
</script>
{% endblock %} 