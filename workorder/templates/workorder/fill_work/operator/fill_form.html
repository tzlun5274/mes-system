{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if object %}編輯作業員補登填報{% else %}新增作業員補登填報{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="fas fa-edit mr-2"></i>
                    {% if object %}編輯作業員補登填報{% else %}新增作業員補登填報{% endif %}
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}">首頁</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'workorder:index' %}">工單管理</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'workorder:fill_work:fill_work_index' %}">填報作業管理</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'workorder:fill_work:fill_work_list' %}">作業員補登填報列表</a></li>
                        <li class="breadcrumb-item active" aria-current="page">
                            {% if object %}編輯{% else %}新增{% endif %}
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- 表單 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list mr-2"></i>
                        作業員補登填報資料
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- 基本資訊欄位 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-info-circle mr-2"></i>基本資訊
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- 產品編號 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.product_id.id_for_label }}" class="form-label">
                                        產品編號 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.product_id }}
                                    {% if form.product_id.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.product_id.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">請手動輸入產品編號</small>
                                </div>
                            </div>

                            <!-- 工單號碼 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.workorder.id_for_label }}" class="form-label">
                                        工單號碼
                                    </label>
                                    {{ form.workorder }}
                                    {% if form.workorder.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.workorder.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">選擇工單號碼</small>
                                </div>
                            </div>

                            <!-- 公司名稱 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.company_name.id_for_label }}" class="form-label">
                                        公司名稱
                                    </label>
                                    {{ form.company_name }}
                                    {% if form.company_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.company_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">輸入公司名稱</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- 作業員 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.operator.id_for_label }}" class="form-label">
                                        作業員 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.operator }}
                                    {% if form.operator.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.operator.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">輸入作業員姓名</small>
                                </div>
                            </div>

                            <!-- 工序 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.process.id_for_label }}" class="form-label">
                                        工序 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.process }}
                                    {% if form.process.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.process.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">選擇作業工序</small>
                                </div>
                            </div>

                            <!-- 使用的設備 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.equipment.id_for_label }}" class="form-label">
                                        使用的設備
                                    </label>
                                    {{ form.equipment }}
                                    {% if form.equipment.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.equipment.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">選擇使用的設備（可選）</small>
                                </div>
                            </div>
                        </div>

                        <!-- 數量資訊欄位 -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h6 class="text-success border-bottom pb-2">
                                    <i class="fas fa-calculator mr-2"></i>數量資訊
                                </h6>
                            </div>
                        </div>

                        <div class="row">
                            <!-- 工單預設生產數量 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.planned_quantity.id_for_label }}" class="form-label">
                                        工單預設生產數量
                                    </label>
                                    {{ form.planned_quantity }}
                                    {% if form.planned_quantity.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.planned_quantity.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">工單預設的生產數量</small>
                                </div>
                            </div>

                            <!-- 工作數量 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.work_quantity.id_for_label }}" class="form-label">
                                        工作數量 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.work_quantity }}
                                    {% if form.work_quantity.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.work_quantity.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">實際完成的工作數量</small>
                                </div>
                            </div>

                            <!-- 不良品數量 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.defect_quantity.id_for_label }}" class="form-label">
                                        不良品數量
                                    </label>
                                    {{ form.defect_quantity }}
                                    {% if form.defect_quantity.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.defect_quantity.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">不良品數量</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- 是否已完工 -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        {{ form.is_completed }}
                                        <label class="custom-control-label" for="{{ form.is_completed.id_for_label }}">
                                            是否已完工
                                        </label>
                                    </div>
                                    {% if form.is_completed.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.is_completed.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">勾選表示此項工作已完成</small>
                                </div>
                            </div>
                        </div>

                        <!-- 時間日期欄位 -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h6 class="text-warning border-bottom pb-2">
                                    <i class="fas fa-clock mr-2"></i>時間日期資訊
                                </h6>
                            </div>
                        </div>

                        <div class="row">
                            <!-- 填報日期 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.work_date.id_for_label }}" class="form-label">
                                        填報日期 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.work_date }}
                                    {% if form.work_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.work_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">選擇填報日期</small>
                                </div>
                            </div>

                            <!-- 開始時間 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.start_time.id_for_label }}" class="form-label">
                                        開始時間 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.start_time }}
                                    {% if form.start_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.start_time.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">格式：HH:MM（24小時制）</small>
                                </div>
                            </div>

                            <!-- 結束時間 -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.end_time.id_for_label }}" class="form-label">
                                        結束時間 <span class="text-danger">*</span>
                                    </label>
                                    {{ form.end_time }}
                                    {% if form.end_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.end_time.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">格式：HH:MM（24小時制）</small>
                                </div>
                            </div>
                        </div>

                        <!-- 備註資訊欄位 -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h6 class="text-secondary border-bottom pb-2">
                                    <i class="fas fa-sticky-note mr-2"></i>備註資訊
                                </h6>
                            </div>
                        </div>

                        <div class="row">
                            <!-- 備註 -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.remarks.id_for_label }}" class="form-label">
                                        備註
                                    </label>
                                    {{ form.remarks }}
                                    {% if form.remarks.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.remarks.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">可選填，記錄特殊情況或說明</small>
                                </div>
                            </div>

                            <!-- 異常記錄 -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.abnormal_notes.id_for_label }}" class="form-label">
                                        異常記錄
                                    </label>
                                    {{ form.abnormal_notes }}
                                    {% if form.abnormal_notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.abnormal_notes.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">記錄異常情況或問題</small>
                                </div>
                            </div>
                        </div>

                        <!-- 按鈕 -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'workorder:fill_work:fill_work_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left mr-1"></i>
                                        返回列表
                                    </a>
                                    <button type="submit" class="btn btn-info">
                                        <i class="fas fa-save mr-1"></i>
                                        儲存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 表單驗證
    $('.needs-validation').on('submit', function(event) {
        if (!this.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(this).addClass('was-validated');
    });

    // 日期選擇器初始化 - 預設為今天
    if ($('#id_work_date').length) {
        $('#id_work_date').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true,
            language: 'zh-TW'
        });
        
        // 如果沒有值，設定為今天
        if (!$('#id_work_date').val()) {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();
            $('#id_work_date').val(yyyy + '-' + mm + '-' + dd);
        }
    }

    // 時間輸入驗證 - 24小時制
    $('#id_start_time, #id_end_time').on('input', function() {
        var value = $(this).val();
        var timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
        
        if (value && !timeRegex.test(value)) {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });

    // 產品編號手動輸入
    $('#id_product_id').attr('readonly', false);
});
</script>
{% endblock %} 