<!--
修正完工工單狀態管理頁面模板
此模板用於檢查和修正錯誤的完工工單狀態
-->
{% extends 'base.html' %}
{% block title %}修正完工工單狀態{% endblock %}
{% block extra_css %}
<style>
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .process-status {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
    }
    
    .status-pending { background-color: #ffc107; color: #000; }
    .status-in_progress { background-color: #17a2b8; color: #fff; }
    .status-completed { background-color: #28a745; color: #fff; }
</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>修正完工工單狀態</h2>
    <div class="row mb-3">
        <div class="col-12">
            <!-- 完工工單子選單 -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'workorder:dispatch_list' %}">派工單</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'workorder:company_orders' %}">公司製令</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'workorder:completed_workorders' %}">完工工單明細</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'workorder:completed_workorders_process_stats' %}">工序統計</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'workorder:fix_completed_workorders' %}">狀態修正</a>
                </li>
            </ul>
        </div>
    </div>
    
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle"></i> 功能說明</h5>
        <p>此功能用於檢查和修正錯誤的完工工單狀態。系統會檢查所有標記為「已完工」的工單，確認它們是否真正符合完工條件：</p>
        <ul>
            <li><strong>簡化邏輯</strong>：出貨包裝報工數量 ≥ 工單生產數量 = 完工</li>
            <li><strong>只計算合格品</strong>：不良品數量不納入完工判斷</li>
            <li><strong>累計所有報工</strong>：支援多次出貨包裝報工，累計總數量</li>
            <li><strong>報工來源</strong>：包含作業員補登、主管報工、SMT報工等</li>
            <li><strong>歷史匯入</strong>：無報工記錄的歷史工單保持完工狀態</li>
        </ul>
    </div>
    
    {% if incorrect_workorders %}
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle"></i> 檢查結果</h5>
        <p>共檢查了 <strong>{{ total_checked }}</strong> 個完工工單，發現 <strong>{{ incorrect_count }}</strong> 個工單狀態不正確。</p>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">錯誤的完工工單列表</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-warning">
                        <tr>
                            <th>工單號</th>
                            <th>公司代號</th>
                            <th>產品編號</th>
                            <th>數量</th>
                            <th>錯誤原因</th>
                            <th>出貨包裝分析</th>
                            <th>工序狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in incorrect_workorders %}
                        <tr>
                            <td>
                                <strong>{{ item.workorder.order_number }}</strong>
                            </td>
                            <td>{{ item.workorder.company_code|default:"-" }}</td>
                            <td>{{ item.workorder.product_code }}</td>
                            <td>{{ item.workorder.quantity }}</td>
                            <td>
                                <span class="text-danger">{{ item.reason }}</span>
                            </td>
                            <td>
                                <div class="small">
                                    <strong>{{ item.packaging_analysis.analysis_summary }}</strong>
                                    {% if item.packaging_analysis.packaging_reports %}
                                    <br>
                                    <span class="text-info">報工記錄：</span>
                                    {% for report in item.packaging_analysis.packaging_reports %}
                                    <div class="ms-2">
                                        <span class="badge {% if report.is_completed %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ report.source }}: {{ report.quantity }}件
                                        </span>
                                        {% if report.defect_quantity > 0 %}
                                        <span class="badge bg-danger">不良{{ report.defect_quantity }}件</span>
                                        {% endif %}
                                        <small class="text-muted">
                                            ({{ report.date|date:"m/d" }} - {{ report.operator|default:report.equipment|default:"未知" }})
                                        </small>
                                        {% if report.is_completed %}<span class="badge bg-success">完工</span>{% endif %}
                                    </div>
                                    {% endfor %}
                                    <div class="ms-2 mt-1">
                                        <strong>總數量：{{ item.packaging_analysis.total_packaging_quantity }}</strong>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% for process in item.processes %}
                                <div class="mb-1">
                                    <span class="process-status status-{{ process.status }}">
                                        {{ process.process_name }}: {{ process.get_status_display }}
                                    </span>
                                    {% if process.completed_quantity %}
                                    <small class="text-muted">({{ process.completed_quantity }}/{{ process.planned_quantity }})</small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <form method="post" onsubmit="return confirm('確定要修正這些錯誤的完工工單狀態嗎？此操作不可復原。')">
                {% csrf_token %}
                <input type="hidden" name="action" value="fix">
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-tools"></i> 修正錯誤狀態
                </button>
                <a href="{% url 'workorder:completed_workorders' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回完工工單列表
                </a>
            </form>
        </div>
    </div>
    
    {% else %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">檢查完工工單狀態</h5>
        </div>
        <div class="card-body">
            <p>點擊下方按鈕開始檢查所有完工工單的狀態。</p>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="check">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> 開始檢查
                </button>
                <a href="{% url 'workorder:completed_workorders' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回完工工單列表
                </a>
            </form>
        </div>
    </div>
    {% endif %}
    
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
// 確認修正操作
function confirmFix() {
    return confirm('確定要修正這些錯誤的完工工單狀態嗎？此操作不可復原。');
}
</script>
{% endblock %} 