{% extends 'workorder/base.html' %}
{% load static %}

{% block title %}從填報資料創建缺失工單{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .missing-workorder-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .missing-workorder-item:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }
    
    .btn-create {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        color: white;
    }
    
    .alert-info {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        color: white;
        border: none;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-plus-circle text-primary"></i>
                    從填報資料創建缺失工單
                </h2>
                <a href="{% url 'workorder:list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 返回工單列表
                </a>
            </div>
            
            <!-- 統計資訊卡片 -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stats-card text-center">
                        <h3 class="mb-2">{{ total_fill_works }}</h3>
                        <p class="mb-0">總填報記錄數</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card text-center">
                        <h3 class="mb-2">{{ total_workorders }}</h3>
                        <p class="mb-0">現有工單數</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card text-center">
                        <h3 class="mb-2">{{ missing_count }}</h3>
                        <p class="mb-0">缺失工單數</p>
                    </div>
                </div>
            </div>
            
            <!-- 說明資訊 -->
            <div class="alert alert-info" role="alert">
                <h5 class="alert-heading">
                    <i class="fas fa-info-circle"></i> 功能說明
                </h5>
                <p class="mb-2">
                    此功能會分析所有填報資料，找出尚未建立對應工單的記錄，並自動創建缺失的工單。
                </p>
                <p class="mb-0">
                    <strong>唯一性識別：</strong>公司名稱/代號 + 製令號碼 + 產品編號
                </p>
            </div>
            
            <!-- 缺失工單列表 -->
            {% if missing_workorders %}
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i>
                            發現 {{ missing_count }} 個缺失的工單
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for item in missing_workorders %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="missing-workorder-item">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <strong class="text-primary">{{ item.workorder }}</strong>
                                            <span class="badge badge-info">{{ item.company_name }}</span>
                                        </div>
                                        <p class="mb-1">
                                            <i class="fas fa-box"></i>
                                            產品編號：{{ item.product_id }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- 創建按鈕 -->
                        <div class="text-center mt-4">
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-create btn-lg">
                                    <i class="fas fa-magic"></i>
                                    創建缺失的工單
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                        <h4 class="mt-3 text-success">沒有發現缺失的工單</h4>
                        <p class="text-muted">所有填報資料都有對應的工單記錄</p>
                    </div>
                </div>
            {% endif %}
            
            <!-- 注意事項 -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb"></i>
                        注意事項
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>創建的工單狀態將設為「待生產」</li>
                        <li>工單來源將標記為「MES手動建立」</li>
                        <li>系統會自動跳過已存在的工單，避免重複創建</li>
                        <li>建議在執行前先備份資料庫</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 確認創建按鈕點擊事件
    $('form').on('submit', function(e) {
        if (!confirm('確定要創建缺失的工單嗎？此操作無法撤銷。')) {
            e.preventDefault();
            return false;
        }
        
        // 顯示載入中狀態
        const btn = $(this).find('button[type="submit"]');
        const originalText = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i> 處理中...');
        btn.prop('disabled', true);
        
        // 恢復按鈕狀態（如果頁面重新載入，這個不會執行）
        setTimeout(function() {
            btn.html(originalText);
            btn.prop('disabled', false);
        }, 10000);
    });
});
</script>
{% endblock %} 