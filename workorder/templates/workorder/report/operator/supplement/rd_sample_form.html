{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if supplement_report %}編輯RD樣品報工{% else %}新增RD樣品報工{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .rd-sample-form-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .rd-sample-form-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .form-section {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #28a745;
    }
    
    .form-section h6 {
        color: #28a745;
        margin-bottom: 15px;
        border-bottom: 2px solid #28a745;
        padding-bottom: 8px;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #495057;
        margin-top: 0.25rem;
        font-weight: 500;
        line-height: 1.4;
    }
    
    .error-text {
        font-size: 0.875rem;
        color: #dc3545;
        margin-top: 0.25rem;
        font-weight: 500;
    }
    
    .form-label {
        color: #212529;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        border-color: #ced4da;
        color: #495057;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-control::placeholder {
        color: #6c757d;
        opacity: 0.8;
    }
    
    /* 修復卡片標題樣式 */
    .card-header h5 {
        color: #212529 !important;
        font-weight: 600 !important;
        font-size: 1.25rem !important;
    }
    
    .card-header.bg-light {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    /* 確保所有標題文字可見 */
    h1, h2, h3, h4, h5, h6 {
        color: #212529 !important;
        font-weight: 600 !important;
    }
    
    /* 修復卡片樣式 */
    .card {
        background-color: #ffffff !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .card-body {
        background-color: #ffffff !important;
        color: #495057 !important;
    }
    
    /* 確保按鈕區域可見 */
    .d-flex.justify-content-end.gap-2 {
        margin-top: 20px;
        padding: 15px 0;
        border-top: 1px solid #dee2e6;
    }
    
    /* 強制顯示所有文字 */
    * {
        color: inherit;
    }
    
    /* 確保表單元素可見 */
    input, select, textarea, button, a {
        color: #495057 !important;
        background-color: #ffffff !important;
    }
    
    /* 確保標籤文字可見 */
    label, .form-label {
        color: #212529 !important;
        font-weight: 600 !important;
    }
    
    .rd-sample-badge {
        background-color: #28a745;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 500;
    }
    
    .rd-info-box {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .rd-info-box h6 {
        color: #155724;
        margin-bottom: 10px;
    }
    
    .rd-info-box p {
        color: #155724;
        margin-bottom: 5px;
    }
    
    .form-check-input:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .rd-sample-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .rd-sample-header h2 {
        color: white;
        margin-bottom: 5px;
    }
    
    .rd-sample-header p {
        color: rgba(255,255,255,0.9);
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- RD樣品報工專用標題 -->
    <div class="rd-sample-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-flask text-white"></i> 
                    {% if supplement_report %}編輯RD樣品報工{% else %}新增RD樣品報工{% endif %}
                </h2>
                <p class="mb-0">
                    {% if supplement_report %}
                        修改RD樣品報工記錄的詳細資訊
                    {% else %}
                        建立新的RD樣品報工記錄
                    {% endif %}
                </p>
            </div>
            <div>
                <span class="rd-sample-badge">
                    <i class="fas fa-flask"></i> RD樣品模式
                </span>
            </div>
        </div>
    </div>

    <!-- RD樣品說明資訊 -->
    <div class="rd-info-box">
        <h6><i class="fas fa-info-circle"></i> RD樣品報工說明</h6>
        <p><strong>適用範圍：</strong>研發部門的樣品製作、測試和驗證工作</p>
        <p><strong>特點：</strong>無需對應正式工單，可自由輸入產品編號，工單預設生產數量為0</p>
        <p><strong>注意事項：</strong>請詳細填寫RD樣品編號，以便後續追蹤和管理</p>
    </div>

    <!-- 表單區域 -->
    <div class="row">
        <div class="col-12">
            <div class="card rd-sample-form-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-flask"></i> 
                        {% if supplement_report %}編輯RD樣品報工記錄{% else %}新增RD樣品報工記錄{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="rd_sample_form">
                        {% csrf_token %}
                        
                        <!-- 隱藏的報工類型欄位 -->
                        <input type="hidden" name="report_type" value="rd_sample">
                        
                        <!-- 基本資訊區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-info-circle"></i> 基本資訊</h6>

                            <!-- 產品編號和工單號碼欄位 -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="rd_sample_code" class="form-label">
                                            產品編號 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="rd_sample_code" 
                                               name="rd_sample_code"
                                               value="{{ form.rd_sample_code.value|default:'' }}"
                                               placeholder="請輸入RD樣品編號，例如：RD-2025-001"
                                               required>
                                        <div class="help-text">請輸入RD樣品的專用編號，建議格式：RD-年份-序號</div>
                                        {% if form.rd_sample_code.errors %}
                                            <div class="error-text">{{ form.rd_sample_code.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="workorder_display" class="form-label">
                                            工單號碼 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="workorder_display" 
                                               name="workorder_display"
                                               value="RD樣品"
                                               readonly>
                                        <div class="help-text">RD樣品報工固定為RD樣品</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 作業員和工序 -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.operator.id_for_label }}" class="form-label">
                                            作業員 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.operator }}
                                        {% if form.operator.help_text %}
                                            <div class="help-text">{{ form.operator.help_text }}</div>
                                        {% endif %}
                                        {% if form.operator.errors %}
                                            <div class="error-text">{{ form.operator.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.process.id_for_label }}" class="form-label">
                                            工序 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.process }}
                                        {% if form.process.help_text %}
                                            <div class="help-text">{{ form.process.help_text }}</div>
                                        {% endif %}
                                        {% if form.process.errors %}
                                            <div class="error-text">{{ form.process.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.equipment.id_for_label }}" class="form-label">
                                            設備
                                        </label>
                                        {{ form.equipment }}
                                        {% if form.equipment.help_text %}
                                            <div class="help-text">{{ form.equipment.help_text }}</div>
                                        {% endif %}
                                        {% if form.equipment.errors %}
                                            <div class="error-text">{{ form.equipment.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 時間資訊區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-clock"></i> 時間資訊</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.work_date.id_for_label }}" class="form-label">
                                            日期 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.work_date }}
                                        {% if form.work_date.help_text %}
                                            <div class="help-text">{{ form.work_date.help_text }}</div>
                                        {% endif %}
                                        {% if form.work_date.errors %}
                                            <div class="error-text">{{ form.work_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.start_time.id_for_label }}" class="form-label">
                                            開始時間 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.start_time }}
                                        {% if form.start_time.help_text %}
                                            <div class="help-text">{{ form.start_time.help_text }}</div>
                                        {% endif %}
                                        {% if form.start_time.errors %}
                                            <div class="error-text">{{ form.start_time.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.end_time.id_for_label }}" class="form-label">
                                            結束時間 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.end_time }}
                                        {% if form.end_time.help_text %}
                                            <div class="help-text">{{ form.end_time.help_text }}</div>
                                        {% endif %}
                                        {% if form.end_time.errors %}
                                            <div class="error-text">{{ form.end_time.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 數量資訊區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-chart-line"></i> 數量資訊</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="planned_quantity" class="form-label">
                                            工單預設生產數量
                                        </label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="planned_quantity" 
                                               name="planned_quantity"
                                               value="0"
                                               readonly>
                                        <div class="help-text">RD樣品報工預設生產數量為0</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.work_quantity.id_for_label }}" class="form-label">
                                            工作數量 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.work_quantity }}
                                        {% if form.work_quantity.help_text %}
                                            <div class="help-text">{{ form.work_quantity.help_text }}</div>
                                        {% endif %}
                                        {% if form.work_quantity.errors %}
                                            <div class="error-text">{{ form.work_quantity.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.defect_quantity.id_for_label }}" class="form-label">
                                            不良品數量
                                        </label>
                                        {{ form.defect_quantity }}
                                        {% if form.defect_quantity.errors %}
                                            <div class="error-text">{{ form.defect_quantity.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 狀態與備註區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-check-circle"></i> 狀態與備註</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            {{ form.is_completed }}
                                            <label class="form-check-label" for="{{ form.is_completed.id_for_label }}">
                                                {{ form.is_completed.label }}
                                            </label>
                                        </div>
                                        {% if form.is_completed.help_text %}
                                            <div class="help-text">{{ form.is_completed.help_text }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.completion_method.id_for_label }}" class="form-label">
                                            完工判斷方式
                                        </label>
                                        {{ form.completion_method }}
                                        {% if form.completion_method.help_text %}
                                            <div class="help-text">{{ form.completion_method.help_text }}</div>
                                        {% endif %}
                                        {% if form.completion_method.errors %}
                                            <div class="error-text">{{ form.completion_method.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.remarks.id_for_label }}" class="form-label">
                                            備註
                                        </label>
                                        {{ form.remarks }}
                                        {% if form.remarks.help_text %}
                                            <div class="help-text">{{ form.remarks.help_text }}</div>
                                        {% endif %}
                                        {% if form.remarks.errors %}
                                            <div class="error-text">{{ form.remarks.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.abnormal_notes.id_for_label }}" class="form-label">
                                            異常記錄
                                        </label>
                                        {{ form.abnormal_notes }}
                                        {% if form.abnormal_notes.help_text %}
                                            <div class="help-text">{{ form.abnormal_notes.help_text }}</div>
                                        {% endif %}
                                        {% if form.abnormal_notes.errors %}
                                            <div class="error-text">{{ form.abnormal_notes.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 表單按鈕 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a href="{% url 'workorder:operator_supplement_report_index' %}" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left"></i> 返回列表
                                        </a>
                                        <a href="{% url 'workorder:operator_supplement_report_create' %}" class="btn btn-outline-primary ml-2">
                                            <i class="fas fa-edit"></i> 切換到正式報工
                                        </a>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save"></i> 
                                            {% if supplement_report %}更新RD樣品報工{% else %}建立RD樣品報工{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // RD樣品編號自動格式化
    const rdSampleCodeInput = document.getElementById('rd_sample_code');
    if (rdSampleCodeInput) {
        rdSampleCodeInput.addEventListener('input', function() {
            let value = this.value.toUpperCase();
            // 自動添加RD-前綴
            if (value && !value.startsWith('RD-')) {
                value = 'RD-' + value;
            }
            this.value = value;
        });
    }

    // 時間選擇器功能
    const startTimeInput = document.querySelector('input[name="start_time"]');
    const endTimeInput = document.querySelector('input[name="end_time"]');
    
    // 創建時間選擇器
    function createTimePicker(inputElement) {
        // 創建時間選擇器容器
        const pickerContainer = document.createElement('div');
        pickerContainer.className = 'time-picker-container';
        pickerContainer.style.cssText = `
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            padding: 10px;
            min-width: 200px;
        `;
        
        // 創建小時選擇器
        const hourSelect = document.createElement('select');
        hourSelect.className = 'form-control mb-2';
        hourSelect.style.width = '80px';
        hourSelect.style.display = 'inline-block';
        hourSelect.style.marginRight = '10px';
        
        for (let i = 0; i < 24; i++) {
            const option = document.createElement('option');
            option.value = i.toString().padStart(2, '0');
            option.textContent = i.toString().padStart(2, '0');
            hourSelect.appendChild(option);
        }
        
        // 創建分鐘選擇器
        const minuteSelect = document.createElement('select');
        minuteSelect.className = 'form-control mb-2';
        minuteSelect.style.width = '80px';
        minuteSelect.style.display = 'inline-block';
        
        for (let i = 0; i < 60; i += 5) {
            const option = document.createElement('option');
            option.value = i.toString().padStart(2, '0');
            option.textContent = i.toString().padStart(2, '0');
            minuteSelect.appendChild(option);
        }
        
        // 創建確定按鈕
        const confirmBtn = document.createElement('button');
        confirmBtn.type = 'button';
        confirmBtn.className = 'btn btn-primary btn-sm';
        confirmBtn.textContent = '確定';
        confirmBtn.style.marginLeft = '10px';
        
        // 創建取消按鈕
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn btn-secondary btn-sm';
        cancelBtn.textContent = '取消';
        cancelBtn.style.marginLeft = '5px';
        
        // 組裝選擇器
        pickerContainer.appendChild(hourSelect);
        pickerContainer.appendChild(minuteSelect);
        pickerContainer.appendChild(confirmBtn);
        pickerContainer.appendChild(cancelBtn);
        
        // 插入到頁面
        inputElement.parentNode.style.position = 'relative';
        inputElement.parentNode.appendChild(pickerContainer);
        
        // 點擊輸入框顯示選擇器
        inputElement.addEventListener('click', function(e) {
            e.preventDefault();
            pickerContainer.style.display = 'block';
            
            // 設定當前值
            const currentValue = inputElement.value;
            if (currentValue) {
                const [hour, minute] = currentValue.split(':');
                hourSelect.value = hour;
                minuteSelect.value = minute;
            }
        });
        
        // 確定按鈕事件
        confirmBtn.addEventListener('click', function() {
            const timeValue = `${hourSelect.value}:${minuteSelect.value}`;
            inputElement.value = timeValue;
            pickerContainer.style.display = 'none';
        });
        
        // 取消按鈕事件
        cancelBtn.addEventListener('click', function() {
            pickerContainer.style.display = 'none';
        });
        
        // 點擊外部關閉選擇器
        document.addEventListener('click', function(e) {
            if (!pickerContainer.contains(e.target) && e.target !== inputElement) {
                pickerContainer.style.display = 'none';
            }
        });
    }
    
    // 初始化時間選擇器
    if (startTimeInput) {
        createTimePicker(startTimeInput);
    }
    if (endTimeInput) {
        createTimePicker(endTimeInput);
    }
    
    // 時間驗證
    if (startTimeInput && endTimeInput) {
        function validateTime() {
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;
            
            if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                
                if (start >= end) {
                    endTimeInput.setCustomValidity('結束時間必須大於開始時間');
                } else {
                    endTimeInput.setCustomValidity('');
                }
            }
        }
        
        startTimeInput.addEventListener('change', validateTime);
        endTimeInput.addEventListener('change', validateTime);
    }

    // 數量驗證
    const workQuantityInput = document.querySelector('input[name="work_quantity"]');
    if (workQuantityInput) {
        workQuantityInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 0) {
                this.setCustomValidity('完成數量不能為負數');
            } else {
                this.setCustomValidity('');
            }
        });
    }

    // 表單提交驗證
    const form = document.getElementById('rd_sample_form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // 檢查必填欄位
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('請填寫所有必填欄位');
            }
        });
    }
});
</script>
{% endblock %} 