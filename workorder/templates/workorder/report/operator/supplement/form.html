{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if supplement_report %}編輯作業員補登報工{% else %}新增作業員補登報工{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* 表單卡片樣式 */
    .operator-supplement-form-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: #ffffff;
    }
    
    /* 表單區塊樣式 */
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .form-section h6 {
        color: #495057;
        margin-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
        font-weight: 600;
    }
    
    /* 說明文字樣式 */
    .help-text {
        font-size: 0.875rem;
        color: #495057 !important;
        margin-top: 0.25rem;
        font-weight: 500;
        line-height: 1.4;
        display: block;
    }
    
    /* 錯誤文字樣式 */
    .error-text {
        font-size: 0.875rem;
        color: #dc3545 !important;
        margin-top: 0.25rem;
        font-weight: 500;
        display: block;
    }
    
    /* 表單標籤樣式 */
    .form-label {
        color: #212529 !important;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    /* 輸入框樣式 */
    .form-control {
        border-color: #ced4da;
        color: #495057;
        background-color: #ffffff;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        color: #495057;
    }
    
    /* 卡片標題樣式 - 強制覆蓋Bootstrap */
    .operator-supplement-form-card .card-header,
    .operator-supplement-form-card .card-header.bg-light {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border-bottom: 3px solid #004085 !important;
        padding: 0 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        border-radius: 8px 8px 0 0 !important;
    }
    
    .operator-supplement-form-card .card-header h5,
    .operator-supplement-form-card .card-header h5.mb-0 {
        color: #ffffff !important;
        font-weight: 700 !important;
        font-size: 1.25rem !important;
        text-align: center !important;
        padding: 15px 20px !important;
        margin: 0 !important;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border-radius: 8px 8px 0 0 !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        border: none !important;
    }
    
    /* 標題欄按鈕樣式 - 強制覆蓋Bootstrap */
    .operator-supplement-form-card .card-header .btn-success,
    .operator-supplement-form-card .card-header .btn-success.btn-sm {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
        border: 2px solid #ffffff !important;
        color: #ffffff !important;
        font-weight: 600 !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        border-radius: 6px !important;
    }
    
    .operator-supplement-form-card .card-header .btn-success:hover,
    .operator-supplement-form-card .card-header .btn-success.btn-sm:hover {
        background: linear-gradient(135deg, #218838 0%, #1c7430 100%) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
        color: #ffffff !important;
    }
    
    /* 確保標題欄容器樣式 */
    .operator-supplement-form-card .card-header .d-flex {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border-radius: 8px 8px 0 0 !important;
        padding: 0 !important;
    }
    
    /* 工單資訊樣式 */
    .workorder-info {
        background-color: #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-top: 10px;
        border-left: 4px solid #007bff;
    }
    
    .workorder-info h6 {
        color: #495057;
        margin-bottom: 10px;
    }
    
    .workorder-info p {
        margin-bottom: 5px;
        color: #6c757d;
    }
    
    .workorder-info strong {
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-edit text-warning"></i> 
                        {% if supplement_report %}編輯作業員補登報工{% else %}新增作業員補登報工{% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if supplement_report %}
                            修改作業員補登報工記錄的詳細資訊
                        {% else %}
                            建立新的作業員補登報工記錄
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'workorder:operator_supplement_report_index' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> 返回列表
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 表單區域 -->
    <div class="row">
        <div class="col-12">
            <div class="card operator-supplement-form-card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-list"></i> 
                            {% if supplement_report %}編輯補登記錄{% else %}新增補登記錄{% endif %}
                        </h5>
                        <a href="{% url 'workorder:rd_sample_supplement_report_create' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-flask"></i> 切換到RD樣品報工
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="operator_supplement_form">
                        {% csrf_token %}
                        
                        <!-- 基本資訊區塊 -->
                        <div class="form-section">

                            <!-- 產品編號和工單號碼欄位 -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.product_id.id_for_label }}" class="form-label">
                                            產品編號 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.product_id }}
                                        {% if form.product_id.help_text %}
                                            <div class="help-text">{{ form.product_id.help_text }}</div>
                                        {% endif %}
                                        {% if form.product_id.errors %}
                                            <div class="error-text">{{ form.product_id.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.workorder.id_for_label }}" class="form-label">
                                            工單號碼 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.workorder }}
                                        {% if form.workorder.help_text %}
                                            <div class="help-text">{{ form.workorder.help_text }}</div>
                                        {% endif %}
                                        {% if form.workorder.errors %}
                                            <div class="error-text">{{ form.workorder.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- 工單資訊顯示區域 -->
                            <div id="workorder_info" class="workorder-info" style="display: none;">
                                <h6><i class="fas fa-file-alt"></i> 工單資訊</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <p><strong>工單號碼：</strong><span id="display_order_number"></span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>公司代號：</strong><span id="display_company_code"></span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>產品編號：</strong><span id="display_product_code"></span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>狀態：</strong><span id="display_status"></span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.operator.id_for_label }}" class="form-label">
                                            作業員 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.operator }}
                                        {% if form.operator.help_text %}
                                            <div class="help-text">{{ form.operator.help_text }}</div>
                                        {% endif %}
                                        {% if form.operator.errors %}
                                            <div class="error-text">{{ form.operator.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.process.id_for_label }}" class="form-label">
                                            工序 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.process }}
                                        {% if form.process.help_text %}
                                            <div class="help-text">{{ form.process.help_text }}</div>
                                        {% endif %}
                                        {% if form.process.errors %}
                                            <div class="error-text">{{ form.process.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.equipment.id_for_label }}" class="form-label">
                                            設備
                                        </label>
                                        {{ form.equipment }}
                                        {% if form.equipment.help_text %}
                                            <div class="help-text">{{ form.equipment.help_text }}</div>
                                        {% endif %}
                                        {% if form.equipment.errors %}
                                            <div class="error-text">{{ form.equipment.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 數量資訊區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-chart-line"></i> 數量資訊</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.planned_quantity.id_for_label }}" class="form-label">
                                            工單預設生產數量
                                        </label>
                                        {{ form.planned_quantity }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.work_quantity.id_for_label }}" class="form-label">
                                            工作數量 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.work_quantity }}
                                        {% if form.work_quantity.help_text %}
                                            <div class="help-text">{{ form.work_quantity.help_text }}</div>
                                        {% endif %}
                                        {% if form.work_quantity.errors %}
                                            <div class="error-text">{{ form.work_quantity.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.defect_quantity.id_for_label }}" class="form-label">
                                            不良品數量
                                        </label>
                                        {{ form.defect_quantity }}
                                        {% if form.defect_quantity.errors %}
                                            <div class="error-text">{{ form.defect_quantity.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 時間資訊區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-clock"></i> 時間資訊</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.work_date.id_for_label }}" class="form-label">
                                            日期 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.work_date }}
                                        {% if form.work_date.help_text %}
                                            <div class="help-text">{{ form.work_date.help_text }}</div>
                                        {% endif %}
                                        {% if form.work_date.errors %}
                                            <div class="error-text">{{ form.work_date.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.start_time.id_for_label }}" class="form-label">
                                            開始時間 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.start_time }}
                                        {% if form.start_time.help_text %}
                                            <div class="help-text">{{ form.start_time.help_text }}</div>
                                        {% endif %}
                                        {% if form.start_time.errors %}
                                            <div class="error-text">{{ form.start_time.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.end_time.id_for_label }}" class="form-label">
                                            結束時間 <span class="text-danger">*</span>
                                        </label>
                                        {{ form.end_time }}
                                        {% if form.end_time.help_text %}
                                            <div class="help-text">{{ form.end_time.help_text }}</div>
                                        {% endif %}
                                        {% if form.end_time.errors %}
                                            <div class="error-text">{{ form.end_time.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 狀態與備註區塊 -->
                        <div class="form-section">
                            <h6><i class="fas fa-check-circle"></i> 狀態與備註</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            {{ form.is_completed }}
                                            <label class="form-check-label" for="{{ form.is_completed.id_for_label }}">
                                                {{ form.is_completed.label }}
                                            </label>
                                        </div>
                                        {% if form.is_completed.help_text %}
                                            <div class="help-text">{{ form.is_completed.help_text }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.completion_method.id_for_label }}" class="form-label">
                                            完工判斷方式
                                        </label>
                                        {{ form.completion_method }}
                                        {% if form.completion_method.help_text %}
                                            <div class="help-text">{{ form.completion_method.help_text }}</div>
                                        {% endif %}
                                        {% if form.completion_method.errors %}
                                            <div class="error-text">{{ form.completion_method.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.remarks.id_for_label }}" class="form-label">
                                            備註
                                        </label>
                                        {{ form.remarks }}
                                        {% if form.remarks.help_text %}
                                            <div class="help-text">{{ form.remarks.help_text }}</div>
                                        {% endif %}
                                        {% if form.remarks.errors %}
                                            <div class="error-text">{{ form.remarks.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.abnormal_notes.id_for_label }}" class="form-label">
                                            異常記錄
                                        </label>
                                        {{ form.abnormal_notes }}
                                        {% if form.abnormal_notes.help_text %}
                                            <div class="help-text">{{ form.abnormal_notes.help_text }}</div>
                                        {% endif %}
                                        {% if form.abnormal_notes.errors %}
                                            <div class="error-text">{{ form.abnormal_notes.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 按鈕區域 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{% url 'workorder:operator_supplement_report_index' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> 取消
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> 
                                        {% if supplement_report %}更新{% else %}儲存{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 取得DOM元素
    const productInput = document.getElementById('product_id_input');
    const workorderSelect = document.getElementById('workorder_select');
    const plannedQuantityInput = document.getElementById('planned_quantity_input');
    const workorderInfo = document.getElementById('workorder_info');
    
    // 產品編號選擇事件（自動帶出工單）
    if (productInput) {
        productInput.addEventListener('change', function() {
            const productId = this.value;
            
            if (productId && productId.trim()) {
                // 呼叫API取得對應的工單
                fetch(`{% url 'workorder:get_workorders_by_product' %}?product_id=${encodeURIComponent(productId.trim())}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' && data.workorders.length > 0) {
                            // 更新工單下拉選單
                            workorderSelect.innerHTML = '<option value="">請選擇工單號碼</option>';
                            
                            data.workorders.forEach(workorder => {
                                const option = document.createElement('option');
                                option.value = workorder.id;
                                option.textContent = `[${workorder.company_code}] 製令單 ${workorder.order_number}`;
                                workorderSelect.appendChild(option);
                            });
                            
                            // 如果只有一個工單，自動選擇
                            if (data.workorders.length === 1) {
                                workorderSelect.value = data.workorders[0].id;
                                workorderSelect.dispatchEvent(new Event('change'));
                            }
                        } else {
                            workorderSelect.innerHTML = '<option value="">請選擇工單號碼</option>';
                        }
                    })
                    .catch(error => {
                        console.error('API錯誤:', error);
                    });
            } else {
                workorderSelect.innerHTML = '<option value="">請選擇工單號碼</option>';
            }
        });
    }
    
    // 工單選擇事件
    if (workorderSelect) {
        workorderSelect.addEventListener('change', function() {
            const workorderId = this.value;
            
            if (workorderId && workorderId !== 'rd_sample') {
                // 載入工單詳細資訊
                fetch(`{% url 'workorder:get_workorder_details' %}?workorder_id=${workorderId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const workorder = data.workorder;
                            
                            // 更新工單預設生產數量
                            if (plannedQuantityInput) {
                                plannedQuantityInput.value = workorder.quantity;
                            }
                            
                            // 自動填入產品編號
                            if (productInput && workorder.product_code) {
                                productInput.value = workorder.product_code;
                            }
                            
                            // 自動帶入工單日期
                            if (workorder.work_date) {
                                let dateStr = workorder.work_date.replace(/\//g, '-');
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                                    const d = new Date(workorder.work_date);
                                    if (!isNaN(d)) {
                                        dateStr = d.toISOString().slice(0, 10);
                                    }
                                }
                                const workDateInput = document.getElementById('work_date_input');
                                if (workDateInput) {
                                    workDateInput.value = dateStr;
                                }
                            }
                            
                            // 顯示工單資訊
                            if (workorderInfo) {
                                document.getElementById('display_order_number').textContent = workorder.order_number;
                                document.getElementById('display_company_code').textContent = workorder.company_code;
                                document.getElementById('display_product_code').textContent = workorder.product_code;
                                document.getElementById('display_status').textContent = workorder.status;
                                workorderInfo.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('AJAX 錯誤:', error);
                    });
            } else {
                if (plannedQuantityInput) plannedQuantityInput.value = '';
                if (workorderInfo) workorderInfo.style.display = 'none';
            }
        });
    }
    
    // 表單驗證
    const form = document.getElementById('operator_supplement_form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const startTime = document.getElementById('start_time_input').value;
            const endTime = document.getElementById('end_time_input').value;
            
            if (startTime && endTime && startTime >= endTime) {
                e.preventDefault();
                alert('結束時間必須大於開始時間');
                return false;
            }
            
            const workQuantity = document.getElementById('work_quantity_input').value;
            if (workQuantity && parseInt(workQuantity) <= 0) {
                e.preventDefault();
                alert('工作數量必須大於0');
                return false;
            }
            
            const defectQuantity = document.getElementById('defect_quantity_input').value;
            if (defectQuantity && parseInt(defectQuantity) < 0) {
                e.preventDefault();
                alert('不良品數量不能為負數');
                return false;
            }
        });
    }
});
</script>
{% endblock %} 