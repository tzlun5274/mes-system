{% extends 'base.html' %}
{% load static %}

{% block title %}新增作業員現場報工{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-user-cog"></i> 新增作業員現場報工
                    </h4>
                </div>
                <div class="card-body">
                    <!-- 訊息顯示區域 -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- 功能說明 -->
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> 現場報工功能說明</h5>
                        <ul class="mb-0">
                            <li><strong>即時報工模式</strong>：以當下報工狀態為時間戳，開工為開始時間，暫停為時間結束</li>
                            <li><strong>狀態流程</strong>：開工 → 暫停 → 重啟開工 → 完工，每筆記錄代表一次完整工作時段</li>
                            <li><strong>數量填寫</strong>：只有暫停、完工、停工時才能填寫工作數量和不良品數量</li>
                            <li><strong>工序自動加入</strong>：報工工單裡沒有的工序時能自動加入工序到工單裡</li>
                            <li>產品編號、工單號碼、公司名稱支援雙向關聯選擇</li>
                            <li>選擇產品編號會自動更新工單號碼選項</li>
                            <li>選擇工單號碼會自動填入公司名稱和預設生產數量</li>
                        </ul>
                    </div>

                    <form method="post" id="onsiteReportForm">
                        {% csrf_token %}
                        
                        <!-- 基本資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-info-circle"></i> 基本資訊
                                </h5>
                            </div>
                            
                            <!-- 產品編號 -->
                            <div class="col-md-4 mb-3">
                                <label for="product_id" class="form-label">產品編號 <span class="text-danger">*</span></label>
                                <select class="form-select" id="product_id" name="product_id" required>
                                    <option value="">請選擇產品編號</option>
                                </select>
                                <div class="form-text">選擇產品編號會自動更新相關的工單號碼選項</div>
                            </div>

                            <!-- 工單號碼 -->
                            <div class="col-md-4 mb-3">
                                <label for="workorder" class="form-label">工單號碼 <span class="text-danger">*</span></label>
                                <select class="form-select" id="workorder" name="workorder" required>
                                    <option value="">請選擇工單號碼</option>
                                </select>
                                <div class="form-text">選擇工單號碼會自動填入公司名稱和預設生產數量</div>
                            </div>

                            <!-- 公司名稱 -->
                            <div class="col-md-4 mb-3">
                                <label for="company_name" class="form-label">公司名稱 <span class="text-danger">*</span></label>
                                <select class="form-select" id="company_name" name="company_name" required>
                                    <option value="">請選擇公司名稱</option>
                                </select>
                                <div class="form-text">選擇公司名稱會更新相關的產品編號選項</div>
                            </div>

                            <!-- 作業員 -->
                            <div class="col-md-4 mb-3">
                                <label for="operator" class="form-label">作業員 <span class="text-danger">*</span></label>
                                <select class="form-select" id="operator" name="operator" required>
                                    <option value="">請選擇作業員</option>
                                </select>
                            </div>

                            <!-- 工序 -->
                            <div class="col-md-4 mb-3">
                                <label for="process" class="form-label">工序 <span class="text-danger">*</span></label>
                                <select class="form-select" id="process" name="process" required>
                                    <option value="">請選擇此次報工的工序</option>
                                </select>
                                <div class="form-text">請選擇此次報工的工序</div>
                            </div>

                            <!-- 使用的設備 -->
                            <div class="col-md-4 mb-3">
                                <label for="equipment" class="form-label">使用的設備</label>
                                <select class="form-select" id="equipment" name="equipment">
                                    <option value="">請選擇設備</option>
                                </select>
                            </div>
                        </div>

                        <!-- 報工資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-clipboard-list"></i> 報工資訊
                                </h5>
                            </div>
                            
                            <!-- 報工狀態 -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">報工狀態 <span class="text-danger">*</span></label>
                                <div class="d-flex flex-row gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status_started" value="started" required>
                                        <label class="form-check-label" for="status_started">開工</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status_paused" value="paused">
                                        <label class="form-check-label" for="status_paused">暫停</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status_resumed" value="resumed">
                                        <label class="form-check-label" for="status_resumed">重啟開工</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status_completed" value="completed">
                                        <label class="form-check-label" for="status_completed">完工</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status_stopped" value="stopped">
                                        <label class="form-check-label" for="status_stopped">停工</label>
                                    </div>
                                </div>
                            </div>

                            <!-- 預設生產數量 -->
                            <div class="col-md-6 mb-3">
                                <label for="planned_quantity" class="form-label">預設生產數量</label>
                                <input type="number" class="form-control" id="planned_quantity" name="planned_quantity" readonly>
                            </div>
                        </div>

                        <!-- 數量資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-calculator"></i> 數量資訊
                                </h5>
                            </div>
                            
                            <!-- 工作數量 -->
                            <div class="col-md-6 mb-3">
                                <label for="work_quantity" class="form-label">工作數量</label>
                                <input type="number" class="form-control" id="work_quantity" name="work_quantity" min="0" value="0">
                            </div>

                            <!-- 不良品數量 -->
                            <div class="col-md-6 mb-3">
                                <label for="defect_quantity" class="form-label">不良品數量</label>
                                <input type="number" class="form-control" id="defect_quantity" name="defect_quantity" min="0" value="0">
                            </div>
                        </div>

                        <!-- 備註資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-sticky-note"></i> 備註資訊
                                </h5>
                            </div>
                            
                            <!-- 備註 -->
                            <div class="col-md-6 mb-3">
                                <label for="remarks" class="form-label">備註</label>
                                <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
                            </div>

                            <!-- 異常記錄 -->
                            <div class="col-md-6 mb-3">
                                <label for="abnormal_notes" class="form-label">異常記錄</label>
                                <textarea class="form-control" id="abnormal_notes" name="abnormal_notes" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- 提交按鈕 -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i> 儲存報工記錄
                                </button>
                                <a href="{% url 'workorder:onsite_reporting:onsite_report_index' %}" class="btn btn-secondary btn-lg ms-2">
                                    <i class="fas fa-arrow-left"></i> 返回列表
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 現場報工表單控制器
        class OnsiteReportController {
            constructor() {
                this.initializeElements();
                this.initializeEventListeners();
                this.loadInitialData();
                this.updateQuantityFields(); // 初始化數量欄位狀態
            }

            // 初始化 DOM 元素
            initializeElements() {
                this.productSelect = document.getElementById('product_id');
                this.workorderSelect = document.getElementById('workorder');
                this.companySelect = document.getElementById('company_name');
                this.plannedQuantityInput = document.getElementById('planned_quantity');
                this.operatorSelect = document.getElementById('operator');
                this.equipmentSelect = document.getElementById('equipment');
                this.workQuantityInput = document.getElementById('work_quantity');
                this.defectQuantityInput = document.getElementById('defect_quantity');
                this.statusRadios = document.querySelectorAll('input[name="status"]');
            }

            // 初始化事件監聽器
            initializeEventListeners() {
                // 公司名稱變更事件
                this.companySelect.addEventListener('change', () => {
                    const companyName = this.companySelect.value;
                    console.log('公司名稱變更為:', companyName);
                    this.loadProducts(companyName);
                    this.loadWorkorders('', companyName);
                });

                            // 產品編號變更事件
            this.productSelect.addEventListener('change', () => {
                const productId = this.productSelect.value;
                const companyName = this.companySelect.value;
                console.log('產品編號變更為:', productId, '公司名稱:', companyName);
                this.loadWorkorders(productId, companyName);
            });

                // 工單號碼變更事件
                this.workorderSelect.addEventListener('change', () => {
                    this.handleWorkorderChange();
                });

                // 設備選擇事件
                this.equipmentSelect.addEventListener('change', () => {
                    this.handleEquipmentChange();
                });

                // 報工狀態變更事件
                this.statusRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateQuantityFields();
                    });
                });

                // 表單提交驗證
                document.getElementById('onsiteReportForm').addEventListener('submit', (e) => {
                    this.validateForm(e);
                });
            }

            // 載入初始資料
            loadInitialData() {
                this.loadCompanies();
                this.loadProducts();
                this.loadWorkorders();
                this.loadOperators();
                this.loadProcesses();
                this.loadEquipment();
            }

            // 載入公司名稱
            async loadCompanies() {
                try {
                    const response = await fetch('/workorder/fill_work/api/workorder-list/');
                    const data = await response.json();
                    if (data.workorders) {
                        // 從工單資料中提取公司名稱
                        const companies = [...new Set(data.workorders.map(w => w.company_name))].sort();
                        this.companySelect.innerHTML = '<option value="">請選擇公司名稱</option>';
                        companies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company;
                            option.textContent = company;
                            this.companySelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('載入公司名稱失敗:', error);
                }
            }

            // 載入產品編號
            async loadProducts(companyName = '') {
                try {
                    let url = '/workorder/fill_work/api/product-list/';
                    if (companyName) {
                        url = `/workorder/fill_work/api/products-by-company/?company_name=${encodeURIComponent(companyName)}`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.products) {
                        this.productSelect.innerHTML = '<option value="">請選擇產品編號</option>';
                        data.products.forEach(product => {
                            const option = document.createElement('option');
                            option.value = product;
                            option.textContent = product;
                            this.productSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('載入產品編號失敗:', error);
                }
            }

            // 載入工單號碼
            async loadWorkorders(productId = '', companyName = '') {
                try {
                    let url = '/workorder/fill_work/api/workorder-list/';
                    if (productId) {
                        url = `/workorder/fill_work/api/workorder-by-product/?product_id=${encodeURIComponent(productId)}`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.workorders) {
                        this.workorderSelect.innerHTML = '<option value="">請選擇工單號碼</option>';
                        
                        // 篩選工單（根據產品編號和公司名稱）
                        let filteredWorkorders = data.workorders;
                        if (companyName) {
                            filteredWorkorders = filteredWorkorders.filter(w => w.company_name === companyName);
                        }
                        
                        filteredWorkorders.forEach(workorder => {
                            const option = document.createElement('option');
                            option.value = workorder.workorder;
                            option.textContent = workorder.workorder;
                            option.dataset.company = workorder.company_name;
                            option.dataset.quantity = workorder.planned_quantity;
                            option.dataset.product = workorder.product_id; // 新增產品編號資料
                            this.workorderSelect.appendChild(option);
                        });
                        
                        console.log(`載入工單號碼完成，共 ${filteredWorkorders.length} 個選項`);
                        
                        // 如果選擇了產品編號，自動選擇第一個工單（參考作業員補登填報紀錄的邏輯）
                        if (productId && filteredWorkorders.length > 0) {
                            const firstWorkorder = filteredWorkorders[0].workorder;
                            this.workorderSelect.value = firstWorkorder;
                            // 觸發工單變更事件
                            this.handleWorkorderChange();
                        }
                    }
                } catch (error) {
                    console.error('載入工單號碼失敗:', error);
                }
            }

            // 載入作業員
            async loadOperators() {
                try {
                    const response = await fetch('/workorder/onsite_reporting/api/operator-list/');
                    const data = await response.json();
                    if (data.success) {
                        this.operatorSelect.innerHTML = '<option value="">請選擇作業員</option>';
                        data.operators.forEach(operator => {
                            const option = document.createElement('option');
                            option.value = operator.name;
                            option.textContent = operator.name;
                            this.operatorSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('載入作業員失敗:', error);
                }
            }

            // 載入工序（過濾非SMT）
            async loadProcesses() {
                try {
                    const response = await fetch('/workorder/onsite_reporting/api/process-list/');
                    const data = await response.json();
                    if (data.success) {
                        const processSelect = document.getElementById('process');
                        processSelect.innerHTML = '<option value="">請選擇此次報工的工序</option>';
                        data.processes.forEach(process => {
                            if (!process.name.includes('SMT')) {
                                const option = document.createElement('option');
                                option.value = process.name;
                                option.textContent = process.name;
                                processSelect.appendChild(option);
                            }
                        });
                    }
                } catch (error) {
                    console.error('載入工序失敗:', error);
                }
            }

            // 載入設備（過濾非SMT）
            async loadEquipment() {
                try {
                    const response = await fetch('/workorder/onsite_reporting/api/equipment-list/');
                    const data = await response.json();
                    if (data.success) {
                        this.equipmentSelect.innerHTML = '<option value="">請選擇設備</option>';
                        data.equipments.forEach(equipment => {
                            if (!equipment.name.includes('SMT')) {
                                const option = document.createElement('option');
                                option.value = equipment.name;
                                option.textContent = equipment.name;
                                this.equipmentSelect.appendChild(option);
                            }
                        });
                    }
                } catch (error) {
                    console.error('載入設備失敗:', error);
                }
            }

            // 處理工單變更
            handleWorkorderChange() {
                const selectedOption = this.workorderSelect.options[this.workorderSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    console.log('工單號碼變更為:', selectedOption.value);
                    
                    // 自動填入公司名稱
                    if (selectedOption.dataset.company) {
                        this.companySelect.value = selectedOption.dataset.company;
                        console.log('自動填入公司名稱:', selectedOption.dataset.company);
                    }
                    
                    // 自動填入預設生產數量
                    const quantity = selectedOption.dataset.quantity || 0;
                    this.plannedQuantityInput.value = quantity;
                    console.log('自動填入預設生產數量:', quantity);
                    
                    // 自動填入產品編號（參考作業員補登填報紀錄的寫法）
                    if (selectedOption.dataset.product) {
                        const productId = selectedOption.dataset.product;
                        console.log('自動填入產品編號:', productId);
                        
                        // 檢查產品編號是否已存在於選項中
                        const existingOption = this.productSelect.querySelector(`option[value="${productId}"]`);
                        if (!existingOption) {
                            // 如果不存在，新增選項
                            const newOption = document.createElement('option');
                            newOption.value = productId;
                            newOption.textContent = productId;
                            this.productSelect.appendChild(newOption);
                        }
                        
                        // 設定選中的產品編號
                        this.productSelect.value = productId;
                    }
                    
                } else {
                    // 清空預設生產數量
                    this.plannedQuantityInput.value = '';
                    console.log('清空預設生產數量');
                }
            }

            // 處理設備變更
            handleEquipmentChange() {
                const equipmentName = this.equipmentSelect.value;
                if (equipmentName) {
                    for (let i = 0; i < this.operatorSelect.options.length; i++) {
                        if (this.operatorSelect.options[i].value === equipmentName) {
                            this.operatorSelect.value = equipmentName;
                            break;
                        }
                    }
                }
            }

            // 更新數量欄位狀態
            updateQuantityFields() {
                const selectedStatus = document.querySelector('input[name="status"]:checked');
                
                if (selectedStatus) {
                    const status = selectedStatus.value;
                    console.log('報工狀態變更為:', status);
                    
                    // 開工和重啟開工時，數量欄位唯讀且設為0
                    if (status === 'started' || status === 'resumed') {
                        this.workQuantityInput.setAttribute('readonly', 'readonly');
                        this.defectQuantityInput.setAttribute('readonly', 'readonly');
                        this.workQuantityInput.value = '0';
                        this.defectQuantityInput.value = '0';
                        this.workQuantityInput.classList.add('bg-light');
                        this.defectQuantityInput.classList.add('bg-light');
                        console.log('數量欄位設為唯讀，數值重置為0');
                    } else {
                        // 暫停、完工、停工時，數量欄位可編輯
                        this.workQuantityInput.removeAttribute('readonly');
                        this.defectQuantityInput.removeAttribute('readonly');
                        this.workQuantityInput.classList.remove('bg-light');
                        this.defectQuantityInput.classList.remove('bg-light');
                        console.log('數量欄位設為可編輯');
                    }
                } else {
                    // 沒有選擇狀態時，預設為可編輯
                    this.workQuantityInput.removeAttribute('readonly');
                    this.defectQuantityInput.removeAttribute('readonly');
                    this.workQuantityInput.classList.remove('bg-light');
                    this.defectQuantityInput.classList.remove('bg-light');
                    console.log('數量欄位預設為可編輯');
                }
            }

            // 表單驗證
            validateForm(e) {
                const requiredFields = ['product_id', 'workorder', 'company_name', 'operator', 'process', 'status'];
                let isValid = true;

                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert('請填寫所有必填欄位');
                }
            }
        }

        // 初始化現場報工控制器
        new OnsiteReportController();
    });
</script>
{% endblock %} 