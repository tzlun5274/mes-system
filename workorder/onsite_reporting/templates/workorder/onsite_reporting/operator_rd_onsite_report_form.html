{% extends 'base.html' %}
{% load static %}

{% block title %}新增作業員RD樣品現場報工{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-flask"></i> 新增作業員RD樣品現場報工
                    </h4>
                </div>
                <div class="card-body">
                    <!-- 訊息顯示區域 -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- 功能說明 -->
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-info-circle"></i> 作業員RD樣品現場報工功能說明</h5>
                        <ul class="mb-0">
                            <li><strong>RD樣品專用</strong>：專門用於研發樣品的現場報工記錄</li>
                            <li><strong>只有開工功能</strong>：記錄作業員開始RD樣品作業的時間點</li>
                            <li><strong>開工記錄</strong>：記錄作業員開始RD樣品作業的時間點</li>
                            <li><strong>產品編號固定為：PFP-CCT</strong></li>
                            <li><strong>工單號碼固定為：RD樣品</strong></li>
                            <li>作業員、工序、設備支援下拉式選擇</li>
                            <li>工序和設備已過濾排除SMT相關項目</li>
                        </ul>
                    </div>

                    <form method="post" id="rdOnsiteReportForm">
                        {% csrf_token %}
                        
                        <!-- 基本資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-info-circle"></i> 基本資訊
                                </h5>
                            </div>
                            
                            <!-- 產品編號 (手動輸入) -->
                            <div class="col-md-4 mb-3">
                                <label for="product_code" class="form-label">產品編號 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="product_code" name="product_code" value="PFP-CCT" placeholder="請輸入產品編號">
                                <div class="form-text">請輸入RD樣品的產品編號</div>
                            </div>

                            <!-- 工單號碼 (固定值) -->
                            <div class="col-md-4 mb-3">
                                <label for="order_number" class="form-label">工單號碼 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="order_number" name="order_number" value="RD樣品" readonly required>
                                <div class="form-text">RD樣品固定工單號碼</div>
                            </div>

                            <!-- 公司名稱 -->
                            <div class="col-md-4 mb-3">
                                <label for="company_code" class="form-label">公司名稱 <span class="text-danger">*</span></label>
                                <select class="form-select" id="company_code" name="company_code" required>
                                    <option value="">請選擇公司名稱</option>
                                    {% for value, label in companies %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇公司名稱</div>
                            </div>

                            <!-- 作業員 -->
                            <div class="col-md-4 mb-3">
                                <label for="operator" class="form-label">作業員 <span class="text-danger">*</span></label>
                                <select class="form-select" id="operator" name="operator" required>
                                    <option value="">請選擇作業員</option>
                                    {% for operator in operators %}
                                        <option value="{{ operator }}">{{ operator }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇執行RD樣品作業的作業員</div>
                            </div>

                            <!-- 工序 -->
                            <div class="col-md-4 mb-3">
                                <label for="process" class="form-label">工序 <span class="text-danger">*</span></label>
                                <select class="form-select" id="process" name="process" required>
                                    <option value="">請選擇工序</option>
                                    {% for process in processes %}
                                        <option value="{{ process }}">{{ process }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇此次RD樣品作業的工序</div>
                            </div>

                            <!-- 使用的設備 -->
                            <div class="col-md-4 mb-3">
                                <label for="equipment" class="form-label">使用的設備</label>
                                <select class="form-select" id="equipment" name="equipment">
                                    <option value="">請選擇使用的設備</option>
                                    {% for equipment in equipments %}
                                        <option value="{{ equipment }}">{{ equipment }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇此次RD樣品作業使用的設備（可選）</div>
                            </div>
                        </div>

                        <!-- 報工資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-clipboard-list"></i> 報工資訊
                                </h5>
                            </div>
                            
                            <!-- 報工狀態和預設生產數量（同一行） -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">報工狀態</label>
                                <input type="text" class="form-control" value="開工" readonly>
                                <input type="hidden" name="status" value="started">
                                <div class="form-text">作業員RD樣品現場報工只有開工功能</div>
                            </div>

                            <!-- 預設生產數量 -->
                            <div class="col-md-6 mb-3">
                                <label for="planned_quantity" class="form-label">預設生產數量</label>
                                <input type="number" class="form-control" id="planned_quantity" name="planned_quantity" value="0" readonly>
                                <div class="form-text">RD樣品無預設生產數量</div>
                            </div>
                        </div>

                        <!-- 數量資訊（作業員RD樣品現場報工不需要填寫數量） -->
                        <div class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-calculator"></i> 數量資訊
                                </h5>
                            </div>
                            
                            <!-- 工作數量 -->
                            <div class="col-md-6 mb-3">
                                <label for="work_quantity" class="form-label">工作數量</label>
                                <input type="number" class="form-control" id="work_quantity" name="work_quantity" min="0" value="0" readonly>
                            </div>

                            <!-- 不良品數量 -->
                            <div class="col-md-6 mb-3">
                                <label for="defect_quantity" class="form-label">不良品數量</label>
                                <input type="number" class="form-control" id="defect_quantity" name="defect_quantity" min="0" value="0" readonly>
                            </div>
                        </div>

                        <!-- 備註資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-sticky-note"></i> 備註資訊
                                </h5>
                            </div>
                            
                            <!-- 備註 -->
                            <div class="col-md-6 mb-3">
                                <label for="remarks" class="form-label">備註</label>
                                <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="請輸入RD樣品作業的相關備註"></textarea>
                                <div class="form-text">請輸入RD樣品作業的相關備註，如實驗目的、特殊要求等</div>
                            </div>

                            <!-- 異常記錄 -->
                            <div class="col-md-6 mb-3">
                                <label for="abnormal_notes" class="form-label">異常記錄</label>
                                <textarea class="form-control" id="abnormal_notes" name="abnormal_notes" rows="3" placeholder="記錄RD樣品作業過程中的異常情況"></textarea>
                                <div class="form-text">記錄RD樣品作業過程中的異常情況，如設備故障、實驗問題等</div>
                            </div>
                        </div>

                        <!-- 提交按鈕 -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-warning btn-lg">
                                    <i class="fas fa-play"></i> 開工
                                </button>
                                <a href="{% url 'workorder:onsite_reporting:onsite_report_index' %}" class="btn btn-secondary btn-lg ms-2">
                                    <i class="fas fa-arrow-left"></i> 返回列表
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 載入指示器 -->
<div id="loadingIndicator" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化現場報工控制器
    class OnsiteReportController {
        constructor() {
            this.initializeElements();
            this.initializeEventListeners();
            this.updateQuantityFields(); // 初始化數量欄位狀態
        }

        // 初始化 DOM 元素
        initializeElements() {
            this.workQuantityInput = document.getElementById('work_quantity');
            this.defectQuantityInput = document.getElementById('defect_quantity');
            this.statusRadios = document.querySelectorAll('input[name="status"]');
        }

        // 初始化事件監聽器
        initializeEventListeners() {
            // 作業員RD樣品現場報工只有開工功能，不需要狀態變更事件
            
            // 表單提交驗證
            const formElement = document.getElementById('rdOnsiteReportForm');
            if (formElement) {
                formElement.addEventListener('submit', (e) => {
                    this.validateForm(e);
                });
            }
        }

        // 更新數量欄位狀態（作業員RD樣品現場報工只有開工功能，數量欄位固定為0）
        updateQuantityFields() {
            // 作業員RD樣品現場報工只有開工功能，數量欄位固定為0且唯讀
            if (this.workQuantityInput) {
                this.workQuantityInput.setAttribute('readonly', 'readonly');
                this.workQuantityInput.value = '0';
                this.workQuantityInput.classList.add('bg-light');
            }
            if (this.defectQuantityInput) {
                this.defectQuantityInput.setAttribute('readonly', 'readonly');
                this.defectQuantityInput.value = '0';
                this.defectQuantityInput.classList.add('bg-light');
            }
            console.log('作業員RD樣品現場報工：數量欄位固定為0且唯讀');
        }

        // 表單驗證
        validateForm(e) {
            let isValid = true;

            // 檢查公司名稱
            const companyField = document.getElementById('company_code');
            if (companyField && !companyField.value.trim()) {
                companyField.classList.add('is-invalid');
                isValid = false;
            } else if (companyField) {
                companyField.classList.remove('is-invalid');
            }

            // 檢查作業員
            const operatorField = document.getElementById('operator');
            if (operatorField && !operatorField.value.trim()) {
                operatorField.classList.add('is-invalid');
                isValid = false;
            } else if (operatorField) {
                operatorField.classList.remove('is-invalid');
            }

            // 檢查工序
            const processField = document.getElementById('process');
            if (processField && !processField.value.trim()) {
                processField.classList.add('is-invalid');
                isValid = false;
            } else if (processField) {
                processField.classList.remove('is-invalid');
            }

            // 檢查報工狀態 (radio button)
            const statusRadios = document.querySelectorAll('input[name="status"]');
            const selectedStatus = document.querySelector('input[name="status"]:checked');
            if (!selectedStatus) {
                // 為所有狀態 radio button 添加錯誤樣式
                statusRadios.forEach(radio => {
                    radio.closest('.form-check').classList.add('is-invalid');
                });
                isValid = false;
            } else {
                // 移除錯誤樣式
                statusRadios.forEach(radio => {
                    radio.closest('.form-check').classList.remove('is-invalid');
                });
            }

            if (!isValid) {
                e.preventDefault();
                alert('請填寫所有必填欄位');
                return false;
            }

            // 驗證通過，顯示載入指示器
            showLoading();
            return true;
        }
    }

    // 初始化現場報工控制器
    new OnsiteReportController();
    
    // 檢查是否有成功訊息，如果有則延遲跳轉
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
                setTimeout(function() {
                    window.location.href = "{% url 'workorder:onsite_reporting:onsite_report_index' %}";
                }, 2000); // 2秒後跳轉
            {% endif %}
        {% endfor %}
    {% endif %}
});

// 顯示載入指示器
function showLoading() {
    const loadingElement = document.getElementById('loadingIndicator');
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
}

// 隱藏載入指示器
function hideLoading() {
    const loadingElement = document.getElementById('loadingIndicator');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
}

// 表單驗證
function validateForm() {
    let errorMessages = [];
    
    // 檢查公司名稱
    const companyElement = document.getElementById('company_code');
    const companyValue = companyElement ? companyElement.value : '';
    if (!companyValue || companyValue === '') {
        errorMessages.push('• 公司名稱 為必填欄位');
    }
    
    // 檢查作業員
    const operatorElement = document.getElementById('operator');
    const operatorValue = operatorElement ? operatorElement.value : '';
    if (!operatorValue || operatorValue === '') {
        errorMessages.push('• 作業員 為必填欄位');
    }
    
    // 檢查工序
    const processElement = document.getElementById('process');
    const processValue = processElement ? processElement.value : '';
    if (!processValue || processValue === '') {
        errorMessages.push('• 工序 為必填欄位');
    }
    
    // 檢查報工狀態 (radio button)
    const selectedStatus = document.querySelector('input[name="status"]:checked');
    if (!selectedStatus) {
        errorMessages.push('• 報工狀態 為必填欄位');
    }
    
    // 驗證工作數量
    const workQuantityElement = document.getElementById('work_quantity');
    const workQuantity = workQuantityElement ? parseInt(workQuantityElement.value) : 0;
    if (isNaN(workQuantity) || workQuantity < 0) {
        errorMessages.push('• 工作數量 不能為負數');
    }
    
    // 驗證不良品數量
    const defectQuantityElement = document.getElementById('defect_quantity');
    const defectQuantity = defectQuantityElement ? parseInt(defectQuantityElement.value) || 0 : 0;
    if (defectQuantity < 0) {
        errorMessages.push('• 不良品數量 不能為負數');
    }
    
    // 如果有錯誤，顯示詳細錯誤訊息
    if (errorMessages.length > 0) {
        const errorTitle = '請修正以下錯誤：';
        const errorContent = errorMessages.join('\n');
        alert(`${errorTitle}\n\n${errorContent}`);
        return false;
    }
    
    return true;
}
</script>
{% endblock %} 