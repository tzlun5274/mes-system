{% extends 'base.html' %}
{% load static %}

{% block title %}新增作業員RD樣品補登填報紀錄{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="card-title">
                        <i class="fas fa-flask"></i> 新增作業員RD樣品補登填報紀錄
                    </h4>
                </div>
                <div class="card-body">
                    <!-- 訊息顯示區域 -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- 功能說明 -->
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-info-circle"></i> RD樣品補登填報說明</h5>
                        <ul class="mb-0">
                            <li><strong>產品編號：預設為PFP-CCT，可手動修改</strong></li>
                            <li><strong>工單號碼固定為：RD樣品</strong></li>
                            <li>公司名稱、作業員、工序、設備支援下拉式選擇</li>
                            <li>工序和設備已過濾排除SMT相關項目</li>
                            <li>休息時間：12:00-13:00，加班時間：17:30後</li>
                            <li>預設生產數量為0（RD樣品無預設數量）</li>
                        </ul>
                    </div>

                    <form method="post" id="fillWorkForm">
                        {% csrf_token %}
                        
                        <!-- 基本資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">基本資訊</h5>
                            </div>
                            
                            <!-- 產品編號 (可編輯) -->
                            <div class="col-md-4 mb-3">
                                <label for="product_id" class="form-label">產品編號</label>
                                <input type="text" class="form-control" id="product_id" name="product_id" value="PFP-CCT" placeholder="請輸入產品編號" title="請輸入RD樣品的產品編號">
                                <div class="form-text">請輸入RD樣品的產品編號（預設為PFP-CCT）</div>
                            </div>

                            <!-- 工單號碼 (固定值) -->
                            <div class="col-md-4 mb-3">
                                <label for="workorder" class="form-label">工單號碼</label>
                                <input type="text" class="form-control" id="workorder" name="workorder" value="RD樣品" readonly>
                                <div class="form-text">RD樣品固定工單號碼</div>
                            </div>

                            <!-- 公司名稱 -->
                            <div class="col-md-4 mb-3">
                                <label for="company_name" class="form-label">公司名稱</label>
                                <select class="form-select" id="company_name" name="company_name">
                                    <option value="">請選擇公司名稱</option>
                                    {% for value, label in form.fields.company_name.choices %}
                                        {% if value %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇公司名稱</div>
                            </div>

                            <!-- 作業員 -->
                            <div class="col-md-4 mb-3">
                                <label for="operator" class="form-label">作業員</label>
                                <select class="form-select" id="operator" name="operator">
                                    <option value="">請選擇作業員</option>
                                    {% for value, label in form.fields.operator.choices %}
                                        {% if value %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇執行RD樣品作業的作業員</div>
                            </div>

                            <!-- 工序 -->
                            <div class="col-md-4 mb-3">
                                <label for="id_process_id" class="form-label">工序</label>
                                {{ form.process_id }}
                                <!-- 隱藏的 process_name 欄位，由 JavaScript 自動填入 -->
                                <input type="hidden" id="id_process_name" name="process_name" value="">
                                <div class="form-text">請選擇此次RD樣品作業的工序（可選）</div>
                            </div>

                            <!-- 使用的設備 -->
                            <div class="col-md-4 mb-3">
                                <label for="equipment" class="form-label">使用的設備</label>
                                <select class="form-select" id="equipment" name="equipment">
                                    <option value="">請選擇使用的設備</option>
                                    {% for value, label in form.fields.equipment.choices %}
                                        {% if value %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇此次RD樣品作業使用的設備（可選）</div>
                            </div>
                        </div>

                        <!-- 數量資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">數量資訊</h5>
                            </div>
                            
                            <!-- 工單預設生產數量 (固定為0) -->
                            <div class="col-md-4 mb-3">
                                <label for="planned_quantity" class="form-label">工單預設生產數量</label>
                                <input type="number" class="form-control" id="planned_quantity" value="0" readonly>
                                <div class="form-text">RD樣品無預設生產數量</div>
                            </div>

                            <!-- 工作數量 -->
                            <div class="col-md-4 mb-3">
                                <label for="work_quantity" class="form-label">工作數量 <span class="text-danger">*</span></label>
                                {{ form.work_quantity }}
                                <div class="form-text">請輸入該時段內實際完成的RD樣品數量</div>
                            </div>

                            <!-- 不良品數量 -->
                            <div class="col-md-4 mb-3">
                                <label for="defect_quantity" class="form-label">不良品數量</label>
                                {{ form.defect_quantity }}
                                <div class="form-text">請輸入本次RD樣品作業中產生的不良品數量，若無則留空或填寫0</div>
                            </div>

                            <!-- 是否已完工 -->
                            <div class="col-md-4 mb-3">
                                <label for="is_completed" class="form-label">是否已完工</label>
                                {{ form.is_completed }}
                                <div class="form-text">勾選表示此RD樣品作業已完成</div>
                            </div>
                        </div>

                        <!-- 時間日期 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">時間日期</h5>
                            </div>
                            
                            <!-- 填報日期 -->
                            <div class="col-md-4 mb-3">
                                <label for="work_date" class="form-label">填報日期 <span class="text-danger">*</span></label>
                                {{ form.work_date }}
                                <div class="form-text">請選擇RD樣品作業的日期</div>
                            </div>

                            <!-- 開始時間 -->
                            <div class="col-md-4 mb-3">
                                <label for="start_time" class="form-label">開始時間 <span class="text-danger">*</span></label>
                                <div class="row">
                                    <div class="col-6">
                                        <select class="form-select" id="start_hour" required>
                                            <option value="">時</option>
                                            {% for hour in hours_range %}
                                                <option value="{{ hour }}">{{ hour }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select" id="start_minute" required>
                                            <option value="">分</option>
                                            {% for minute in minutes_range %}
                                                <option value="{{ minute }}">{{ minute }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" id="start_time" name="start_time">
                                <div class="form-text">請選擇RD樣品作業開始時間 (格式：HH:MM)</div>
                            </div>

                            <!-- 結束時間 -->
                            <div class="col-md-4 mb-3">
                                <label for="end_time" class="form-label">結束時間 <span class="text-danger">*</span></label>
                                <div class="row">
                                    <div class="col-6">
                                        <select class="form-select" id="end_hour" required>
                                            <option value="">時</option>
                                            {% for hour in hours_range %}
                                                <option value="{{ hour }}">{{ hour }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select" id="end_minute" required>
                                            <option value="">分</option>
                                            {% for minute in minutes_range %}
                                                <option value="{{ minute }}">{{ minute }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" id="end_time" name="end_time">
                                <div class="form-text">請選擇RD樣品作業結束時間 (格式：HH:MM)</div>
                            </div>
                        </div>

                        <!-- 備註資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">備註資訊</h5>
                            </div>
                            
                            <!-- 備註 -->
                            <div class="col-md-6 mb-3">
                                <label for="remarks" class="form-label">備註</label>
                                {{ form.remarks }}
                                <div class="form-text">請輸入RD樣品作業的相關備註，如實驗目的、特殊要求等</div>
                            </div>

                            <!-- 異常記錄 -->
                            <div class="col-md-6 mb-3">
                                <label for="abnormal_notes" class="form-label">異常記錄</label>
                                {{ form.abnormal_notes }}
                                <div class="form-text">記錄RD樣品作業過程中的異常情況，如設備故障、實驗問題等</div>
                            </div>
                        </div>

                        <!-- 提交按鈕 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'workorder:fill_work:operator_index' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> 返回列表
                                    </a>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-flask"></i> 儲存RD樣品填報紀錄
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 載入指示器 -->
<div id="loadingIndicator" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 設定預設時間
    document.getElementById('start_hour').value = '08';
    document.getElementById('start_minute').value = '30';
    document.getElementById('end_hour').value = '17';
    document.getElementById('end_minute').value = '30';
    
    // 更新隱藏的時間欄位
    updateTimeFields();
    
    // 時間選擇變更事件
    const timeSelects = ['start_hour', 'start_minute', 'end_hour', 'end_minute'];
    timeSelects.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                updateTimeFields();
                // 同步到手動輸入欄位
                syncToManualInput();
            });
        }
    });
    
    // 表單提交前驗證
    const formElement = document.getElementById('fillWorkForm');
    if (formElement) {
        formElement.addEventListener('submit', function(e) {
            console.log('=== 表單提交事件觸發 ===');
            
            // 先更新隱藏欄位
            updateTimeFields();
            
            // 移除表單驗證，直接提交
            console.log('表單驗證已移除，直接提交');
            // 顯示載入指示器
            showLoading();
            
            // 允許表單提交
            return true;
        });
    }
    
    // 檢查是否有成功訊息，如果有則延遲跳轉
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
                setTimeout(function() {
                    window.location.href = "{% url 'workorder:fill_work:operator_index' %}";
                }, 2000); // 2秒後跳轉
            {% endif %}
        {% endfor %}
    {% endif %}
    
    // 工序選擇事件：自動填入 process_name
    const processSelect = document.getElementById('id_process_id');
    const processNameInput = document.getElementById('id_process_name');
    if (processSelect && processNameInput) {
        console.log('綁定工序選擇事件');
        processSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const processName = selectedOption.text;
            console.log('工序選擇變更為:', processName);
            processNameInput.value = processName;
        });
        
        // 初始化時也要填入 process_name
        if (processSelect.value) {
            const selectedOption = processSelect.options[processSelect.selectedIndex];
            const processName = selectedOption.text;
            processNameInput.value = processName;
        }
    }
});

// 更新隱藏的時間欄位
function updateTimeFields() {
    const startHour = document.getElementById('start_hour').value;
    const startMinute = document.getElementById('start_minute').value;
    const endHour = document.getElementById('end_hour').value;
    const endMinute = document.getElementById('end_minute').value;
    
    if (startHour && startMinute) {
        const startTime = `${startHour}:${startMinute}`;
        document.getElementById('start_time').value = startTime;
    }
    
    if (endHour && endMinute) {
        const endTime = `${endHour}:${endMinute}`;
        document.getElementById('end_time').value = endTime;
    }
}

// 移除手動輸入同步功能（僅保留下拉選擇）
function syncToManualInput() {
    // 僅同步隱藏欄位值
    updateTimeFields();
}

// 顯示載入指示器
function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'block';
}

// 隱藏載入指示器
function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

// 表單驗證（移除驗證邏輯）
function validateForm() {
    // 移除所有驗證邏輯，直接返回true
    console.log('表單驗證已移除，直接通過');
    return true;
}
</script>
{% endblock %} 