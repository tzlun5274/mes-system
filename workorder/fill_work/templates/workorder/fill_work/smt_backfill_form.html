{% extends 'base.html' %}
{% load static %}

{% block title %}新增SMT補登填報紀錄{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">新增SMT補登填報紀錄</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    
                    <!-- 前端驗證與 AJAX 錯誤訊息容器 -->
                    <div id="formMessageContainer"></div>
                    
                    <!-- 功能說明 -->
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> 功能說明</h5>
                        <ul class="mb-0">
                            <li>產品編號、工單號碼、公司名稱支援雙向關聯選擇</li>
                            <li>選擇產品編號會自動更新工單號碼選項</li>
                            <li>選擇工單號碼會自動填入公司名稱和預設生產數量</li>
                            <li>工序和設備已過濾只顯示SMT相關項目</li>
                            <li>選擇設備時作業員欄位會自動填入設備名稱</li>
                            <li>無休息時間，加班時間：16:30後</li>
                        </ul>
                    </div>

                    <form method="post" id="fillWorkForm">
                        {% csrf_token %}
                        
                        <!-- 基本資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">基本資訊</h5>
                            </div>
                            
                            <!-- 產品編號 -->
                            <div class="col-md-4 mb-3">
                                <label for="product_id" class="form-label">產品編號 <span class="text-danger">*</span></label>
                                <select class="form-select" id="product_id" name="product_id" required>
                                    <option value="">請選擇產品編號</option>
                                    {% for value, label in form.fields.product_id.choices %}
                                        {% if value %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">選擇產品編號會自動更新相關的工單號碼選項</div>
                            </div>

                            <!-- 工單號碼 -->
                            <div class="col-md-4 mb-3">
                                <label for="workorder" class="form-label">工單號碼 <span class="text-danger">*</span></label>
                                <select class="form-select" id="workorder" name="workorder" required>
                                    <option value="">請選擇工單號碼</option>
                                </select>
                                <div class="form-text">選擇工單號碼會自動填入公司名稱和預設生產數量</div>
                            </div>

                            <!-- 公司名稱 -->
                            <div class="col-md-4 mb-3">
                                <label for="company_name" class="form-label">公司名稱 <span class="text-danger">*</span></label>
                                <select class="form-select" id="company_name" name="company_name" required>
                                    <option value="">請選擇公司名稱</option>
                                    {% for value, label in form.fields.company_name.choices %}
                                        {% if value %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">選擇公司名稱會更新相關的產品編號選項</div>
                            </div>

                            <!-- 作業員 -->
                            <div class="col-md-4 mb-3">
                                <label for="operator_display" class="form-label">作業員 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="operator_display" value="" readonly>
                                <input type="hidden" id="operator" name="operator" value="">
                            </div>

                            <!-- 工序 -->
                            <div class="col-md-4 mb-3">
                                <label for="process" class="form-label">工序 <span class="text-danger">*</span></label>
                                {{ form.process }}
                                <div class="form-text">請選擇此次填報的工序</div>
                            </div>

                            <!-- 使用的設備 -->
                            <div class="col-md-4 mb-3">
                                <label for="equipment" class="form-label">使用的設備 <span class="text-danger">*</span></label>
                                <select class="form-select" id="equipment" name="equipment" required>
                                    <option value="">請選擇使用的設備</option>
                                    {% for value, label in form.fields.equipment.choices %}
                                        {% if value %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">請選擇此次填報使用的設備，選擇後會自動填入作業員欄位</div>
                            </div>
                        </div>

                        <!-- 數量資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">數量資訊</h5>
                            </div>
                            
                            <!-- 工單預設生產數量 -->
                            <div class="col-md-4 mb-3">
                                <label for="planned_quantity" class="form-label">工單預設生產數量</label>
                                <input type="number" class="form-control" id="planned_quantity" readonly>
                                <div class="form-text">此為工單規劃的總生產數量，不可修改</div>
                            </div>

                            <!-- 工作數量 -->
                            <div class="col-md-4 mb-3">
                                <label for="work_quantity" class="form-label">工作數量 <span class="text-danger">*</span></label>
                                {{ form.work_quantity }}
                                <div class="form-text">請輸入該時段內實際完成的合格產品數量</div>
                            </div>

                            <!-- 不良品數量 -->
                            <div class="col-md-4 mb-3">
                                <label for="defect_quantity" class="form-label">不良品數量</label>
                                {{ form.defect_quantity }}
                                <div class="form-text">請輸入本次生產中產生的不良品數量，若無則留空或填寫0</div>
                            </div>

                            <!-- 是否已完工 -->
                            <div class="col-md-4 mb-3">
                                <label for="is_completed" class="form-label">是否已完工</label>
                                {{ form.is_completed }}
                            </div>
                        </div>

                        <!-- 時間日期 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">時間日期</h5>
                            </div>
                            
                            <!-- 填報日期 -->
                            <div class="col-md-4 mb-3">
                                <label for="work_date" class="form-label">填報日期 <span class="text-danger">*</span></label>
                                {{ form.work_date }}
                                <div class="form-text">請選擇填報作業的日期</div>
                            </div>

                            <!-- 開始時間 -->
                            <div class="col-md-4 mb-3">
                                <label for="start_time" class="form-label">開始時間 <span class="text-danger">*</span></label>
                                <div class="row">
                                    <div class="col-6">
                                        <select class="form-select" id="start_hour" required>
                                            <option value="">時</option>
                                            {% for hour in hours_range %}
                                                <option value="{{ hour }}">{{ hour }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select" id="start_minute" required>
                                            <option value="">分</option>
                                            {% for minute in minutes_range %}
                                                <option value="{{ minute }}">{{ minute }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" id="start_time" name="start_time">
                                <div class="form-text">請選擇開始時間</div>
                            </div>

                            <!-- 結束時間 -->
                            <div class="col-md-4 mb-3">
                                <label for="end_time" class="form-label">結束時間 <span class="text-danger">*</span></label>
                                <div class="row">
                                    <div class="col-6">
                                        <select class="form-select" id="end_hour" required>
                                            <option value="">時</option>
                                            {% for hour in hours_range %}
                                                <option value="{{ hour }}">{{ hour }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select" id="end_minute" required>
                                            <option value="">分</option>
                                            {% for minute in minutes_range %}
                                                <option value="{{ minute }}">{{ minute }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" id="end_time" name="end_time">
                                <div class="form-text">請選擇結束時間</div>
                            </div>
                        </div>

                        <!-- 備註資訊 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">備註資訊</h5>
                            </div>
                            
                            <!-- 備註 -->
                            <div class="col-md-6 mb-3">
                                <label for="remarks" class="form-label">備註</label>
                                {{ form.remarks }}
                                <div class="form-text">請輸入任何需要補充的資訊，如設備標記、操作說明等</div>
                            </div>

                            <!-- 異常記錄 -->
                            <div class="col-md-6 mb-3">
                                <label for="abnormal_notes" class="form-label">異常記錄</label>
                                {{ form.abnormal_notes }}
                                <div class="form-text">記錄生產過程中的異常情況，如設備故障、品質問題等</div>
                            </div>
                        </div>

                        <!-- 提交按鈕 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'workorder:fill_work:smt_index' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> 返回列表
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> 儲存填報紀錄
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 載入指示器 -->
<div id="loadingIndicator" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 設定預設日期為今天
    const today = new Date().toISOString().split('T')[0];
    $('#id_work_date').val(today);
    
    // 設定預設時間
    $('#start_hour').val('08');
    $('#start_minute').val('30');
    $('#end_hour').val('16');
    $('#end_minute').val('30');
    
    // 初始化 product/workorder 下拉
    $('#product_id').html('<option value="">請選擇產品編號</option>');
    $('#workorder').html('<option value="">請選擇工單號碼</option>');
    // 載入全部產品清單
    $.ajax({
        url: '{% url "workorder:fill_work:get_product_list" %}',
        success: function(data){ updateProductOptions(data); }
    });
    // 載入全部工單號碼
    $.ajax({
        url: '{% url "workorder:fill_work:get_all_workorder_numbers" %}',
        success: function(data){
            const arr = (data && data.workorders) ? data.workorders : [];
            let options = '<option value="">請選擇工單號碼</option>';
            arr.forEach(function(no){ options += `<option value="${no}">${no}</option>`; });
            $('#workorder').html(options);
        }
    });
    
    // 更新隱藏的時間欄位
    updateTimeFields();
    $('#start_hour, #start_minute, #end_hour, #end_minute').change(updateTimeFields);
    
    // 產品編號變更事件
    $('#product_id').change(function() {
        const productId = $(this).val();
        if (productId) {
            showLoading();
            $.ajax({
                url: '{% url "workorder:fill_work:get_workorder_by_product" %}',
                data: { product_id: productId },
                success: function(data) {
                    const items = data && data.workorders ? data.workorders : [];
                    updateWorkorderOptions(items);
                    if (items.length > 0) {
                        const firstNo = items[0].workorder;
                        $('#workorder').val(firstNo).trigger('change');
                    }
                    hideLoading();
                },
                error: function() {
                    hideLoading();
                    showFormMessage('danger', '獲取工單資料失敗');
                }
            });
        } else {
            $('#workorder').html('<option value="">請選擇工單號碼</option>');
            $('#planned_quantity').val('');
            $('#company_name').val('');
        }
    });
    
    // 工單號碼變更事件
    $('#workorder').change(function() {
        const workorderId = $(this).val();
        if (workorderId) {
            showLoading();
            $.ajax({
                url: '{% url "workorder:fill_work:get_workorder_info" %}',
                data: { workorder_id: workorderId },
                success: function(data) {
                    $('#planned_quantity').val(data.planned_quantity);
                    $('#company_name').val(data.company_name);
                    // 同步設定產品編號下拉（若不存在於選項，先加入再選取）
                    if (data.product_id) {
                        const $pid = $('#product_id');
                        if ($pid.find(`option[value='${data.product_id}']`).length === 0) {
                            $pid.append(`<option value="${data.product_id}">${data.product_id}</option>`);
                        }
                        $pid.val(data.product_id);
                    }
                    hideLoading();
                },
                error: function() {
                    hideLoading();
                    showFormMessage('danger', '獲取工單資訊失敗');
                }
            });
        } else {
            $('#planned_quantity').val('');
            $('#company_name').val('');
        }
    });
    
    // 公司名稱變更事件
    $('#company_name').change(function() {
        const companyName = $(this).val();
        if (companyName) {
            showLoading();
            $.ajax({
                url: '{% url "workorder:fill_work:get_products_by_company" %}',
                data: { company_name: companyName },
                success: function(data) {
                    updateProductOptions(data);
                    // 若有產品清單，預設選第一筆並觸發變更，更新工單清單
                    const products = (data && data.products) ? data.products : [];
                    if (products.length > 0) {
                        $('#product_id').val(products[0]).trigger('change');
                    } else {
                        $('#product_id').val('');
                        $('#workorder').html('<option value="">請選擇工單號碼</option>');
                        $('#planned_quantity').val('');
                    }
                    hideLoading();
                },
                error: function() {
                    hideLoading();
                    showFormMessage('danger', '獲取產品資料失敗');
                }
            });
        }
    });
    
    // 設備選擇變更事件 - 自動填入作業員
    $('#equipment').change(function() {
        const equipmentName = $(this).val();
        if (equipmentName) {
            $('#operator_display').val(equipmentName);
            $('#operator').val(equipmentName);
        } else {
            $('#operator_display').val('');
            $('#operator').val('');
        }
    });
    
    // 表單提交前驗證
    $('#fillWorkForm').submit(function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return false;
        }
    });
});

// 顯示頁面內提示訊息
function showFormMessage(type, text) {
    const container = $('#formMessageContainer');
    const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
    container.html(alertHtml);
    if (container.length && container[0].scrollIntoView) {
        container[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// 更新工單選項
function updateWorkorderOptions(workorders) {
    let options = '<option value="">請選擇工單號碼</option>';
    workorders.forEach(function(workorder) {
        options += `<option value="${workorder.workorder}" data-planned-quantity="${workorder.planned_quantity}" data-company-name="${workorder.company_name}">${workorder.workorder}</option>`;
    });
    $('#workorder').html(options);
}

// 更新產品選項
function updateProductOptions(data) {
    const products = (data && data.products) ? data.products : [];
    let options = '<option value="">請選擇產品編號</option>';
    products.forEach(function(pid) {
        options += `<option value="${pid}">${pid}</option>`;
    });
    $('#product_id').html(options);
}
// 組合隱藏時間欄位
function updateTimeFields() {
    const sh = $('#start_hour').val();
    const sm = $('#start_minute').val();
    const eh = $('#end_hour').val();
    const em = $('#end_minute').val();
    if (sh && sm) { $('#start_time').val(`${sh}:${sm}`); }
    if (eh && em) { $('#end_time').val(`${eh}:${em}`); }
}

// 顯示載入指示器
function showLoading() {
    $('#loadingIndicator').show();
}

// 隱藏載入指示器
function hideLoading() {
    $('#loadingIndicator').hide();
}

// 表單驗證
function validateForm() {
    // 對應實際欄位 id
    const selectors = {
        product_id: '#product_id',
        workorder: '#workorder',
        company_name: '#company_name',
        process: '#id_process',
        equipment: '#equipment',
        work_quantity: '#id_work_quantity',
        operator: '#operator'
    };
    const labelMap = {
        product_id: '產品編號',
        workorder: '工單號碼',
        company_name: '公司名稱',
        process: '工序',
        equipment: '使用的設備',
        work_quantity: '工作數量',
        operator: '作業員'
    };
    for (const key of Object.keys(selectors)) {
        const sel = selectors[key];
        const v = (($(sel).val()) || '').toString().trim();
        if (!v) {
            showFormMessage('danger', `請填寫必填欄位：${labelMap[key] || key}`);
            if ($(sel).length) { $(sel).focus(); }
            return false;
        }
    }
    
    const startTime = $('#start_time').val();
    const endTime = $('#end_time').val();
    
    if (!startTime || !endTime) {
        showFormMessage('danger', '請選擇完整的開始時間和結束時間');
        return false;
    }
    
    const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
    const endMinutes = parseInt(endTime.split(':')[0]) * 60 + parseInt(endTime.split(':')[1]);
    
    if (endMinutes <= startMinutes) {
        showFormMessage('danger', '結束時間必須晚於開始時間');
        return false;
    }
    
    return true;
}
</script>
{% endblock %}
