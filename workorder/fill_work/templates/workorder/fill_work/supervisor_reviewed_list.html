{% extends 'base.html' %}
{% load static %}

{% block title %}主管已審核填報作業{% endblock %}

{% block extra_head %}
<style>
    .batch-actions {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        /* 調試樣式：確保可見性 */
        position: relative;
        z-index: 1000;
    }
    
    /* 調試：批次操作區域可見性 */
    .batch-actions[style*="display: none"] {
        display: block !important;
        background-color: #fff3cd !important;
        border-color: #ffc107 !important;
    }
    
    .select-all-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .table th:first-child,
    .table td:first-child {
        width: 50px;
        text-align: center;
    }
    
    .checkbox-custom {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .filter-form {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }
    
    .filter-form .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    .filter-form .form-control {
        font-size: 0.875rem;
    }
    
    .filter-actions {
        border-top: 1px solid #dee2e6;
        padding-top: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
	<div class="mb-2">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-2">
				<li class="breadcrumb-item">
					<a href="{% url 'workorder:fill_work:fill_work_index' %}"><i class="fas fa-home"></i> 填報管理</a>
				</li>
				<li class="breadcrumb-item">
					<a href="{% url 'workorder:fill_work:supervisor_approval_index' %}"><i class="fas fa-user-shield"></i> 主管審核</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">已審核</li>
			</ol>
		</nav>
	</div>
	<h4 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>主管已審核填報作業</h4>
	<div class="mb-3 text-muted">共 {{ total_count }} 筆（已核准 {{ approved_count }}、已駁回 {{ rejected_count }}）</div>
	
	<!-- 篩選條件摘要 -->
	{% if filter_operator or filter_workorder or filter_product_id or filter_operation or filter_approval_status or filter_report_type or filter_start_date or filter_end_date %}
	<div class="alert alert-info alert-dismissible fade show" role="alert">
		<strong><i class="fas fa-filter"></i> 篩選條件：</strong>
		{% if filter_operator %}<span class="badge bg-primary me-1">作業員: {{ filter_operator }}</span>{% endif %}
		{% if filter_workorder %}<span class="badge bg-primary me-1">工單: {{ filter_workorder }}</span>{% endif %}
		{% if filter_product_id %}<span class="badge bg-primary me-1">產品: {{ filter_product_id }}</span>{% endif %}
		{% if filter_operation %}<span class="badge bg-primary me-1">工序: {{ filter_operation }}</span>{% endif %}
		{% if filter_approval_status == 'approved' %}<span class="badge bg-success me-1">已核准</span>{% endif %}
		{% if filter_approval_status == 'rejected' %}<span class="badge bg-danger me-1">已駁回</span>{% endif %}
		{% if filter_report_type == 'operator' %}<span class="badge bg-info me-1">作業員</span>{% endif %}
		{% if filter_report_type == 'smt' %}<span class="badge bg-warning me-1">SMT</span>{% endif %}
		{% if filter_start_date %}<span class="badge bg-secondary me-1">開始: {{ filter_start_date }}</span>{% endif %}
		{% if filter_end_date %}<span class="badge bg-secondary me-1">結束: {{ filter_end_date }}</span>{% endif %}
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
	{% endif %}
	
	<!-- 篩選表單 -->
	<form method="get" class="filter-form">
		<div class="row g-2 align-items-end">
		<div class="col-sm-2">
			<label class="form-label">作業員</label>
			<input type="text" name="operator" value="{{ filter_operator }}" class="form-control" placeholder="輸入作業員">
		</div>
		<div class="col-sm-2">
			<label class="form-label">工單號碼</label>
			<input type="text" name="workorder" value="{{ filter_workorder }}" class="form-control" placeholder="輸入工單號碼">
		</div>
		<div class="col-sm-2">
			<label class="form-label">產品編號</label>
			<input type="text" name="product_id" value="{{ filter_product_id }}" class="form-control" placeholder="輸入產品編號">
		</div>
		<div class="col-sm-2">
			<label class="form-label">工序</label>
			<input type="text" name="operation" value="{{ filter_operation }}" class="form-control" placeholder="輸入工序名稱">
		</div>
		<div class="col-sm-2">
			<label class="form-label">審核狀態</label>
			<select name="approval_status" class="form-control">
				<option value="">全部</option>
				<option value="approved" {% if filter_approval_status == 'approved' %}selected{% endif %}>已核准</option>
				<option value="rejected" {% if filter_approval_status == 'rejected' %}selected{% endif %}>已駁回</option>
			</select>
		</div>
		<div class="col-sm-2">
			<label class="form-label">報工類型</label>
			<select name="report_type" class="form-control">
				<option value="">全部</option>
				<option value="operator" {% if filter_report_type == 'operator' %}selected{% endif %}>作業員</option>
				<option value="smt" {% if filter_report_type == 'smt' %}selected{% endif %}>SMT</option>
			</select>
		</div>
		<div class="col-sm-2">
			<label class="form-label">開始日期</label>
			<input type="date" name="start_date" value="{{ filter_start_date }}" class="form-control">
		</div>
		<div class="col-sm-2">
			<label class="form-label">結束日期</label>
			<input type="date" name="end_date" value="{{ filter_end_date }}" class="form-control">
		</div>
		</div>
		<div class="filter-actions d-flex justify-content-between align-items-center">
			<div>
				<button type="submit" class="btn btn-primary">
					<i class="fas fa-search"></i> 篩選
				</button>
				<a href="{% url 'workorder:fill_work:supervisor_reviewed_list' %}" class="btn btn-outline-secondary">
					<i class="fas fa-times"></i> 清除篩選
				</a>
				<button type="button" class="btn btn-outline-info" id="todayFilter">
					<i class="fas fa-calendar-day"></i> 今天
				</button>
				<button type="button" class="btn btn-outline-warning" id="weekFilter">
					<i class="fas fa-calendar-week"></i> 本週
				</button>
				<button type="button" class="btn btn-outline-success" id="exportFilter">
					<i class="fas fa-download"></i> 匯出
				</button>
			</div>
			<div class="text-muted">
				<small>顯示 {{ page_obj.start_index|default:0 }} - {{ page_obj.end_index|default:0 }} 筆，共 {{ page_obj.paginator.count|default:0 }} 筆記錄</small>
			</div>
		</div>
	</form>
	
	<!-- 批次操作提示 -->
	<div class="alert alert-info alert-dismissible fade show" role="alert">
		<strong><i class="fas fa-info-circle"></i> 批次操作說明：</strong>
		勾選下方表格中的記錄，即可顯示批次取消審核功能。
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
	
	<!-- 批次操作區域 -->
	<div class="batch-actions" id="batchActions" style="display: none;">
		<div class="row align-items-center">
			<div class="col-md-6">
				<div class="select-all-container">
					<input type="checkbox" id="selectAll" class="checkbox-custom">
					<label for="selectAll" class="mb-0">全選</label>
					<span class="text-muted ms-2">已選擇 <span id="selectedCount">0</span> 筆記錄</span>
				</div>
			</div>
			<div class="col-md-6 text-end">
				<button type="button" class="btn btn-warning" id="batchUnapproveBtn" disabled>
					<i class="fas fa-undo"></i> 批次取消審核
				</button>
			</div>
		</div>
	</div>
	
	<div class="card">
		<div class="card-body p-0">
			<!-- 快速操作按鈕 -->
			<div class="p-2 border-bottom bg-light">
				<button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllRecords()">
					<i class="fas fa-check-square"></i> 全選所有記錄
				</button>
				<button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSelections()">
					<i class="fas fa-square"></i> 清除選擇
				</button>
			</div>
			
			<div class="table-responsive">
				<form id="batchForm" method="post" action="{% url 'workorder:fill_work:batch_unapprove_fill_work' %}">
					{% csrf_token %}
					<table class="table table-hover table-sm mb-0">
						<thead>
							<tr>
								<th>
									<input type="checkbox" id="headerCheckbox" class="checkbox-custom">
								</th>
								<th>狀態</th>
								<th>類型</th>
								<th>作業員/設備</th>
								<th>工單</th>
								<th>產品</th>
								<th>日期</th>
								<th>開始</th>
								<th>數量</th>
								<th class="text-end">操作</th>
							</tr>
						</thead>
						<tbody>
						{% for r in fill_works %}
							<tr>
								<td>
									<input type="checkbox" name="record_ids" value="{{ r.id }}" class="record-checkbox checkbox-custom">
								</td>
								<td>
									{% if r.approval_status == 'approved' %}
										<span class="badge bg-success">已核准</span>
									{% else %}
										<span class="badge bg-danger">已駁回</span>
									{% endif %}
								</td>
								<td>{% if 'SMT' in r.operator|upper or 'SMT' in r.process.name|upper %}SMT{% else %}作業員{% endif %}</td>
								<td>{{ r.operator|default:r.equipment }}</td>
								<td>{{ r.workorder }}</td>
								<td>{{ r.product_id }}</td>
								<td>{{ r.work_date|date:'Y-m-d' }}</td>
								<td>{{ r.start_time|time:'H:i' }}</td>
								<td>{{ r.work_quantity }}</td>
								<td class="text-end">
									<a href="{% url 'workorder:fill_work:fill_work_detail' r.id %}" class="btn btn-outline-primary btn-sm"><i class="fas fa-eye"></i></a>
								</td>
							</tr>
						{% empty %}
							<tr><td colspan="10" class="text-center text-muted py-3">目前沒有已審核的填報</td></tr>
						{% endfor %}
						</tbody>
					</table>
				</form>
			</div>
		</div>
	</div>
    {% include 'includes/pagination.html' with page_obj=page_obj %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('JavaScript 已載入');
    
    // 篩選功能
    const filterForm = document.querySelector('.filter-form');
    const filterInputs = filterForm.querySelectorAll('input, select');
    
    // 自動提交篩選（當選擇狀態或類型時）
    const autoSubmitSelects = filterForm.querySelectorAll('select[name="approval_status"], select[name="report_type"]');
    autoSubmitSelects.forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });
    
    // 快速篩選功能
    const todayFilter = document.getElementById('todayFilter');
    const weekFilter = document.getElementById('weekFilter');
    
    todayFilter.addEventListener('click', function() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="start_date"]').value = today;
        document.querySelector('input[name="end_date"]').value = today;
        filterForm.submit();
    });
    
    weekFilter.addEventListener('click', function() {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        const endOfWeek = new Date(today);
        endOfWeek.setDate(today.getDate() + (6 - today.getDay()));
        
        document.querySelector('input[name="start_date"]').value = startOfWeek.toISOString().split('T')[0];
        document.querySelector('input[name="end_date"]').value = endOfWeek.toISOString().split('T')[0];
        filterForm.submit();
    });
    
    // 匯出功能
    const exportFilter = document.getElementById('exportFilter');
    exportFilter.addEventListener('click', function() {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('export', 'excel');
        window.open(currentUrl.toString(), '_blank');
    });
    
    // 批次操作功能
    const headerCheckbox = document.getElementById('headerCheckbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    const recordCheckboxes = document.querySelectorAll('.record-checkbox');
    const batchActions = document.getElementById('batchActions');
    const selectedCountSpan = document.getElementById('selectedCount');
    const batchUnapproveBtn = document.getElementById('batchUnapproveBtn');
    const batchForm = document.getElementById('batchForm');
    

    
    // 更新選中數量
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (selectedCountSpan) {
            selectedCountSpan.textContent = count;
        }
        
        // 顯示/隱藏批次操作區域
        if (batchActions) {
            if (count > 0) {
                batchActions.style.display = 'block';
            } else {
                batchActions.style.display = 'none';
            }
        }
        
        // 啟用/禁用批次取消審核按鈕
        if (batchUnapproveBtn) {
            batchUnapproveBtn.disabled = count === 0;
        }
        
        // 更新全選狀態
        const allChecked = checkedBoxes.length === recordCheckboxes.length && recordCheckboxes.length > 0;
        const someChecked = checkedBoxes.length > 0 && checkedBoxes.length < recordCheckboxes.length;
        
        if (headerCheckbox) {
            headerCheckbox.checked = allChecked;
            headerCheckbox.indeterminate = someChecked;
        }
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked;
        }
    }
    
    // 表頭勾選框事件
    if (headerCheckbox) {
        headerCheckbox.addEventListener('change', function() {
            recordCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // 全選勾選框事件
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            recordCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // 個別記錄勾選框事件
    recordCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
        });
    });
    
    // 批次取消審核按鈕事件
    if (batchUnapproveBtn) {
        batchUnapproveBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                alert('請選擇要取消審核的記錄');
                return;
            }
            
            // 檢查表單數據
            const formData = new FormData(batchForm);
            const recordIds = formData.getAll('record_ids');
            
            if (confirm(`確定要取消審核選中的 ${checkedBoxes.length} 筆記錄嗎？\n\n取消審核後，這些記錄將回到待審核狀態。`)) {
                if (batchForm) {
                    batchForm.submit();
                } else {
                    alert('系統錯誤：找不到表單元素');
                }
            }
        });
    }
    
    // 初始化
    updateSelectedCount();
});

function selectAllRecords() {
    const recordCheckboxes = document.querySelectorAll('.record-checkbox');
    recordCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function clearAllSelections() {
    const recordCheckboxes = document.querySelectorAll('.record-checkbox');
    recordCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}
</script>
{% endblock %} 