# 工單自動分配作業員和設備功能

## 功能概述

本功能在製令轉工單時自動分配作業員和設備，提升工作效率，減少手動分配的時間。

## 修改內容

### 1. 修改的檔案

- `workorder/views.py` - 修改 `manual_convert_orders` 和 `create_workorder_processes` 函數
- `workorder/models.py` - 添加 `auto_assignment` 操作類型到 `WorkOrderProcessLog`

### 2. 自動分配邏輯

#### 作業員分配
1. 根據工序名稱找到有對應技能的作業員
2. 計算每個作業員的當前工作負載（進行中的工序數量）
3. 選擇工作負載最輕的作業員進行分配

#### 設備分配
1. 優先檢查工序是否有指定可用設備ID（`usable_equipment_ids`）
2. 如果沒有指定設備，則從工序設備對應表（`ProcessEquipment`）查找
3. 選擇狀態為「閒置」的設備進行分配

### 3. 分配優先順序

1. **作業員分配**：
   - 查找有該工序技能的作業員
   - 計算當前工作負載
   - 選擇負載最輕的作業員

2. **設備分配**：
   - 優先使用工序指定的設備ID
   - 其次使用工序設備對應表
   - 只分配狀態為「閒置」的設備

### 4. 日誌記錄

每次自動分配都會記錄到 `WorkOrderProcessLog` 表中：
- 操作類型：`auto_assignment`
- 記錄分配的作業員和設備
- 備註說明分配原因

### 5. 成功訊息

轉換完成後會顯示詳細的成功訊息，包含：
- 轉換的製令單數量
- 建立的工序明細數量
- 自動分配的工序數量

## 使用方式

### 手動轉換製令單
1. 進入「公司製令單」頁面
2. 點擊「手動轉換」按鈕
3. 系統會自動：
   - 轉換製令單為工單
   - 建立工序明細
   - 自動分配作業員和設備

### 建立工序明細
1. 進入工單詳情頁面
2. 點擊「建立工序明細」按鈕
3. 系統會自動：
   - 根據產品工藝路線建立工序
   - 自動分配作業員和設備

## 注意事項

1. **作業員技能設定**：確保作業員有正確的技能設定
2. **設備狀態**：只有狀態為「閒置」的設備才會被分配
3. **工序設備對應**：建議在工序管理中設定完整的設備對應關係
4. **日誌追蹤**：所有自動分配都會記錄在日誌中，方便追蹤

## 測試結果

測試顯示系統能正確：
- 找到有技能的作業員（4-6人/工序）
- 找到可用的設備（狀態為閒置）
- 選擇工作負載最輕的作業員
- 記錄分配日誌

## 未來改進

1. 考慮設備維護時間
2. 考慮作業員班次安排
3. 考慮工序間的依賴關係
4. 添加更複雜的負載平衡算法 