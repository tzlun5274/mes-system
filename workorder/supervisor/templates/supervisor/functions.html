{% extends 'base.html' %}
{% load static %}

{% block title %}主管功能{% endblock %}

{% block extra_head %}
<style>
    .function-container {
        padding: 20px;
    }
    
    .function-card {
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease-in-out;
    }
    
    .function-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .function-card .card-header {
        border-radius: 8px 8px 0 0;
        font-weight: bold;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    .abnormal-table {
        margin-top: 20px;
    }
    
    .abnormal-table th {
        background-color: #dc3545;
        color: white;
        border-top: none;
        font-weight: 600;
    }
    
    .status-badge {
        font-size: 0.8em;
        padding: 4px 8px;
        border-radius: 12px;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .function-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .function-item {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .function-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .function-icon {
        font-size: 2em;
        margin-bottom: 15px;
        color: #007bff;
    }
    
    .function-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }
    
    .function-description {
        color: #666;
        margin-bottom: 15px;
        line-height: 1.5;
    }
    
    .function-button {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 5px;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .function-button:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-2px);
    }
    
    /* 響應式設計 */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .function-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-cogs text-warning"></i>
                    主管功能首頁
                </h2>
                <div class="d-flex align-items-center">
                    <a href="{% url 'workorder:report_index' %}" class="btn btn-outline-primary me-3">
                        <i class="fas fa-arrow-left me-2"></i>返回報工管理
                    </a>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'workorder:index' %}">工單管理</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'workorder:report_index' %}">報工管理</a></li>
                            <li class="breadcrumb-item active" aria-current="page">主管功能</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 統計資訊卡片 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_reports_today|default:0 }}</div>
            <div class="stat-label">今日報工總數</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_reports_month|default:0 }}</div>
            <div class="stat-label">本月報工總數</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.pending_reports|default:0 }}</div>
            <div class="stat-label">待審核報工</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.abnormal_reports|default:0 }}</div>
            <div class="stat-label">異常報工</div>
        </div>
    </div>

    <!-- 功能區塊 -->
    <div class="function-grid">
        <!-- 報工統計 -->
        <div class="function-item">
            <div class="function-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="function-title">報工統計分析</div>
            <div class="function-description">
                查看各類型報工的詳細統計資訊，包含產能分析、效率評估等。
            </div>
            <button class="function-button" onclick="location.href='{% url 'workorder:supervisor:report_statistics' %}'">
                <i class="fas fa-chart-line"></i> 進入統計
            </button>
        </div>

        <!-- 異常處理 -->
        <div class="function-item">
            <div class="function-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="function-title">異常處理</div>
            <div class="function-description">
                處理報工異常情況，包含異常原因分析、處理方案制定等。
            </div>
            <button class="function-button" onclick="location.href='{% url 'workorder:supervisor:abnormal_management' %}'">
                <i class="fas fa-tools"></i> 處理異常
            </button>
        </div>

        <!-- 審核管理 -->
        <div class="function-item">
            <div class="function-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="function-title">審核管理</div>
            <div class="function-description">
                管理報工審核流程，包含批量審核、審核歷史等。
            </div>
            <button class="function-button" onclick="location.href='{% url 'workorder:supervisor:supervisor_report_index' %}'">
                <i class="fas fa-clipboard-check"></i> 進入審核
            </button>
        </div>

        <!-- 資料維護 -->
        <div class="function-item">
            <div class="function-icon">
                <i class="fas fa-database"></i>
            </div>
            <div class="function-title">資料維護</div>
            <div class="function-description">
                維護報工相關資料，包含資料清理、備份還原等。
            </div>
            <button class="function-button" onclick="location.href='{% url 'workorder:supervisor:data_maintenance' %}'">
                <i class="fas fa-wrench"></i> 資料維護
            </button>
        </div>

        <!-- 自動分配管理 -->
        <div class="function-item">
            <div class="function-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="function-title">自動分配管理</div>
            <div class="function-description">
                管理自動分配功能，設定執行頻率、監控執行狀態等。
            </div>
            <button class="function-button" onclick="openAutoAllocationModal()">
                <i class="fas fa-cog"></i> 管理設定
            </button>
        </div>
    </div>

    <!-- 最近異常記錄 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card function-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 最近異常記錄
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover abnormal-table">
                            <thead>
                                <tr>
                                    <th>時間</th>
                                    <th>類型</th>
                                    <th>作業員/設備</th>
                                    <th>工單號</th>
                                    <th>工序</th>
                                    <th>異常說明</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if recent_abnormal %}
                                    {% for report in recent_abnormal %}
                                    <tr>
                                        <td>{{ report.time|date:"Y-m-d" }}</td>
                                        <td>
                                            <span class="badge badge-info">{{ report.type }}</span>
                                        </td>
                                        <td>{{ report.operator }}</td>
                                        <td>{{ report.workorder }}</td>
                                        <td>{{ report.process }}</td>
                                        <td>
                                            <span class="text-danger">{{ report.remarks|truncatechars:30 }}</span>
                                        </td>
                                        <td>
                                            {% if report.status == 'pending' %}
                                                <span class="badge status-pending">待審核</span>
                                            {% elif report.status == 'approved' %}
                                                <span class="badge status-approved">已審核</span>
                                            {% elif report.status == 'rejected' %}
                                                <span class="badge status-rejected">已駁回</span>
                                            {% else %}
                                                <span class="badge badge-secondary">{{ report.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-info" title="查看詳情" 
                                                        onclick="viewAbnormalDetail('{{ report.type }}', '{{ report.workorder }}', '{{ report.operator }}')">
                                                    <i class="fas fa-eye"></i> 查看
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning" title="處理異常"
                                                        onclick="handleAbnormal('{{ report.type }}', '{{ report.workorder }}', '{{ report.operator }}')">
                                                    <i class="fas fa-tools"></i> 處理
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                                            <br>
                                            目前沒有異常記錄
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自動分配設定模態框 -->
<div class="modal fade" id="autoAllocationModal" tabindex="-1" role="dialog" aria-labelledby="autoAllocationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="autoAllocationModalLabel">
                    <i class="fas fa-robot"></i> 自動分配管理
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 當前狀態 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> 當前狀態</h6>
                            </div>
                            <div class="card-body">
                                <div id="currentStatus">
                                    <p><strong>執行狀態：</strong><span id="executionStatus" class="badge badge-secondary">檢查中...</span></p>
                                    <p><strong>執行頻率：</strong><span id="executionInterval">--</span></p>
                                    <p><strong>最後執行：</strong><span id="lastExecution">--</span></p>
                                    <p><strong>下次執行：</strong><span id="nextExecution">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-chart-bar"></i> 執行統計</h6>
                            </div>
                            <div class="card-body">
                                <div id="executionStats">
                                    <p><strong>今日執行：</strong><span id="todayExecutions">--</span></p>
                                    <p><strong>成功次數：</strong><span id="successCount">--</span></p>
                                    <p><strong>失敗次數：</strong><span id="failureCount">--</span></p>
                                    <p><strong>平均執行時間：</strong><span id="avgExecutionTime">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 設定選項 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-cog"></i> 自動執行設定</h6>
                            </div>
                            <div class="card-body">
                                <form id="autoAllocationForm">
                                    <div class="form-group">
                                        <label for="executionEnabled">
                                            <input type="checkbox" id="executionEnabled" name="executionEnabled">
                                            啟用自動執行
                                        </label>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="executionInterval">執行頻率（分鐘）</label>
                                        <select class="form-control" id="executionInterval" name="executionInterval">
                                            <option value="5">5 分鐘</option>
                                            <option value="10">10 分鐘</option>
                                            <option value="15">15 分鐘</option>
                                            <option value="30">30 分鐘</option>
                                            <option value="60">1 小時</option>
                                            <option value="120">2 小時</option>
                                            <option value="240">4 小時</option>
                                            <option value="480">8 小時</option>
                                            <option value="1440">24 小時</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="executionTime">執行時間範圍</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label>開始時間</label>
                                                <input type="time" class="form-control" id="startTime" name="startTime" value="08:00">
                                            </div>
                                            <div class="col-md-6">
                                                <label>結束時間</label>
                                                <input type="time" class="form-control" id="endTime" name="endTime" value="18:00">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="maxExecutionTime">最大執行時間（分鐘）</label>
                                        <input type="number" class="form-control" id="maxExecutionTime" name="maxExecutionTime" value="30" min="1" max="120">
                                        <small class="form-text text-muted">超過此時間的執行將被強制停止</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="notificationEnabled">
                                            <input type="checkbox" id="notificationEnabled" name="notificationEnabled" checked>
                                            啟用執行通知
                                        </label>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-play"></i> 手動操作</h6>
                            </div>
                            <div class="card-body">
                                <button type="button" class="btn btn-success btn-block mb-2" onclick="startManualExecution()">
                                    <i class="fas fa-play"></i> 立即執行
                                </button>
                                <button type="button" class="btn btn-warning btn-block mb-2" onclick="stopAutoExecution()">
                                    <i class="fas fa-pause"></i> 停止自動執行
                                </button>
                                <button type="button" class="btn btn-info btn-block mb-2" onclick="refreshStatus()">
                                    <i class="fas fa-sync"></i> 刷新狀態
                                </button>
                                <button type="button" class="btn btn-secondary btn-block" onclick="viewExecutionLog()">
                                    <i class="fas fa-list"></i> 查看執行記錄
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAutoAllocationSettings()">
                    <i class="fas fa-save"></i> 儲存設定
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 主管功能專用 JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // 卡片懸停效果
        const cards = document.querySelectorAll('.function-card, .function-item');
        cards.forEach(function(card) {
            card.addEventListener('mouseenter', function() {
                this.classList.add('shadow-lg');
            });
            card.addEventListener('mouseleave', function() {
                this.classList.remove('shadow-lg');
            });
        });
        
        // 統計卡片動畫
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(function(card, index) {
            setTimeout(function() {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.5s ease';
                
                setTimeout(function() {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            }, index * 100);
        });
        
        // 自動隱藏訊息提示
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                if (alert.classList.contains('alert-success') || alert.classList.contains('alert-info')) {
                    setTimeout(function() {
                        alert.style.opacity = '0';
                        setTimeout(function() {
                            alert.remove();
                        }, 300);
                    }, 3000);
                }
            });
        }, 1000);
    });
    
    // 確認操作函數
    function confirmAction(message) {
        return confirm(message || '確定要執行此操作嗎？');
    }
    
    // 顯示載入中
    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading';
        loadingDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> 處理中...</div>';
        loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.2);z-index:9999;';
        document.body.appendChild(loadingDiv);
    }
    
    // 隱藏載入中
    function hideLoading() {
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }
    
    // 查看異常詳情
    function viewAbnormalDetail(type, workorder, operator) {
        showLoading();
        // 根據類型導向不同的詳情頁面
        if (type === '作業員報工') {
            window.location.href = "{% url 'workorder:supervisor:abnormal_management' %}";
        } else if (type === 'SMT報工') {
            window.location.href = "{% url 'workorder:supervisor:abnormal_management' %}";
        } else {
            hideLoading();
            alert('暫不支援此類型的詳情查看');
        }
    }
    
    // 處理異常按鈕點擊事件
    function handleAbnormal(type, workorder, operator) {
        if (confirmAction('確定要處理此異常嗎？')) {
            showLoading();
            // 導向異常處理頁面
            window.location.href = "{% url 'workorder:supervisor:abnormal_management' %}";
        }
    }
    
    // 自動分配管理相關函數
    function openAutoAllocationModal() {
        $('#autoAllocationModal').modal('show');
        loadAutoAllocationStatus();
    }
    
    // 載入自動分配狀態
    function loadAutoAllocationStatus() {
        showLoading();
        fetch('{% url "workorder:auto_allocation_status" %}')
            .then(response => response.json())
            .then(data => {
                hideLoading();
                updateStatusDisplay(data);
            })
            .catch(error => {
                hideLoading();
                console.error('載入狀態失敗:', error);
                alert('載入狀態失敗，請稍後再試');
            });
    }
    
    // 更新狀態顯示
    function updateStatusDisplay(data) {
        // 更新執行狀態
        const statusElement = document.getElementById('executionStatus');
        if (data.is_running) {
            statusElement.textContent = '執行中';
            statusElement.className = 'badge badge-success';
        } else {
            statusElement.textContent = '已停止';
            statusElement.className = 'badge badge-secondary';
        }
        
        // 更新其他狀態資訊
        document.getElementById('executionInterval').textContent = data.interval_minutes + ' 分鐘';
        document.getElementById('lastExecution').textContent = data.last_execution || '--';
        document.getElementById('nextExecution').textContent = data.next_execution || '--';
        document.getElementById('todayExecutions').textContent = data.today_executions || '0';
        document.getElementById('successCount').textContent = data.success_count || '0';
        document.getElementById('failureCount').textContent = data.failure_count || '0';
        document.getElementById('avgExecutionTime').textContent = data.avg_execution_time || '--';
        
        // 更新表單設定
        document.getElementById('executionEnabled').checked = data.enabled;
        document.getElementById('executionInterval').value = data.interval_minutes;
        document.getElementById('startTime').value = data.start_time;
        document.getElementById('endTime').value = data.end_time;
        document.getElementById('maxExecutionTime').value = data.max_execution_time;
        document.getElementById('notificationEnabled').checked = data.notification_enabled;
    }
    
    // 儲存自動分配設定
    function saveAutoAllocationSettings() {
        const formData = new FormData(document.getElementById('autoAllocationForm'));
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        showLoading();
        fetch('{% url "workorder:auto_allocation_settings" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                alert('設定儲存成功！');
                $('#autoAllocationModal').modal('hide');
                loadAutoAllocationStatus();
            } else {
                alert('設定儲存失敗：' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('儲存設定失敗:', error);
            alert('儲存設定失敗，請稍後再試');
        });
    }
    
    // 立即執行自動分配
    function startManualExecution() {
        if (confirmAction('確定要立即執行自動分配嗎？')) {
            showLoading();
            fetch('{% url "workorder:auto_allocation_execute" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    alert('自動分配執行成功！\n處理工單數：' + data.total_workorders + '\n成功分配：' + data.successful_allocations);
                    loadAutoAllocationStatus();
                } else {
                    alert('自動分配執行失敗：' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('執行失敗:', error);
                alert('執行失敗，請稍後再試');
            });
        }
    }
    
    // 停止自動執行
    function stopAutoExecution() {
        if (confirmAction('確定要停止自動執行嗎？')) {
            showLoading();
            fetch('{% url "workorder:auto_allocation_stop" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    alert('自動執行已停止！');
                    loadAutoAllocationStatus();
                } else {
                    alert('停止失敗：' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('停止失敗:', error);
                alert('停止失敗，請稍後再試');
            });
        }
    }
    
    // 刷新狀態
    function refreshStatus() {
        loadAutoAllocationStatus();
    }
    
    // 查看執行記錄
    function viewExecutionLog() {
        window.open('{% url "workorder:auto_allocation_log" %}', '_blank');
    }
</script>
{% endblock %} 