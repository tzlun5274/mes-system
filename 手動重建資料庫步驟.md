# 手動重建 MES 系統資料庫步驟

## 🔧 完整重建流程

### 方法1: 使用自動化腳本（推薦）

```bash
# 1. 給腳本執行權限
chmod +x rebuild_database.sh
chmod +x run_rebuild.sh

# 2. 執行重建腳本
./rebuild_database.sh

# 或者使用 Python 腳本
python3 rebuild_db.py
```

### 方法2: 手動執行命令

```bash
# 1. 設定環境變數
export PGPASSWORD=mes_password
export DJANGO_SETTINGS_MODULE=mes_config.settings
export PYTHONPATH=/var/www/mes

# 2. 停止所有資料庫連線
psql -h localhost -p 5432 -U mes_user -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'mes_db' AND pid <> pg_backend_pid();"

# 3. 刪除現有資料庫
dropdb -h localhost -p 5432 -U mes_user --if-exists mes_db

# 4. 重新建立資料庫
createdb -h localhost -p 5432 -U mes_user mes_db

# 5. 設定 schema
psql -h localhost -p 5432 -U mes_user -d mes_db -c "SET search_path TO public;"

# 6. 切換到專案目錄
cd /var/www/mes

# 7. 執行 Django migrate
python3 manage.py migrate --noinput

# 8. 建立超級用戶
python3 manage.py createsuperuser --noinput --username admin --email admin@example.com

# 9. 建立基本群組
python3 -c "
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mes_config.settings')
import django
django.setup()
from django.contrib.auth.models import Group
groups = ['系統管理員', '生產主管', '作業員', '品質管理員', '報表使用者']
for group_name in groups:
    Group.objects.get_or_create(name=group_name)
print('基本群組建立完成')
"

# 10. 收集靜態檔案
python3 manage.py collectstatic --noinput
```

## 📋 重建完成後

### 1. 重新啟動 Django 服務
```bash
# 如果使用 gunicorn
sudo systemctl restart gunicorn

# 或者重新啟動開發伺服器
python3 manage.py runserver 0.0.0.0:8000
```

### 2. 還原備份資料
1. 登入系統（admin/admin123）
2. 進入系統管理 → 資料庫備份
3. 選擇要還原的備份檔案
4. 執行還原

### 3. 驗證系統功能
- 檢查所有模組是否正常運作
- 確認資料是否正確還原
- 測試基本功能

## ⚠️ 注意事項

1. **備份重要**：重建前確保有完整的備份檔案
2. **停止服務**：重建期間建議停止 Django 服務
3. **權限檢查**：確保有足夠的資料庫權限
4. **網路連線**：確保能正常連接到 PostgreSQL

## 🎯 預期結果

- ✅ 全新的乾淨資料庫
- ✅ 所有 Django 資料表正確建立
- ✅ 超級用戶帳號可用
- ✅ 基本群組已建立
- ✅ 系統功能完全恢復 