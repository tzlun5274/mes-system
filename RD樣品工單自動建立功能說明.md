# RD樣品工單自動建立功能說明

## 🎯 功能概述

當主管核准RD樣品填報記錄時，系統會自動查找或建立對應的MES工單和派工單。這個功能確保了RD樣品生產流程的完整性和資料一致性。

## 🔧 功能特色

### 1. 自動識別RD樣品
系統會自動識別以下類型的RD樣品記錄：
- 工單號碼包含 "RD樣品"
- 產品編號為 "PFP-CCT"
- 工序名稱包含 "RD" 關鍵字

### 2. 智能工單建立
- **查找現有工單**：使用公司代號+RD樣品+產品編號作為唯一識別
- **建立新工單**：如果找不到對應工單，自動建立新的MES工單
- **工單號碼格式**：`RD樣品-{產品編號}`（例如：RD樣品-PFP-CCT）

### 3. 自動派工單建立
- **查找現有派工單**：檢查是否已有對應的派工單
- **建立新派工單**：自動建立派工單並設定相關資訊
- **派工狀態**：直接設為 "已派工" 狀態
- **工序設定**：**不設定預定工序**（RD樣品特性）

### 4. 資料完整性保證
- **事務處理**：確保工單和派工單的建立過程是原子性的
- **資料同步**：核准後自動同步到生產執行監控系統
- **錯誤處理**：完善的錯誤處理和日誌記錄

## 📋 使用流程

### 1. 主管核准RD樣品
```
主管登入系統 → 進入填報管理 → 查看待核准清單 → 核准RD樣品記錄
```

### 2. 系統自動處理
```
檢查是否為RD樣品 → 查找現有工單 → 建立新工單（如需要） → 建立派工單（如需要） → 更新填報記錄
```

### 3. 結果回饋
```
顯示核准成功訊息 → 顯示工單建立狀態 → 顯示派工單建立狀態
```

## 🏗️ 技術架構

### 服務層設計
```python
class RDSampleWorkOrderService:
    """RD樣品工單自動建立服務"""
    
    @staticmethod
    def is_rd_sample_record(fill_work_record):
        """判斷是否為RD樣品記錄"""
    
    @staticmethod
    def find_or_create_rd_workorder(fill_work_record):
        """查找或建立RD樣品MES工單"""
    
    @staticmethod
    def find_or_create_rd_dispatch(workorder, fill_work_record):
        """查找或建立RD樣品派工單"""
    
    @staticmethod
    def process_rd_sample_approval(fill_work_record, approved_by):
        """處理RD樣品核准流程"""
```

### 核准服務整合
```python
class FillWorkApprovalService:
    """填報核准服務"""
    
    @staticmethod
    def approve_fill_work_record(fill_work_record, approved_by, approval_remarks=''):
        """核准填報記錄（包含RD樣品處理）"""
    
    @staticmethod
    def batch_approve_fill_work_records(record_ids, approved_by):
        """批量核准填報記錄（包含RD樣品處理）"""
```

## 📊 資料模型

### 工單建立規則
- **公司代號**：使用填報記錄的公司代號，預設為 "01"
- **工單號碼**：`RD樣品-{產品編號}`
- **產品編號**：使用填報記錄的產品編號
- **數量**：使用填報記錄的預設生產數量
- **狀態**：設為 "待生產"
- **來源**：標記為 "MES手動建立"

### 派工單建立規則
- **公司代號**：與工單相同
- **工單號碼**：與工單相同
- **產品編號**：與工單相同
- **產品名稱**：`RD樣品-{產品編號}`
- **計劃數量**：與工單相同
- **狀態**：設為 "已派工"
- **派工日期**：使用填報記錄的工作日期
- **分配作業員**：使用填報記錄的作業員
- **分配設備**：使用填報記錄的設備
- **工序名稱**：**不設定**（RD樣品無預定工序流程）
- **備註**：標註為RD樣品，提醒無預定工序流程

## 🔬 RD樣品的特殊性

### RD樣品與正式工單的差異
RD樣品（Research & Development Sample）是研發階段的產品，與正式量產工單有以下重要差異：

1. **無預定工序流程**：RD樣品通常沒有標準化的工序流程，因為還在研發階段
2. **靈活生產方式**：可以根據研發需求調整生產方式和工序
3. **試驗性質**：主要目的是驗證設計和工藝，而非量產
4. **數量不固定**：生產數量通常較少且不固定

### 設計考量
- **工單建立**：建立基本工單記錄，但不包含詳細的工序規劃
- **派工單建立**：不設定預定工序，讓作業員根據實際情況靈活處理
- **資料追蹤**：仍然需要追蹤生產記錄，但格式更靈活

## 🔍 識別邏輯

### RD樣品判斷條件
```python
def is_rd_sample_record(fill_work_record):
    # 檢查工單號碼是否為RD樣品
    if fill_work_record.workorder and 'RD樣品' in fill_work_record.workorder:
        return True
    
    # 檢查產品編號是否為RD樣品相關
    if fill_work_record.product_id and 'PFP-CCT' in fill_work_record.product_id:
        return True
    
    # 檢查工序是否包含RD相關關鍵字
    if fill_work_record.process and 'RD' in fill_work_record.process.name.upper():
        return True
        
    return False
```

## 🛠️ 管理命令

### 手動建立RD樣品工單
```bash
# 試運行模式（不實際建立資料）
python3 manage.py create_rd_workorders --dry-run

# 處理指定填報記錄
python3 manage.py create_rd_workorders --fill-work-id 123

# 強制建立（即使工單已存在）
python3 manage.py create_rd_workorders --force

# 指定公司代號和產品編號
python3 manage.py create_rd_workorders --company-code 02 --product-id PFP-CCT
```

### 命令參數說明
- `--fill-work-id`：指定填報記錄ID，只處理該記錄
- `--company-code`：公司代號（預設：01）
- `--product-id`：產品編號（預設：PFP-CCT）
- `--dry-run`：試運行模式，不實際建立資料
- `--force`：強制建立，即使工單已存在

## 🧪 測試功能

### 自動測試腳本
```bash
# 執行完整測試
python3 test_rd_sample_workorder.py
```

### 測試項目
1. **RD樣品識別測試**：驗證系統能正確識別RD樣品記錄
2. **工單建立測試**：驗證工單建立功能正常運作
3. **派工單建立測試**：驗證派工單建立功能正常運作
4. **核准流程測試**：驗證完整核准流程
5. **批量核准測試**：驗證批量核准功能

## 📝 使用範例

### 單筆核准
1. 主管登入系統
2. 進入填報管理 → 主管審核
3. 找到RD樣品記錄
4. 點擊核准按鈕
5. 系統顯示：
   ```
   填報記錄核准成功，已自動建立RD樣品工單，已自動建立RD樣品派工單
   RD樣品處理: RD樣品核准處理完成
   ```

### 批量核准
1. 主管選擇多筆RD樣品記錄
2. 點擊批量核准
3. 系統顯示：
   ```
   成功核准 3 筆填報記錄，已自動建立 2 個RD樣品工單，已自動建立 2 個RD樣品派工單
   ```

## 🔒 安全考量

### 權限控制
- 只有主管和超級管理員可以核准填報記錄
- 工單和派工單建立過程有完整的日誌記錄
- 所有操作都在事務中執行，確保資料一致性

### 錯誤處理
- 工單建立失敗不影響核准流程
- 詳細的錯誤日誌記錄
- 使用者友善的錯誤訊息

## 📈 監控與維護

### 日誌記錄
- 所有RD樣品工單建立操作都會記錄日誌
- 包含操作時間、操作人員、建立結果等資訊
- 便於問題追蹤和系統維護

### 資料清理
- 定期清理測試資料
- 監控工單和派工單的建立情況
- 確保系統效能

## 🎉 功能優勢

1. **自動化**：減少手動建立工單的工作量
2. **一致性**：確保RD樣品資料的完整性和一致性
3. **效率**：提高主管核准RD樣品的效率
4. **追蹤**：完整的操作記錄和資料追蹤
5. **靈活性**：支援單筆和批量核准
6. **可靠性**：完善的錯誤處理和事務管理

## 🔄 未來擴展

1. **更多RD樣品類型**：支援更多種類的RD樣品識別
2. **自定義規則**：允許用戶自定義RD樣品識別規則
3. **報表功能**：提供RD樣品工單建立統計報表
4. **通知功能**：工單建立後自動發送通知
5. **審計功能**：更詳細的操作審計記錄 