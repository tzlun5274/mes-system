# 設備權限功能實現總結

## 功能概述

為 `UserWorkPermission` 模型增加了設備權限控制功能，讓管理員可以為每個使用者設定可操作的設備清單，實現更精細的權限控制。

## 實現內容

### 1. 資料庫模型擴展

#### `UserWorkPermission` 模型新增欄位
```python
# 設備名稱（支援多個，用逗號分隔）
equipment_names = models.TextField(
    blank=True,
    null=True,
    verbose_name="設備名稱",
    help_text="可操作的設備名稱，多個用逗號分隔，留空表示可操作所有設備"
)
```

#### 新增方法
- `get_equipment_names_list()`: 獲取設備名稱列表
- `can_operate_equipment(equipment_name)`: 檢查是否可以操作指定設備
- 更新 `check_user_permission()`: 增加設備權限檢查

### 2. 工具函數擴展

#### `system/utils.py` 新增函數
```python
def get_user_allowed_equipments(user, permission_type='both'):
    """
    獲取使用者可以操作的設備列表
    
    Args:
        user: 使用者物件
        permission_type: 權限類型
    
    Returns:
        list: 可操作的設備名稱列表，空列表表示可以操作所有設備
    """
```

### 3. 多重過濾服務更新

#### `MultiFilterService` 設備過濾方法
```python
@staticmethod
def get_multi_filtered_equipment_queryset(user, form_type='operator', permission_type='both'):
    """
    多重過濾設備查詢集：結合SMT/作業員過濾和使用者權限過濾
    """
    # 第一步：根據表單類型進行SMT/作業員過濾
    # 第二步：根據使用者權限進行進一步過濾
    allowed_equipments = get_user_allowed_equipments(user, permission_type)
    
    if allowed_equipments:
        # 有權限設定，只顯示權限內的設備
        return base_queryset.filter(name__in=allowed_equipments).order_by('name')
    else:
        # 沒有權限設定，顯示所有符合表單類型的設備
        return base_queryset.order_by('name')
```

### 4. API 端點更新

#### `get_equipment_list_unified` API
```python
@require_GET
def get_equipment_list_unified(request):
    """統一設備清單API"""
    try:
        from workorder.fill_work.services import MultiFilterService
        
        # 使用多重過濾服務獲取設備查詢集
        equipment_queryset = MultiFilterService.get_multi_filtered_equipment_queryset(
            user=request.user,
            form_type=form_type,
            permission_type='both'
        )
        
        # 轉換為API格式
        equipments = equipment_queryset.values('name').distinct().order_by('name')
        
        return JsonResponse({
            'success': True,
            'equipments': list(equipments)
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': f'載入失敗: {str(e)}'
        }, status=400)
```

### 5. 管理介面更新

#### `UserWorkPermissionForm` 表單擴展
- 新增 `equipment_names_multiple` 多選欄位
- 新增 `_get_equipment_choices()` 方法獲取設備選項
- 新增 `clean_equipment_names_multiple()` 驗證方法
- 更新 `clean()` 和 `save()` 方法處理設備權限

## 測試結果

### 1. 權限設定測試
```bash
# 為 amy 設定設備權限
permission.equipment_names = 'AOI-1, 包裝機-01, 電測機-01'
```

### 2. 過濾功能測試
```bash
# 多重過濾服務測試
Filtered equipment count: 3
Filtered equipment names: ['AOI-1', '包裝機-01', '電測機-01']

# API 測試
API equipment count: 3
API equipment names: ['AOI-1', '包裝機-01', '電測機-01']
```

## 功能特點

### 1. **雙重過濾機制**
- **第一層過濾**：根據表單類型（SMT/作業員）進行基本過濾
- **第二層過濾**：根據使用者權限進行進一步過濾

### 2. **向後相容性**
- 如果使用者沒有設備權限設定，會顯示所有符合表單類型的設備
- 不影響現有的作業員和工序權限功能

### 3. **靈活配置**
- 支援多個設備名稱，用逗號分隔
- 管理員可以透過網頁介面輕鬆設定設備權限

### 4. **統一管理**
- 與作業員、工序權限統一管理
- 支援相同的權限類型（填報報工、現場報工、兩者）

## 使用方式

### 1. 管理員設定權限
1. 登入系統管理介面
2. 前往「使用者工作權限管理」
3. 編輯或新增使用者權限
4. 在「設備名稱」欄位中選擇允許操作的設備
5. 儲存設定

### 2. 使用者操作
1. 使用者登入後，前往填報或現場報工頁面
2. 設備下拉選單會自動過濾，只顯示有權限的設備
3. 無法選擇沒有權限的設備

## 檔案清單

### 修改的檔案
1. `system/models.py` - 新增設備權限欄位和方法
2. `system/utils.py` - 新增設備權限工具函數
3. `system/forms.py` - 更新管理表單支援設備權限
4. `workorder/fill_work/services.py` - 更新多重過濾服務
5. `workorder/views_main.py` - 更新設備 API 端點

### 新增的遷移檔案
- `system/migrations/0005_add_equipment_permission.py`

## 注意事項

1. **資料庫遷移**：需要執行 `python manage.py migrate` 來新增設備權限欄位
2. **權限設定**：建議為重要使用者設定設備權限，確保安全性
3. **向後相容**：現有使用者如果沒有設備權限設定，會顯示所有設備
4. **效能考量**：設備權限檢查會增加少量查詢開銷，但影響微乎其微

## 結論

設備權限功能的實現完善了 MES 系統的權限控制機制，現在系統可以對作業員、工序、設備三個維度進行精細的權限控制，大大提升了系統的安全性和管理效率。 