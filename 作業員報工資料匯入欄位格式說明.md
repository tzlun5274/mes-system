# 作業員報工資料匯入欄位格式說明

## 概述

本文件詳細說明 MES 系統中作業員報工資料匯入功能的欄位格式規範。此功能支援從 Excel (.xlsx) 和 CSV 檔案匯入作業員的報工資料，包含完整的資料驗證和錯誤處理機制。

## 支援的檔案格式

- **Excel 格式**：.xlsx 檔案
- **CSV 格式**：.csv 檔案（UTF-8 編碼）

## 欄位格式規範

### 完整欄位清單

| 欄位名稱 | 必填 | 資料類型 | 說明 | 範例 | 驗證規則 |
|---------|------|----------|------|------|----------|
| 作業員名稱 | ✓ | 文字 | 作業員的姓名，必須在系統中已存在 | 張小明 | 不能為空，必須對應到系統中的作業員 |
| 公司代號 | ✓ | 文字 | 公司代號，用於識別不同公司的工單 | 01 | 不能為空，必須對應到系統中的公司設定 |
| 報工日期 | ✓ | 日期 | 報工的日期 | 2025-01-15 | 格式：YYYY-MM-DD、YYYY/MM/DD、YYYY.MM.DD |
| 開始時間 | ✓ | 時間 | 報工開始時間 | 08:00 或 0800 | 支援 HH:MM:SS、HH:MM、HHMM、12小時制、Excel時間格式 |
| 結束時間 | ✓ | 時間 | 報工結束時間 | 12:00 或 1200 | 支援 HH:MM:SS、HH:MM、HHMM、12小時制、Excel時間格式 |
| 工單號 | ✓ | 文字 | 工單號碼 | WO-01-202501001 | 不能為空，必須對應到系統中的工單 |
| 產品編號 | ✓ | 文字 | 產品編號 | PROD-001 | 不能為空 |
| 工序名稱 | ✓ | 文字 | 工序名稱 | SMT、DIP、測試 | 不能為空，必須對應到系統中的工序 |
| 設備名稱 | ✗ | 文字 | 使用的設備名稱（選填） | SMT-001 | 可為空，如果填寫必須對應到系統中的設備 |
| 報工數量 | ✓ | 整數 | 合格品數量 | 100 | 必須為非負整數 |
| 不良品數量 | ✗ | 整數 | 不良品數量（選填） | 2 | 可為空，如果填寫必須為非負整數 |
| 備註 | ✗ | 文字 | 備註說明（選填） | 正常生產 | 可為空，純文字描述 |
| 異常紀錄 | ✗ | 文字 | 異常情況記錄（選填） | 設備故障30分鐘 | 可為空，有內容才會列入異常紀錄 |

### 欄位詳細說明

#### 必填欄位

1. **作業員名稱**
   - 必須是系統中已存在的作業員姓名
   - 系統會自動檢查作業員是否存在
   - 範例：張小明、李小華、王小美

2. **公司代號**
   - 用於識別不同公司的工單
   - 必須對應到 `CompanyConfig` 模型中的公司代號
   - 範例：01、02、03

3. **報工日期**
   - 支援多種格式：
     - YYYY-MM-DD：2025-01-15
     - YYYY/MM/DD：2025/01/15
     - YYYY.MM.DD：2025.01.15
   - 系統會自動識別並轉換格式
   - 範例：2025-01-15、2025/01/15、2025.01.15

4. **開始時間**
   - 支援多種格式：
     - HH:MM:SS 格式：08:00:00、16:30:00
     - HH:MM 格式：08:00、16:30
     - HHMM 格式：0800、1630
     - 12小時制格式：04:30:00 PM、08:00:00 AM
     - Excel 時間格式：0 days 08:30:00（系統會自動處理）
   - 支援 24 小時制和 12 小時制
   - 範例：08:00:00、08:00、0800、04:30:00 PM、0 days 08:30:00

5. **結束時間**
   - 格式同開始時間
   - 必須晚於開始時間
   - 範例：12:00:00、12:00、1200、04:30:00 PM、0 days 12:00:00

6. **工單號**
   - 必須是系統中已存在的工單號碼
   - 系統會根據公司代號和工單號進行查詢
   - 範例：WO-01-202501001、WO-02-202501002

7. **產品編號**
   - 產品識別編號
   - 不能為空
   - 範例：PROD-001、PROD-002

8. **工序名稱**
   - 必須是系統中已存在的工序名稱
   - 系統會自動檢查工序是否存在
   - 範例：SMT、DIP、測試、包裝

9. **報工數量**
   - 合格品數量
   - 必須為非負整數
   - 範例：100、0、500

#### 選填欄位

10. **設備名稱**
    - 使用的設備名稱
    - 可為空
    - 如果填寫，必須對應到系統中的設備
    - 範例：SMT-001、DIP-001、（空白）

11. **不良品數量**
    - 不良品數量
    - 可為空，預設為 0
    - 如果填寫，必須為非負整數
    - 範例：2、0、5、（空白）

12. **備註**
    - 備註說明
    - 可為空
    - 純文字描述
    - 範例：正常生產、設備調整、加班生產、（空白）

13. **異常紀錄**
    - 異常情況記錄
    - 可為空
    - **重要**：只有此欄位有內容時，才會被列入異常紀錄
    - 範例：設備故障30分鐘、品質異常、（空白）

## 資料驗證規則

### 基本驗證

1. **檔案格式驗證**
   - 只支援 .xlsx 和 .csv 格式
   - CSV 檔案必須使用 UTF-8 編碼

2. **必要欄位驗證**
   - 所有必填欄位不能為空
   - 系統會檢查欄位是否存在

3. **資料類型驗證**
   - 日期格式：YYYY-MM-DD、YYYY/MM/DD、YYYY.MM.DD
   - 時間格式：HH:MM 或 HHMM
   - 數量欄位：非負整數

### 業務邏輯驗證

1. **作業員驗證**
   - 作業員名稱必須在系統中存在
   - 檢查 `Operator` 模型

2. **公司驗證**
   - 公司代號必須在系統中存在
   - 檢查 `CompanyConfig` 模型

3. **工單驗證**
   - 工單號必須在系統中存在
   - 根據公司代號和工單號進行查詢
   - 檢查 `WorkOrder` 模型

4. **工序驗證**
   - 工序名稱必須在系統中存在
   - 檢查 `ProcessName` 模型

5. **設備驗證**
   - 如果填寫設備名稱，必須在系統中存在
   - 檢查 `Equipment` 模型

6. **時間邏輯驗證**
   - 結束時間必須晚於開始時間
   - 支援跨日報工

### 重複資料檢查

- 系統會自動檢查是否已存在相同的報工記錄
- 檢查條件：作業員 + 工單 + 工序 + 日期 + 開始時間 + 結束時間
- 如果發現重複記錄，會自動跳過並記錄在跳過清單中

## 範例資料

### Excel/CSV 檔案範例

```csv
作業員名稱,公司代號,報工日期,開始時間,結束時間,工單號,產品編號,工序名稱,設備名稱,報工數量,不良品數量,備註,異常紀錄
張小明,01,2025-01-15,08:00,12:00,WO-01-202501001,PROD-001,SMT,SMT-001,100,2,正常生產,
李小華,01,2025/01/15,13:00,17:00,WO-01-202501001,PROD-001,DIP,DIP-001,95,5,設備調整,設備故障30分鐘
王小美,02,2025.01.15,08:00,16:00,WO-02-202501002,PROD-002,測試,,200,0,加班生產,
```

### 範例說明

1. **第一筆記錄**：張小明在 SMT 工序的正常生產記錄
   - 時間：08:00-12:00（上午班）
   - 數量：100 個合格品，2 個不良品
   - 無異常紀錄

2. **第二筆記錄**：李小華在 DIP 工序的記錄
   - 時間：13:00-17:00（下午班）
   - 數量：95 個合格品，5 個不良品
   - 有異常紀錄：設備故障30分鐘

3. **第三筆記錄**：王小美在測試工序的加班記錄
   - 時間：08:00-16:00（全天班）
   - 數量：200 個合格品，0 個不良品
   - 備註：加班生產

## 匯入處理流程

### 1. 檔案上傳
- 支援拖拽上傳和點擊選擇
- 即時檔案格式驗證
- 顯示上傳進度

### 2. 資料讀取
- 自動識別 Excel 或 CSV 格式
- 讀取所有欄位資料
- 檢查必要欄位是否存在

### 3. 資料驗證
- 逐行驗證資料格式
- 檢查業務邏輯正確性
- 記錄錯誤和警告訊息

### 4. 資料處理
- 建立 `OperatorSupplementReport` 記錄
- 自動計算工時和休息時間
- 處理異常紀錄標記

### 5. 結果回饋
- 顯示成功、錯誤、跳過統計
- 詳細的錯誤訊息
- 可下載處理報告

## 特殊處理規則

### 時間格式處理

1. **支援多種時間格式**
   - HH:MM：08:00、16:30
   - HHMM：0800、1630

2. **自動格式轉換**
   - 系統會自動識別並轉換時間格式
   - 統一儲存為標準時間格式

### 異常紀錄處理

1. **異常紀錄標記**
   - 只有「異常紀錄」欄位有內容時，才會被標記為異常
   - 空白的異常紀錄欄位不會影響正常報工

2. **異常紀錄內容**
   - 純文字描述
   - 用於記錄設備故障、品質問題等異常情況

### 重複資料處理

1. **重複檢查**
   - 系統會檢查是否已存在相同的報工記錄
   - 檢查條件：作業員 + 工單 + 工序 + 日期 + 開始時間 + 結束時間

2. **跳過處理**
   - 發現重複記錄時會自動跳過
   - 不會覆蓋現有資料
   - 在結果中顯示跳過統計

## 錯誤處理

### 常見錯誤類型

1. **檔案格式錯誤**
   - 不支援的檔案格式
   - 檔案損壞或無法讀取

2. **欄位格式錯誤**
   - 缺少必要欄位
   - 欄位名稱不正確

3. **資料格式錯誤**
   - 日期格式錯誤
   - 時間格式錯誤
   - 數量格式錯誤

4. **業務邏輯錯誤**
   - 作業員不存在
   - 工單不存在
   - 工序不存在
   - 設備不存在

### 錯誤訊息格式

```
第 X 行：錯誤描述
```

範例：
- 第 1 行：找不到作業員 "張小明"
- 第 2 行：報工日期格式錯誤 "2025/01/15"
- 第 3 行：開始時間格式錯誤 "8點"

## 使用建議

### 準備資料時

1. **使用範本檔案**
   - 下載系統提供的 Excel 範本
   - 按照範本格式填寫資料

2. **檢查資料完整性**
   - 確保所有必填欄位都有資料
   - 檢查資料格式是否正確

3. **驗證業務資料**
   - 確認作業員、工單、工序等資料在系統中存在
   - 檢查公司代號是否正確

### 匯入時

1. **分批匯入**
   - 大量資料建議分批匯入
   - 每批建議不超過 1000 筆

2. **檢查結果**
   - 仔細查看匯入結果
   - 處理錯誤和警告訊息

3. **備份資料**
   - 匯入前備份重要資料
   - 保留原始檔案

## 技術規格

### 支援的檔案大小
- 最大檔案大小：10MB
- 建議單次匯入筆數：1000 筆以內

### 處理時間
- 一般處理速度：每秒 50-100 筆
- 實際處理時間取決於資料量和系統負載

### 資料庫影響
- 匯入的資料會直接寫入 `OperatorSupplementReport` 表
- 系統會自動計算工時相關欄位
- 支援事務回滾，確保資料一致性

## 聯絡支援

如果在使用過程中遇到問題，請聯絡系統管理員或查看系統日誌檔案。

---

**版本**：1.0  
**更新日期**：2025-01-15  
**適用系統**：MES 系統 v2.0+ 