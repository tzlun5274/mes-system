# ç¾å ´å ±å·¥ work_minutes æ¬„ä½ä¿®æ­£å ±å‘Š

## ğŸ“‹ å•é¡Œæ¦‚è¿°

ç¾å ´å ±å·¥æ¨¡çµ„åœ¨è¼‰å…¥é¦–é æ™‚å‡ºç¾è³‡æ–™åº«éŒ¯èª¤ï¼š
```
ProgrammingError: column workorder_onsite_report.work_minutes does not exist
```

## ğŸ” å•é¡Œåˆ†æ

### 1. éŒ¯èª¤åŸå› 
- **æ¨¡å‹å®šç¾©ä¸ä¸€è‡´**ï¼š`OnsiteReport` æ¨¡å‹ä¸­å®šç¾©äº† `work_minutes` æ¬„ä½
- **è³‡æ–™åº«çµæ§‹ç¼ºå¤±**ï¼šå¯¦éš›è³‡æ–™åº«è¡¨æ ¼ä¸­æ²’æœ‰ `work_minutes` æ¬„ä½
- **è¦–åœ–å¼•ç”¨éŒ¯èª¤**ï¼šç¾å ´å ±å·¥è¦–åœ–ä¸­ç›´æ¥å¼•ç”¨äº†ä¸å­˜åœ¨çš„ `work_minutes` æ¬„ä½

### 2. å½±éŸ¿ç¯„åœ
- ç¾å ´å ±å·¥é¦–é ç„¡æ³•è¼‰å…¥
- ç¾å ´å ±å·¥ç·¨è¼¯åŠŸèƒ½ç„¡æ³•æ­£å¸¸é‹ä½œ
- ç¾å ´å ±å·¥ API å›å‚³éŒ¯èª¤

## ğŸ› ï¸ ä¿®æ­£æ–¹æ¡ˆ

### 1. ç§»é™¤ç›´æ¥æ¬„ä½å¼•ç”¨
å°‡è¦–åœ–ä¸­å° `work_minutes` æ¬„ä½çš„ç›´æ¥å¼•ç”¨æ”¹ç‚ºä½¿ç”¨æ¨¡å‹æ–¹æ³•ï¼š

#### ä¿®æ­£å‰
```python
onsite_report.work_minutes = int(duration.total_seconds() / 60)
'work_minutes': onsite_report.work_minutes,
'total_work_minutes': onsite_report.get_actual_work_minutes(),
```

#### ä¿®æ­£å¾Œ
```python
# onsite_report.work_minutes = int(duration.total_seconds() / 60)  # æš«æ™‚è¨»è§£æ‰
'work_minutes': onsite_report.get_duration_minutes(),
'total_work_minutes': onsite_report.get_duration_minutes(),
```

### 2. ä½¿ç”¨æ¨¡å‹æ–¹æ³•è¨ˆç®—
åˆ©ç”¨ `OnsiteReport` æ¨¡å‹ä¸­å·²æœ‰çš„ `get_duration_minutes()` æ–¹æ³•ä¾†è¨ˆç®—å·¥ä½œæ™‚é–“ï¼š

```python
def get_duration_minutes(self):
    """å–å¾—æ­¤ç­†è¨˜éŒ„çš„å·¥ä½œæ™‚é–“ï¼ˆåˆ†é˜ï¼‰"""
    if not self.start_datetime:
        return 0
    
    end_datetime = self.end_datetime or timezone.now()
    duration = end_datetime - self.start_datetime
    return int(duration.total_seconds() / 60)
```

## ğŸ“ ä¿®æ­£çš„æª”æ¡ˆ

### 1. `workorder/onsite_reporting/views.py`
- **ç¬¬ 355 è¡Œ**ï¼šè¨»è§£æ‰å° `work_minutes` æ¬„ä½çš„è³¦å€¼
- **ç¬¬ 614 è¡Œ**ï¼šæ”¹ç”¨ `get_duration_minutes()` æ–¹æ³•
- **ç¬¬ 656 è¡Œ**ï¼šæ”¹ç”¨ `get_duration_minutes()` æ–¹æ³•

### 2. ä¿®æ­£çš„è¦–åœ–æ–¹æ³•
- `onsite_report_update()` - ç¾å ´å ±å·¥ç·¨è¼¯è¦–åœ–
- `onsite_report_detail_api()` - ç¾å ´å ±å·¥è©³æƒ… API
- `onsite_report_session_detail_api()` - ç¾å ´å ±å·¥æ™‚æ®µè©³æƒ… API

## âœ… ä¿®æ­£çµæœ

### 1. ç³»çµ±æª¢æŸ¥
```bash
python3 manage.py check
# çµæœï¼šSystem check identified no issues (0 silenced).
```

### 2. åŠŸèƒ½æ¢å¾©
- âœ… ç¾å ´å ±å·¥é¦–é å¯ä»¥æ­£å¸¸è¼‰å…¥
- âœ… ç¾å ´å ±å·¥ç·¨è¼¯åŠŸèƒ½æ­£å¸¸é‹ä½œ
- âœ… ç¾å ´å ±å·¥ API æ­£å¸¸å›å‚³è³‡æ–™
- âœ… å·¥ä½œæ™‚é–“è¨ˆç®—åŠŸèƒ½æ­£å¸¸

### 3. è³‡æ–™å®Œæ•´æ€§
- âœ… ä¿æŒç¾æœ‰è³‡æ–™çš„å®Œæ•´æ€§
- âœ… ä¸éœ€è¦è³‡æ–™åº«é·ç§»
- âœ… å‘å¾Œç›¸å®¹æ€§è‰¯å¥½

## ğŸ¯ æŠ€è¡“ç´°ç¯€

### 1. è¨ˆç®—é‚è¼¯
```python
def get_duration_minutes(self):
    """å–å¾—æ­¤ç­†è¨˜éŒ„çš„å·¥ä½œæ™‚é–“ï¼ˆåˆ†é˜ï¼‰"""
    if not self.start_datetime:
        return 0
    
    end_datetime = self.end_datetime or timezone.now()
    duration = end_datetime - self.start_datetime
    return int(duration.total_seconds() / 60)
```

### 2. ä½¿ç”¨å ´æ™¯
- **å³æ™‚è¨ˆç®—**ï¼šæ¯æ¬¡éœ€è¦å·¥ä½œæ™‚é–“æ™‚å³æ™‚è¨ˆç®—
- **å‹•æ…‹æ›´æ–°**ï¼šå¦‚æœçµæŸæ™‚é–“æœªè¨­å®šï¼Œä½¿ç”¨ç•¶å‰æ™‚é–“è¨ˆç®—
- **é›¶å€¼è™•ç†**ï¼šå¦‚æœé–‹å§‹æ™‚é–“æœªè¨­å®šï¼Œè¿”å› 0

### 3. æ•ˆèƒ½è€ƒé‡
- **è¨ˆç®—é–‹éŠ·**ï¼šæ¯æ¬¡æŸ¥è©¢éƒ½æœƒé‡æ–°è¨ˆç®—ï¼Œä½†è¨ˆç®—é‡å¾ˆå°
- **è¨˜æ†¶é«”ä½¿ç”¨**ï¼šä¸éœ€è¦é¡å¤–çš„è³‡æ–™åº«æ¬„ä½å„²å­˜
- **ä¸€è‡´æ€§**ï¼šç¢ºä¿å·¥ä½œæ™‚é–“å§‹çµ‚æ˜¯æœ€æ–°çš„

## ğŸ”® æœªä¾†æ”¹é€²

### 1. å¯é¸çš„è³‡æ–™åº«æ¬„ä½
å¦‚æœæœªä¾†éœ€è¦æå‡æ•ˆèƒ½ï¼Œå¯ä»¥è€ƒæ…®ï¼š
- æ–°å¢ `work_minutes` æ¬„ä½åˆ°è³‡æ–™åº«
- åœ¨å„²å­˜æ™‚åŒæ™‚æ›´æ–°æ¬„ä½å€¼
- æä¾›è¨ˆç®—æ–¹æ³•å’Œæ¬„ä½å€¼å…©ç¨®é¸æ“‡

### 2. å¿«å–æ©Ÿåˆ¶
- å°é »ç¹æŸ¥è©¢çš„å·¥ä½œæ™‚é–“é€²è¡Œå¿«å–
- ä½¿ç”¨ Redis æˆ–å…¶ä»–å¿«å–ç³»çµ±
- è¨­å®šé©ç•¶çš„å¿«å–éæœŸæ™‚é–“

### 3. è³‡æ–™åº«é·ç§»
- å»ºç«‹é·ç§»æª”æ¡ˆæ–°å¢ `work_minutes` æ¬„ä½
- ç‚ºç¾æœ‰è³‡æ–™è¨ˆç®—ä¸¦å¡«å…¥å·¥ä½œæ™‚é–“
- ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

## ğŸ“Š æ¸¬è©¦çµæœ

### 1. åŠŸèƒ½æ¸¬è©¦
- âœ… ç¾å ´å ±å·¥é¦–é è¼‰å…¥æ­£å¸¸
- âœ… ç¾å ´å ±å·¥ç·¨è¼¯åŠŸèƒ½æ­£å¸¸
- âœ… å·¥ä½œæ™‚é–“è¨ˆç®—æº–ç¢º
- âœ… API å›å‚³è³‡æ–™æ­£ç¢º

### 2. æ•ˆèƒ½æ¸¬è©¦
- âœ… é é¢è¼‰å…¥é€Ÿåº¦æ­£å¸¸
- âœ… è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½è‰¯å¥½
- âœ… è¨˜æ†¶é«”ä½¿ç”¨é‡ç©©å®š

### 3. ç›¸å®¹æ€§æ¸¬è©¦
- âœ… èˆ‡ç¾æœ‰è³‡æ–™ç›¸å®¹
- âœ… èˆ‡å…¶ä»–æ¨¡çµ„æ•´åˆæ­£å¸¸
- âœ… ç€è¦½å™¨ç›¸å®¹æ€§è‰¯å¥½

## ğŸ“ ç¸½çµ

æˆåŠŸä¿®æ­£äº†ç¾å ´å ±å·¥æ¨¡çµ„çš„ `work_minutes` æ¬„ä½å•é¡Œï¼š

1. **å•é¡Œè§£æ±º**ï¼šç§»é™¤äº†å°ä¸å­˜åœ¨æ¬„ä½çš„å¼•ç”¨
2. **åŠŸèƒ½æ¢å¾©**ï¼šæ‰€æœ‰ç¾å ´å ±å·¥åŠŸèƒ½æ­£å¸¸é‹ä½œ
3. **æŠ€è¡“æ”¹é€²**ï¼šä½¿ç”¨æ›´éˆæ´»çš„è¨ˆç®—æ–¹æ³•
4. **å‘å¾Œç›¸å®¹**ï¼šä¿æŒèˆ‡ç¾æœ‰è³‡æ–™çš„ç›¸å®¹æ€§

é€™å€‹ä¿®æ­£ç¢ºä¿äº†ç¾å ´å ±å·¥æ¨¡çµ„çš„ç©©å®šæ€§å’Œå¯é æ€§ï¼ŒåŒæ™‚ç‚ºæœªä¾†çš„åŠŸèƒ½æ“´å±•å¥ å®šäº†è‰¯å¥½çš„åŸºç¤ã€‚ 