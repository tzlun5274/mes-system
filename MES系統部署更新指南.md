# MES ç³»çµ±éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®éŒ„
- [éƒ¨ç½²æ¦‚è¿°](#éƒ¨ç½²æ¦‚è¿°)
- [é·ç§»ä¾è³´å•é¡Œè§£æ±ºæ–¹æ¡ˆ](#é·ç§»ä¾è³´å•é¡Œè§£æ±ºæ–¹æ¡ˆ)
- [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
- [é·ç§»æª”æ¡ˆèªªæ˜](#é·ç§»æª”æ¡ˆèªªæ˜)
- [æ³¨æ„äº‹é …](#æ³¨æ„äº‹é …)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [å¾ŒçºŒé–‹ç™¼](#å¾ŒçºŒé–‹ç™¼)

---

## ğŸ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•å°‡ MES ç³»çµ±å¾é–‹ç™¼ç’°å¢ƒéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒï¼Œç‰¹åˆ¥æ˜¯å¦‚ä½•è™•ç†é·ç§»ä¾è³´å•é¡Œã€‚

### ğŸ“Š ç³»çµ±æ¶æ§‹
- **Web ä¼ºæœå™¨**: Nginx + Gunicorn
- **è³‡æ–™åº«**: PostgreSQL
- **å¿«å–/è¨Šæ¯ä½‡åˆ—**: Redis
- **èƒŒæ™¯ä»»å‹™**: Celery Worker + Celery Beat
- **æ‡‰ç”¨æ¡†æ¶**: Django 5.1.8

### ğŸ¯ éƒ¨ç½²ç›®æ¨™
- å°‡ MES ç³»çµ±éƒ¨ç½²åˆ°å…¨æ–°çš„ Ubuntu ä¸»æ©Ÿ
- è‡ªå‹•åŒ–æ‰€æœ‰å®‰è£å’Œé…ç½®æ­¥é©Ÿ
- ç¢ºä¿ç³»çµ±ç©©å®šé‹è¡Œ
- æä¾›å®Œæ•´çš„ç›£æ§å’Œç¶­è­·åŠŸèƒ½

---

## ğŸ”§ é·ç§»ä¾è³´å•é¡Œè§£æ±ºæ–¹æ¡ˆ

### å•é¡Œæè¿°
åœ¨é–‹ç™¼éç¨‹ä¸­ï¼Œæœƒç”¢ç”Ÿå¤§é‡çš„é·ç§»æª”æ¡ˆï¼ˆmigrationsï¼‰ï¼Œé€™äº›æª”æ¡ˆæœƒé€ æˆï¼š
1. é·ç§»ä¾è³´è¤‡é›œåŒ–
2. ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å›°é›£
3. è³‡æ–™åº«çµæ§‹ä¸ä¸€è‡´çš„é¢¨éšª

### è§£æ±ºæ–¹æ¡ˆ
ä½¿ç”¨ Django çš„ `squashmigrations` åŠŸèƒ½ï¼Œå°‡å¤šå€‹é·ç§»æª”æ¡ˆåˆä½µæˆä¸€å€‹åˆå§‹é·ç§»æª”æ¡ˆã€‚

### é·ç§»ç®¡ç†è…³æœ¬

#### 1. é‡ç½®é·ç§»è…³æœ¬ (`é‡ç½®é·ç§».sh`)
**ç”¨é€”**ï¼šé‡ç½®ç•¶å‰é–‹ç™¼ç’°å¢ƒçš„é·ç§»ç‹€æ…‹ï¼Œé‡æ–°ç”Ÿæˆåˆå§‹é·ç§»

**é©ç”¨å ´æ™¯**ï¼š
- é·ç§»æª”æ¡ˆå‡ºç¾å•é¡Œéœ€è¦é‡ç½®
- é–‹ç™¼ç’°å¢ƒé·ç§»ç‹€æ…‹æ··äº‚
- éœ€è¦é‡æ–°æ•´ç†é·ç§»æ­·å²
- ç•¶å‰ç’°å¢ƒçš„è³‡æ–™åº«çµæ§‹éœ€è¦æ›´æ–°

**åŸ·è¡Œæµç¨‹**ï¼š
1. **å‚™ä»½ç¾æœ‰é·ç§»**ï¼šå‰µå»ºæ™‚é–“æˆ³å‚™ä»½ç›®éŒ„
2. **åˆªé™¤é·ç§»æª”æ¡ˆ**ï¼šæ¸…ç†æ‰€æœ‰ `.py` é·ç§»æª”æ¡ˆï¼ˆä¿ç•™ `__init__.py`ï¼‰
3. **é‡æ–°ç”Ÿæˆé·ç§»**ï¼šç‚ºæ¯å€‹æ‡‰ç”¨åŸ·è¡Œ `makemigrations`
4. **åŸ·è¡Œé·ç§»**ï¼šçœŸæ­£åŸ·è¡Œé·ç§»ï¼ˆä¸æ˜¯ `--fake`ï¼‰
5. **æª¢æŸ¥çµæœ**ï¼šé©—è­‰é·ç§»ç‹€æ…‹å’Œç³»çµ±æª¢æŸ¥

**å®‰å…¨ç‰¹æ€§**ï¼š
- âœ… è‡ªå‹•å‚™ä»½ç¾æœ‰é·ç§»æª”æ¡ˆ
- âœ… è¦æ±‚ç”¨æˆ¶ç¢ºèªæ“ä½œ
- âœ… è©³ç´°çš„æ—¥èªŒè¨˜éŒ„
- âœ… åªé‡å°ç‰¹å®šæ‡‰ç”¨ï¼ˆsystem, workorder, erp_integration, reportingï¼‰

**ä½¿ç”¨æ³¨æ„**ï¼š
- âš ï¸ æœƒçœŸæ­£åŸ·è¡Œé·ç§»ï¼Œå¯èƒ½æ”¹è®Šè³‡æ–™åº«çµæ§‹
- âš ï¸ ä½¿ç”¨å‰å‹™å¿…å‚™ä»½è³‡æ–™åº«
- âš ï¸ åƒ…é©ç”¨æ–¼é–‹ç™¼ç’°å¢ƒå•é¡Œä¿®å¾©

#### 2. æ¸…ç†å°ˆæ¡ˆé·ç§»è…³æœ¬ (`æ¸…ç†å°ˆæ¡ˆé·ç§».sh`)
**ç”¨é€”**ï¼šå®Œå…¨æ¸…ç†å°ˆæ¡ˆçš„æ‰€æœ‰é·ç§»ç›¸é—œæª”æ¡ˆï¼Œæº–å‚™éƒ¨ç½²åˆ°ç”Ÿç”¢ä¸»æ©Ÿ

**é©ç”¨å ´æ™¯**ï¼š
- æº–å‚™éƒ¨ç½²åˆ°å…¨æ–°çš„ç”Ÿç”¢ä¸»æ©Ÿ
- é·ç§»æª”æ¡ˆå‡ºç¾åš´é‡å•é¡Œéœ€è¦é‡ç½®
- å°ˆæ¡ˆé‡æ–°æ•´ç†ï¼Œéœ€è¦ä¹¾æ·¨çš„é·ç§»ç‹€æ…‹

**åŸ·è¡Œæµç¨‹**ï¼š
1. **åˆªé™¤é·ç§»æª”æ¡ˆ**ï¼šæ¸…ç†æ‰€æœ‰ `.py` é·ç§»æª”æ¡ˆ
2. **åˆªé™¤å‚™ä»½ç›®éŒ„**ï¼šæ¸…ç†é·ç§»å‚™ä»½ç›®éŒ„
3. **æ¸…ç†è³‡æ–™åº«è¨˜éŒ„**ï¼šåˆªé™¤ `django_migrations` è¡¨ä¸­çš„é·ç§»è¨˜éŒ„
4. **é‡æ–°ç”Ÿæˆé·ç§»**ï¼šåŸ·è¡Œ `makemigrations` ç”Ÿæˆæ–°çš„åˆå§‹é·ç§»

**é‡è¦ç‰¹é»**ï¼š
- ğŸš¨ **å®Œå…¨ä¸å¯é€†**ï¼šåˆªé™¤çš„é·ç§»æª”æ¡ˆç„¡æ³•æ¢å¾©
- ğŸš¨ **æ¸…ç†è³‡æ–™åº«è¨˜éŒ„**ï¼šæœƒæ¸…ç©º `django_migrations` è¡¨
- ğŸš¨ **åƒ…é™ç”Ÿç”¢éƒ¨ç½²**ï¼šä¸æ‡‰è©²åœ¨é–‹ç™¼ç’°å¢ƒä½¿ç”¨

**éƒ¨ç½²å»ºè­°**ï¼š
1. æ‰“åŒ…å°ˆæ¡ˆï¼š`tar -czf mes_clean.tar.gz .`
2. ä¸Šå‚³åˆ°ç”Ÿç”¢ä¸»æ©Ÿ
3. åŸ·è¡Œé·ç§»ï¼š`python3 manage.py migrate --fake`
4. å‰µå»ºè¶…ç´šç”¨æˆ¶ï¼š`python3 manage.py createsuperuser`

### è…³æœ¬é¸æ“‡æŒ‡å—

| ä½¿ç”¨å ´æ™¯ | æ¨è–¦è…³æœ¬ | åŸ·è¡Œä¸»æ©Ÿ | åŸå›  |
|---------|----------|----------|------|
| **é–‹ç™¼ç’°å¢ƒé·ç§»å•é¡Œ** | `é‡ç½®é·ç§».sh` | é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ | æœƒå‚™ä»½ã€æœƒåŸ·è¡Œé·ç§»ã€ç›¸å°å®‰å…¨ |
| **ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æº–å‚™** | `æ¸…ç†å°ˆæ¡ˆé·ç§».sh` | é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ | å®Œå…¨æ¸…ç†ã€æº–å‚™ä¹¾æ·¨éƒ¨ç½² |
| **é·ç§»æª”æ¡ˆæå£** | `é‡ç½®é·ç§».sh` | é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ | ä¿ç•™å‚™ä»½ã€å¯æ¢å¾© |
| **å…¨æ–°ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²** | `æ¸…ç†å°ˆæ¡ˆé·ç§».sh` | é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ | æœ€ä¹¾æ·¨çš„ç‹€æ…‹ |
| **æ¸¬è©¦ç’°å¢ƒé‡ç½®** | `é‡ç½®é·ç§».sh` | é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ | è¼ƒå®‰å…¨çš„é‡ç½®æ–¹å¼ |

**é‡è¦èªªæ˜**ï¼šæ‰€æœ‰è…³æœ¬éƒ½åªèƒ½åœ¨é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿä¸ŠåŸ·è¡Œï¼Œç”Ÿç”¢ç’°å¢ƒä¸»æ©Ÿåªéœ€è¦åŸ·è¡Œ Django çš„ migrate å‘½ä»¤ï¼

### è…³æœ¬åŸ·è¡Œæ¬Šé™
```bash
# è¨­å®šè…³æœ¬åŸ·è¡Œæ¬Šé™
chmod +x é‡ç½®é·ç§».sh
chmod +x æ¸…ç†å°ˆæ¡ˆé·ç§».sh

# ä»¥ mes ç”¨æˆ¶èº«ä»½åŸ·è¡Œ
su - mes
./é‡ç½®é·ç§».sh
# æˆ–
./æ¸…ç†å°ˆæ¡ˆé·ç§».sh
```

### ğŸ–¥ï¸ è…³æœ¬åŸ·è¡Œä¸»æ©Ÿèªªæ˜

#### **é‡ç½®é·ç§»è…³æœ¬ (`é‡ç½®é·ç§».sh`)**
- **åŸ·è¡Œä¸»æ©Ÿ**ï¼š**é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ**ï¼ˆç•¶å‰é–‹ç™¼çš„æ©Ÿå™¨ï¼‰
- **åŸ·è¡Œæ™‚æ©Ÿ**ï¼šé–‹ç™¼éç¨‹ä¸­é‡åˆ°é·ç§»å•é¡Œæ™‚
- **åŸ·è¡Œç”¨æˆ¶**ï¼š`mes` ç”¨æˆ¶
- **åŸ·è¡Œä½ç½®**ï¼š`/var/www/mes/` å°ˆæ¡ˆç›®éŒ„
- **å½±éŸ¿ç¯„åœ**ï¼šç•¶å‰é–‹ç™¼ç’°å¢ƒçš„é·ç§»ç‹€æ…‹

#### **æ¸…ç†å°ˆæ¡ˆé·ç§»è…³æœ¬ (`æ¸…ç†å°ˆæ¡ˆé·ç§».sh`)**
- **åŸ·è¡Œä¸»æ©Ÿ**ï¼š**é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ**ï¼ˆæº–å‚™éƒ¨ç½²åŒ…çš„æ©Ÿå™¨ï¼‰
- **åŸ·è¡Œæ™‚æ©Ÿ**ï¼šæº–å‚™éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒå‰
- **åŸ·è¡Œç”¨æˆ¶**ï¼š`mes` ç”¨æˆ¶
- **åŸ·è¡Œä½ç½®**ï¼š`/var/www/mes/` å°ˆæ¡ˆç›®éŒ„
- **å½±éŸ¿ç¯„åœ**ï¼šé–‹ç™¼ç’°å¢ƒçš„é·ç§»æª”æ¡ˆï¼ˆç‚ºç”Ÿç”¢éƒ¨ç½²åšæº–å‚™ï¼‰

### ğŸ“ è…³æœ¬åŸ·è¡Œä½ç½®ç¤ºæ„åœ–

```
é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ (192.168.1.21)
â”œâ”€â”€ /var/www/mes/
â”‚   â”œâ”€â”€ é‡ç½®é·ç§».sh          â† åœ¨é€™è£¡åŸ·è¡Œ
â”‚   â”œâ”€â”€ æ¸…ç†å°ˆæ¡ˆé·ç§».sh      â† åœ¨é€™è£¡åŸ·è¡Œ
â”‚   â”œâ”€â”€ system/migrations/
â”‚   â”œâ”€â”€ workorder/migrations/
â”‚   â””â”€â”€ ...
â””â”€â”€ åŸ·è¡Œè…³æœ¬å¾Œç”Ÿæˆéƒ¨ç½²åŒ…

ç”Ÿç”¢ç’°å¢ƒä¸»æ©Ÿ (ç”Ÿç”¢ä¸»æ©ŸIP)
â”œâ”€â”€ æ¥æ”¶éƒ¨ç½²åŒ…
â”œâ”€â”€ è§£å£“éƒ¨ç½²åŒ…
â””â”€â”€ åŸ·è¡Œ python3 manage.py migrate --fake
```

### âš ï¸ é‡è¦æé†’

1. **å…©å€‹è…³æœ¬éƒ½åªèƒ½åœ¨é–‹ç™¼ç’°å¢ƒä¸»æ©Ÿä¸ŠåŸ·è¡Œ**
2. **çµ•å°ä¸èƒ½åœ¨ç”Ÿç”¢ç’°å¢ƒä¸»æ©Ÿä¸ŠåŸ·è¡Œé€™äº›è…³æœ¬**
3. **è…³æœ¬åŸ·è¡Œå¾Œï¼Œæœƒå½±éŸ¿é–‹ç™¼ç’°å¢ƒçš„é·ç§»ç‹€æ…‹**
4. **ç”Ÿç”¢ç’°å¢ƒåªéœ€è¦åŸ·è¡Œ Django çš„ migrate å‘½ä»¤**

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æº–å‚™éšæ®µï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰

**åŸ·è¡Œä¸»æ©Ÿ**ï¼šé–‹ç™¼ç’°å¢ƒä¸»æ©Ÿï¼ˆå¦‚ï¼š192.168.1.21ï¼‰

#### 1.1 åˆä½µé·ç§»æª”æ¡ˆ
```bash
# åŸ·è¡Œé·ç§»åˆä½µè…³æœ¬
./merge_migrations.sh
```

é€™å€‹è…³æœ¬æœƒï¼š
- å‚™ä»½æ‰€æœ‰ç¾æœ‰é·ç§»æª”æ¡ˆ
- åˆä½µä»¥ä¸‹æ¨¡çµ„çš„é·ç§»æª”æ¡ˆï¼š
  - workorder: 29å€‹ â†’ 1å€‹
  - system: 13å€‹ â†’ 1å€‹
  - reporting: 14å€‹ â†’ 1å€‹
  - workorder_dispatch: 7å€‹ â†’ 1å€‹
  - fill_work: 8å€‹ â†’ 1å€‹
  - onsite_reporting: 10å€‹ â†’ 1å€‹
  - manufacturing_order: 5å€‹ â†’ 1å€‹

#### 1.2 å‰µå»ºéƒ¨ç½²åŒ…
```bash
# åŸ·è¡Œéƒ¨ç½²åŒ…å‰µå»ºè…³æœ¬
./create_production_package.sh
```

é€™å€‹è…³æœ¬æœƒï¼š
- å‚™ä»½ç•¶å‰è³‡æ–™åº«
- æª¢æŸ¥ä¸¦åˆä½µé·ç§»æª”æ¡ˆï¼ˆå¦‚æœé‚„æ²’åˆä½µï¼‰
- å‰µå»ºå®Œæ•´çš„éƒ¨ç½²åŒ…
- ç”Ÿæˆè©³ç´°çš„éƒ¨ç½²èªªæ˜æ–‡ä»¶

### 2. éƒ¨ç½²éšæ®µï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

**åŸ·è¡Œä¸»æ©Ÿ**ï¼šç”Ÿç”¢ç’°å¢ƒä¸»æ©Ÿï¼ˆç›®æ¨™éƒ¨ç½²æ©Ÿå™¨ï¼‰

#### 2.1 ç’°å¢ƒæº–å‚™
```bash
# å®‰è£å¿…è¦å¥—ä»¶
sudo apt update
sudo apt install python3.10 python3.10-venv python3.10-dev
sudo apt install postgresql postgresql-contrib
sudo apt install redis-server
sudo apt install nginx
```

#### 2.2 è³‡æ–™åº«è¨­å®š
```bash
# å‰µå»ºè³‡æ–™åº«å’Œç”¨æˆ¶
sudo -u postgres psql
CREATE DATABASE mes_db;
CREATE USER mes_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE mes_db TO mes_user;
\q
```

#### 2.3 éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼
```bash
# è§£å£“éƒ¨ç½²åŒ…
tar -xzf mes_production_YYYYMMDD_HHMMSS.tar.gz
cd mes_production_YYYYMMDD_HHMMSS

# å‰µå»ºè™›æ“¬ç’°å¢ƒ
python3.10 -m venv venv
source venv/bin/activate

# å®‰è£ä¾è³´
pip install -r requirements.txt

# è¨­å®šç’°å¢ƒè®Šæ•¸
cp .env.example .env
# ç·¨è¼¯ .env æª”æ¡ˆï¼Œè¨­å®šæ­£ç¢ºçš„è³‡æ–™åº«é€£ç·šè³‡è¨Š

# åŸ·è¡Œé·ç§»ï¼ˆä½¿ç”¨åˆä½µå¾Œçš„é·ç§»æª”æ¡ˆï¼‰
python3 manage.py migrate

# æ”¶é›†éœæ…‹æª”æ¡ˆ
python3 manage.py collectstatic --noinput

# å‰µå»ºè¶…ç´šç”¨æˆ¶
python3 manage.py createsuperuser
```

#### 2.4 è¨­å®šæœå‹™
```bash
# è¨­å®š Celery æœå‹™
sudo cp deployment/celery.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable celery-mes_config
sudo systemctl start celery-mes_config

# è¨­å®š Nginx
sudo cp deployment/nginx.conf /etc/nginx/sites-available/mes
sudo ln -s /etc/nginx/sites-available/mes /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# è¨­å®š Gunicorn
sudo cp deployment/gunicorn.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable gunicorn-mes_config
sudo systemctl start gunicorn-mes_config
```

---

## ğŸ“ é·ç§»æª”æ¡ˆèªªæ˜

### åˆä½µå¾Œçš„é·ç§»æª”æ¡ˆ
éƒ¨ç½²åŒ…åŒ…å«ä»¥ä¸‹åˆä½µå¾Œçš„é·ç§»æª”æ¡ˆï¼š

1. **workorder**: `0001_squashed_0029_alter_completedworkorder_completed_at.py`
   - åŒ…å« 29 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹å·¥å–®ç®¡ç†çš„æ‰€æœ‰åŠŸèƒ½

2. **system**: `0001_squashed_0013_ordersynclog_ordersyncsettings.py`
   - åŒ…å« 13 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹ç³»çµ±ç®¡ç†çš„æ‰€æœ‰åŠŸèƒ½

3. **reporting**: `0001_squashed_0014_alter_completedworkorderanalysis_unique_together.py`
   - åŒ…å« 14 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹å ±è¡¨åŠŸèƒ½çš„æ‰€æœ‰åŠŸèƒ½

4. **workorder_dispatch**: `0001_squashed_0007_update_dispatch_default_status.py`
   - åŒ…å« 7 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹å·¥å–®æ´¾ç™¼çš„æ‰€æœ‰åŠŸèƒ½

5. **fill_work**: `0001_squashed_0008_alter_fillwork_unique_together.py`
   - åŒ…å« 8 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹å¡«å ±å·¥ä½œçš„æ‰€æœ‰åŠŸèƒ½

6. **onsite_reporting**: `0001_squashed_0010_alter_onsitereport_abnormal_notes_and_more.py`
   - åŒ…å« 10 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹ç¾å ´å ±å·¥çš„æ‰€æœ‰åŠŸèƒ½

7. **manufacturing_order**: `0001_squashed_0005_delete_companyordersystemconfig.py`
   - åŒ…å« 5 å€‹åŸå§‹é·ç§»æª”æ¡ˆçš„å…§å®¹
   - æ¶µè“‹å…¬å¸è¨‚å–®çš„æ‰€æœ‰åŠŸèƒ½

### é·ç§»æª”æ¡ˆå„ªåŒ–
åˆä½µéç¨‹ä¸­ï¼ŒDjango æœƒè‡ªå‹•å„ªåŒ–é·ç§»æ“ä½œï¼š
- ç§»é™¤é‡è¤‡çš„æ“ä½œ
- åˆä½µç›¸é—œçš„æ¬„ä½è®Šæ›´
- æ¸›å°‘ç¸½æ“ä½œæ•¸é‡

ä¾‹å¦‚ï¼š
- workorder: 86å€‹æ“ä½œ â†’ 77å€‹æ“ä½œ
- system: 25å€‹æ“ä½œ â†’ 12å€‹æ“ä½œ
- reporting: 28å€‹æ“ä½œ â†’ 5å€‹æ“ä½œ

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. å‚™ä»½é‡è¦æ€§
- éƒ¨ç½²å‰å‹™å¿…å‚™ä»½ç¾æœ‰è³‡æ–™åº«
- é·ç§»æª”æ¡ˆåˆä½µå‰æœƒè‡ªå‹•å‚™ä»½åŸå§‹æª”æ¡ˆ

### 2. ç’°å¢ƒä¸€è‡´æ€§
- ç¢ºä¿é–‹ç™¼ç’°å¢ƒå’Œç”Ÿç”¢ç’°å¢ƒçš„ Python ç‰ˆæœ¬ä¸€è‡´
- ç¢ºä¿è³‡æ–™åº«ç‰ˆæœ¬ä¸€è‡´
- ç¢ºä¿æ‰€æœ‰ä¾è³´å¥—ä»¶ç‰ˆæœ¬ä¸€è‡´

### 3. æ¸¬è©¦é©—è­‰
- éƒ¨ç½²å¾Œè¦æ¸¬è©¦æ‰€æœ‰ä¸»è¦åŠŸèƒ½
- æª¢æŸ¥ Celery ä»»å‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
- æª¢æŸ¥å®šæ™‚ä»»å‹™æ˜¯å¦æ­£å¸¸åŸ·è¡Œ

### 4. ç›£æ§ç¶­è­·
- å®šæœŸæª¢æŸ¥ç³»çµ±æ—¥èªŒ
- ç›£æ§è³‡æ–™åº«æ•ˆèƒ½
- å®šæœŸå‚™ä»½è³‡æ–™åº«

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **é·ç§»å¤±æ•—**
   ```bash
   # æª¢æŸ¥é·ç§»ç‹€æ…‹
   python3 manage.py showmigrations
   
   # å¼·åˆ¶åŸ·è¡Œé·ç§»
   python3 manage.py migrate --fake-initial
   
   # å¦‚æœé·ç§»æª”æ¡ˆåš´é‡æå£ï¼Œä½¿ç”¨é‡ç½®è…³æœ¬
   ./é‡ç½®é·ç§».sh
   ```

2. **é·ç§»æª”æ¡ˆæ··äº‚**
   ```bash
   # æª¢æŸ¥é·ç§»æª”æ¡ˆæ•¸é‡
   find . -path "*/migrations/*.py" -not -name "__init__.py" | wc -l
   
   # ä½¿ç”¨é‡ç½®è…³æœ¬æ•´ç†é·ç§»ç‹€æ…‹
   ./é‡ç½®é·ç§».sh
   
   # æˆ–ä½¿ç”¨æ¸…ç†è…³æœ¬ï¼ˆåƒ…é™ç”Ÿç”¢éƒ¨ç½²ï¼‰
   ./æ¸…ç†å°ˆæ¡ˆé·ç§».sh
   ```

2. **æœå‹™å•Ÿå‹•å¤±æ•—**
   ```bash
   # æª¢æŸ¥æœå‹™ç‹€æ…‹
   sudo systemctl status celery-mes_config
   sudo systemctl status gunicorn-mes_config
   sudo systemctl status nginx
   
   # æŸ¥çœ‹æ—¥èªŒ
   sudo journalctl -u celery-mes_config -f
   sudo journalctl -u gunicorn-mes_config -f
   ```

3. **è³‡æ–™åº«é€£ç·šå•é¡Œ**
   ```bash
   # æ¸¬è©¦è³‡æ–™åº«é€£ç·š
   python3 manage.py dbshell
   
   # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
   cat .env | grep DATABASE
   ```

4. **æ¬Šé™å•é¡Œ**
   ```bash
   # ä¿®å¾©æ¬Šé™
   sudo chown -R mes:www-data /var/www/mes/
   sudo chown -R mes:www-data /var/log/mes/
   sudo chmod -R 755 /var/www/mes/
   ```

---

## ğŸ”„ å¾ŒçºŒé–‹ç™¼èˆ‡ç¶­è­·

### ğŸ“ é–‹ç™¼æµç¨‹ï¼ˆçµ¦ç¨‹å¼é–‹ç™¼äººå“¡ï¼‰

#### 1. æ—¥å¸¸é–‹ç™¼
ç•¶æ‚¨éœ€è¦ä¿®æ”¹è³‡æ–™åº«çµæ§‹æ™‚ï¼ˆä¾‹å¦‚æ–°å¢æ¬„ä½ã€ä¿®æ”¹è¡¨æ ¼ï¼‰ï¼š

```bash
# 1. ä¿®æ”¹ models.py æª”æ¡ˆ
# 2. ç”¢ç”Ÿæ–°çš„é·ç§»æª”æ¡ˆ
python3 manage.py makemigrations

# 3. åœ¨é–‹ç™¼ç’°å¢ƒæ¸¬è©¦
python3 manage.py migrate
python3 manage.py runserver
```

#### 2. æº–å‚™éƒ¨ç½²
ç•¶é–‹ç™¼å®Œæˆï¼Œè¦éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒæ™‚ï¼š

```bash
# 1. åˆä½µæ‰€æœ‰é·ç§»æª”æ¡ˆï¼ˆè§£æ±ºä¾è³´å•é¡Œï¼‰
./åˆä½µé·ç§»æª”æ¡ˆ.sh

# 2. å‰µå»ºæ–°çš„éƒ¨ç½²åŒ…
./å‰µå»ºéƒ¨ç½²åŒ….sh

# 3. å°‡éƒ¨ç½²åŒ…ä¸Šå‚³åˆ°ç”Ÿç”¢ç’°å¢ƒ
```

#### 2.1 é·ç§»æª”æ¡ˆç®¡ç†ï¼ˆé‡è¦ï¼ï¼‰
**åŸ·è¡Œä¸»æ©Ÿ**ï¼šé–‹ç™¼ç’°å¢ƒä¸»æ©Ÿ

åœ¨éƒ¨ç½²å‰ï¼Œå¯èƒ½éœ€è¦æ•´ç†é·ç§»æª”æ¡ˆï¼š

```bash
# æƒ…æ³ A: é–‹ç™¼ç’°å¢ƒé·ç§»å•é¡Œ
./é‡ç½®é·ç§».sh

# æƒ…æ³ B: æº–å‚™ç”Ÿç”¢éƒ¨ç½²ï¼ˆå®Œå…¨æ¸…ç†ï¼‰
./æ¸…ç†å°ˆæ¡ˆé·ç§».sh

# æƒ…æ³ C: æª¢æŸ¥é·ç§»ç‹€æ…‹
python3 manage.py showmigrations
find . -path "*/migrations/*.py" -not -name "__init__.py" | wc -l
```

#### 3. ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²
```bash
# 1. è§£å£“æ–°çš„éƒ¨ç½²åŒ…
tar -xzf mes_production_YYYYMMDD_HHMMSS.tar.gz

# 2. åŸ·è¡Œéƒ¨ç½²
sudo ./å…¨æ–°éƒ¨ç½².sh
```

### ğŸ”„ ç³»çµ±æ›´æ–°æµç¨‹ï¼ˆé‡è¦ï¼ï¼‰

#### æƒ…æ³ 1: å…¨æ–°éƒ¨ç½²ï¼ˆç¬¬ä¸€æ¬¡å®‰è£ï¼‰
```bash
# é©ç”¨æ–¼ï¼šå…¨æ–°çš„ç”Ÿç”¢ç’°å¢ƒ
sudo ./å…¨æ–°éƒ¨ç½².sh
```

#### æƒ…æ³ 2: ç³»çµ±æ›´æ–°ï¼ˆå·²æœ‰ç³»çµ±ï¼Œè¦æ›´æ–°åŠŸèƒ½ï¼‰
```bash
# 1. å‚™ä»½ç¾æœ‰ç³»çµ±
sudo -u postgres pg_dump mes_db > /backup/mes_db_before_update_$(date +%Y%m%d_%H%M%S).sql
sudo tar -czf /backup/mes_files_before_update_$(date +%Y%m%d_%H%M%S).tar.gz /var/www/mes/

# 2. åœæ­¢æœå‹™
sudo systemctl stop gunicorn-mes_config celery-mes_config

# 3. å‚™ä»½ç•¶å‰ç¨‹å¼ç¢¼
sudo cp -r /var/www/mes /var/www/mes_backup_$(date +%Y%m%d_%H%M%S)

# 4. è§£å£“æ–°ç‰ˆæœ¬
cd /var/www
sudo tar -xzf mes_production_YYYYMMDD_HHMMSS.tar.gz
sudo mv mes mes_old
sudo mv mes_production_YYYYMMDD_HHMMSS mes

# 5. è¨­å®šæ¬Šé™
sudo chown -R mes:www-data /var/www/mes/
sudo chmod -R 755 /var/www/mes/

# 6. æ›´æ–°ç’°å¢ƒè¨­å®šï¼ˆä¿ç•™åŸæœ‰çš„ .envï¼‰
sudo cp /var/www/mes_old/.env /var/www/mes/

# 7. åŸ·è¡Œè³‡æ–™åº«é·ç§»
cd /var/www/mes
source venv/bin/activate
python3 manage.py migrate

# 8. æ”¶é›†éœæ…‹æª”æ¡ˆ
python3 manage.py collectstatic --noinput

# 9. é‡å•Ÿæœå‹™
sudo systemctl start gunicorn-mes_config celery-mes_config

# 10. æª¢æŸ¥æœå‹™ç‹€æ…‹
sudo systemctl status gunicorn-mes_config celery-mes_config

# 11. æ¸¬è©¦ç¶²ç«™åŠŸèƒ½
curl -I http://localhost

# 12. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ¸…ç†èˆŠæª”æ¡ˆ
sudo rm -rf /var/www/mes_old
```

#### æƒ…æ³ 3: ç·Šæ€¥ä¿®å¾©ï¼ˆåªæ›´æ–°ç‰¹å®šæª”æ¡ˆï¼‰
```bash
# é©ç”¨æ–¼ï¼šä¿®å¾© BUGï¼Œåªæ›´æ–°å°‘æ•¸æª”æ¡ˆ

# 1. å‚™ä»½è¦ä¿®æ”¹çš„æª”æ¡ˆ
sudo cp /var/www/mes/workorder/views.py /backup/workorder_views_$(date +%Y%m%d_%H%M%S).py

# 2. åœæ­¢æœå‹™
sudo systemctl stop gunicorn-mes_config

# 3. æ›´æ–°æª”æ¡ˆ
sudo cp new_workorder_views.py /var/www/mes/workorder/views.py

# 4. é‡å•Ÿæœå‹™
sudo systemctl start gunicorn-mes_config

# 5. æª¢æŸ¥æœå‹™ç‹€æ…‹
sudo systemctl status gunicorn-mes_config
```

### ğŸ”§ ç³»çµ±ç¶­è­·ï¼ˆçµ¦ç³»çµ±ç®¡ç†å“¡ï¼‰

#### é·ç§»æª”æ¡ˆç¶­è­·
```bash
# å®šæœŸæª¢æŸ¥é·ç§»æª”æ¡ˆç‹€æ…‹
find . -path "*/migrations/*.py" -not -name "__init__.py" | wc -l

# æª¢æŸ¥é·ç§»è¨˜éŒ„
python3 manage.py showmigrations

# å¦‚æœé·ç§»æª”æ¡ˆéå¤šæˆ–æ··äº‚ï¼Œè€ƒæ…®æ•´ç†
./é‡ç½®é·ç§».sh  # é–‹ç™¼ç’°å¢ƒ
# æˆ–
./æ¸…ç†å°ˆæ¡ˆé·ç§».sh  # ç”Ÿç”¢ç’°å¢ƒï¼ˆè¬¹æ…ä½¿ç”¨ï¼‰
```

#### æ—¥å¸¸æª¢æŸ¥
```bash
# æª¢æŸ¥æ‰€æœ‰æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
sudo systemctl status nginx postgresql redis-server
sudo systemctl status gunicorn-mes_config
sudo systemctl status celery-mes_config

# æª¢æŸ¥ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³
htop                    # CPU å’Œè¨˜æ†¶é«”ä½¿ç”¨
df -h                   # ç¡¬ç¢Ÿç©ºé–“
free -h                 # è¨˜æ†¶é«”ä½¿ç”¨
```

#### æŸ¥çœ‹æ—¥èªŒ
```bash
# æŸ¥çœ‹ MES ç³»çµ±æ—¥èªŒ
tail -f /var/log/mes/django/mes.log

# æŸ¥çœ‹ç¶²ç«™è¨ªå•æ—¥èªŒ
tail -f /var/log/nginx/access.log

# æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ
tail -f /var/log/nginx/error.log

# æŸ¥çœ‹ Celery ä»»å‹™æ—¥èªŒ
sudo journalctl -u celery-mes_config -f
```

#### å®šæœŸå‚™ä»½
```bash
# å‚™ä»½è³‡æ–™åº«ï¼ˆæ¯å¤©åŸ·è¡Œä¸€æ¬¡ï¼‰
sudo -u postgres pg_dump mes_db > /backup/mes_db_$(date +%Y%m%d).sql

# å‚™ä»½é‡è¦æª”æ¡ˆ
sudo tar -czf /backup/mes_files_$(date +%Y%m%d).tar.gz /var/www/mes/

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å‚™ä»½
find /backup/ -name "*.sql" -mtime +7 -delete
find /backup/ -name "*.tar.gz" -mtime +7 -delete
```

#### ç³»çµ±æ›´æ–°
```bash
# æ›´æ–°ç³»çµ±å¥—ä»¶ï¼ˆæ¯é€±åŸ·è¡Œä¸€æ¬¡ï¼‰
sudo apt update
sudo apt upgrade -y

# é‡å•Ÿæœå‹™
sudo systemctl restart nginx postgresql redis-server
sudo systemctl restart gunicorn-mes_config
sudo systemctl restart celery-mes_config

# æª¢æŸ¥æœå‹™ç‹€æ…‹
sudo systemctl status nginx postgresql redis-server
sudo systemctl status gunicorn-mes_config
sudo systemctl status celery-mes_config
```

### ğŸš¨ ç·Šæ€¥è™•ç†

#### æœå‹™ç„¡æ³•å•Ÿå‹•
```bash
# 1. æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ
sudo journalctl -u gunicorn-mes_config -n 50

# 2. æª¢æŸ¥è³‡æ–™åº«é€£ç·š
python3 manage.py dbshell

# 3. é‡æ–°å•Ÿå‹•æœå‹™
sudo systemctl restart gunicorn-mes_config
```

#### ç¶²ç«™ç„¡æ³•è¨ªå•
```bash
# 1. æª¢æŸ¥ Nginx ç‹€æ…‹
sudo systemctl status nginx

# 2. æª¢æŸ¥ Nginx é…ç½®
sudo nginx -t

# 3. é‡æ–°è¼‰å…¥ Nginx
sudo systemctl reload nginx
```

#### è³‡æ–™åº«å•é¡Œ
```bash
# 1. æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹
sudo systemctl status postgresql

# 2. æª¢æŸ¥è³‡æ–™åº«é€£ç·š
sudo -u postgres psql -d mes_db

# 3. å¾å‚™ä»½é‚„åŸï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo -u postgres psql -d mes_db < /backup/mes_db_YYYYMMDD.sql
```

### ğŸ“‹ ç¶­è­·æª¢æŸ¥æ¸…å–®

#### æ¯æ—¥æª¢æŸ¥
- [ ] ç¶²ç«™æ˜¯å¦å¯ä»¥æ­£å¸¸è¨ªå•
- [ ] æ‰€æœ‰æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
- [ ] ç³»çµ±è³‡æºä½¿ç”¨æ˜¯å¦æ­£å¸¸
- [ ] éŒ¯èª¤æ—¥èªŒæ˜¯å¦æœ‰ç•°å¸¸

#### æ¯é€±æª¢æŸ¥
- [ ] åŸ·è¡Œç³»çµ±æ›´æ–°
- [ ] æª¢æŸ¥å‚™ä»½æ˜¯å¦æˆåŠŸ
- [ ] æ¸…ç†èˆŠçš„æ—¥èªŒæª”æ¡ˆ
- [ ] æª¢æŸ¥ç£ç¢Ÿç©ºé–“

#### æ¯æœˆæª¢æŸ¥
- [ ] æª¢æŸ¥ç³»çµ±æ•ˆèƒ½
- [ ] æ›´æ–°å®‰å…¨å¥—ä»¶
- [ ] æª¢æŸ¥å‚™ä»½é‚„åŸæ¸¬è©¦
- [ ] æª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™

---

## ğŸ“ æŠ€è¡“æ”¯æ´

### ç·Šæ€¥è¯çµ¡
- **ç³»çµ±ç®¡ç†å“¡**: [è¯çµ¡è³‡è¨Š]
- **æŠ€è¡“æ”¯æ´**: [è¯çµ¡è³‡è¨Š]
- **ç·Šæ€¥é›»è©±**: [é›»è©±è™Ÿç¢¼]

### ç›¸é—œæ–‡ä»¶
- [MES ç³»çµ±ä½¿ç”¨æ‰‹å†Š]
- [API æ–‡ä»¶]
- [é–‹ç™¼è€…æ–‡ä»¶]

---

## ğŸ“ ç‰ˆæœ¬è³‡è¨Š

- **æ–‡ä»¶ç‰ˆæœ¬**: 1.0
- **æœ€å¾Œæ›´æ–°**: 2025-08-28
- **é©ç”¨ç‰ˆæœ¬**: MES ç³»çµ± v1.0
- **ä½œè€…**: MES é–‹ç™¼åœ˜éšŠ

---

## ğŸ‰ ç¸½çµ

é€šéä½¿ç”¨é·ç§»åˆä½µæŠ€è¡“ï¼Œæˆ‘å€‘å¯ä»¥ï¼š
1. ç°¡åŒ–ç”Ÿç”¢ç’°å¢ƒçš„éƒ¨ç½²æµç¨‹
2. æ¸›å°‘é·ç§»ä¾è³´å•é¡Œ
3. ç¢ºä¿é–‹ç™¼ç’°å¢ƒå’Œç”Ÿç”¢ç’°å¢ƒçš„ä¸€è‡´æ€§
4. æé«˜éƒ¨ç½²çš„å¯é æ€§å’Œæ•ˆç‡

é€™å€‹è§£æ±ºæ–¹æ¡ˆç‰¹åˆ¥é©åˆéœ€è¦é »ç¹éƒ¨ç½²çš„å°ˆæ¡ˆï¼Œå¯ä»¥å¤§å¤§æ¸›å°‘éƒ¨ç½²éç¨‹ä¸­çš„å•é¡Œå’Œé¢¨éšªã€‚

---

**æ³¨æ„**: æœ¬æ–‡ä»¶é©ç”¨æ–¼ MES ç³»çµ±çš„ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ã€‚å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯çµ¡æŠ€è¡“æ”¯æ´åœ˜éšŠã€‚
