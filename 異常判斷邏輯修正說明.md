# 異常判斷邏輯修正說明

## 問題描述

您反映的問題：「為什麼我匯入的資料沒有異常紀錄，系統卻判斷有1233筆異常？」

## 根本原因

系統中存在**兩套不同的異常判斷邏輯**，導致統計數據不一致：

### 舊邏輯（錯誤的）
- **主管功能頁面** (`supervisor_functions`) 和 **主管報工首頁** (`supervisor_report_index`)
- 作業員異常：`Q(remarks__isnull=False) & ~Q(remarks='')` （只要備註有內容就算異常）
- SMT異常：`Q(remarks__icontains='異常')` （備註包含「異常」字樣就算異常）

### 新邏輯（正確的）
- **異常管理頁面** (`abnormal_management`)
- 作業員異常：`Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')` （異常紀錄欄位有內容）
- SMT異常：`Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')` （異常紀錄欄位有內容）

## 修正內容

### 1. 修正主管功能頁面 (`supervisor_functions`)
**檔案位置**：`workorder/views.py` 第3467-3509行

**修正前**：
```python
# 異常統計
'abnormal_operator': OperatorSupplementReport.objects.filter(
    Q(remarks__isnull=False) & ~Q(remarks='')
).count(),
'abnormal_smt': SMTProductionReport.objects.filter(
    Q(remarks__icontains='異常') | Q(remarks__icontains='異常')
).count(),
```

**修正後**：
```python
# 異常統計
'abnormal_operator': OperatorSupplementReport.objects.filter(
    Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')
).count(),
'abnormal_smt': SMTProductionReport.objects.filter(
    Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')
).count(),
```

### 2. 修正主管報工首頁 (`supervisor_report_index`)
**檔案位置**：`workorder/views.py` 第3350-3360行

**修正前**：
```python
# 異常統計
'abnormal_supervisor': SupervisorProductionReport.objects.filter(
    Q(remarks__isnull=False) & ~Q(remarks='')
).count(),
'abnormal_operator': OperatorSupplementReport.objects.filter(
    Q(remarks__isnull=False) & ~Q(remarks='')
).count(),
'abnormal_smt': SMTProductionReport.objects.filter(
    Q(remarks__icontains='異常') | Q(remarks__icontains='異常')
).count(),
```

**修正後**：
```python
# 異常統計
'abnormal_supervisor': SupervisorProductionReport.objects.filter(
    Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')
).count(),
'abnormal_operator': OperatorSupplementReport.objects.filter(
    Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')
).count(),
'abnormal_smt': SMTProductionReport.objects.filter(
    Q(abnormal_notes__isnull=False) & ~Q(abnormal_notes='')
).count(),
```

### 3. 修正最近異常記錄顯示
**修正前**：顯示 `report.remarks`（備註內容）
**修正後**：顯示 `report.abnormal_notes`（異常紀錄內容）

## 正確的異常判斷邏輯

### 正常報工
- **備註欄位**：有內容（如「正常生產」、「大量生產」等）或空白
- **異常紀錄欄位**：空白或無內容
- **系統判斷**：正常報工

### 異常報工
- **備註欄位**：有內容（如「RD樣品測試」等）或空白
- **異常紀錄欄位**：有內容（如「設備故障」、「品質問題」等）
- **系統判斷**：異常報工

## 重要說明

**異常判斷的唯一標準是異常紀錄欄位**：
- 異常紀錄欄位有內容 → 異常報工
- 異常紀錄欄位空白 → 正常報工
- 備註欄位內容不影響異常判斷

## 修正結果

1. **統一異常判斷邏輯**：所有頁面都使用 `abnormal_notes` 欄位判斷異常
2. **正確統計數據**：異常數量將反映真實的異常紀錄數量
3. **邏輯一致性**：備註欄位只作為一般說明，不再影響異常判斷

## 驗證方法

1. 檢查主管功能頁面的異常統計數量
2. 檢查異常管理頁面的異常列表
3. 確認只有異常紀錄欄位有內容的報工才會被判斷為異常

## 注意事項

- 備註欄位現在只作為一般說明用途
- 只有異常紀錄欄位有內容的報工才會被系統判斷為異常
- 匯入資料時，請確保異常報工在異常紀錄欄位填入相關內容 