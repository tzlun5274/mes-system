# 已完工工單工序紀錄數量分配功能實現總結

## 🎯 功能概述

根據您的需求，我已經成功實現了已完工工單工序紀錄數量自動分配功能。此功能會為已完工工單中數量為0的工序紀錄自動分配數量，並標記為系統分配。

## 📋 分配邏輯

### 基本規則
1. **排除條件**：一律排除工序名稱為 "出貨包裝" 的工序
2. **分配單位**：一筆工序紀錄為一筆（不論作業員是否相同）
3. **獨立計算**：
   - 兩筆同一名作業員同一個工序 = 兩筆獨立紀錄
   - 三筆兩個不同作業員同一個工序 = 三筆獨立紀錄

### 分配範例
假設工單生產數量是 1000：

1. **一個作業員一個工序，沒有重複** → 1筆紀錄分配 1000
2. **一個作業員分兩次報工，同一個工序** → 2筆紀錄，每筆分配 500
3. **兩個作業員同一個工序** → 2筆獨立紀錄，每筆分配 500
4. **三個作業員同一個工序** → 3筆紀錄，每筆分配 333（餘數1給第一筆）
5. **三個作業員同一個工序有4筆紀錄** → 4筆紀錄，每筆分配 250
6. **三個作業員同一個工序有4筆紀錄，其中1筆已有數量** → 將1000減掉已有數量，剩餘平均分配給數量為0的3筆紀錄

## 🏗️ 系統架構

### 核心組件

1. **分配服務** (`workorder/services/completed_workorder_allocation_service.py`)
   - 核心分配邏輯
   - 批量處理功能
   - 統計摘要功能

2. **管理命令** (`workorder/management/commands/allocate_completed_workorder_quantities.py`)
   - 手動執行分配
   - 支援乾跑模式
   - 摘要顯示功能

3. **定時任務** (`workorder/tasks.py`)
   - 自動執行分配
   - 定期檢查待分配工單

4. **設定管理** (`workorder/management/commands/setup_completed_workorder_allocation_task.py`)
   - 定時任務設定
   - 啟用/停用控制

5. **資料模型** (`workorder/models.py`)
   - 新增 `is_system_allocated` 欄位標記系統分配
   - 擴展 `AutoAllocationSettings` 模型

6. **網頁介面** (`workorder/templates/workorder/completed_workorder/completed_workorder_detail.html`)
   - 在已完工工單詳情頁面顯示分配標記

## 🔧 主要功能

### 1. 自動分配邏輯

```python
# 按工序名稱分組
processes_data = {}

for report in production_reports:
    process_name = report.process_name
    
    if process_name not in processes_data:
        processes_data[process_name] = {
            'reports': [],
            'total_existing_quantity': 0,
            'zero_quantity_reports': []
        }
    
    # 統計已有數量
    if report.work_quantity > 0:
        processes_data[process_name]['total_existing_quantity'] += report.work_quantity
    else:
        processes_data[process_name]['zero_quantity_reports'].append(report)
```

### 2. 數量分配計算

```python
# 計算該工序需要分配的數量
existing_quantity = data['total_existing_quantity']
remaining_quantity = total_planned_quantity - existing_quantity

# 計算每筆紀錄的分配數量
zero_reports_count = len(data['zero_quantity_reports'])
quantity_per_report = remaining_quantity // zero_reports_count
remainder = remaining_quantity % zero_reports_count

for i, report in enumerate(data['zero_quantity_reports']):
    # 分配數量（前面的紀錄獲得餘數）
    allocated_quantity = quantity_per_report + (1 if i < remainder else 0)
    
    # 更新紀錄並標記為系統分配
    report.work_quantity = allocated_quantity
    report.is_system_allocated = True
    report.allocated_at = timezone.now()
    report.allocation_method = 'completed_workorder_allocation'
    report.save()
```

### 3. 系統分配標記

在 `CompletedProductionReport` 模型中新增欄位：
- `is_system_allocated`: 標記是否為系統自動分配
- `allocated_at`: 分配時間
- `allocation_method`: 分配方式

## 📊 使用方式

### 1. 手動執行分配

```bash
# 查看分配摘要
python3 manage.py allocate_completed_workorder_quantities --summary

# 乾跑模式（只顯示會執行的操作）
python3 manage.py allocate_completed_workorder_quantities --dry-run

# 為指定工單執行分配
python3 manage.py allocate_completed_workorder_quantities --workorder WO001

# 為所有待分配工單執行分配
python3 manage.py allocate_completed_workorder_quantities
```

### 2. 定時任務管理

```bash
# 創建定時任務（60分鐘執行一次）
python3 manage.py setup_completed_workorder_allocation_task --create --interval 60

# 啟用定時任務
python3 manage.py setup_completed_workorder_allocation_task --enable

# 停用定時任務
python3 manage.py setup_completed_workorder_allocation_task --disable

# 刪除定時任務
python3 manage.py setup_completed_workorder_allocation_task --delete
```

### 3. 網頁介面

在已完工工單詳情頁面中，填報記錄表格會顯示分配標記：
- **系統分配**：藍色徽章，顯示 "系統分配"
- **手動填寫**：灰色徽章，顯示 "手動填寫"

## 🔍 監控與統計

### 1. 分配摘要

```python
summary = service.get_allocation_summary(workorder_number)
# 返回：
{
    'workorder_number': 'WO001',
    'planned_quantity': 1000,
    'total_reports': 15,
    'total_quantity': 1000,
    'total_system_allocated': 500,
    'total_manual_quantity': 500,
    'total_zero_quantity_reports': 3,
    'processes': {...}
}
```

### 2. 待分配工單列表

```python
pending_workorders = service.get_pending_allocation_workorders()
# 返回需要分配的工單列表
```

## ⚙️ 設定管理

在 `AutoAllocationSettings` 模型中新增設定：

- `completed_workorder_allocation_enabled`: 是否啟用已完工工單數量分配
- `completed_workorder_allocation_interval`: 執行頻率（分鐘）

## 🎯 功能特點

1. **智能分配**：根據工序名稱分組，每筆紀錄獨立計算
2. **公平分配**：剩餘數量平均分配，餘數優先給前面的紀錄
3. **標記系統**：清楚標示系統分配與手動填寫的數量
4. **批量處理**：支援批量處理所有待分配工單
5. **定時執行**：可設定定時任務自動執行
6. **安全機制**：支援乾跑模式，避免意外操作
7. **詳細統計**：提供完整的分配統計資訊

## 🔒 安全考量

1. **事務處理**：所有分配操作都在資料庫事務中執行
2. **錯誤處理**：完整的異常處理和日誌記錄
3. **資料驗證**：確保分配數量不超過工單總數量
4. **權限控制**：只有授權用戶可以執行分配操作

## 📈 效能優化

1. **批量處理**：一次處理多個工單，提高效率
2. **索引優化**：在相關欄位上建立資料庫索引
3. **記憶體管理**：分批處理大量資料，避免記憶體溢出
4. **非同步執行**：支援 Celery 非同步任務執行

這個功能已經完全按照您的需求實現，可以自動為已完工工單的工序紀錄分配數量，並在網頁介面中清楚顯示分配標記。 