# 工作時數計算方案說明

## 方案選擇

經過分析，我們選擇了**方案2：直接計算並增加兩個欄位：工作時數、加班時數**。

## 方案優點

1. **前端不變**：不需要修改前端介面，只需要在後端計算時處理
2. **資料結構簡潔**：直接儲存計算結果，避免資料冗餘
3. **符合需求**：自動處理橫跨中午休息時間的扣除邏輯
4. **實現簡單**：風險較低，容易維護

## 實作內容

### 1. 資料庫欄位新增

在 `OperatorSupplementReport` 和 `SupervisorProductionReport` 模型中新增了以下欄位：

- `work_hours_calculated`：工作時數（扣除休息時間後的實際工作時數）
- `overtime_hours_calculated`：加班時數（超過正常工時的部分）

### 2. 計算邏輯

#### 休息時間判斷
- 固定休息時間：12:00-13:00（1小時）
- 判斷邏輯：當開始時間在12:00之前且結束時間在13:00之後時，自動扣除1小時休息時間

#### 工作時數計算
- 總工作時數 = 結束時間 - 開始時間
- 實際工作時數 = 總工作時數 - 休息時數
- 工作時數 = 實際工作時數（扣除休息時間後的完整工作時數）
- 加班時數 = 結束時間超過17:30的部分

### 3. 計算範例

#### 案例1：10:00-12:00（不橫跨休息時間）
- 總工作時數：2小時
- 休息時數：0小時
- 實際工作時數：2小時
- 工作時數：2小時
- 加班時數：0小時

#### 案例2：10:00-15:00（橫跨休息時間）
- 總工作時數：5小時
- 休息時數：1小時
- 實際工作時數：4小時
- 工作時數：4小時
- 加班時數：0小時

#### 案例3：08:00-18:00（橫跨休息時間且有加班）
- 總工作時數：10小時
- 休息時數：1小時
- 實際工作時數：9小時
- 工作時數：9小時
- 加班時數：0.5小時（18:00-17:30）

#### 案例4：16:00-19:00（全部在17:30之後）
- 總工作時數：3小時
- 休息時數：0小時
- 實際工作時數：3小時
- 工作時數：3小時
- 加班時數：1.5小時（19:00-17:30）

## 使用方法

### 1. 自動計算
當儲存報工記錄時，系統會自動計算並更新工作時數和加班時數：

```python
# 在模型中已實作
def save(self, *args, **kwargs):
    """儲存時自動計算工作時數和加班時數"""
    self.calculate_work_hours()
    super().save(*args, **kwargs)
```

### 2. 手動重新計算
使用管理命令重新計算現有記錄：

```bash
# 重新計算最近30天的工作時數
python3 manage.py recalculate_work_hours

# 重新計算指定日期範圍
python3 manage.py recalculate_work_hours --date-from 2025-01-01 --date-to 2025-01-31

# 重新計算特定作業員
python3 manage.py recalculate_work_hours --worker "時美珍"

# 試運行模式（不實際更新資料庫）
python3 manage.py recalculate_work_hours --dry-run
```

### 3. 測試計算邏輯
使用測試命令驗證計算是否正確：

```bash
# 測試所有案例
python3 manage.py test_work_time_calculation

# 測試特定案例
python3 manage.py test_work_time_calculation --test-case basic
```

## 資料庫遷移

已建立遷移檔案：`workorder/migrations/0062_operatorsupplementreport_overtime_hours_calculated_and_more.py`

包含以下變更：
- 新增 `work_hours_calculated` 欄位到 `OperatorSupplementReport`
- 新增 `overtime_hours_calculated` 欄位到 `OperatorSupplementReport`
- 新增 `work_hours_calculated` 欄位到 `SupervisorProductionReport`
- 新增 `overtime_hours_calculated` 欄位到 `SupervisorProductionReport`

## 報表整合

這些新增的欄位可以直接用於報表系統：

- `work_hours_calculated`：用於工作報表，顯示實際工作時數
- `overtime_hours_calculated`：用於工時報表，顯示加班時數
- 結合現有的 `break_hours` 欄位，可以完整顯示工時分析

## 注意事項

1. **加班時間設定**：目前加班開始時間為17:30，如需調整請修改 `calculate_work_hours` 方法中的 `overtime_start_time` 變數
2. **休息時間固定**：目前休息時間固定為12:00-13:00，如需調整請修改計算邏輯
3. **SMT設備**：此計算邏輯僅適用於作業員報工，SMT設備不適用休息時間扣除
4. **資料一致性**：建議在部署後使用 `recalculate_work_hours` 命令重新計算所有現有記錄

## 未來擴展

1. **動態休息時間**：可以根據產線設定動態調整休息時間
2. **多班次支援**：可以支援不同班次的工時計算
3. **假日加班**：可以區分平日和假日的加班計算
4. **彈性工時**：可以支援彈性上下班時間的計算 